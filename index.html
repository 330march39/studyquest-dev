<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StudyQuest</title>

    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    
    <meta name="theme-color" content="#1A1A1D" media="(prefers-color-scheme: dark)">

    <style>
        /* 1. htmlã¨bodyã«æœ€åˆã‹ã‚‰èƒŒæ™¯è‰²ã‚’ã¤ã‘ã‚‹ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; 
            overscroll-behavior: none;
            touch-action: pan-y;
        }

        /* 2. ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®è¨­å®š */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; /* æœ¬ä½“ã¨åŒã˜è‰² */
            transition: opacity 0.5s ease;
        }
        
        #splash-screen img {
            width: 16rem;
            height: 16rem;
            object-fit: contain;
            margin-bottom: 1rem;
        }

        /* ãƒ­ã‚´ã®å‡ºã—åˆ†ã‘ */
        #splash-logo-dark { display: none; }
        #splash-logo-light { display: block; }

        /* 3. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®èƒŒæ™¯è‰²ã‚’OSè¨­å®šã‹ã‚‰å³åº§ã«åæ˜  */
        @media (prefers-color-scheme: dark) {
            html, body {
                background-color: #1A1A1D; /* ğŸ‘ˆ bg-gray-800 (ãƒ˜ãƒƒãƒ€ãƒ¼ã¨åŒã˜è‰²) ã«å¤‰æ›´ */
            }
            #splash-screen {
                background-color: #000000; /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã¯å…ƒã®ã¾ã¾ã§OK */
            }
            #splash-logo-light { display: none; }
            #splash-logo-dark { display: block; }
        }
        /* â–¼â–¼â–¼ è¿½åŠ ï¼šãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—è‰²ã‚’ç™½ã«å¼·åˆ¶ã™ã‚‹ â–¼â–¼â–¼ */
html.dark .text-gray-500 {
    color: #ffffff !important;
}

        /* ã‚¯ãƒ©ã‚¹ã«ã‚ˆã‚‹åˆ¶å¾¡ (JSãƒ­ãƒ¼ãƒ‰å¾Œ) */
        html.dark, html.dark body { background-color: #111827; } /* ğŸ‘ˆ ãƒ˜ãƒƒãƒ€ãƒ¼è‰² */
        html.dark #splash-screen { background-color: #000000; } /* ğŸ‘ˆ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è‰² */
        html.dark #splash-logo-light { display: none; }
        html.dark #splash-logo-dark { display: block; }
        /* â–¼â–¼â–¼ è¿½åŠ ï¼šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»Šæ—¥ã®äºˆå®šã€è¨­å®šã®è¦‹å‡ºã—ãªã©ï¼‰ã®ä¸€æ‹¬å¤‰æ›´ â–¼â–¼â–¼ */

/* 1. å…±é€šã®ç‰¹å¾´ã‚’æŒã¤è¦ç´ ã‚’ç‹™ã„æ’ƒã¡ã—ã¦ã€ã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹ */
.text-xs.font-bold.uppercase.tracking-wider {
    font-size: 15px !important; /* å…ƒã®12pxã‹ã‚‰15pxã«æ‹¡å¤§ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰ */
}

/* 2. ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã ã‘ã€æ–‡å­—è‰²ã‚’çœŸã£ç™½ã«ã™ã‚‹ */
html.dark .text-xs.font-bold.uppercase.tracking-wider {
    color: #ffffff !important;
}
    </style>

    <script>
        // ä¿®æ­£ç®‡æ‰€: ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ã—ã€æœªç™»éŒ²ãªã‚‰å¼·åˆ¶ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
        (function() {
            let isRegistered = false;
            try {
                const saved = localStorage.getItem('quizAppUltimateV8');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç¢ºèª
                    if (parsed.user && parsed.user.isRegistered) {
                        isRegistered = true;
                    }
                }
            } catch (e) {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æœªç™»éŒ²æ‰±ã„ï¼ˆãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
            }

            // ç™»éŒ²æ¸ˆã¿ ã‹ã¤ OSãŒãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ dark ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
            if (isRegistered && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                // ãã‚Œä»¥å¤–ï¼ˆåˆå›èµ·å‹•å«ã‚€ï¼‰ã¯ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ï¼ˆãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>

    <!-- PWAé–¢é€£ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta id="meta-status-bar" name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="StudyQuest">

    <link rel="icon" type="image/png" href="SQ_logo.png">

    <link rel="apple-touch-icon" href="SQ_logo.png">

    <meta property="og:image" content="SQ_logo.png">
    
    <link rel="manifest" href="manifest.json">
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ•ã‚©ãƒ³ãƒˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // OSã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã«åˆã‚ã›ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function updateStatusBarStyle() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const meta = document.getElementById('meta-status-bar');
            if (meta) {
                // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚: 'black-translucent'
                // â†’ èƒŒæ™¯ãŒé€æ˜ã«ãªã‚Šã€bodyã«è¨­å®šã—ãŸè‰²ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¨åŒã˜è‰²ï¼‰ãŒãã®ã¾ã¾é€ã‘ã¦è¦‹ãˆã¾ã™ã€‚æ–‡å­—ã¯ç™½ã«ãªã‚Šã¾ã™ã€‚
                // ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚: 'default'
                // â†’ æ¨™æº–ã®ç™½èƒŒæ™¯ãƒ»é»’æ–‡å­—ã«ãªã‚Šã¾ã™ã€‚
                meta.content = isDark ? 'black-translucent' : 'default';
            }
        }

        // 1. èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        updateStatusBarStyle();

        // 2. OSã®è¨­å®šå¤‰æ›´ã‚’ç›£è¦–ã—ã¦å®Ÿè¡Œï¼ˆã‚¢ãƒ—ãƒªèµ·å‹•ä¸­ã«ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸå ´åˆç”¨ï¼‰
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateStatusBarStyle);
        }
    </script>
    
    <script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          gray: {
            // ã“ã“ã§è‰²ã‚’ä¸Šæ›¸ãã—ã¾ã™
            800: '#1A1A1D', // ãƒªã‚¹ãƒˆãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ã‚¿ãƒ–ãƒãƒ¼ã®è‰²
            900: '#000000', // å…¨ä½“ã®èƒŒæ™¯è‰²
          }
        }
      }
    }
  }
</script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* â–¼â–¼â–¼ è¿½åŠ : LINE Seed JP ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ â–¼â–¼â–¼ */
        @font-face {
            font-family: 'LINE Seed JP';
            src: url('LINESeedJP_OTF_Rg.woff2') format('woff2'); /* ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆã‚ã›ã‚‹ */
            font-weight: 400; /* é€šå¸¸ */
            font-style: normal;
        }
        @font-face {
            font-family: 'LINE Seed JP';
            src: url('LINESeedJP_OTF_Bd.woff2') format('woff2'); /* ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆã‚ã›ã‚‹ */
            font-weight: 700; /* å¤ªå­— */
            font-style: normal;
        }
        /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

        :root {
            --primary-color: #4f46e5;
            --primary-color-hover: #4338ca;
        }
        /* â–¼â–¼â–¼ ä¿®æ­£: font-family ã®å…ˆé ­ã« 'LINE Seed JP' ã‚’è¿½åŠ  â–¼â–¼â–¼ */
        body { 
            font-family: 'LINE Seed JP', 'Inter', 'Noto Sans JP', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        .page { display: none; }
        .page.active { display: block; }
        #focus-page.page.active { display: flex; }
        #focus-page { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn {
            animation: fadeIn 0.8s ease-out forwards;
        }
        #loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .primary-bg { background-color: var(--primary-color); }
        
        .primary-text { color: var(--primary-color); }
        .toggle-checkbox { appearance: none; width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; transition: background .3s; }
        .toggle-checkbox:before { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform .3s; }
        .toggle-checkbox:checked { background: var(--primary-color); }
        .toggle-checkbox:checked:before { transform: translateX(20px); }
        #theme-purchase-modal, #background-purchase-modal { z-index: 60; }

        /* ãƒŸãƒ‹ã‚¿ã‚¤ãƒãƒ¼ */
        #mini-timer-container {
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s;
            transform: translateY(150%);
            opacity: 0;
            pointer-events: none;
        }
        #mini-timer-container.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #mini-timer-container.visible #mini-timer-bar {
            pointer-events: auto !important;
        }
        #mini-timer-progress-bar {
            transition: width 0.5s linear;
        }
        /* é›†ä¸­ãƒ¢ãƒ¼ãƒ‰èƒŒæ™¯ */
        .focus-view-bg {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }

        #app-container {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨è¨­å®š â–¼â–¼â–¼ */
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            will-change: transform;
            transform-origin: center left;
        }

        /* â–¼â–¼â–¼ è¿½åŠ : ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã®ãƒ¡ã‚¤ãƒ³ç”»é¢ã®çŠ¶æ…‹ â–¼â–¼â–¼ */
        #app-container.background-pushed {
            transform: translateX(-30%); /* å·¦ã«å°‘ã—ãšã‚Œã‚‹ */
        }
        
        /* â†“â†“â†“ æ—¢å­˜ã® .break-content-btn é–¢é€£ã‚’ã“ã‚Œã«ç½®ãæ›ãˆã¦ãã ã•ã„ â†“â†“â†“ */

.break-icon-grid-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4åˆ—è¡¨ç¤º */
    gap: 1.5rem 0.5rem; /* ç¸¦ã®é–“éš”ã‚’åºƒã’ã‚‹ */
    width: 100%;
    padding: 10px;
}

.break-content-btn {
    /* èƒŒæ™¯ã‚„æ ç·šã‚’å‰Šé™¤ã—ã¦é€æ˜ã« */
    background-color: transparent;
    border: none;
    color: #ffffff;
    
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    
    padding: 0;
    width: 100%;
    /* min-heightæŒ‡å®šã‚’å‰Šé™¤ã—ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãªã‚Šã«ã™ã‚‹ */
    transition: transform 0.2s;
}

.break-content-btn:hover {
    background-color: transparent; /* ãƒ›ãƒãƒ¼æ™‚ã‚‚èƒŒæ™¯ãªã— */
    transform: scale(1.05); /* å°‘ã—æ‹¡å¤§ */
    opacity: 0.8;
}

/* â†“â†“â†“ ã“ã®éƒ¨åˆ†ã‚’æ¢ã—ã¦ã€widthã¨heightã®æ•°å€¤ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ â†“â†“â†“ */
.break-app-icon {
    width: 72px;  /* ğŸ‘ˆ 60px ã‹ã‚‰ 72px ã«å¤‰æ›´ */
    height: 72px; /* ğŸ‘ˆ 60px ã‹ã‚‰ 72px ã«å¤‰æ›´ */
    border-radius: 16px; /* è§’ä¸¸ã‚‚å°‘ã—å¤§ãã */
    object-fit: cover;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    margin-bottom: 8px; /* æ–‡å­—ã¨ã®é–“éš”ã‚‚å°‘ã—åºƒã’ã‚‹ */
    background-color: #374151; /* ç”»åƒãŒãªã„æ™‚ã®èƒŒæ™¯è‰² (ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼) */
    
    /* æŸ”è»Ÿãªé…ç½®ã®ãŸã‚ */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
}

.break-content-btn span {
    font-size: 0.7rem; /* æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
    font-weight: 500;
    line-height: 1.1;
    text-align: center;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5); /* è¦–èªæ€§å‘ä¸Šã®å½± */
    
    /* 2è¡Œã¾ã§è¡¨ç¤ºã—ã¦æº¢ã‚ŒãŸã‚‰...ã«ã™ã‚‹è¨­å®š */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    width: 100%;
}
/* â†‘â†‘â†‘ ä¿®æ­£ã“ã“ã¾ã§ â†‘â†‘â†‘ */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e2e8f0; /* light gray */
        }
        .dark .sortable-ghost {
            background-color: #374151; /* dark gray */
        }
        .task-item .task-text-input {
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .task-item:hover .task-text-input {
            background-color: rgba(0,0,0,0.03);
        }
        .dark .task-item:hover .task-text-input {
            background-color: rgba(255,255,255,0.05);
        }
        /* ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ã‚¤ãƒ†ãƒ  */
        .break-settings-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            text-align: center;
            /* èƒŒæ™¯è‰²ã‚„æ ç·šã‚’å‰Šé™¤ */
            background-color: transparent !important;
            border: none !important;
            padding: 0 !important;
        }
        .break-settings-handle {
            cursor: move; /* "cursor-move" */
            margin-right: 0.75rem; /* mr-3 */
            color: #9ca3af; /* text-gray-400 */
        }
        .break-settings-item span {
            font-size: 0.7rem;
            font-weight: 500;
            line-height: 1.1;
            text-align: center;
            width: 100%;
            margin-top: 4px; /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ã®é–“éš” */
            
            /* 2è¡Œåˆ¶é™ */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            
            color: #4b5563; /* text-gray-600 */
        }
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®æ–‡å­—è‰² */
        html.dark .break-settings-item span {
            color: #d1d5db; /* text-gray-300 */
        }
        /* ç©ºã®ãƒªã‚¹ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹CSSãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ */
        /* HTMLè¦ç´ ã‚’ç½®ã‹ãšã«CSSã§æ–‡å­—ã‚’å‡ºã™ã“ã¨ã§ã€ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã‚’é˜»å®³ã—ã¾ã›ã‚“ */
        #break-active-list:empty::after {
            content: 'ã“ã“ã¸ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¿½åŠ ';
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            grid-column: 1 / -1; /* å…¨åˆ—ã‚’ä½¿ã† */
            color: #9ca3af;
            font-size: 0.75rem;
            pointer-events: none;
        }
        
        #break-inactive-list:empty::after {
            content: 'ã™ã¹ã¦è¿½åŠ æ¸ˆã¿ã§ã™';
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            grid-column: 1 / -1;
            color: #9ca3af;
            font-size: 0.75rem;
            pointer-events: none;
        }
        
        /* å‰Šé™¤ãƒ»è¿½åŠ ãƒœã‚¿ãƒ³ã®ä½ç½®èª¿æ•´ */
        .action-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid #ffffff;
        }
        html.dark .action-badge {
            border-color: #1f2937;
        }
        /* 1. ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç¦æ­¢ */
        body {
            -webkit-user-select: none; /* Safari/Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE */
            user-select: none;         /* æ¨™æº– */
        }
        
        /* 2. input ã‚„ textarea ã¯é¸æŠã§ãã‚‹ã‚ˆã†ã«è¨±å¯ã™ã‚‹ï¼ˆã‚³ãƒ”ãƒšãªã©ã«å¿…è¦ï¼‰ */
        input, 
        textarea {
            -webkit-user-select: text; /* Safari/Chrome */
            -moz-user-select: text;    /* Firefox */
            -ms-user-select: text;     /* IE */
            user-select: text;         /* æ¨™æº– */
        }

        /* â–¼â–¼â–¼ è¿½åŠ : iOSã®æ—¥ä»˜å…¥åŠ›ã¯ã¿å‡ºã—å¯¾ç­– â–¼â–¼â–¼ */
        input[type="date"] {
            /* iOSç‹¬è‡ªã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ */
            -webkit-appearance: none;
            appearance: none;
            /* è¦ªè¦ç´ ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«æœ€å¤§å¹…ã‚’åˆ¶é™ */
            max-width: 100%;
            /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå°ã•ããªã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆFlexboxå¯¾ç­–ï¼‰ */
            min-width: 0;
            /* ãƒœãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºã®è¨ˆç®—ã‚’ç¢ºå®Ÿã«ã™ã‚‹ */
            box-sizing: border-box;
            /* èƒŒæ™¯è‰²ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«ã™ã‚‹ */
            background-color: inherit; 
        }
        /* 3. ç”»åƒã‚„SVGã‚¢ã‚¤ã‚³ãƒ³ã®å®Œå…¨ä¿è­·ï¼ˆä¿å­˜ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ãƒ»å³ã‚¯ãƒªãƒƒã‚¯ç¦æ­¢ï¼‰ */
        img, svg {
            -webkit-touch-callout: none; /* iOSé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹ */
            -webkit-user-drag: none;     /* ãƒ‰ãƒ©ãƒƒã‚°ç„¡åŠ¹ (Chrome/Safari) */
            -moz-user-drag: none;        /* ãƒ‰ãƒ©ãƒƒã‚°ç„¡åŠ¹ (Firefox) */
            user-select: none;           /* é¸æŠç„¡åŠ¹ */
            pointer-events: none;        /* â˜…é‡è¦: ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šè‡ªä½“ã‚’ç„¡åŠ¹åŒ–ï¼ˆè¦ªã®ãƒœã‚¿ãƒ³ç­‰ã¯åå¿œã—ã¾ã™ï¼‰ */
        }
        /* --- ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ç”¨CSS --- */
        .swipe-container {
            position: relative;
            overflow: hidden; /* ã¯ã¿å‡ºã—ãŸãƒœã‚¿ãƒ³ã‚’éš ã™ */
            touch-action: pan-y; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è¨±å¯ã—ã¤ã¤ã€æ¨ªæ“ä½œã‚’JSã§åˆ¶å¾¡ */
        }
        
        /* ãƒœã‚¿ãƒ³ãŒé…ç½®ã•ã‚Œã‚‹èƒŒæ™¯å±¤ */
        .swipe-actions {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            display: flex;
            height: 100%;
            z-index: 1; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ */
        }
        
        .swipe-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            height: 100%;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å±¤ï¼ˆæŒ‡ã§å‹•ã‹ã™éƒ¨åˆ†ï¼‰ */
        .swipe-content {
            position: relative;
            z-index: 10;
            background-color: inherit; /* è¦ªã®è‰²ã‚’å¼•ãç¶™ã */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* é›¢ã—ãŸæ™‚ã®ã‚¹ãƒŠãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            will-change: transform; /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚‹ï¼ˆè¿½å¾“æ€§ã‚’è‰¯ãã™ã‚‹ãŸã‚ï¼‰ */
        .is-dragging .swipe-content {
            transition: none;
        }
        
        /* å‰Šé™¤æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .swipe-deleting {
            transition: height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            opacity: 0;
            margin: 0 !important;
            overflow: hidden;
        }
        /* ä¸¦ã³æ›¿ãˆãƒãƒ³ãƒ‰ãƒ«å‘¨è¾ºã®ã‚¿ãƒƒãƒæ“ä½œã‚’ç¢ºå®Ÿã«ã™ã‚‹ */
        .task-handle, .quest-handle, .break-settings-handle {
            cursor: grab;
            touch-action: none; /* ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’ç„¡åŠ¹åŒ–ã—ã€JSã§åˆ¶å¾¡ã—ã‚„ã™ãã™ã‚‹ */
            padding: 10px; /* ã‚¿ãƒƒãƒ—åˆ¤å®šã‚’å¤§ããã™ã‚‹ */
            margin: -5px; /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢ */
        }
        
        /* INPUTã‚¿ã‚°ã¯ã‚¹ãƒ¯ã‚¤ãƒ—å¯¾è±¡å¤–ã¨ã—ã¦ã€æ–‡å­—é¸æŠã‚„ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•ã‚’å„ªå…ˆã•ã›ã‚‹ */
        input[type="text"], input[type="number"] {
            touch-action: manipulation; /* ã‚¹ãƒ¯ã‚¤ãƒ—ã‚„ã‚ºãƒ¼ãƒ ä»¥å¤–ã®æ¨™æº–å‹•ä½œ */
        }
        /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã‚„ã€å‰Šé™¤ãƒœã‚¿ãƒ³ãŒå‡ºã¦ã„ã‚‹æ™‚ã¯ã€ãƒãƒ³ãƒ‰ãƒ«ã‚’æ“ä½œä¸èƒ½ã«ã™ã‚‹ï¼ˆã“ã‚Œã§ä¸¦ã³æ›¿ãˆæš´ç™ºã‚’é˜²ãï¼‰ */
        .swipe-container.is-swiping .task-handle,
        .swipe-container.is-swiping .quest-handle,
        .swipe-container.is-swiping .break-settings-handle,
        .swipe-container.swiped-open .task-handle,
        .swipe-container.swiped-open .quest-handle,
        .swipe-container.swiped-open .break-settings-handle {
            pointer-events: none; /* ã‚¿ãƒƒãƒ—ä¸å¯ã«ã™ã‚‹ */
            opacity: 0.2; /* è¦–è¦šçš„ã«ã‚‚ç„¡åŠ¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
        }
        /* æ—¢å­˜ã® #iframe-overlay ã‚’ä¿®æ­£ï¼ˆflexã§ä¸­å¤®æƒãˆã§ãã‚‹ã‚ˆã†ã«ï¼‰ */
        #iframe-overlay {
            /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ç¶­æŒã—ã¤ã¤ã€loaderã®é…ç½®ç”¨ã«relativeç­‰ã‚’èª¿æ•´ */
            z-index: 220; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šä¸Šã«æ¥ã‚‹ã‚ˆã†ã«èª¿æ•´ */
        }
        
        /* iframeå†…ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆä¸­å¤®é…ç½®ï¼‰ */
        #iframe-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1; /* iframeãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰éš ã‚Œã‚‹ã‚ˆã†ã«å¾Œã‚ã¸ã€ã‚ã‚‹ã„ã¯JSã§åˆ¶å¾¡ */
        }
        
        /* ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
        .preview-carousel {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden; 
            touch-action: pan-x;
            scroll-snap-type: x mandatory; /* ã‚¹ãƒŠãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            -webkit-overflow-scrolling: touch;
            gap: 1rem;
            padding: 0 1.5rem; /* ä¸¡ç«¯ã«ä½™ç™½ã‚’è¿½åŠ  */
            margin-bottom: 1rem;
            width: 100%;
            /* â–¼â–¼â–¼ ä¿®æ­£: é«˜ã•ã‚’å¤§ããã™ã‚‹ï¼ˆç¸¦é•·ç”»åƒç”¨ï¼‰ â–¼â–¼â–¼ */
            height: 550px; /* å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ */
            align-items: center; /* ä¸Šä¸‹ä¸­å¤®æƒãˆ */
        }
        
        .preview-item {
            /* â–¼â–¼â–¼ ä¿®æ­£: å¹…ã‚’100%ã‹ã‚‰å›ºå®šå¹…ã«å¤‰æ›´ï¼ˆã“ã‚Œã§æ¨ªä¸¦ã³ã«ãªã‚Šã¾ã™ï¼‰ â–¼â–¼â–¼ */
            flex: 0 0 280px; /* 1æšã®å¹…ã‚’280pxã«å›ºå®šï¼ˆæ¬¡ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰ */
            width: 280px;
            
            /* é«˜ã•ã‚’è¦ªè¦ç´ ã„ã£ã±ã„ã«ã™ã‚‹ */
            height: 100%;
            scroll-snap-align: center;
            
            border-radius: 1rem; /* è§’ä¸¸ã‚’å¤§ãã */
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* å½±ã‚’ã¤ã‘ã¦æµ®ãå‡ºã•ã›ã‚‹ */
        }
        
        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦åã‚ã‚‹ */
        }
        .preview-item img {
            pointer-events: none;       /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é˜²æ­¢ï¼‰ */
            -webkit-user-drag: none;    /* ãƒ‰ãƒ©ãƒƒã‚°ç¦æ­¢ */
            user-select: none;          /* é¸æŠç¦æ­¢ */
        }
                
        /* è©¦è´ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .playing-icon {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .focus-theme-border:focus {
            border-color: var(--primary-color) !important;
        }  
        
        /* ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ */
        main {
            position: relative;
            overflow-x: hidden; /* æ¨ªæºã‚Œé˜²æ­¢ */
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© (å¤‰åŒ–é‡ã‚’å°ã•ãã—ã¦ä¸Šå“ã«) */
        @keyframes appZoomIn {
            0% { opacity: 0; transform: scale(0.98); } /* 0.92 -> 0.98 ã«å¤‰æ›´ */
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes appZoomOut {
            0% { opacity: 0; transform: scale(1); }
            100% { opacity: 0; transform: scale(1); } /* 1.05 -> 1.02 ã«å¤‰æ›´ */
        }

        /* â–¼â–¼â–¼ è¿½åŠ : æ´—ç·´ã•ã‚ŒãŸã€Œãµã‚ã£ã€ã¨å‡ºã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼ */
        @keyframes slideUpFade {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.98); /* å°‘ã—ä¸‹ã§å°‘ã—å°ã•ã„ */
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1); /* å®šä½ç½®ã§ç­‰å€ */
            }
        }

        .animate-enter-active {
            /* ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°(å‹•ãã®ç·©æ€¥)ã‚’èª¿æ•´ã—ã¦ã€Œé«˜ç´šæ„Ÿã€ã‚’å‡ºã™ */
            animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* â–¼â–¼â–¼ è¿½åŠ : ç”»é¢å…¨ä½“ç”¨ã®æ´—ç·´ã•ã‚ŒãŸå‡ºç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼ */
        @keyframes screenZoomFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.92); /* å°‘ã—ç¸®ã‚“ã çŠ¶æ…‹ã‹ã‚‰ */
            }
            100% {
                opacity: 1;
                transform: scale(1);    /* å…ƒã®ã‚µã‚¤ã‚ºã¸ */
            }
        }

        .animate-screen-enter {
            /* ç”»é¢å…¨ä½“ç”¨ãªã®ã§ã€å°‘ã—ã‚†ã£ãã‚Šã‚ã§é«˜ç´šæ„Ÿã‚’å‡ºã™ */
            animation: screenZoomFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* æ–°ã—ãå…¥ã£ã¦ãã‚‹ãƒšãƒ¼ã‚¸ */
        .page-enter {
            display: block !important;
            animation: appZoomIn 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; /* æ™‚é–“ã‚’å°‘ã—çŸ­ç¸® */
            z-index: 20;
            will-change: transform, opacity; /* ã€é‡è¦ã€‘æç”»æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ */
            transform-origin: top center;
        }
        #focus-page.page-enter {
            display: flex !important;
        }

        /* æ¶ˆãˆã¦ã„ããƒšãƒ¼ã‚¸ */
        .page-exit {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            animation: appZoomOut 0.25s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            z-index: 10;
            pointer-events: none;
            will-change: transform, opacity; /* ã€é‡è¦ã€‘æç”»æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ */
            height: 0 !important;
            overflow: hidden !important;
        }
        #focus-page.page-exit {
            display: flex !important;
            height: 0 !important;  /* â† ã“ã‚Œã‚’è¿½åŠ  */
            overflow: hidden !important;  /* â† ã“ã‚Œã‚’è¿½åŠ  */
        }        
        /* --- ã‚¿ãƒ–ãƒãƒ¼ã®å³æ ¼ãªè‰²æŒ‡å®š (é»’è‰²åŒ–é˜²æ­¢) --- */
        
        /* 1. åŸºæœ¬ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ (æœªé¸æŠæ™‚) */
        /* Tailwindã®ã‚¯ãƒ©ã‚¹ã«ä¾å­˜ã›ãšã€CSSã§å¼·åˆ¶çš„ã«ã‚°ãƒ¬ãƒ¼ã«ã™ã‚‹ */
        #bottom-nav .tab-btn {
            color: #9ca3af !important; /* text-gray-400 ã¨åŒã˜è‰² */
            transition: color 0.2s ease; /* è‰²ã®å¤‰ã‚ã‚Šç›®ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ */
        }

        /* 2. é¸æŠä¸­ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ */
        /* active-tab ã‚¯ãƒ©ã‚¹ãŒã¤ã„ãŸç¬é–“ã€ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«ä¸Šæ›¸ãã™ã‚‹ */
        #bottom-nav .tab-btn.active-tab {
            color: var(--primary-color) !important;
        }

        /* 3. çœŸã‚“ä¸­ã®é›†ä¸­ãƒœã‚¿ãƒ³ (ä¾‹å¤–) */
        /* ä½•ãŒã‚ã£ã¦ã‚‚å¸¸ã«ç™½æ–‡å­— */
        #bottom-nav .center-fab,
        #bottom-nav .center-fab.active-tab {
            color: #ffffff !important;
        }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­èº«ï¼ˆSVGï¼‰ã‚‚è¦ªã®è‰²ã‚’ç¶™æ‰¿ã•ã›ã‚‹ */
        #bottom-nav .tab-btn svg {
            stroke: currentColor;
        }
        /* --- çœŸã‚“ä¸­ã®å¼·èª¿ãƒœã‚¿ãƒ³ (ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç‰ˆ) --- */
.center-fab {
    position: absolute;
    left: 50%;
    /* ä½ç½®ã‚’ä¸‹ã’ã‚‹: å…ƒã® -24px ã‹ã‚‰ -12px ã«å¤‰æ›´ (1/10ç¨‹åº¦é£›ã³å‡ºã™è¨­å®š) */
    top: -12px; 
    transform: translateX(-50%);
    
    /* ã‚µã‚¤ã‚ºè¨­å®š */
    width: 64px;
    height: 64px;
    border-radius: 50%;
    
    /* ã‚¢ã‚¤ã‚³ãƒ³ã¨æ–‡å­—ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹è¨­å®š */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    
    gap: 3px; 
    
    color: #ffffff !important;
    
    border: none !important; 
    /* â˜…ã“ã“ã‚’å¤‰æ›´: å½±ã‚’ãªã—ã«ã™ã‚‹ */
    box-shadow: none !important;
    
    z-index: 60;
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    
    outline: none;
    -webkit-tap-highlight-color: transparent;
}

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®æ ç·šè¨­å®šã‚‚ä¸è¦ãªã®ã§å‰Šé™¤ã¾ãŸã¯ä¸Šæ›¸ã */
html.dark .center-fab {
    border: none !important;
}

/* æŠ¼ã—ãŸæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.center-fab:active {
    transform: translateX(-50%) scale(0.95);
}

/* --- ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã®å¼·åˆ¶é…ç½®ç”¨ --- */
.force-bottom {
    bottom: 0 !important;
    padding-bottom: 1.5rem !important; /* ç”»é¢ç«¯ã™ããªã„ã‚ˆã†ã«å°‘ã—ä½™ç™½ */
    z-index: 50;
}
        
        /* å›ºå®šé…ç½®ã®è¦ç´ ã‚’ã€ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢åˆ†ã ã‘ä¸Šã«æŠ¼ã—ä¸Šã’ã‚‹ */
        /* calc() ã‚’ä½¿ã£ã¦ã€Œå…ƒã®ä½ç½® + ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢ã€ã‚’è¨ˆç®— */
        .bottom-safe-20 {
            bottom: 6rem; /* ãƒŸãƒ‹ã‚¿ã‚¤ãƒãƒ¼ã®ä½ç½® */
        }
        .bottom-safe-16 {
            bottom: 4rem; /* ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã®ä½ç½® */
        }
        .header-safe {
            padding-top: env(safe-area-inset-top, 0px);
            /* é«˜ã•ã‚’ 56px(3.5rem) + å®‰å…¨é ˜åŸŸ ã«å®Œå…¨å›ºå®š */
            height: calc(3.5rem + env(safe-area-inset-top, 0px));
            box-sizing: border-box;
            
            /* Flexboxè¨­å®š */
            display: flex;
            align-items: center;
            justify-content: space-between;
            
            /* â˜…é‡è¦: ã“ã‚Œã§çµ¶å¯¾ã«æ½°ã‚Œãªããªã‚Šã¾ã™ */
            flex-shrink: 0;
            width: 100%;
            z-index: 30;
        }
        /* --- ç”»é¢é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (iOSé¢¨) --- */
        .screen-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f3f4f6; /* light bg */
            z-index: 100; /* æœ€å‰é¢ */
            transform: translateX(100%); /* åˆæœŸçŠ¶æ…‹ã¯å³å¤–å´ */
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1); /* iOSé¢¨ã®ã‚¤ãƒ¼ã‚¸ãƒ³ã‚° */
            will-change: transform;
            display: flex;
            flex-direction: column;
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        html.dark .screen-layer {
            background-color: #000000; /* dark bg */
        }
        
        /* ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹æ™‚ã®ã‚¯ãƒ©ã‚¹ */
        .screen-layer.active {
            transform: translateX(0);
            box-shadow: -10px 0 25px rgba(0,0,0,0.1); /* å·¦å´ã«å½±ã‚’è½ã¨ã™ */
        }
        
        /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã®å½± */
        .screen-layer.is-swiping {
            transition: none; /* æŒ‡ã«è¿½å¾“ã•ã›ã‚‹ãŸã‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚‹ */
            box-shadow: -10px 0 25px rgba(0,0,0,0.1);
        }
        /* â–¼â–¼â–¼ è¿½åŠ : LPç²å¾—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼ */
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒå¼¾ã‚€ã‚ˆã†ã«å‡ºç¾ */
        @keyframes popInElastic {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            70% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* ã‚³ã‚¤ãƒ³ãŒæµ®éŠã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes coinFloat {
            0%, 100% { transform: translateY(0) rotateY(0deg); }
            50% { transform: translateY(-10px) rotateY(10deg); }
        }

        /* å¾Œã‚ã®å…‰ãŒå›è»¢ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes sunburstRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-pop-elastic {
            animation: popInElastic 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã¯ç«¶åˆã‚’é˜²ããŸã‚ã«transitionã‚’åˆ‡ã‚‹ â–¼â–¼â–¼ */
            transition: none !important;
        }

        .animate-coin-float {
            animation: coinFloat 3s ease-in-out infinite;
        }

        /* å¾Œå…‰ï¼ˆã‚µãƒ³ãƒãƒ¼ã‚¹ãƒˆï¼‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ - ã‚µã‚¤ã‚ºæ‹¡å¤§ãƒ»è–„è‰²åŒ–ç‰ˆ */
        .sunburst {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1200px;
            height: 1200px;
            margin-left: -600px; /* widthã®åŠåˆ† */
            margin-top: -600px;  /* heightã®åŠåˆ† */
            
            background: repeating-conic-gradient(
                from 0deg,
                rgba(255, 215, 0, 0.08) 0deg 20deg,
                transparent 20deg 40deg
            );
            border-radius: 50%;
            animation: sunburstRotate 30s linear infinite; /* å°‘ã—ã‚†ã£ãã‚Šå›ã™ã‚ˆã†ã«å¤‰æ›´(ä»»æ„) */
            z-index: -1;
            pointer-events: none;
        }
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…‰ã‚ˆã‚Šå‰ã«å‡ºã™ãŸã‚ã®è¨­å®š */
        .popup-content-layer {
            position: relative;
            z-index: 10;
        }
        
        /* æ•°å­—ãŒã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ™‚ç”¨ã®ã‚¯ãƒ©ã‚¹ï¼ˆJSåˆ¶å¾¡ç”¨ï¼‰ */
        .lp-amount-text {
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #fbbf24, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* â–¼â–¼â–¼ è¿½åŠ : iOSãƒãƒƒãƒå¯¾ç­– â–¼â–¼â–¼ */

        /* 1. é€šçŸ¥ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆï¼‰ã®ä½ç½®ä¿®æ­£ */
        #toast {
            /* top-5 (1.25rem) ã‚’ä¸Šæ›¸ãã—ã€ãƒãƒƒãƒã®é«˜ã• + ä½™è£•ã‚’æŒãŸã›ã‚‹ */
            top: calc(env(safe-area-inset-top, 20px) + 1rem) !important;
        }

        /* 2. ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ä¿®æ­£ */
        #quiz-modal header {
            /* ä¸Šéƒ¨ã«ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢åˆ†ã®ä½™ç™½ã‚’è¿½åŠ  + å…ƒã®p-3(0.75rem) */
            padding-top: calc(env(safe-area-inset-top, 20px) + 0.75rem);
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’ç¢ºä¿ */
            height: auto;
            /* ä¸‹éƒ¨ã®ä½™ç™½ã¯ç¶­æŒ */
            padding-bottom: 0.75rem;
        }

        /* 1. ã‚¿ã‚¤ãƒãƒ¼/ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®åˆ‡ã‚Šæ›¿ãˆã‚°ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .toggle-container {
            position: relative;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.25rem; /* p-1 */
            display: flex;
            cursor: pointer;
            z-index: 0;
        }
        .dark .toggle-container {
            background-color: #374151; /* gray-700 */
        }
        
        /* å‹•ãèƒŒæ™¯ (ã‚°ãƒ©ã‚¤ãƒ€ãƒ¼) */
        .toggle-glider {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            height: calc(100% - 0.5rem);
            width: calc(50% - 0.25rem);
            background-color: var(--primary-color); /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ */
            border-radius: 0.375rem; /* rounded-md */
            z-index: 1;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); /* ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹• */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .focus-mode-btn {
            position: relative;
            z-index: 2; /* ã‚°ãƒ©ã‚¤ãƒ€ãƒ¼ã‚ˆã‚Šä¸Š */
            flex: 1;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            border-radius: 0.375rem;
            transition: color 0.3s;
            color: #6b7280; /* text-gray-500 (éé¸æŠæ™‚) */
        }
        .dark .focus-mode-btn {
            color: #9ca3af; /* text-gray-400 */
        }
        
        /* é¸æŠä¸­ã®æ–‡å­—è‰² */
        .focus-mode-btn.active {
            color: white !important;
        }

        /* 2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        
        /* æœˆç§»å‹•æ™‚ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .calendar-slide-next {
            animation: slideInRight 0.3s ease-out forwards;
        }
        .calendar-slide-prev {
            animation: slideInLeft 0.3s ease-out forwards;
        }

        /* æ—¥ä»˜é¸æŠæ™‚ã®ãƒãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes popDate {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .date-pop-anim {
            animation: popDate 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        /* â–¼â–¼â–¼ è¿½åŠ : ç”»é¢åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼ */
        @keyframes viewFadeIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .view-fade-enter {
            /* 0.3ç§’ã‹ã‘ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
            animation: viewFadeIn 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }
        /* --- è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆãƒªã‚¹ãƒˆã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆç”¨ --- */
        .quest-item-view {
            cursor: text;
            width: 100%;
            min-height: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .quest-item-input {
            width: 100%;
            font-size: 1rem; /* 16px (æ–‡å­—ã‚µã‚¤ã‚ºç¸®å°) */
            background: transparent;
            outline: none;
            border-bottom: 2px solid var(--primary-color);
        }
        
        /* â–¼â–¼â–¼ ä¿®æ­£: å½±è¦‹åˆ‡ã‚Œé˜²æ­¢ & ä½™ç™½çŸ­ç¸®ç‰ˆ â–¼â–¼â–¼ */
        .banner-wrapper {
            /* PCå¯¾å¿œã®å¹…è¨­å®š */
            width: calc(100% + 2rem);
            margin-left: -1rem;
            margin-right: -1rem;
            
            overflow: hidden;
            padding-bottom: 0; /* â˜…å¤‰æ›´: ã“ã“ã®ä½™ç™½ã‚’å‰Šé™¤ï¼ˆé–“éš”ã‚’è©°ã‚ã‚‹ãŸã‚ï¼‰ */
        }

        .banner-carousel {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden; /* ã“ã“ã§å½±ãŒåˆ‡ã‚Œã¦ã„ãŸ */
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            
            /* â˜…å¤‰æ›´: ä¸‹ã«20pxã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¦å½±ã‚’è¡¨ç¤ºã•ã›ã‚‹ */
            /* ä¸Š0, å³4.5%, ä¸‹20px, å·¦4.5% */
            padding: 0 4.5% 20px 4.5%; 
            
            gap: 12px;
            width: 100%;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        /* â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² */
        .banner-carousel::-webkit-scrollbar { display: none; }

        .banner-item {
            /* â–¼ å¤‰æ›´: ç”»åƒã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹ (85% â†’ 92%) */
            flex: 0 0 92%; 
            
            /* æ¯”ç‡ã¯ 3/2 ã®ã¾ã¾ã ã¨ã‹ãªã‚Šç¸¦é•·ã§å¤§ããè¦‹ãˆã¾ã™ã€‚
               å°‘ã—ã‚¹ãƒƒã‚­ãƒªã•ã›ãŸã„å ´åˆã¯ 16 / 9 ã«å¤‰æ›´ã—ã¦ãã ã•ã„ */
            aspect-ratio: 3 / 2;
            
            scroll-snap-align: center;
            border-radius: 20px;
            overflow: visible;
            position: relative;
            
            /* å½±ã‚’èª¿æ•´ */
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.25);
            
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
        }
        /* â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² */
        
        /* ç”»åƒè‡ªä½“ã®è§’ä¸¸ã¯ã“ã“ã§åˆ¶å¾¡ */
        .banner-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px; /* è¦ªã®overflow:visibleå¯¾ç­–ã§imgã«è§’ä¸¸ã‚’ã¤ã‘ã‚‹ */
            pointer-events: none;
            user-select: none;
        }
        /* â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² */
        /* â–¼â–¼â–¼ ä¿®æ­£ç‰ˆv3: ç¸¦é•·ç”»åƒå¯¾å¿œãƒ»ã‚µã‚¤ã‚ºæœ€å¤§åŒ– â–¼â–¼â–¼ */
        .welcome-slideshow {
            position: relative;
            
            /* æ¨ªå¹…ã¯ã„ã£ã±ã„ã¾ã§ä½¿ã† */
            width: 100%;
            
            /* â˜…ã“ã“ãŒé‡è¦: æ­£æ–¹å½¢å›ºå®šã‚’ã‚„ã‚ã€ç”»é¢é«˜ã•ã®ç´„åŠåˆ†(55%)ã‚’ä½¿ã†è¨­å®šã«å¤‰æ›´ */
            /* ã“ã‚Œã«ã‚ˆã‚Šç¸¦é•·ã®ç”»åƒã‚‚ç¸®å°ã•ã‚Œãšã€ç¸¦ã«å¤§ããè¡¨ç¤ºã•ã‚Œã¾ã™ */
            height: 55vh; 
            
            /* PCãªã©ã§å·¨å¤§ã«ãªã‚Šã™ããªã„ãŸã‚ã®ãƒªãƒŸãƒƒã‚¿ãƒ¼ */
            max-width: 500px;
            max-height: 700px; 
            
            /* ä¸­å¤®æƒãˆã¨ä½™ç™½ */
            margin: 1rem auto 4rem auto;
            
            flex-shrink: 0; 
        }

        .welcome-slide-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* æ ã«åˆã‚ã›ã¦æœ€å¤§ã‚µã‚¤ã‚ºã§è¡¨ç¤º */
            object-fit: contain;
            object-position: center;
            
            opacity: 0;
            animation: slideFadeLoop4 16s infinite;
        }

        /* --- ç”»åƒã”ã¨ã®å¾®èª¿æ•´ --- */
        
        /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨: ä½™ç™½ãªã— */
        .slide-tutorial {
            padding: 0; 
        }

        /* ãƒ­ã‚´ç”¨: ãƒ­ã‚´ã¯æ¨ªé•·ã‚„æ­£æ–¹å½¢ãŒå¤šã„ã®ã§ã€ç¸¦é•·æ ã®ä¸­ã§å°‘ã—ä½™ç™½ã‚’æŒãŸã›ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹ */
        .slide-logo {
            padding: 1rem; 
            box-sizing: border-box;
            padding-top: 6rem;
        }

        /* â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€: ç”»åƒã®é †ç•ªå¤‰æ›´ã«å¯¾å¿œã—ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶è¨­å®š â–¼â–¼â–¼ */
        
        /* 1æšç›®: Tutorial 1 (0ç§’ï½) */
        .welcome-slide-item:nth-child(1) { 
            animation-delay: 0s; 
        }
        
        /* 2æšç›®: Tutorial 2 (4ç§’ï½) */
        .welcome-slide-item:nth-child(2) { 
            animation-delay: 4s; 
        }

        /* 3æšç›®: Tutorial 3 (8ç§’ï½) */
        .welcome-slide-item:nth-child(3) { 
            animation-delay: 8s; 
        }

        /* 4æšç›® & 5æšç›®: ãƒ­ã‚´ (12ç§’ï½) */
        /* â€»ãƒ­ã‚´ã¯ãƒ©ã‚¤ãƒˆç”¨ã¨ãƒ€ãƒ¼ã‚¯ç”¨ã®2æšã‚ã‚‹ãŸã‚ã€ä¸¡æ–¹ã¨ã‚‚æœ€å¾Œã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«è¨­å®š */
        .welcome-slide-item:nth-child(4),
        .welcome-slide-item:nth-child(5) { 
            animation-delay: 12s; 
        }
        /* â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² */

        @keyframes slideFadeLoop4 {
            0% { opacity: 0; transform: scale(0.96); }
            4% { opacity: 1; transform: scale(1); }
            21% { opacity: 1; transform: scale(1.02); }
            25% { opacity: 0; transform: scale(1.05); }
            100% { opacity: 0; transform: scale(1.05); }
        }
        /* â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² */
        /* PWAèª˜å°ç”»é¢ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #pwa-install-prompt {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        /* iOSã®ã‚·ã‚§ã‚¢ã‚¢ã‚¤ã‚³ãƒ³ã®è¦‹ãŸç›®ã‚’èª¿æ•´ï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰ */
        .ios-share-icon {
            display: inline-block;
            vertical-align: middle;
            margin: 0 4px;
        }
        /* â–¼â–¼â–¼ è¿½åŠ : LPãƒãƒŠãƒ¼ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â–¼â–¼â–¼ */
        @keyframes shine {
            0% { left: -100%; opacity: 0; }
            50% { opacity: 0.5; }
            100% { left: 200%; opacity: 0; }
        }
        .animate-shine {
            animation: shine 3s infinite cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes gradient-xy {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .animate-gradient-xy {
            background-size: 200% 200%;
            animation: gradient-xy 6s ease infinite;
            
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¹ãƒãƒ›ã§ã®æç”»ãƒã‚°å¯¾ç­– â–¼â–¼â–¼ */
            will-change: background-position; /* ãƒ–ãƒ©ã‚¦ã‚¶ã«å¤‰åŒ–ã‚’äºˆå‘Š */
            transform: translate3d(0, 0, 0);  /* GPUã‚’ä½¿ç”¨ã•ã›ã‚‹ãŠã¾ã˜ãªã„ */
            -webkit-transform: translate3d(0, 0, 0);
            -webkit-backface-visibility: hidden; /* ãƒãƒ©ã¤ãé˜²æ­¢ */
            backface-visibility: hidden;
            perspective: 1000px;
        }
        /* å¤§è¦æ¨¡ãªè¦ç´ ï¼ˆãƒ‘ãƒãƒ«ãƒ»ã‚³ãƒ³ãƒ†ãƒŠï¼‰ç”¨: 24pxç¨‹åº¦ */
        .rounded-ios-lg {
            border-radius: 24px !important;
        }
        /* å°è¦æ¨¡ãªè¦ç´ ï¼ˆãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ãƒ»ã‚«ãƒ¼ãƒ‰ï¼‰ç”¨: 16pxç¨‹åº¦ (iOSã®æ¨™æº–çš„ãªãƒœã‚¿ãƒ³) */
        .rounded-ios-md {
            border-radius: 16px !important;
        }
/* â–¼â–¼â–¼ è¿½åŠ ãƒ»ä¿®æ­£ç”¨CSS â–¼â–¼â–¼ */

/* 1. å¤§ããªè§’ä¸¸ï¼ˆãƒªã‚¹ãƒˆã®å¤–æ ç”¨ï¼‰ */
.rounded-super {
    border-radius: 24px !important;
}

/* 2. ãƒ¢ãƒ€ãƒ³ãªå½±ï¼ˆãƒªã‚¹ãƒˆå…¨ä½“ç”¨ï¼‰ */
.shadow-modern {
    box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.08);
}
.dark .shadow-modern {
    box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
    border: none; /* æ ç·šã‚’ãªã—ã«ã™ã‚‹ */
}

/* 3. ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®å…¥åŠ›æ¬„èª¿æ•´ */
/* ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ ç·šã‚’æ¶ˆã—ã€é«˜ã•ã‚’ç¢ºä¿ */
#new-task-input {
    outline: none;
    box-shadow: none;
    min-width: 0; /* Flexboxã§ã®ç¸®å°å¯¾ç­– */
}

/* 4. ã‚¹ãƒ¯ã‚¤ãƒ—å‹•ä½œã®å®‰å®šåŒ– */
.swipe-container {
    touch-action: pan-y; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä»»ã›ã€æ¨ªã ã‘JSã§åˆ¶å¾¡ */
    transform: translateZ(0); /* GPUã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãƒãƒ©ã¤ãé˜²æ­¢ */
}

/* å®Œäº†ã‚¿ã‚¹ã‚¯ã§ã‚‚èƒŒæ™¯ãŒé€ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹ */
.task-item .swipe-content {
    /* å¸¸ã«ä¸é€æ˜ãªè‰²ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒé‡è¦ */
    /* JSå´ã§ bg-white / bg-gray-50 ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã‚‹ã®ã§ã“ã“ã¯åŸºæœ¬è¨­å®šã®ã¿ */
    will-change: transform;
}
        /* --- â–¼â–¼â–¼ è¿½åŠ : ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â–¼â–¼â–¼ */
.pb-safe {
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãŒã‚ã‚‹ç«¯æœ«ã§ã¯ãã®é«˜ã•åˆ†ã€ãªã„ç«¯æœ«ã§ã¯0pxã«ãªã‚Šã¾ã™ */
    padding-bottom: calc(env(safe-area-inset-bottom, 0px) - 10px) !important;
}

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹ä½™ç™½ã‚‚ã€ã‚¿ãƒ–ãƒãƒ¼ãŒç¸¦ã«ä¼¸ã³ã‚‹åˆ†ã ã‘å¢—ã‚„ã™ */
.pb-with-nav {
    /* å…ƒã®80px(pb-20) + ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢ */
    padding-bottom: calc(5rem + env(safe-area-inset-bottom, 0px)) !important;
}
        /* --- ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®šç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */

/* å‰Šé™¤æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes scaleOutFade {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0); opacity: 0; margin: 0; height: 0; padding: 0; }
}
.animate-scale-out {
    animation: scaleOutFade 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    pointer-events: none; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã¯æ“ä½œä¸å¯ */
}

/* è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ™‚ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
@keyframes fadeInList {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in-list {
    animation: fadeInList 0.3s ease-out forwards;
}

/* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦‹ãŸç›® (SortableJSç”¨) */
.sortable-drag {
    opacity: 0; /* å…ƒã®è¦ç´ ã¯éš ã™ */
}
.sortable-ghost {
    opacity: 0.4;
    transform: scale(0.95);
    filter: grayscale(100%);
}
/* ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã„ã‚‹æ‰‹å…ƒã®è¦ç´ ï¼ˆSortableJSãŒç”Ÿæˆã™ã‚‹ã‚¯ãƒ­ãƒ¼ãƒ³ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ã¯JSå´ã§åˆ¶å¾¡ã•ã‚Œã¾ã™ãŒã€
   è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ã—ã¦ä»¥ä¸‹ã‚’è¿½åŠ  */
.break-settings-item.sortable-chosen {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 16px;
}
        /* â–¼â–¼â–¼ ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ãƒ»å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ä¿®æ­£ (ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¨ãƒªã‚¢å¯¾ç­–) â–¼â–¼â–¼ */
#welcome-screen,
#ios-install-overlay,
#registration-screen {
    height: 100dvh; /* dvhã‚’ä½¿ã†ã“ã¨ã§ãƒ¢ãƒã‚¤ãƒ«ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼æŒ™å‹•ã«å¯¾å¿œ */
    padding-bottom: env(safe-area-inset-bottom, 20px); /* ä¸‹éƒ¨ã«å®‰å…¨é ˜åŸŸã‚’ç¢ºä¿ */
    padding-top: env(safe-area-inset-top, 20px);
    box-sizing: border-box;
}

/* ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã®ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºç”¨ */
.wizard-step-indicator {
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 24px;
}
.step-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #e5e7eb; /* gray-200 */
    transition: all 0.3s ease;
}
.dark .step-dot { background-color: #374151; }
.step-dot.active {
    background-color: var(--primary-color);
    width: 24px;
    border-radius: 4px;
}

/* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå­¦å¹´é¸æŠãƒœã‚¿ãƒ³ç”¨ï¼‰ */
.grade-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    width: 100%;
}
        /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å¼·åˆ¶é©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ */
.primary-border { border-color: var(--primary-color) !important; }
.primary-ring { --tw-ring-color: var(--primary-color) !important; }

/* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.step-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #e5e7eb; /* gray-200 */
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); /* ãªã‚ã‚‰ã‹ã« */
}
.dark .step-dot { background-color: #374151; }
.step-dot.active {
    background-color: var(--primary-color);
    width: 32px; /* å°‘ã—é•·ãã—ã¦é€²è¡Œæ„Ÿã‚’å‡ºã™ */
    border-radius: 10px;
}
        /* â–¼â–¼â–¼ è¿½åŠ : UIçµ±ä¸€ãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨CSS â–¼â–¼â–¼ */

/* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å¼·åˆ¶é©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ */
.primary-border { border-color: var(--primary-color) !important; }
.primary-ring { --tw-ring-color: var(--primary-color) !important; }

/* ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.step-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px; /* å®Œå…¨ãªå††/ã‚«ãƒ—ã‚»ãƒ« */
    background-color: #e5e7eb; /* gray-200 */
    transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    transform-origin: center;
}
.dark .step-dot { background-color: #374151; }
.step-dot.active {
    background-color: var(--primary-color);
    width: 32px; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã¯æ¨ªã«ä¼¸ã³ã‚‹ */
}

/* ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ç”»é¢é·ç§» (ã‚ˆã‚Šãƒªãƒƒãƒãªå‹•ã) */
.wizard-anim-next-enter { animation: wizardSlideInRight 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
.wizard-anim-next-exit { animation: wizardSlideOutLeft 0.4s cubic-bezier(0.4, 0, 1, 1) forwards; }
.wizard-anim-prev-enter { animation: wizardSlideInLeft 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
.wizard-anim-prev-exit { animation: wizardSlideOutRight 0.4s cubic-bezier(0.4, 0, 1, 1) forwards; }

@keyframes wizardSlideInRight {
    from { opacity: 0; transform: translateX(30px) scale(0.95); }
    to { opacity: 1; transform: translateX(0) scale(1); }
}
@keyframes wizardSlideOutLeft {
    from { opacity: 1; transform: translateX(0) scale(1); }
    to { opacity: 0; transform: translateX(-10px) scale(0.95); }
}
@keyframes wizardSlideInLeft {
    from { opacity: 0; transform: translateX(-30px) scale(0.95); }
    to { opacity: 1; transform: translateX(0) scale(1); }
}
@keyframes wizardSlideOutRight {
    from { opacity: 1; transform: translateX(0) scale(1); }
    to { opacity: 0; transform: translateX(10px) scale(0.95); }
}

/* ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ç­‰ã®çµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³ */
.input-modern {
    background-color: #fff;
    border: 2px solid transparent;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* shadow-moderné¢¨ */
    transition: all 0.2s;
}
.dark .input-modern {
    background-color: #1f2937;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
}
.input-modern:focus {
    border-color: var(--primary-color);
    outline: none;
    transform: scale(1.01);
}
        /* â–¼â–¼â–¼ è¿½åŠ : æ¨ªç”»é¢åˆ¶å¾¡ç”¨ã®CSS â–¼â–¼â–¼ */

/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯è­¦å‘Šã‚’éš ã™ */
#orientation-lock-overlay {
    display: none !important;
}

/* ç«¯æœ«ãŒã€Œæ¨ªå‘ãã€ã®å ´åˆã®ãƒ«ãƒ¼ãƒ« */
@media (orientation: landscape) {
    /* bodyã« 'is-quest-mode' ã‚¯ãƒ©ã‚¹ãŒç„¡ã„å ´åˆã®ã¿ã€è­¦å‘Šã‚’è¡¨ç¤ºã™ã‚‹ */
    body:not(.is-quest-mode) #orientation-lock-overlay {
        display: flex !important;
    }

    /* è­¦å‘ŠãŒå‡ºã¦ã„ã‚‹é–“ã¯ã€å¾Œã‚ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
    body:not(.is-quest-mode) {
        overflow: hidden !important;
    }
}
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */
        /* â–¼â–¼â–¼ è¿½åŠ : ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ–ãƒãƒ¼ã®å½±ã‚’å¼·åˆ¶çš„ã«å‰Šé™¤ â–¼â–¼â–¼ */
.header-safe,
#bottom-nav {
    box-shadow: none !important;
}
    </style>
</head>
<body class="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 overflow-hidden h-[100dvh] antialiased">
    <div id="splash-screen" class="fixed inset-0 z-[300] flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 transition-opacity duration-500">
        <img id="splash-logo-light" src="SQ_logo2.png" alt="StudyQuest Logo" class="w-64 h-64 mb-4 block dark:hidden">
        
        <img id="splash-logo-dark" src="SQ_logo3.png" alt="StudyQuest Logo Dark" class="w-64 h-64 mb-4 hidden dark:block">
    </div>

    <div id="app-container" class="h-full w-full flex flex-col max-w-lg mx-auto shadow-2xl bg-gray-100 dark:bg-black">
        
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm">
            <h1 id="header-title" class="text-lg font-bold text-gray-900 dark:text-white">ãƒ›ãƒ¼ãƒ </h1>
        </header>

        <main class="flex-grow overflow-y-auto pb-with-nav">
            <div id="home-page" class="page active p-4 space-y-6">
                <div class="banner-wrapper mb-2">
                    <div id="home-banner-carousel" class="banner-carousel">
                        </div>
                </div>
                
                <button id="home-lp-banner" class="w-full relative overflow-hidden rounded-super shadow-modern transform transition-all duration-300 hover:scale-[1.02] active:scale-95 group">
                    <div class="absolute inset-0 bg-gradient-to-r from-yellow-400 via-orange-500 to-yellow-500 animate-gradient-xy"></div>
                    <div class="absolute inset-0 bg-white/10 backdrop-blur-[1px]"></div>
                    
                    <div class="absolute top-0 -left-[100%] w-full h-full bg-gradient-to-r from-transparent via-white/40 to-transparent skew-x-[-25deg] animate-shine"></div>
            
                    <div class="relative z-10 p-5 flex items-center justify-between text-white">
                        <div class="flex items-center space-x-4">
                            <img src="coin.png" alt="Coin" class="w-14 h-14 object-contain drop-shadow-md">
                            <div class="text-left">
                                <p class="text-xs font-bold text-yellow-100 uppercase tracking-widest opacity-90">Learning Points</p>
                                <p class="text-3xl font-black tracking-tighter drop-shadow-sm flex items-baseline">
                                    <span id="home-lp-value" class="tabular-nums">0</span>
                                    <span class="text-sm ml-1 font-bold opacity-80">LP</span>
                                </p>
                            </div>
                        </div>
                        
                        <div class="bg-white/20 p-2 rounded-super backdrop-blur-sm hover:bg-white/30 transition-colors">
                            <i data-lucide="chevron-right" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                </button>

                 <div>
                    <h2 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</h2>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                        
                        <div id="home-task-list" class="divide-y divide-gray-100 dark:divide-gray-700">
                            <p class="text-center text-sm text-gray-400 py-6">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        </div>
                
                        <div class="flex items-center px-4 py-3 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700">
                            <div id="add-task-btn" class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-400 mr-3 cursor-pointer hover:opacity-80 transition-opacity">
                                <i data-lucide="plus" class="w-4 h-4 stroke-[2]"></i>
                            </div>
                            <input type="text" id="new-task-input" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ " class="flex-grow bg-transparent border-none outline-none text-sm font-bold text-gray-700 dark:text-gray-200 placeholder-gray-400 h-10">
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-2 ml-2 mr-1">
                        <h2 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</h2>
                        <button id="add-countdown-btn" class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-400"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="countdown-list" class="space-y-3"></div>
                </div>
                
                 
            </div>

            <div id="study-page" class="page p-4">
                <div class="mb-2">
                    <h2 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ãƒ”ãƒ³ç•™ã‚</h2>
                    <div id="pinned-quizzes" class="grid grid-cols-1 gap-3"></div>
                </div>
                <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ã™ã¹ã¦ã®ã‚¯ã‚¤ã‚º</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="filter-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="all-quizzes" class="grid grid-cols-1 gap-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div> Â  Â  Â  Â  Â  Â  
            <div id="focus-page" class="page relative flex flex-col h-full">
                
                <div id="focus-main-view" class="flex flex-col h-full p-4 space-y-4">
                    <div class="flex-shrink-0">
                        <button id="show-quest-btn" class="w-full py-4 px-6 rounded-full font-bold text-lg shadow-modern flex items-center justify-center space-x-2 bg-white dark:bg-gray-800 text-gray-800 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition-all active:scale-[0.98] border border-transparent dark:border-gray-700" data-mode="quest">
                            <i data-lucide="map" class="w-6 h-6 primary-text"></i>
                            <span>ã‚¯ã‚¨ã‚¹ãƒˆ</span>
                        </button>
                    </div>
            
                    <div class="flex-shrink-0">
                        <div class="toggle-container bg-gray-200 dark:bg-gray-800 rounded-full p-1.5 shadow-inner" id="focus-mode-toggle">
                            <div class="toggle-glider rounded-full shadow-sm" id="focus-mode-glider"></div>
                            <button class="focus-mode-btn active rounded-full py-2 z-10" data-mode="timer">ã‚¿ã‚¤ãƒãƒ¼</button>
                            <button class="focus-mode-btn rounded-full py-2 z-10" data-mode="stopwatch">ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</button>
                        </div>
                    </div>
            
                    <div id="timer-view" class="focus-view-bg flex-grow flex flex-col items-center justify-center text-center relative text-white rounded-super shadow-modern overflow-hidden border border-gray-200/20 dark:border-gray-700/50">
                        <div class="absolute inset-0 bg-black/50 dark:bg-black/70"></div>
                        <div class="relative z-10 p-6 w-full max-w-sm mx-auto">
                            
                            <div id="timer-settings-container" class="mb-8">
                                <div class="flex flex-wrap justify-center gap-3">
                                    <button class="time-add-btn bg-white/10 hover:bg-white/20 border border-white/10 px-4 py-2 rounded-xl text-sm font-bold backdrop-blur-md transition active:scale-95" data-time="60">+1åˆ†</button>
                                    <button class="time-add-btn bg-white/10 hover:bg-white/20 border border-white/10 px-4 py-2 rounded-xl text-sm font-bold backdrop-blur-md transition active:scale-95" data-time="300">+5åˆ†</button>
                                    <button class="time-add-btn bg-white/10 hover:bg-white/20 border border-white/10 px-4 py-2 rounded-xl text-sm font-bold backdrop-blur-md transition active:scale-95" data-time="1800">+30åˆ†</button>
                                    <button id="timer-reset-btn" class="bg-white/10 hover:bg-white/20 border border-white/10 w-10 h-10 rounded-xl flex items-center justify-center backdrop-blur-md transition active:scale-95 text-gray-300 hover:text-white">
                                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
            
                            <div id="focus-timer-display" class="text-7xl font-black tracking-tighter tabular-nums mb-10 drop-shadow-lg">30:00</div>
                            
                            <button id="focus-start-btn" class="w-full primary-bg hover:opacity-90 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg flex items-center justify-center transition-transform active:scale-95">
                                <i data-lucide="play" class="w-6 h-6 mr-2 fill-current"></i> ã‚¹ã‚¿ãƒ¼ãƒˆ
                            </button>
                            
                            <div id="focus-controls" class="hidden flex flex-col gap-3 w-full">
                                <button id="focus-pause-btn" class="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-4 rounded-full text-lg backdrop-blur-md border border-white/10 transition-colors flex items-center justify-center">
                                    <i data-lucide="pause" class="w-6 h-6 mr-2 fill-current"></i> ä¸€æ™‚åœæ­¢
                                </button>
                                <button id="focus-end-btn" class="w-full bg-red-500/80 hover:bg-red-600/80 text-white font-bold py-4 rounded-full text-lg backdrop-blur-md transition-colors flex items-center justify-center">
                                    <i data-lucide="square" class="w-6 h-6 mr-2 fill-current"></i> çµ‚äº†
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stopwatch-view" class="focus-view-bg hidden flex-grow flex-col items-center justify-center text-center relative text-white rounded-super shadow-modern overflow-hidden border border-gray-200/20 dark:border-gray-700/50">
                        <div class="absolute inset-0 bg-black/50 dark:bg-black/70"></div>
                        <div class="relative z-10 p-6 w-full max-w-sm mx-auto">
                            <div id="stopwatch-display" class="text-7xl font-black tracking-tighter tabular-nums mb-10 drop-shadow-lg">00:00</div>
                            
                            <button id="stopwatch-start-btn" class="w-full primary-bg hover:opacity-90 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg flex items-center justify-center transition-transform active:scale-95">
                                <i data-lucide="play" class="w-6 h-6 mr-2 fill-current"></i> ã‚¹ã‚¿ãƒ¼ãƒˆ
                            </button>
                            
                            <div id="stopwatch-controls" class="hidden flex flex-col gap-3 w-full">
                                <button id="stopwatch-pause-btn" class="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-4 rounded-full text-lg backdrop-blur-md border border-white/10 transition-colors flex items-center justify-center">
                                    <i data-lucide="pause" class="w-6 h-6 mr-2 fill-current"></i> ä¸€æ™‚åœæ­¢
                                </button>
                                <button id="stopwatch-end-btn" class="w-full bg-red-500/80 hover:bg-red-600/80 text-white font-bold py-4 rounded-full text-lg backdrop-blur-md transition-colors flex items-center justify-center">
                                    <i data-lucide="square" class="w-6 h-6 mr-2 fill-current"></i> çµ‚äº†
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            
            </div>
            <div id="my-chart-page" class="page p-4 space-y-6">
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ä»Šæ—¥</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-today">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ä»Šé€±</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-week">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg shadow text-center">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">ç·åˆè¨ˆ</p>
                        <p class="text-xl font-bold primary-text" id="report-stat-total">0<span class="text-xs text-gray-500 ml-1">æ™‚é–“</span></p>
                    </div>
                </div>
            
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 primary-text"></i> é€±é–“ãƒ¬ãƒãƒ¼ãƒˆ
                    </h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                        <canvas id="study-time-chart"></canvas>
                    </div>
                </div>
            
                <div class="flex flex-col h-[75vh]"> <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="calendar" class="w-5 h-5 mr-2 primary-text"></i> å­¦ç¿’ãƒ­ã‚°
                    </h2>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-t-lg shadow-sm z-10">
                        <div class="flex justify-between items-center mb-4">
                            <button id="cal-prev-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <h3 id="cal-month-title" class="font-bold text-lg"></h3>
                            <button id="cal-next-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2 text-gray-400">
                            <span>æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span>åœŸ</span>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm">
                            </div>
                    </div>
            
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-b-lg shadow p-4 flex-grow overflow-y-auto border-t border-gray-200 dark:border-gray-600">
                        <h4 id="detail-date-title" class="text-sm font-bold mb-3 text-gray-500 dark:text-gray-400 sticky top-0 bg-gray-50 dark:bg-gray-800 py-1">ä»Šæ—¥ã®è©³ç´°</h4>
                        <div id="study-session-list" class="space-y-3">
                            <p class="text-center text-xs text-gray-400 mt-4">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-page" class="page p-4 space-y-4">
                </div>

        <nav id="bottom-nav" class="fixed bottom-0 w-full max-w-lg pb-safe bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40">
        <div class="relative flex justify-between items-end h-16 px-2">
            
            <div class="flex-1 flex justify-around items-center h-full">
                <button class="tab-btn active-tab flex flex-col items-center justify-center w-full h-full transition-colors" data-page="home-page" data-title="ãƒ›ãƒ¼ãƒ ">
                    <i data-lucide="home" class="w-6 h-6 mb-0.5"></i>
                    <span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span>
                </button>
                <button class="tab-btn flex flex-col items-center justify-center w-full h-full transition-colors" data-page="study-page" data-title="æ•™æ">
                    <i data-lucide="book-marked" class="w-6 h-6 mb-0.5"></i>
                    <span class="text-[10px] font-bold">æ•™æ</span>
                </button>
            </div>

            <div class="w-16 flex-shrink-0 h-full relative">
                <button class="center-fab primary-bg tab-btn" data-page="focus-page" data-title="é›†ä¸­">
                    <i data-lucide="timer" class="w-7 h-7"></i>
                    <span class="text-[9px] font-bold leading-none">é›†ä¸­</span>
                </button>
            </div>

            <div class="flex-1 flex justify-around items-center h-full">
                <button class="tab-btn flex flex-col items-center justify-center w-full h-full transition-colors" data-page="my-chart-page" data-title="ãƒ¬ãƒãƒ¼ãƒˆ">
                    <i data-lucide="bar-chart-2" class="w-6 h-6 mb-0.5"></i>
                    <span class="text-[10px] font-bold">ãƒ¬ãƒãƒ¼ãƒˆ</span>
                </button>
                <button class="tab-btn flex flex-col items-center justify-center w-full h-full transition-colors" data-page="settings-page" data-title="è¨­å®š">
                    <i data-lucide="settings" class="w-6 h-6 mb-0.5"></i>
                    <span class="text-[10px] font-bold">è¨­å®š</span>
                </button>
            </div>
        </div>
    </nav>
        
    </div>

    <div id="welcome-screen" class="fixed inset-0 z-[200] bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center p-6 hidden">
        
        <div class="welcome-slideshow animate-fadeIn">
            
            <img src="tutorial_1.png" class="welcome-slide-item slide-tutorial" alt="Tutorial 1" onerror="this.style.display='none'">
            
            <img src="tutorial_2.png" class="welcome-slide-item slide-tutorial" alt="Tutorial 2" onerror="this.style.display='none'">
            
            <img src="tutorial_3.png" class="welcome-slide-item slide-tutorial" alt="Tutorial 3" onerror="this.style.display='none'">

            <img src="SQ_logo4.png" class="welcome-slide-item slide-logo block dark:hidden" alt="Logo Light">
            
            <img src="SQ_logo5.png" class="welcome-slide-item slide-logo hidden dark:block" alt="Logo Dark">
            
        </div>
        <div class="w-full max-w-xs space-y-4 animate-fadeIn" style="animation-delay: 0.3s; opacity: 0;">
            
            <div id="pwa-start-buttons" class="space-y-4 hidden">
                <button id="btn-start-new" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-full shadow-modern transition-transform hover:scale-105">
                    åˆã‚ã¦ã®æ–¹ã¯ã“ã¡ã‚‰
                </button>
                <button id="btn-transfer-start" class="w-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 font-bold py-4 rounded-full shadow-modern transition-colors border-2 border-gray-100 dark:border-gray-700">
                    ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã
                </button>
            </div>

            <div id="pwa-install-trigger-area" class="hidden">
                <button id="pwa-install-trigger-btn" class="w-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold py-4 rounded-full shadow-modern transition-transform hover:scale-105 flex items-center justify-center">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                    ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
                </button>
                <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-3">
                    â€» ã”åˆ©ç”¨ã«ã¯ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®è¿½åŠ ãŒå¿…è¦ã§ã™
                </p>
            </div>

        </div>
    </div>

    <div id="registration-wizard" class="fixed inset-0 z-[200] bg-gray-50 dark:bg-gray-900 flex flex-col transition-all duration-300 hidden opacity-0 transform scale-95">
        
        <header class="px-6 py-4 flex-shrink-0 flex items-center justify-between relative">
            <button id="wizard-close-btn" class="p-2 -ml-2 text-gray-400 hover:text-gray-600 dark:text-gray-500 transition-colors rounded-full hover:bg-gray-200 dark:hover:bg-gray-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <div class="wizard-step-indicator absolute left-1/2 -translate-x-1/2" id="wizard-steps">
                </div>
            
            <div class="w-8"></div> </header>
    
        <div id="wizard-content" class="flex-grow flex flex-col items-center justify-start pt-4 px-6 overflow-y-auto pb-4 w-full max-w-md mx-auto">
            </div>
    
        <div class="p-6 flex-shrink-0 w-full max-w-sm mx-auto">
            <div class="flex items-center gap-3">
                <button id="wizard-prev-btn" class="hidden w-14 h-14 flex-shrink-0 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-full shadow-md flex items-center justify-center transition-transform active:scale-95 border border-gray-100 dark:border-gray-700">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                
                <button id="wizard-next-btn" class="flex-grow primary-bg hover:opacity-90 text-white font-bold h-14 rounded-full shadow-lg transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    æ¬¡ã¸
                </button>
            </div>
        </div>
    </div>
    
    <div id="migration-screen" class="fixed inset-0 z-[300] bg-gray-50 dark:bg-gray-900 flex flex-col transition-all duration-300 opacity-0 pointer-events-none transform scale-95">
        <header class="header-safe px-6 py-4 flex items-center justify-between min-h-[60px]">
            <button id="close-migration-btn" class="p-2 -ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors text-gray-500 dark:text-gray-400 flex items-center">
                <i data-lucide="x" class="w-6 h-6 mr-1"></i>
                <span class="font-bold text-sm">é–‰ã˜ã‚‹</span>
            </button>
            <div class="flex-1"></div>
        </header>

        <div class="flex-grow flex flex-col items-center justify-center p-6 max-w-md mx-auto w-full relative">
            
            <div id="migration-step-1" class="migration-view w-full flex flex-col items-center space-y-8 animate-fadeIn">
                <div class="text-center space-y-2">
                    <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600 dark:text-indigo-400">
                        <i data-lucide="smartphone" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">ãƒ‡ãƒ¼ã‚¿å¼•ç¶™ã</h2>
                    <p class="text-gray-500 dark:text-gray-400">å¤ã„ç«¯æœ«ã¨æ–°ã—ã„ç«¯æœ«ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div class="w-full space-y-4">
                    <button id="migration-mode-send" class="w-full bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border-2 border-transparent hover:border-indigo-500 dark:hover:border-indigo-500 transition-all group text-left relative overflow-hidden">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-500 mr-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="upload-cloud" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 dark:text-white text-lg">ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">å¤ã„ã‚¹ãƒãƒ›ï¼ˆå¼•ç¶™ãå…ƒï¼‰</p>
                            </div>
                        </div>
                    </button>

                    <button id="migration-mode-receive" class="w-full bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border-2 border-transparent hover:border-green-500 dark:hover:border-green-500 transition-all group text-left relative overflow-hidden">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-50 dark:bg-green-900/20 text-green-500 mr-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="download-cloud" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 dark:text-white text-lg">ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">æ–°ã—ã„ã‚¹ãƒãƒ›ï¼ˆå¼•ç¶™ãå…ˆï¼‰</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <div id="migration-sender-view" class="migration-view hidden w-full flex flex-col items-center space-y-6 animate-fadeIn">
                <div class="text-center">
                    <h3 class="text-xl font-bold mb-2">æ¥ç¶šå…ˆã‚’å…¥åŠ›</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">æ–°ã—ã„ã‚¹ãƒãƒ›ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div class="w-full bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">Target ID</label>
                    <input type="text" id="migration-target-id" class="w-full text-center text-3xl font-mono font-bold bg-gray-100 dark:bg-gray-900 border-b-2 border-gray-300 dark:border-gray-700 focus:border-indigo-500 focus:outline-none py-2 tracking-widest uppercase rounded-t-md transition-colors" placeholder="XXXX">
                </div>

                <div id="migration-sender-error" class="hidden w-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-3 rounded-lg text-sm flex items-center justify-center">
                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>
                    <span id="migration-sender-error-text"></span>
                </div>

                <button id="migration-connect-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all hover:-translate-y-1 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>æ¥ç¶šã™ã‚‹</span>
                </button>
                
                <button class="migration-back-step text-gray-400 hover:text-gray-600 text-sm mt-4">
                    æˆ»ã‚‹
                </button>
            </div>

            <div id="migration-receiver-view" class="migration-view hidden w-full flex flex-col items-center space-y-6 animate-fadeIn">
                <div class="text-center">
                    <h3 class="text-xl font-bold mb-2">å¾…æ©Ÿä¸­...</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">ã“ã®IDã‚’å¤ã„ã‚¹ãƒãƒ›ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                </div>

                <div class="relative w-full aspect-video bg-gray-800 rounded-2xl flex flex-col items-center justify-center shadow-inner overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/20 to-purple-500/20 animate-pulse"></div>
                    <p class="text-gray-400 text-xs font-mono mb-2 relative z-10">YOUR ID</p>
                    <p class="text-5xl font-mono font-bold tracking-widest text-white relative z-10 drop-shadow-lg" id="migration-my-id">...</p>
                </div>

                <div class="flex items-center space-x-2 text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20 px-4 py-2 rounded-full transition-colors" id="migration-receiver-status-box">
                    <div class="w-2 h-2 bg-yellow-500 rounded-full animate-ping" id="migration-receiver-indicator"></div>
                    <span class="text-xs font-bold" id="migration-status-receive">æ¥ç¶šå¾…ã¡</span>
                </div>

                <button class="migration-back-step text-gray-400 hover:text-gray-600 text-sm mt-4">
                    æˆ»ã‚‹
                </button>
            </div>

            <div id="migration-confirm-view" class="migration-view hidden w-full flex flex-col items-center space-y-6 animate-fadeIn">
                <div class="w-20 h-20 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center text-yellow-500 mb-2">
                    <i data-lucide="alert-triangle" class="w-10 h-10"></i>
                </div>
                
                <div class="text-center space-y-4">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">æœ¬å½“ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ</h3>
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-xl text-left text-sm text-gray-600 dark:text-gray-300">
                        <ul class="list-disc list-inside space-y-2">
                            <li>æ–°ã—ã„ã‚¹ãƒãƒ›ã«ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</li>
                            <li><strong>é€ä¿¡å¾Œã€ã“ã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã¯åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚</strong></li>
                        </ul>
                    </div>
                </div>

                <div class="w-full space-y-3 pt-4">
                    <button id="migration-confirm-yes-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95">
                        ã¯ã„ã€é€ä¿¡ã—ã¦åˆæœŸåŒ–ã—ã¾ã™
                    </button>
                    <button id="migration-confirm-no-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold py-4 rounded-xl transition-colors">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>

            <div id="migration-complete-view" class="migration-view hidden w-full flex flex-col items-center justify-center space-y-6 animate-fadeIn text-center">
                <div class="relative">
                    <div id="migration-spinner" class="w-24 h-24 border-4 border-indigo-200 border-t-indigo-500 rounded-full animate-spin"></div>
                    <div id="migration-success-icon" class="hidden absolute inset-0 flex items-center justify-center text-green-500">
                        <i data-lucide="check-circle" class="w-24 h-24 fill-green-100 dark:fill-green-900"></i>
                    </div>
                </div>
                
                <div>
                    <h3 id="migration-complete-title" class="text-2xl font-bold mb-2">å‡¦ç†ä¸­...</h3>
                    <p id="migration-complete-msg" class="text-gray-500 dark:text-gray-400">é€šä¿¡ã‚’åˆ‡æ–­ã—ãªã„ã§ãã ã•ã„</p>
                </div>
            </div>

        </div>
    </div>

    <div id="theme-settings-screen" class="screen-layer">
    <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
        <div class="flex items-center flex-1">
            <button id="close-theme-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                <div class="flex items-center font-medium primary-text">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    <span>æˆ»ã‚‹</span>
                </div>
            </button>
        </div>
        <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒ†ãƒ¼ãƒè¨­å®š</h2>
        <div class="flex-1"></div>
    </header>
    <div id="theme-settings-content" class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900"></div>
</div>

    <div id="background-settings-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-bg-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">å£ç´™è¨­å®š</h2>
            <div class="flex-1"></div>
        </header>
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4">
                <h3 class="font-semibold mb-4">å£ç´™ã‚’é¸æŠ</h3>
                <div id="background-selector-container" class="grid grid-cols-3 gap-4"></div>
            </div>
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow flex items-center justify-between">
                <div>
                    <p class="font-semibold">å£ç´™ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã«é©ç”¨</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">â€»è¦–èªæ€§ãŒæ‚ªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</p>
                </div>
                <input type="checkbox" id="background-scope-toggle-sub" class="toggle-checkbox">
            </div>
        </div>
    </div>

    <div id="bgm-settings-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-bgm-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">BGMè¨­å®š</h2>
            <div class="flex-1"></div>
        </header>
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold flex items-center">
                        <i data-lucide="music" class="w-5 h-5 mr-2 primary-text"></i>
                        <span>BGMæ©Ÿèƒ½</span>
                    </h3>
                    <input type="checkbox" id="bgm-toggle-sub" class="toggle-checkbox">
                </div>
                <p class="text-xs text-gray-500">ONã«ã™ã‚‹ã¨ã€ã‚¯ã‚¨ã‚¹ãƒˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸­ã«ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆé †ã§å†ç”Ÿã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow mb-4">
                <h4 class="text-sm font-bold mb-2 flex items-center"><i data-lucide="list-music" class="w-4 h-4 mr-1"></i> ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h4>
                <div id="playlist-container-sub" class="space-y-2 mb-4 min-h-[50px] bg-gray-50 dark:bg-gray-800/50 rounded-lg p-2"></div>
            </div>

            <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                <h4 class="text-sm font-bold mb-2 flex items-center"><i data-lucide="library" class="w-4 h-4 mr-1"></i> è¿½åŠ å¯èƒ½ãªæ›²</h4>
                <div id="unlocked-music-list-sub" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>

    <div id="quest-view" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="quest-back-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ã‚¯ã‚¨ã‚¹ãƒˆ</h2>
            <div class="flex-1"></div>
        </header>

        <div class="flex-grow overflow-y-auto p-4 pb-36 bg-gray-100 dark:bg-gray-900">
            <button id="load-tasks-btn" class="w-full mb-6 primary-bg primary-bg-hover text-white py-3 px-6 rounded-full font-bold shadow-md transition-transform active:scale-95 flex items-center justify-center space-x-2">
                <i data-lucide="check-square" class="w-5 h-5"></i>
                <span>ã€Œä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã€ã‚’èª­ã¿è¾¼ã‚€</span>
            </button>
            
            <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden mb-24">
    
                <div id="quest-plan-list" class="divide-y divide-gray-100 dark:divide-gray-700">
                    </div>
            
                <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800/50 gap-2 border-t border-gray-100 dark:border-gray-700">
                    <button id="add-section-btn" class="flex-1 py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold text-sm transition-colors flex items-center justify-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-1"></i> ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                    </button>
                    <div class="w-px h-6 bg-gray-300 dark:bg-gray-600"></div>
                    <button id="add-break-btn" class="flex-1 py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold text-sm transition-colors flex items-center justify-center">
                        <i data-lucide="coffee" class="w-4 h-4 mr-1"></i> ãƒ–ãƒ¬ã‚¤ã‚¯
                    </button>
                </div>
            </div>
        </div>

        <div class="fixed force-bottom left-0 right-0 max-w-lg mx-auto p-4 pointer-events-none">
            <button id="start-quest-btn" class="w-full primary-bg primary-bg-hover text-white py-4 px-8 rounded-full font-bold text-lg shadow-lg hover:scale-105 transition-transform transform flex items-center justify-center space-x-2 pointer-events-auto">
                <i data-lucide="play" class="w-6 h-6"></i>
                <span>ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹</span>
            </button>
        </div>
    </div>

    <div id="quiz-screen" class="screen-layer flex flex-col h-full bg-gray-100 dark:bg-gray-900">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-quiz-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 id="quiz-screen-title" class="text-lg font-bold text-gray-900 dark:text-white truncate max-w-[60%] text-center"></h2>
            <div class="flex-1"></div>
        </header>
        <div id="quiz-container" class="flex-grow relative w-full h-full">
         <div id="quiz-loader" class="absolute inset-0 flex items-center justify-center" style="display: none;"><div id="loader"></div></div>
         </div>
    </div>

    <div id="countdown-screen" class="screen-layer flex flex-col h-full bg-gray-100 dark:bg-gray-900">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-countdown-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 id="countdown-screen-title" class="text-lg font-bold text-gray-900 dark:text-white">ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š</h2>
             <div class="flex-1"></div>
        </header>

        <div class="flex-grow overflow-y-auto p-4 pb-safe space-y-6 bg-gray-100 dark:bg-gray-900">
    
            <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden divide-y divide-gray-100 dark:divide-gray-700">
                <div class="p-4">
                    <label class="block text-xs font-bold text-gray-400 dark:text-gray-500 mb-1">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                    <input id="countdown-name" type="text" placeholder="ä¾‹: æœŸæœ«ãƒ†ã‚¹ãƒˆ" class="w-full bg-transparent border-none outline-none font-bold text-lg text-gray-800 dark:text-gray-200 placeholder-gray-300">
                </div>
                <div class="p-4">
                    <label class="block text-xs font-bold text-gray-400 dark:text-gray-500 mb-1">æ—¥ä»˜</label>
                    <input id="countdown-date" type="date" class="w-full bg-transparent border-none outline-none font-bold text-lg text-gray-800 dark:text-gray-200">
                </div>
            </div>
        
            <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden p-4">
                <label class="block text-xs font-bold text-gray-400 dark:text-gray-500 mb-2">ãƒ¡ãƒ¢</label>
                <textarea id="countdown-memo" rows="5" placeholder="ç¯„å›²ã‚„ç›®æ¨™ãªã©ã‚’å…¥åŠ›..." class="w-full bg-gray-50 dark:bg-gray-700/50 rounded-xl p-3 border-none outline-none text-sm text-gray-700 dark:text-gray-300 resize-none"></textarea>
            </div>
        
                        <button id="countdown-save-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-full shadow-lg hover:shadow-xl transition-all active:scale-95 flex items-center justify-center">
                <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                ä¿å­˜ã™ã‚‹
            </button>
        
            <button id="countdown-delete-btn" class="w-full bg-white dark:bg-gray-800 text-red-500 font-bold py-4 rounded-full shadow-sm hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center justify-center hidden">
                <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
            </button>
            
            <div class="h-20"></div></div>
        </div>

    <div id="break-settings-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-break-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®š</h2>
            <div class="flex-1"></div>
        </header>
        
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">ä¼‘æ†©ä¸­ã«è¡¨ç¤ºã™ã‚‹ã‚²ãƒ¼ãƒ ãªã©ã‚’è¨­å®šã—ã¾ã™ã€‚</p>

            <h4 class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-2 px-1">è¡¨ç¤ºä¸­ (ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ)</h4>
            <div id="break-active-list" class="w-full space-y-2"></div>

            <h4 class="text-xs font-bold text-gray-500 dark:text-gray-400 mt-6 mb-2 px-1">è¿½åŠ å¯èƒ½</h4>
            <div id="break-inactive-list" class="w-full flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div id="profile-screen" class="screen-layer flex flex-col">
        <header class="header-safe px-4 border-b border-gray-200 dark:border-gray-800 shadow-sm flex-shrink-0 sticky top-0 z-10 bg-white dark:bg-gray-800">
            <div class="flex items-center flex-1">
                <button id="close-profile-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-900 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>
            <div class="flex-1"></div>
        </header>

        <div class="flex-grow overflow-y-auto p-4 pb-safe space-y-6">
        
        <div class="flex flex-col items-center justify-center mt-4">
            <div class="relative group cursor-pointer" onclick="document.getElementById('edit-icon-random-btn').click()">
                <input type="text" id="edit-profile-icon" 
                       class="w-32 h-32 rounded-full text-center text-[5rem] bg-white dark:bg-gray-800 shadow-xl border-4 border-white dark:border-gray-700 outline-none cursor-pointer select-none" 
                       style="font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;"
                       readonly>
                
                <button id="edit-icon-random-btn" class="absolute bottom-0 right-0 p-3 rounded-full shadow-lg transition-transform active:scale-90 border-4 border-white dark:border-gray-800" style="background-color: var(--primary-color);">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-white"></i>
                </button>
            </div>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-3 font-bold">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ å¤‰æ›´</p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden gap-divider">
            
            <div class="flex items-center justify-between p-4 h-16">
                <div class="flex items-center flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 shadow-sm" style="background-color: var(--primary-color);">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-300">åå‰</span>
                </div>
                <input type="text" id="edit-profile-name" class="flex-1 min-w-0 ml-4 text-right font-bold text-gray-900 dark:text-white bg-transparent outline-none placeholder-gray-300" placeholder="åå‰ã‚’å…¥åŠ›">
            </div>
            
            <div class="flex items-center justify-between p-4 h-16 relative">
                <div class="flex items-center flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 shadow-sm" style="background-color: var(--primary-color);">
                        <i data-lucide="graduation-cap" class="w-4 h-4 text-white"></i>
                    </div>
                    <span class="font-bold text-sm text-gray-700 dark:text-gray-300">å­¦å¹´</span>
                </div>
                <div class="flex-1 min-w-0 ml-4 relative h-full">
                    <select id="edit-profile-grade" class="w-full h-full bg-transparent border-none outline-none font-bold text-gray-900 dark:text-white appearance-none pr-6 cursor-pointer" style="direction: rtl;">
                        </select>
                    <i data-lucide="chevron-right" class="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                </div>
            </div>

        </div>

        <button id="save-profile-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-4 rounded-full shadow-lg transition-transform active:scale-95 flex items-center justify-center">
            <i data-lucide="save" class="w-5 h-5 mr-2"></i>
            å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹
        </button>

        <div class="pt-6">
            <h3 class="text-xs font-bold text-gray-500 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                <button id="open-migration-menu-btn" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition text-left">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 shadow-sm" style="background-color: var(--primary-color);">
                            <i data-lucide="smartphone" class="w-4 h-4 text-white"></i>
                        </div>
                        <span class="font-bold text-sm text-gray-800 dark:text-white">æ©Ÿç¨®å¤‰æ›´ãƒ»ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 dark:text-gray-600"></i>
                </button>
            </div>
        </div>
        
        <div class="h-10"></div>
    </div>
    </div>

    <div id="routine-settings-screen" class="screen-layer flex flex-col h-full bg-gray-100 dark:bg-gray-900">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-routine-settings-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¨­å®š</h2>
            <div class="flex-1"></div>
        </header>

        <div id="routine-settings-content" class="flex-grow overflow-y-auto p-4 pb-safe"></div>
    </div>
</div>

    <div id="mini-timer-container" class="fixed bottom-safe-20 left-0 right-0 mx-auto w-max z-50 pointer-events-none flex justify-center transition-all duration-300 transform translate-y-[150%] opacity-0">
        <div id="mini-timer-bar" class="bg-gray-900/90 backdrop-blur-md text-white px-5 py-3 rounded-full shadow-2xl flex items-center space-x-4 pointer-events-none cursor-pointer border border-gray-700/50">
            <span id="mini-timer-text" class="font-bold text-xl tracking-wider">00:00</span>
            
            <div class="w-24 h-1.5 bg-gray-700 rounded-full overflow-hidden">
                <div id="mini-timer-progress-bar" class="h-full bg-indigo-500 w-full transition-all duration-1000 ease-linear"></div>
            </div>

            <button id="close-mini-timer-btn" class="p-1 -mr-2 text-gray-400 hover:text-white transition-colors rounded-full hover:bg-white/10">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
    <div id="quiz-modal" class="fixed inset-0 bg-black/70 z-50 flex-col hidden"><div class="w-full h-full max-w-lg mx-auto bg-gray-100 dark:bg-gray-900 flex flex-col"><header class="p-3 flex items-center justify-between shadow-md bg-white dark:bg-gray-800"><h2 id="quiz-modal-title" class="truncate font-bold"></h2><button class="close-modal-btn p-1" data-modal="quiz-modal"><i data-lucide="x"></i></button></header><div class="flex-grow relative"><div class="absolute inset-0 flex items-center justify-center"><div id="loader"></div></div><iframe id="quiz-iframe" class="w-full h-full border-0 invisible" sandbox="allow-scripts allow-forms allow-popups"></iframe></div></div></div>
    <div id="assessment-modal" class="hidden fixed inset-0 bg-black/70 z-[210] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300 backdrop-blur-sm">
    <div id="assessment-content" class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl w-full max-w-sm p-6 text-center transform scale-0 transition-transform duration-300 border border-gray-100 dark:border-gray-700">
        <h2 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>
        <p class="mb-6 text-gray-500 dark:text-gray-400 text-sm font-bold">ç†è§£åº¦ã‚’è¨˜éŒ²ã—ã¦å®Œäº†ã—ã¾ã™</p>
        
        <div class="flex flex-col gap-3">
            <button class="assessment-btn w-full py-4 px-6 flex items-center justify-between bg-yellow-50 dark:bg-yellow-900/20 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 border border-yellow-200 dark:border-yellow-700 rounded-2xl transition-all active:scale-95 group" data-level="3">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-800 flex items-center justify-center mr-3 text-yellow-600 dark:text-yellow-400">
                        <i data-lucide="award" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-lg text-yellow-700 dark:text-yellow-400">å®Œç’§</span>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-yellow-400"></i>
            </button>

            <button class="assessment-btn w-full py-4 px-6 flex items-center justify-between bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/40 border border-green-200 dark:border-green-700 rounded-2xl transition-all active:scale-95 group" data-level="2">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-800 flex items-center justify-center mr-3 text-green-600 dark:text-green-400">
                        <i data-lucide="thumbs-up" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-lg text-green-700 dark:text-green-400">ã¾ã‚ã¾ã‚</span>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-green-400"></i>
            </button>

            <button class="assessment-btn w-full py-4 px-6 flex items-center justify-between bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/40 border border-blue-200 dark:border-blue-700 rounded-2xl transition-all active:scale-95 group" data-level="1">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-800 flex items-center justify-center mr-3 text-blue-600 dark:text-blue-400">
                        <i data-lucide="book-open-check" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-lg text-blue-700 dark:text-blue-400">è¦å¾©ç¿’</span>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-blue-400"></i>
            </button>
        </div>
    </div>
</div>
    
    <div id="item-detail-screen" class="screen-layer bg-white dark:bg-gray-900 z-[150] flex flex-col">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-item-detail-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°</h2>
            
            <div class="flex-1"></div>
        </header>

        <div class="flex-grow overflow-y-auto pb-safe">
            <div class="p-6 pb-0 flex flex-col md:flex-row gap-6">
                <div class="flex-shrink-0 mx-auto md:mx-0">
                    <div id="detail-icon-container" class="w-32 h-32 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden flex items-center justify-center bg-gray-100 dark:bg-gray-800">
                        </div>
                </div>
                
                <div class="flex-grow text-center md:text-left flex flex-col justify-between">
                    <div>
                        <h2 id="detail-title" class="text-2xl font-bold text-gray-900 dark:text-white mb-1">ã‚¢ã‚¤ãƒ†ãƒ å</h2>
                        <p id="detail-subtitle" class="text-sm text-gray-500 dark:text-gray-400 mb-4">ã‚«ãƒ†ã‚´ãƒªå</p>
                    </div>
                    
                    <div class="flex justify-center md:justify-start items-center space-x-4 mb-4">
                        <button id="detail-action-btn" class="primary-bg text-white font-bold py-2 px-8 rounded-full shadow-lg transition-transform active:scale-95 flex items-center min-w-[120px] justify-center">
                            <span>å–å¾—</span>
                        </button>
                        <p id="detail-status-text" class="text-xs text-gray-500 font-bold hidden">äº¤æ›æ¸ˆã¿</p>
                    </div>
                </div>
            </div>

            <hr class="my-6 border-gray-200 dark:border-gray-800 mx-6">

            <div class="px-6 space-y-6">
                <div id="detail-preview-section" class="hidden">
                    <h3 class="font-bold text-lg mb-3 text-gray-900 dark:text-white">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div id="detail-carousel" class="preview-carousel gap-4 pb-4">
                        </div>
                </div>

                <div>
                    <h3 class="font-bold text-lg mb-2 text-gray-900 dark:text-white">è©³ç´°</h3>
                    <p id="detail-description" class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed">
                        ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å­¦ç¿’ä½“é¨“ãŒã‚ˆã‚Šè±Šã‹ã«ãªã‚Šã¾ã™ã€‚LPã‚’è²¯ã‚ã¦äº¤æ›ã—ã¾ã—ã‚‡ã†ã€‚
                    </p>
                </div>
            </div>
            
            <div class="h-20"></div>
        </div>
    </div>
    
    </div>
</div>
       
    <div id="status-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0">
            <div class="flex items-center flex-1">
                <button id="close-status-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ã‚¹ãƒˆã‚¢</h2>
            
            <div class="flex-1"></div>
        </header>

        <div class="relative p-6 text-center flex-shrink-0 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-yellow-400 via-orange-500 to-yellow-500 animate-gradient-xy"></div>
            <div class="absolute inset-0 bg-white/10 backdrop-blur-[1px]"></div>
            
            <div class="relative z-10 text-white">
                <p class="text-xs font-bold text-yellow-100 uppercase tracking-widest opacity-90 mb-2">Learning Points</p>
                
                <div class="flex items-center justify-center space-x-3 mb-1">
                        <img src="coin.png" alt="Coin" class="w-12 h-12 object-contain drop-shadow-md">
                    <p class="text-5xl font-black tracking-tighter drop-shadow-sm text-white" id="status-lp-display">0</p>
                </div>
                <p class="text-xs font-bold opacity-80 mt-2 text-white">å­¦ç¿’ã—ã¦LPã‚’è²¯ã‚ã€ã‚¢ã‚¤ãƒ†ãƒ ã¨äº¤æ›ã—ã‚ˆã†</p>
            </div>
        </div>

        <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex-shrink-0 overflow-x-auto">
            <div class="flex space-x-2 pb-1" id="status-tabs-container">
                <button class="status-tab-btn active primary-bg text-white px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors" data-target="theme">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</button>
                <button class="status-tab-btn bg-gray-200 dark:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors" data-target="background">å£ç´™</button>
                <button class="status-tab-btn bg-gray-200 dark:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors" data-target="game">ã‚²ãƒ¼ãƒ </button>
                <button class="status-tab-btn bg-gray-200 dark:bg-gray-600 px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors" data-target="music">BGM</button>
            </div>
        </div>
    
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            
            <div id="status-content-theme" class="status-content-section">
                <div id="status-theme-list" class="grid grid-cols-4 gap-4"></div>
            </div>

            <div id="status-content-background" class="status-content-section hidden">
                <div id="status-background-list" class="grid grid-cols-2 gap-3"></div>
            </div>

            <div id="status-content-game" class="status-content-section hidden">
                <div id="status-game-list" class="grid grid-cols-3 gap-3"></div>
            </div>

            <div id="status-content-music" class="status-content-section hidden">
                <div id="status-music-list" class="grid grid-cols-3 gap-3"></div>
            </div>

        </div>
    </div>

    <div id="lp-popup-modal" class="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden" style="opacity: 0; transition: opacity 0.3s;">
        
        <div id="lp-popup-content" class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl relative transform scale-0 overflow-hidden border border-yellow-400/30">
            
            <div class="popup-content-layer">
                <h2 id="popup-title" class="text-3xl font-black text-gray-800 dark:text-white mb-6 tracking-widest drop-shadow-sm">GET!</h2>
                
                <div class="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
                    
                    <div class="sunburst"></div>

                    <div class="absolute inset-0 bg-yellow-400 blur-[40px] opacity-40 rounded-full animate-pulse"></div>
                    
                    <img id="popup-coin-img" src="coin.png" alt="LP Coin" class="w-full h-full object-contain relative z-10 animate-coin-float drop-shadow-xl">
                    
                    <div id="popup-item-icon" class="relative z-10 hidden w-28 h-28 flex items-center justify-center animate-coin-float"></div>
                </div>

                <div class="mb-8">
                    <span id="lp-popup-reason" class="text-lg font-bold text-gray-500 dark:text-gray-400 block mb-1">ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹</span>
                    
                    <div id="popup-lp-container" class="flex items-baseline justify-center space-x-1">
                        <span class="text-2xl font-bold text-yellow-500">+</span>
                        <span id="lp-popup-amount" class="text-6xl font-black lp-amount-text tabular-nums">0</span>
                        <span class="text-xl font-bold text-yellow-600 dark:text-yellow-500">LP</span>
                    </div>

                    <p id="popup-item-name" class="hidden text-2xl font-bold text-gray-800 dark:text-white mt-2 animate-pulse"></p>
                </div>

                <button id="lp-popup-close-btn" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition active:scale-95 text-xl">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-all duration-300 z-[2000] transform -translate-y-10"></div>
        
    <div id="quest-active-screen" class="focus-view-bg hidden fixed inset-0 bg-gray-900 text-gray-100 z-[200] flex flex-col items-center justify-center transition-all duration-500 bg-cover bg-center">

        <div class="absolute inset-0 bg-black/60 z-0"></div>

        <div class="relative z-10 w-full h-full flex flex-col items-center justify-center">
        
            <div class="absolute right-6 flex items-center space-x-2 z-50" style="top: calc(1.5rem + env(safe-area-inset-top));">
                <button id="end-quest-btn" class="text-gray-300 p-2 rounded-full hover:bg-gray-700 transition-colors">
                    <i data-lucide="x" class="w-7 h-7"></i> 
                </button>
            </div>
                
            <div id="quest-content-area" class="relative w-full h-full overflow-hidden">
            
                <div id="quest-section-view" class="hidden absolute inset-0 w-full h-full flex-col items-center justify-center p-4 z-10 animate-enter-active">
                    <div class="text-center">
                        <h2 id="quest-section-title" class="text-2xl md:text-3xl font-bold mb-2 text-gray-400 tracking-wider"></h2>
                        <p class="text-7xl md:text-9xl tabular-nums font-extrabold tracking-tight" id="quest-timer">25:00</p>
                        <p id="quest-progress" class="mt-4 text-lg text-gray-400 font-medium"></p>
                    </div>
                </div>

                <div id="quest-break-view" class="hidden absolute inset-0 w-full h-full flex-col items-center justify-center p-4 z-10 animate-enter-active">
                    <div class="text-center mb-8 flex-shrink-0">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-400 tracking-wider">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </h2>
                        <p class="text-5xl md:text-7xl tabular-nums font-extrabold tracking-tight" id="break-timer">05:00</p>
                    </div>

                    <div class="w-full max-w-sm overflow-y-auto max-h-[50vh] px-2">
                        <div id="break-icon-grid" class="break-icon-grid-container">
                            </div>
                    </div>
                </div>

                <div id="quest-transition-view" class="hidden fixed inset-0 w-full h-full z-[60] bg-gray-900/95 overflow-y-auto">
                    <div class="min-h-full flex flex-col landscape:flex-row items-center justify-center p-6 gap-8 landscape:gap-16 max-w-5xl mx-auto animate-enter-active">
                        
                        <div class="flex flex-col items-center text-center landscape:w-1/2 landscape:items-end landscape:text-right space-y-4">
                            <i id="transition-icon" data-lucide="arrow-right-circle" class="w-24 h-24 text-white opacity-80"></i>
                            <div>
                                <h2 id="transition-title" class="text-3xl md:text-4xl font-bold text-white mb-2"></h2>
                                <p id="transition-message" class="text-xl text-gray-300"></p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-center landscape:items-start landscape:w-1/2 w-full max-w-sm">
                            <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 w-full border border-white/20 mb-8 shadow-xl">
                                <p class="text-sm text-gray-400 mb-1 font-bold tracking-wider">NEXT STEP</p>
                                <p id="transition-next-text" class="text-2xl font-bold text-white truncate my-1"></p>
                                <div class="flex items-center text-gray-300">
                                    <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                                    <p id="transition-next-duration" class="text-sm font-mono"></p>
                                </div>
                            </div>

                            <button id="transition-start-btn" class="primary-bg primary-bg-hover text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center justify-center w-full landscape:w-auto">
                                <i data-lucide="play" class="w-6 h-6 mr-2 fill-current"></i>
                                <span>å§‹ã‚ã‚‹</span>
                            </button>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div id="iframe-overlay" class="hidden fixed inset-0 bg-gray-900 z-[220] flex flex-col">
        <div class="bg-gray-800 w-full px-2 pb-2 flex justify-between items-center z-10 shadow-md" style="padding-top: calc(0.5rem + env(safe-area-inset-top));">
            <span class="text-white font-bold ml-2">Game</span>
            <button id="close-iframe-btn" class="text-gray-300 p-2 rounded-full hover:bg-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div id="game-container" class="relative flex-grow w-full h-full bg-white">
            <div id="iframe-loader" class="flex flex-col items-center justify-center absolute inset-0" style="display: none;">
                <div id="loader"></div> <p class="mt-4 text-gray-500 font-bold">Loading...</p>
            </div>
        </div>
    </div>

    <div id="resume-quest-modal" class="hidden fixed inset-0 bg-black/80 z-[210] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <div class="mb-4">
                <i data-lucide="alert-circle" class="w-12 h-12 text-yellow-500 mx-auto mb-2"></i>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">ã‚¯ã‚¨ã‚¹ãƒˆã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">å‰å›ã€ã‚¯ã‚¨ã‚¹ãƒˆã®é€”ä¸­ã§ã‚¢ãƒ—ãƒªãŒçµ‚äº†ã—ã¾ã—ãŸã€‚</p>
            </div>
            <div class="flex flex-col space-y-3">
                <button id="resume-quest-yes-btn" class="w-full py-3 rounded-lg primary-bg primary-bg-hover text-white font-bold shadow-lg">
                    å†é–‹ã™ã‚‹
                </button>
                <button id="resume-quest-no-btn" class="w-full py-3 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold">
                    çµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã¸
                </button>
            </div>
        </div>
    </div>

    <div id="feedback-reward-modal" class="hidden fixed inset-0 z-[1100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div id="feedback-reward-content" class="bg-white dark:bg-gray-800 rounded-3xl p-6 w-full max-w-sm text-center shadow-2xl transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">ã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
                é€ä¿¡å®Œäº†ç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦<br>ãŠç¤¼ã®LPã‚’å—ã‘å–ã£ã¦ãã ã•ã„ã€‚
            </p>
            
            <div class="mb-6">
                <input type="text" id="feedback-code-input" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ› " class="w-full text-center text-2xl font-bold tracking-widest p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-900 focus:outline-none focus:border-indigo-500 uppercase transition-colors">
                <p id="feedback-code-error" class="text-red-500 text-xs font-bold mt-2 hidden">ã‚³ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™</p>
            </div>

            <div class="flex space-x-3">
                <button id="feedback-code-cancel" class="flex-1 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    é–‰ã˜ã‚‹
                </button>
                <button id="feedback-code-submit" class="flex-1 py-3 rounded-xl font-bold text-white primary-bg primary-bg-hover shadow-lg transition-transform active:scale-95">
                    å—ã‘å–ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="pinned-list-screen" class="screen-layer">
        <header class="header-safe bg-white dark:bg-gray-800 px-4 border-b border-gray-200 dark:border-gray-700 shadow-sm flex-shrink-0 sticky top-0 z-10">
            <div class="flex items-center flex-1">
                <button id="close-pinned-list-btn" class="p-2 -ml-2 text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <div class="flex items-center font-medium primary-text">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        <span>æˆ»ã‚‹</span>
                    </div>
                </button>
            </div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white">ãƒ”ãƒ³ç•™ã‚ã—ãŸã‚¯ã‚¤ã‚º</h2>
            <div class="flex-1"></div>
        </header>
        <div class="flex-grow overflow-y-auto p-4 pb-safe bg-gray-100 dark:bg-gray-900">
            <div id="pinned-list-full-content" class="grid grid-cols-1 gap-3"></div>
        </div>
    </div>

    <div id="general-confirm-modal" class="hidden fixed inset-0 bg-black/60 z-[300] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300 backdrop-blur-sm">
    <div id="general-confirm-content" class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center transform scale-0 transition-transform duration-300">
        <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mx-auto mb-4 text-gray-500 dark:text-gray-300">
            <i id="general-confirm-icon" data-lucide="alert-circle" class="w-8 h-8"></i>
        </div>
        <h3 id="general-confirm-title" class="text-xl font-bold text-gray-900 dark:text-white mb-2">ç¢ºèª</h3>
        <p id="general-confirm-msg" class="text-sm text-gray-500 dark:text-gray-400 mb-8 font-bold leading-relaxed">ã“ã‚Œã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ</p>
        <div class="flex flex-col space-y-3">
            <button id="general-confirm-ok-btn" class="w-full py-3.5 rounded-full primary-bg text-white font-bold shadow-lg transition-transform active:scale-95">å®Ÿè¡Œã™ã‚‹</button>
            <button id="general-confirm-cancel-btn" class="w-full py-3.5 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="purchase-confirm-modal" class="hidden fixed inset-0 bg-black/60 z-[300] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300 backdrop-blur-sm">
    <div id="purchase-confirm-content" class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-6 w-full max-w-sm text-center transform scale-0 transition-transform duration-300 relative overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-gray-50 to-transparent dark:from-gray-700/50 dark:to-transparent -z-10"></div>

        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-6">ã‚¢ã‚¤ãƒ†ãƒ ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ</h3>

        <div class="flex items-center justify-center mb-6">
            <div id="purchase-item-preview" class="mr-4"></div> <div class="text-left">
                <p id="purchase-item-name" class="font-bold text-lg text-gray-800 dark:text-white">ã‚¢ã‚¤ãƒ†ãƒ å</p>
                <p id="purchase-item-type" class="text-xs text-gray-400 dark:text-gray-500 font-bold uppercase tracking-wider">CATEGORY</p>
            </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700/50 rounded-2xl p-4 mb-6 border border-gray-100 dark:border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-gray-400">æ‰€æŒ LP</span>
                <span id="purchase-current-lp" class="font-bold text-gray-600 dark:text-gray-300">0</span>
            </div>
            <div class="flex justify-between items-center mb-2 text-red-500">
                <span class="text-xs font-bold">æ¶ˆè²» LP</span>
                <span id="purchase-cost-lp" class="font-bold">-0</span>
            </div>
            <div class="w-full h-px bg-gray-200 dark:bg-gray-600 my-2"></div>
            <div class="flex justify-between items-center">
                <span class="text-xs font-bold text-gray-400">äº¤æ›å¾Œ</span>
                <span id="purchase-after-lp" class="font-black text-xl primary-text">0</span>
            </div>
        </div>

        <div class="flex flex-col space-y-3">
            <button id="purchase-confirm-ok-btn" class="w-full py-3.5 rounded-full primary-bg text-white font-bold shadow-lg transition-transform active:scale-95 flex items-center justify-center">
                <i data-lucide="check" class="w-5 h-5 mr-2"></i> äº¤æ›ã™ã‚‹
            </button>
            <button id="purchase-confirm-cancel-btn" class="w-full py-3.5 rounded-full bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 text-gray-500 dark:text-gray-400 font-bold transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>
    <div id="orientation-lock-overlay" class="fixed inset-0 z-[10000] bg-gray-900 text-white flex-col items-center justify-center text-center p-6 hidden touch-none">
    <div class="mb-6">
        <img src="yokogamen.png" alt="ç”»é¢ã‚’æ¨ªã‹ã‚‰ç¸¦ã«" class="w-32 h-auto mx-auto">
        </div>
    <h2 class="text-2xl font-bold mb-2">ç”»é¢ã‚’ç¸¦ã«æˆ»ã—ã¦ãã ã•ã„</h2>
    <p class="text-sm text-gray-400 font-bold">æ¨ªç”»é¢ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“</p>
</div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // â–¼â–¼â–¼ é–‹ç™ºç’°å¢ƒãƒ­ãƒƒã‚¯æ©Ÿèƒ½ (ã“ã“ã«è¿½åŠ ) â–¼â–¼â–¼
            const checkDevLock = () => {
                // 1. URLã« 'studyquest-dev' ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                // (æœ¬ç•ªç’°å¢ƒãªã©åˆ¥ã®URLã®ã¨ãã¯è¡¨ç¤ºã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚)
                if (window.location.href.includes('studyquest-dev')) {
                    
                    // 2. æ—¢ã«èªè¨¼æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ (localStorageã‚’ç¢ºèª)
                    const isDevAuth = localStorage.getItem('isDevAuthenticated');

                    if (!isDevAuth) {
                        // æœªèªè¨¼ãªã‚‰ãƒ­ãƒƒã‚¯ç”»é¢ã‚’è¡¨ç¤º
                        const lockScreen = document.getElementById('dev-lock-screen');
                        const input = document.getElementById('dev-pass-input');
                        const btn = document.getElementById('dev-unlock-btn');
                        const errorMsg = document.getElementById('dev-pass-error');

                        if (lockScreen) {
                            lockScreen.classList.remove('hidden');
                            
                            // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆï¼ˆã“ã®æ™‚ç‚¹ã§ã¯ã¾ã lucide.createIconsãŒèµ°ã£ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å¿µã®ç‚ºï¼‰
                            if(window.lucide) lucide.createIcons({ root: lockScreen });

                            const unlock = () => {
                                const val = input.value;
                                // æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹å«ã‚€å®Œå…¨ä¸€è‡´ï¼‰
                                if (val === 'é–‹ç™ºç”¨ã€€SQpjfij5678') {
                                    // æ­£è§£ãªã‚‰ä¿å­˜ã—ã¦ç”»é¢ã‚’æ¶ˆã™
                                    localStorage.setItem('isDevAuthenticated', 'true');
                                    lockScreen.classList.add('hidden');
                                    showToast('é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã—ãŸ');
                                } else {
                                    // ä¸æ­£è§£
                                    errorMsg.classList.remove('hidden');
                                    input.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                                    // æºã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                                    input.animate([
                                        { transform: 'translateX(0)' },
                                        { transform: 'translateX(-5px)' },
                                        { transform: 'translateX(5px)' },
                                        { transform: 'translateX(0)' }
                                    ], { duration: 200 });
                                }
                            };

                            btn.onclick = unlock;
                            
                            // Enterã‚­ãƒ¼ã§ã‚‚è§£é™¤å¯èƒ½ã«
                            input.onkeypress = (e) => {
                                if (e.key === 'Enter') unlock();
                            };
                            
                            // å…¥åŠ›ã—ç›´ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã‚’æ¶ˆã™
                            input.oninput = () => {
                                errorMsg.classList.add('hidden');
                                input.classList.remove('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                            };
                        }
                    }
                }
            };
            checkDevLock();
            const initialData = {
                quizzes: [
                    //tagsã®'JHS'ï¼šä¸­å­¦ã€'HS'ï¼šé«˜æ ¡
                    //æ—¥æœ¬å²ï¼ˆä¸­å­¦ï¼‰
                    { id: 'nihonshi_1', title: "æ—¥æœ¬å²â‘ ï½æ—§çŸ³å™¨â†’ç¸„æ–‡æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfINOBeZA23WwT6i5Y4kAYR6mooRtiGXS1w4on7bDZXI62oag/viewform?usp=pp_url" },
                    { id: 'nihonshi_2', title: "æ—¥æœ¬å²â‘¡ï½å¼¥ç”Ÿæ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfJgVO0waXZ9LoTgC7ZuQItV5EDG9P8oHtDGQ5FFVYF-glflg/viewform?usp=pp_url" },
                    { id: 'nihonshi_3', title: "æ—¥æœ¬å²â‘¢ï½ãƒ¤ãƒãƒˆæ”¿æ¨©ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://forms.gle/Arrhaxxq6DbyUpvC8" },
                    { id: 'nihonshi_15', title: "æ—¥æœ¬å²â‘®ï½éŒå€‰æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSeQ41uYYG6UQuRVpZBtGCW9jyeBPHt_dfnqVF0aH85kbxDCkg/viewform?usp=pp_url" },
                    { id: 'nihonshi_16', title: "æ—¥æœ¬å²â‘¯ï½éŒå€‰æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfMHo_lHE_SVgTEmj_N56Vs3tv9AvOr-dpTyKIQhiBSDmSjag/viewform?usp=pp_url" },
                    { id: 'nihonshi_17', title: "æ—¥æœ¬å²â‘°ï½å®¤ç”ºæ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfLwopSoQTQvfV14IpSSAenEAPoMxC9m2W4K8qWAeHfvJIltg/viewform?usp=pp_url" },
                    { id: 'nihonshi_18', title: "æ—¥æœ¬å²â‘±ï½å®¤ç”ºæ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSdcpPVkNPc6BZcoqfdeMC7A5WVmhEBTYRcmAuiFUGB7nzA4NQ/viewform?usp=pp_url" },
                    { id: 'nihonshi_19', title: "æ—¥æœ¬å²â‘²ï½å®¤ç”ºæ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfZGxRILYaOSfeKLupr3XiJJbM-G1g_wQr5KtxCOfNpbalw7g/viewform" },
                    { id: 'nihonshi_20', title: "æ—¥æœ¬å²â‘³ï½å®¤ç”ºæ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSdOHIvNtpJlmMd_y9k_L9SQrGGKTuiUDq9g7fRhe7mQiCB7Nw/viewform?usp=pp_url" },
                    { id: 'nihonshi_21', title: "æ—¥æœ¬å²ã‰‘ï½å®‰åœŸæ¡ƒå±±æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLScn3X0kzRMtAhTClCqipKAwzSswe0m0ikcgosl8Y2spPYyyGA/viewform?usp=pp_url" },
                    { id: 'nihonshi_22', title: "æ—¥æœ¬å²ã‰’ï½å®‰åœŸæ¡ƒå±±â†’æ±Ÿæˆ¸æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLScTzlBuGJ9g2VE-P-jiqED6wEHKLQFxSS38JpdbulpllFArag/viewform?usp=pp_url" },
                    { id: 'nihonshi_23', title: "æ—¥æœ¬å²ã‰“ï½æ±Ÿæˆ¸æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSeOa8IGDJtdW99e2kpKOpS5i5T5iUW97kDJ4265W5Ak29CwDA/viewform?usp=pp_url" },
                    { id: 'nihonshi_24', title: "æ—¥æœ¬å²ã‰”ï½æ±Ÿæˆ¸æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSdZmwUHpJJuM4-RSdzVPSGLT5IQBfvg-g8QHnBEIPbKtyyTcQ/viewform?usp=pp_url" },
                    { id: 'nihonshi_25', title: "æ—¥æœ¬å²ã‰•ï½æ±Ÿæˆ¸æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSduPMTZb1Byk1227Ze1nrUaPiQT38jyqB8V9rgmrFff8ahHoQ/viewform?usp=pp_url" },
                    { id: 'nihonshi_26', title: "æ—¥æœ¬å²ã‰–ï½æ±Ÿæˆ¸æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSdxGxgHVA6vTzINPFh1VW3XDRsFH6gLzyW6CQqbq5YFi3Oe7A/viewform?usp=pp_url" },
                    { id: 'nihonshi_27', title: "æ—¥æœ¬å²ã‰—ï½æ±Ÿæˆ¸æ™‚ä»£ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://forms.gle/F6PzpmzVzxRTHBxm6" },
                    { id: 'nihonshi_28', title: "æ­´å²ç·å¾©ç¿’ï½æ˜æ²»æ™‚ä»£â‘¡ï½", subject: "æ—¥æœ¬å²", genre: "ä¸­å­¦", tags: ['JHS','nihonshi'], url: "https://forms.gle/bhXeJo6HbqhrZ9bF6" },

                    //ä¸–ç•Œå²ï¼ˆä¸­å­¦ï¼‰ mi
                    { id: 'sekaishi_1', title: "ä¸–ç•Œå²â‘ ï½å¤ä»£æ–‡æ˜ã®ç™ºç”Ÿï½", subject: "ä¸–ç•Œå²", genre: "ä¸­å­¦", tags: ['JHS','sekaishi'], url: "https://docs.google.com/forms/d/e/1FAIpQLSe4VHPhgiNEut0yNrDCit_W5q54EeFggQW6CQUkVtoS9UGxIg/viewform" },

                    //å…¬æ°‘ï¼ˆä¸­å­¦ï¼‰mi
                    { id: 'komin_19', title: "å…¬æ°‘â‘ ï½â‘¨", subject: "å…¬æ°‘", genre: "ä¸­å­¦", tags: ['JHS','komin'], url: "https://forms.gle/9KPrvLkPmENeLrVR9" },

                    //åœ°ç†ï¼ˆä¸­å­¦ï¼‰mi
                    { id: 'chiri_1', title: "åœ°ç†â‘ ï½ä¸–ç•Œã®å§¿ï½", subject: "åœ°ç†", genre: "ä¸­å­¦", tags: ['JHS','chiri'], url: "https://forms.gle/cM4HbDqnqucUKPsf6" },

                    //è‹±èª
                    { id: 'eigo_1', title: "å‹•åè©ã®ã‚¤ãƒ‡ã‚£ã‚ªãƒ ", subject: "è‹±èª", genre: "ä¸­å­¦ãƒ»é«˜æ ¡", tags: ['JHS','HS','eigo'], url: "https://forms.gle/1fWg5Rxsw67mrJdZ9" },
                    { id: 'eigo_2', title: "ä¸å®šè©ã®ã‚¤ãƒ‡ã‚£ã‚ªãƒ ", subject: "è‹±èª", genre: "ä¸­å­¦ãƒ»é«˜æ ¡", tags: ['JHS','HS','eigo'], url: "https://forms.gle/vgBKcxo28vMVG6uA7" },
                    { id: 'eigo_3', title: "åŠ©å‹•è©ã®ã‚¤ãƒ‡ã‚£ã‚ªãƒ ", subject: "è‹±èª", genre: "ä¸­å­¦ãƒ»é«˜æ ¡", tags: ['JHS','HS','eigo'], url: "https://forms.gle/UvCMjVdyuATM8ZxV8" },
                    { id: 'eigo_4', title: "æ™‚åˆ¶ã®ã‚¤ãƒ‡ã‚£ã‚ªãƒ ", subject: "è‹±èª", genre: "ä¸­å­¦ãƒ»é«˜æ ¡", tags: ['JHS','HS','eigo'], url: "https://forms.gle/zRoEiVFdTDR4smUe6" },
                    { id: 'eigo_5', title: "ä»®å®šæ³•ã®ã‚¤ãƒ‡ã‚£ã‚ªãƒ ", subject: "è‹±èª", genre: "ä¸­å­¦ãƒ»é«˜æ ¡", tags: ['JHS','HS','eigo'], url: "https://forms.gle/uFW9PTrDLBjyzKra9" },

                    //ä¿å¥
                    { id: 'hoken_2', title: "ä¸­å­¦2å¹´ç”Ÿ", subject: "ä¿å¥", genre: "ä¸­å­¦2å¹´", tags: ['JHS_2','hoken'], url: "https://forms.gle/1Lcc4if9XiAnZzsz7" },
                    { id: 'hoken_3', title: "ä¸­å­¦3å¹´ç”Ÿ", subject: "ä¿å¥", genre: "ä¸­å­¦3å¹´", tags: ['JHS_3','hoken'], url: "https://forms.gle/dYhYuCj4o4iHmWFK8" },
                    
                    //æƒ…å ±mi
                ],

                // â–¼â–¼â–¼ è¿½åŠ : ãƒãƒŠãƒ¼ãƒ‡ãƒ¼ã‚¿ â–¼â–¼â–¼
                banners: [
                    { id: 1, url: 'banner_1_1.png', link: '' }, // ç”»åƒãƒ‘ã‚¹ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„
                    { id: 2, url: 'banner_2.png', link: 'action:feedback' },
                    { id: 3, url: 'banner_3.png', link: 'item:game:NumberPlace' }
                ],
                
                themes: {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', color: '#28497A', dark: '#97AED2', cost: 0 },
                    green: { name: 'ãƒŸãƒ³ãƒˆ', color: '#78CBBF', dark: '#78CBBF', cost: 1000 },
                    red: { name: 'ãƒãƒŠãƒŠ', color: '#F1C56E', dark: '#F1C56E', cost: 1500 },
                    orange: { name: 'ã‚­ãƒ£ãƒ©ãƒ¡ãƒ«', color: '#E99E09', dark: '#E99E09', cost: 2000 },
                    purple: { name: 'ã‚¯ãƒƒã‚­ãƒ¼', color: '#5B4420', dark: '#5B4420', cost: 2500 },
                    pink: { name: 'ãƒ†ã‚£ãƒ¼', color: '#799832', dark: '#799832', cost: 3000 },
                    teal: { name: 'ã‚¹ãƒˆãƒ­ãƒ™ãƒªãƒ¼', color: '#B0312D', dark: '#B0312D', cost: 3500 },
                },
                backgrounds: {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', url: '', cost: 0 , tone: 'system' },
                    sky: { name: 'é’ç©ºã¨æµã‚Œæ˜Ÿ', url: 'okumono_hosisoratate8.png', cost: 5000, tone: 'light' },
                    night: { name: 'æ‰‹æ›¸ãã‚†ã‚‹ãƒ‰ãƒƒãƒˆ', url: 'https://sozaino.site/wp-content/uploads/2022/01/yurudot32.png', cost: 7000, tone: 'light' },
                    sdotb: { name: 'ã‚·ãƒ£ãƒ¯ãƒ¼ãƒ‰ãƒƒãƒˆ(ãƒ–ãƒ«ãƒ¼)', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-4.png', cost: 7000, tone: 'light' },
                    utyuu: { name: 'å£®å¤§ãªå®‡å®™', url: 'https://sozaino.site/wp-content/uploads/2021/02/utyuu.jpg', cost: 7000, tone: 'dark' },
                    jyanguru: { name: 'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«', url: 'https://sozaino.site/wp-content/uploads/2025/07/okumono_jungle1.png', cost: 7000, tone: 'light' },
                    wapop: { name: 'å’Œãƒãƒƒãƒ—ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰', url: 'okumono_wapop3.png', cost: 7000, tone: 'light' },
                    yuruhuwa1: { name: 'ã‚†ã‚‹ãµã‚èŠ±ã‚‚ã‚ˆã†ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-26.png', cost: 8000, tone: 'light' },
                    yuruhuwa2: { name: 'ã‚†ã‚‹ãµã‚èŠ±ã‚‚ã‚ˆã†ï¼ˆã‚°ãƒªãƒ¼ãƒ³ï¼‰', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-29.png', cost: 8000, tone: 'light' },
                    sdotb2: { name: 'ã‚·ãƒ£ãƒ¯ãƒ¼ãƒ‰ãƒƒãƒˆ(ã‚°ãƒªãƒ¼ãƒ³)', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-5.png', cost: 7000, tone: 'light' },
                    itachoco: { name: 'ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³', url: 'itachoco1.png', cost: 5000, tone: 'dark' },
                    suisai1: { name: 'æ°´å½©ï¼ˆãƒ–ãƒ«ãƒ¼ï¼‰', url: 'https://sozaino.site/wp-content/uploads/2025/03/okumono_enogu7.png', cost: 9000, tone: 'light' },
                    suisai2: { name: 'æ°´å½©ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰', url: 'https://sozaino.site/wp-content/uploads/2025/03/okumono_enogu2.png', cost: 9000, tone: 'light' },
                    suisai3: { name: 'æ°´å½©ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰', url: 'https://sozaino.site/wp-content/uploads/2025/03/okumono_enogu1.png', cost: 9000, tone: 'light' },
                    //summer: { name: 'å¤ç©º', url: 'https://sozaino.site/wp-content/uploads/2024/08/okumono-haikei2-.png', cost: 7000, tone: 'light' },
                },
                
                games: {
                    // ID: { name: 'ã‚²ãƒ¼ãƒ å', url: 'URL', cost: å¿…è¦LP, icon: 'ã‚¢ã‚¤ã‚³ãƒ³å,'thumbnail: 'icon_m10.png', }
                    // previews: ['ç”»åƒã®URL', 'å‹•ç”»ã®URL', ...] ã®å½¢å¼ã§è¿½åŠ ã—ã¾ã™
                    just100: { 
                        name: 'Just 1.00s', 
                        url: 'https://330march39.github.io/games/just1m_37928/', 
                        cost: 10000, 
                        icon: 'gamepad-2',
                        thumbnail: 'icon_just1m.png',
                        description: 'ã€Œ1.000ç§’ã€ã®å¥‡è·¡ã‚’ãã®æŒ‡å…ˆã«ã€‚\nä½“å†…æ™‚è¨ˆã‚’æ¥µé™ã¾ã§ç ”ãæ¾„ã¾ã™ã€ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚²ãƒ¼ãƒ ãŒç™»å ´ï¼\n\nâ—† ã‚³ãƒ³ãƒæ•°ç§’ã®ä¸–ç•Œã¸é£›ã³è¾¼ã¿ã€å·±ã®æ„Ÿè¦šã‚’è©¦ãã†ï¼\nãƒ«ãƒ¼ãƒ«ã¯æ¥µé™ã¾ã§ã‚·ãƒ³ãƒ—ãƒ«ã€‚ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¿ã‚¤ãƒãƒ¼ã‚’å§‹å‹•ã—ã€æŒ‡å®šã•ã‚ŒãŸç§’æ•°ã‚¸ãƒ£ã‚¹ãƒˆã§æ­¢ã‚ã‚‹ã ã‘ï¼\nãŸã ã—ã€è¨ˆæ¸¬ä¸­ã¯ã€Œæ•°å­—ãŒæ¶ˆãˆã‚‹ã€ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰ä»•æ§˜ï¼ï¼Ÿ\né ¼ã‚Œã‚‹ã®ã¯è‡ªåˆ†ã®ãƒªã‚ºãƒ æ„Ÿã®ã¿ã€‚èª¤å·®0.000ç§’ã®ã€Œç¥ã®é ˜åŸŸã€ã‚’ç›®æŒ‡ã—ã¦ã€é›†ä¸­åŠ›ã‚’ç ”ãæ¾„ã¾ã›ï¼\n\nâ—† ã“ã“ã§ã—ã‹å‘³ã‚ãˆãªã„ã€Œç§°å·ã€ã‚’ç²å¾—ã›ã‚ˆï¼\nãã®ã‚¿ãƒƒãƒ—ã®ç²¾åº¦ã«ã‚ˆã£ã¦ã€ã‚ãªãŸã¸ã®è©•ä¾¡ãŒåŠ‡çš„ã«å¤‰åŒ–ï¼\næ­£ç¢ºç„¡æ¯”ãªã€Œç²¾å¯†æ©Ÿæ¢°ã€ã‹ã€æ™‚ã‚’æ“ã‚‹ã€Œæ™‚é–“åœæ­¢èƒ½åŠ›è€…ã€ã‹ã€ãã‚Œã¨ã‚‚ãŸã ã®ã€Œä¸€èˆ¬äººã€ã‹â€¦ï¼Ÿ\nèª¤å·®ã‚¼ãƒ­ã§é”æˆã—ãŸæ™‚ã«ã ã‘ç¾ã‚Œã‚‹ã€é»„é‡‘ã«è¼ãã€Œãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼æ¼”å‡ºã€ã¯å¿…è¦‹ï¼\nãã®ç¾ã—ã•ã«å¤¢ä¸­ã«ãªã‚ã†ï¼\n\nâ—† å¤šå½©ãªã‚¿ã‚¤ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’æ”»ç•¥ã—ã‚ˆã†ï¼\nç¬ç™ºåŠ›ãŒå•ã‚ã‚Œã‚‹ã€Œ1.00ç§’ã€ã ã‘ã˜ã‚ƒãªã„ï¼\nã€Œ10ç§’ã€ã€Œ30ç§’ã€ã€ãã—ã¦é›†ä¸­åŠ›ãŒè©¦ã•ã‚Œã‚‹ã€Œ60ç§’ã€ãƒ¢ãƒ¼ãƒ‰ã‚‚æ­è¼‰ï¼\næ™‚é–“ãŒé•·ããªã‚‹ã»ã©ç‹‚ã„å‡ºã™ä½“å†…æ™‚è¨ˆâ€¦ã‚ãªãŸã¯ã©ã“ã¾ã§æ­£ç¢ºã•ã‚’ä¿ã¦ã‚‹ã‹ï¼ï¼Ÿ\néŸ³ã¨å…‰ãŒã€ã‚ãªãŸã®æŒ‘æˆ¦ã‚’ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æ¼”å‡ºï¼\n\nâ—† å·±ã®é™ç•Œï¼ˆãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢ï¼‰ã‚’è¶…ãˆã‚ï¼\nç›´è¿‘ã®æˆç¸¾ãŒã‚ã‹ã‚‹ã€Œãƒ’ã‚¹ãƒˆãƒªãƒ¼æ©Ÿèƒ½ã€ã§ã€è‡ªåˆ†ã®ã‚¯ã‚»ã‚„æˆé•·ã‚’ä¸€ç›®ã§ç¢ºèªï¼\nä½•åº¦ã‚‚æŒ‘ã‚“ã§ã€è‡ªå·±ãƒ™ã‚¹ãƒˆã‚’æ›´æ–°ã—ç¶šã‘ã‚ˆã†ï¼\nä¼‘æ†©æ™‚é–“ã®ã¡ã‚‡ã£ã¨ã—ãŸæ™‚é–“ãŒã€ç†±ã„ã€Œè‡ªåˆ†ã¨ã®æˆ¦ã„ã€ã«å¤‰ã‚ã‚‹ï¼',
                        previews: [
                            'just100s.png', // ç”»åƒ1
                            'just100s_2.png',
                            'just100s_3.png',
                            // å‹•ç”»ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«mp4ã®URLã‚’å…¥ã‚Œã‚‹
                            // 'https://www.w3schools.com/html/mov_bbb.mp4' 
                        ]
                    },
                    ColorHunter: { 
                        name: 'Color Hunter', 
                        url: 'https://330march39.github.io/games/color_hunter_24197/', 
                        cost: 30000, 
                        icon: 'gamepad-2',
                        thumbnail: 'icon_ch.png',
                        description: 'ã€ŒColor Hunterã€ãã®ã€Œé•å’Œæ„Ÿã€ã‚’è¦‹é€ƒã™ãªï¼è‰²å½©æ„Ÿè¦šã‚’æ¥µé™ã¾ã§è©¦ã™ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãªãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ ãŒç™»å ´ï¼\n\nâ—†ã€Œè‰²å½©ã€ã®ä¸–ç•Œã«é£›ã³è¾¼ã¿é™ç•Œã«æŒ‘ã‚‚ã†ï¼\nç›´æ„Ÿã‚’ç ”ãæ¾„ã¾ã›ã¦ã€Œæ­£è§£ã€ã¸ï¼ç„¡æ•°ã«ä¸¦ã¶ã‚¿ã‚¤ãƒ«ã®ä¸­ã‹ã‚‰ã€ãŸã£ãŸä¸€ã¤ã ã‘é•ã†è‰²ã‚’è¦‹ã¤ã‘å‡ºã—ã¦ã€Œã‚¹ã‚³ã‚¢ã€ã‚’ä¼¸ã°ãã†ï¼\nã‚¹ãƒ†ãƒ¼ã‚¸ãŒé€²ã‚€ã«ã¤ã‚Œã¦å¢—ãˆã¦ã„ããƒã‚¹ç›®ã€ãã—ã¦ã©ã‚“ã©ã‚“å¾®å¦™ã«ãªã£ã¦ã„ãè‰²ã®å·®â€¦ï¼\nãŠæ‰‹ã¤ãã¯å³ç¦ï¼ãƒŸã‚¹ã‚’ã™ã‚‹ã¨æŒã¡æ™‚é–“ãŒæ¸›ã£ã¦ã—ã¾ã†ã€ã‚¹ãƒªãƒ«æº€ç‚¹ã®ã€Œ60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ã€ã‚’æ¥½ã—ã‚‚ã†ï¼\n\nâ—† ã“ã“ã§ã—ã‹å‘³ã‚ãˆãªã„é”æˆæ„Ÿï¼ï¼Ÿ\nã‚¹ã‚³ã‚¢ã‚’é‡ã­ã¦ã€è‡ªåˆ†ã ã‘ã®ã€Œæœ€é«˜è¨˜éŒ²ã€ã‚’æ›´æ–°ã—ã‚ˆã†ï¼\nãƒ—ãƒ¬ã‚¤ã™ã‚‹ãŸã³ã«ç£¨ã‹ã‚Œã‚‹æ„Ÿè¦šâ€¦æ˜¨æ—¥ã®è‡ªåˆ†ã‚’è¶…ãˆãŸæ™‚ã€ç”»é¢ã«ã¯ã€ŒNew Recordã€ã®ãƒãƒƒã‚¸ãŒè¼ãï¼\nã‚·ãƒ³ãƒ—ãƒ«ãªãŒã‚‰ã‚‚å¥¥æ·±ã„ã€ç¾ã—ã„è‰²ã®ä¸–ç•Œã«å¤¢ä¸­ã«ãªã‚ã†ï¼\n\nâ—† æ „å…‰ã®ã€Œç§°å·ã€ã‚’æ‰‹ã«å…¥ã‚Œã‚ˆã†ï¼\nã€Œä¸€èˆ¬äººã€ã‹ã‚‰å§‹ã¾ã‚Šã€ç›®æŒ‡ã™ã¯è‡³é«˜ã®ã€Œè‰²å½©ã®ç¥ã€ï¼\nã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦å¤‰åŒ–ã™ã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ©ãƒ³ã‚¯ä»˜ã‘æ©Ÿèƒ½ã‚’æ­è¼‰ï¼\nã‚ãªãŸã¯ã©ã“ã¾ã§ç™»ã‚Šã¤ã‚ã‚‰ã‚Œã‚‹ã‹ã€ãã®ç›®ã§ç¢ºã‹ã‚ã‚ˆã†ï¼\n\nâ—† éš™é–“æ™‚é–“ã§ã‚µã‚¯ãƒƒã¨æ¥½ã—ã‚ã‚‹ï¼\nä¼‘æ†©æ™‚é–“ã«ã€ã‚ãªãŸã®ã€Œç›®ã€ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ',
                        previews: [
                            'colorhanter_1.png',
                            'colorhanter_2.png',
                            'colorhanter_3.png'
                        ]
                    },
                    MAKE10: { 
                        name: 'MAKE 10', 
                        url: 'https://330march39.github.io/games/make10_26518/', 
                        cost: 50000, 
                        icon: 'gamepad-2',
                        thumbnail: 'icon_m10.png',
                        description: 'ã€ŒMake 10ã€æ•°å­—ãŒé™ã‚Šæ³¨ãæ–°æ„Ÿè¦šã®è„³ãƒˆãƒ¬ã«ã‚ˆã†ã“ãã€‚ç›´æ„Ÿã¨è¨ˆç®—åŠ›ãŒè©¦ã•ã‚Œã‚‹ã€ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãƒ»è½ã¡ç‰©ãƒ‘ã‚ºãƒ«ï¼\n\nâ—†ã€Œè¶³ã—ç®—ã€ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¶ˆæ»…ã•ã›ã‚ï¼\nä¸Šã‹ã‚‰è½ã¡ã¦ãã‚‹æ•°å­—ã‚’å·§ã¿ã«ç©ã¿ä¸Šã’ã€ç¸¦ã®åˆè¨ˆã‚’ã€ŒTARGETã€ã«åˆã‚ã›ã‚ˆã†ï¼\nç‹™ã„é€šã‚Šã«æ¶ˆãˆãŸæ™‚ã®çˆ½å¿«æ„Ÿã¨ã€ç¾ã—ã„å…‰ã®æ¼”å‡ºãŒã‚¯ã‚»ã«ãªã‚‹ï¼\n\nâ—† å¸¸è­˜ã‚’è¦†ã™ã€Œã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¤‰å‹•ã€ã‚·ã‚¹ãƒ†ãƒ ï¼\nç›®æ¨™ã¯ã€Œ10ã€ã ã‘ã˜ã‚ƒãªã„ï¼ï¼Ÿã‚²ãƒ¼ãƒ ãŒé€²ã‚€ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æ•°å€¤ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¤‰åŒ–ï¼\nã€Œ12ã€ã€Œ15ã€â€¦åˆ»ã€…ã¨å¤‰ã‚ã‚‹ãƒ«ãƒ¼ãƒ«ã«é ­ã‚’åˆ‡ã‚Šæ›¿ãˆã€æŸ”è»Ÿãªæ€è€ƒã§ãƒ”ãƒ³ãƒã‚’åˆ‡ã‚ŠæŠœã‘ã‚ï¼\n\nâ—† æ²¡å…¥æ„Ÿã‚’é«˜ã‚ã‚‹ã‚µã‚¤ãƒãƒ¼ç©ºé–“ï¼\næ´—ç·´ã•ã‚ŒãŸã‚°ãƒ©ã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ã¨å¿ƒåœ°ã‚ˆã„ã‚µã‚¦ãƒ³ãƒ‰ãŒã€ã‚ãªãŸã‚’ã‚¾ãƒ¼ãƒ³ã¸ã¨èª˜ã†ï¼\næ™‚é–“ã‚’å¿˜ã‚Œã¦æ²¡é ­ã§ãã‚‹ã€æ¥µä¸Šã®ãƒ—ãƒ¬ã‚¤ä½“é¨“ã‚’ãã®æ‰‹ã«ï¼\n\nâ—† å·±ã®é™ç•Œï¼ˆãƒã‚¤ã‚¹ã‚³ã‚¢ï¼‰ã‚’æ›´æ–°ã›ã‚ˆï¼\nå˜ç´”ã«è¦‹ãˆã¦å¥¥æ·±ã„ã€çµ‚ã‚ã‚Šã®ãªã„è¨ˆç®—ã®æ—…ï¼\nä¸–ç•Œã§ä¸€ç•ªã‚¯ãƒ¼ãƒ«ãªè„³ãƒˆãƒ¬ã‚’ä»Šã™ãå§‹ã‚ã‚ˆã†ï¼',
                        previews: [
                            'make10_1.png',
                            'make10_2.png',
                            'make10_3.png'
                        ]
                    },
                    EraserStack: { 
                        name: 'Eraser Stack', 
                        url: 'https://330march39.github.io/games/eraser_stack_19054/', 
                        cost: 60000, 
                        icon: 'gamepad-2',
                        thumbnail: 'icon_es.png',
                        description: 'ã€Œã‚ã®é ƒã®éŠã³ã€ãŒã‚¹ãƒãƒ›ã§é€²åŒ–ï¼ï¼Ÿæ¶ˆã—ã‚´ãƒ ã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°ã‚²ãƒ¼ãƒ ã€ŒEraser Stackã€\n\nâ—† æºã‚Œã‚‹æ¶ˆã—ã‚´ãƒ ã‚’ç©ã¿ä¸Šã’ã‚ï¼\nãƒ«ãƒ¼ãƒ«ã¯è¶…ã‚·ãƒ³ãƒ—ãƒ«ã€ç‹™ã„ã‚’å®šã‚ã¦ã€ŒDROPã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ï¼\nå·¦å³ã«æºã‚Œã‚‹æ¶ˆã—ã‚´ãƒ ã‚’ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚ˆãè½ã¨ã—ã€å°åº§ã®ä¸Šã«ç©ã¿é‡ã­ã¦ã„ã“ã†ï¼\nãƒªã‚¢ãƒ«ãªç‰©ç†æŒ™å‹•ãŒç”Ÿã¿å‡ºã™ã€Œäºˆæƒ³å¤–ã®ãƒã‚¦ãƒ³ãƒ‰ã€ã‚„ã€Œå´©è½ã®å±æ©Ÿã€â€¦\næŒ‡å…ˆã®ï¼‘ãƒŸãƒªãŒé‹å‘½ã‚’åˆ†ã‘ã‚‹ã€ãƒãƒ©ãƒãƒ©ãƒ‰ã‚­ãƒ‰ã‚­ã®ãƒãƒ©ãƒ³ã‚¹ä½“é¨“ã‚’æ¥½ã—ã‚‚ã†ï¼\n\nâ—† ç›®æŒ‡ã›ã€å¤©ç©ºã®ã‚¿ãƒ¯ãƒ¼å»ºè¨­ï¼\né«˜ãç©ã‚ã°ç©ã‚€ã»ã©è¦–ç‚¹ã‚‚ä¸Šæ˜‡ï¼\nå®‰å®šé‡è¦–ã§æ…é‡ã«ã„ãã‹ã€æ”»ã‚ã®ç©ã¿æ–¹ã§è¨˜éŒ²ã‚’ç‹™ã†ã‹â€¦æˆ¦ç•¥ã¯å›æ¬¡ç¬¬ï¼\nè‡ªå·±ãƒ™ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹ã¨ã€ç”»é¢ã„ã£ã±ã„ã«ç¥ç¦ã®ã€Œãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ç´™å¹é›ªã€ãŒèˆã†ï¼\nè¼ãã€ŒNEW RECORDã€ã®æ–‡å­—ã‚’ãã®æ‰‹ã§æ´ã¿å–ã‚Œï¼\n\nâ—† ä¼‘ã¿æ™‚é–“ã®æš‡ã¤ã¶ã—ã«æœ€é©ï¼\nã„ã¤ã‚‚ã®ã€Œæ¶ˆã—ã‚´ãƒ ã€ã®è³ªæ„Ÿã¨ã€å¿ƒåœ°ã‚ˆã„ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒé›†ä¸­åŠ›ã‚’é«˜ã‚ã‚‹ï¼\nã¡ã‚‡ã£ã¨ã—ãŸéš™é–“æ™‚é–“ã«ã€çµ‚ã‚ã‚‰ãªã„æŒ‘æˆ¦ã‚’å§‹ã‚ã‚ˆã†ï¼',
                        previews: [
                            'eraserstack_1.png',
                            'eraserstack_2.png'
                        ]
                    },
                    NumberPlace: { 
                        name: 'ãƒŠãƒ³ãƒ—ãƒ¬', 
                        url: 'https://330march39.github.io/games/nanpure_76382/', 
                        cost: 30000, 
                        icon: 'gamepad-2',
                        thumbnail: 'icon_nanpure.png',
                        description: 'ç©¶æ¥µã®æš‡ã¤ã¶ã—ï¼ã‚·ãƒ³ãƒ—ãƒ«ã§ç¾ã—ã„ã€ŒãƒŠãƒ³ãƒ—ãƒ¬ã€ãŒç™»å ´ï¼\n\nâ—†æ•°å­—ã‚’åŸ‹ã‚ã¦è„³ã‚’æ´»æ€§åŒ–ã•ã›ã‚ˆã†ï¼\nç¸¦ãƒ»æ¨ªãƒ»3Ã—3ã®ãƒ–ãƒ­ãƒƒã‚¯ã«1ã‹ã‚‰9ã®æ•°å­—ã‚’å…¥ã‚Œã‚‹ã ã‘ï¼ã‚·ãƒ³ãƒ—ãƒ«ã ã‘ã©å¥¥æ·±ã„ãƒ‘ã‚ºãƒ«ã«æŒ‘æˆ¦ã—ã¦ã€é ­ã®ä½“æ“ã‚’å§‹ã‚ã‚ˆã†ï¼\nåˆå¿ƒè€…å‘ã‘ã®ã€Œã‚„ã•ã—ã„ã€ã‹ã‚‰ã€ä¸Šç´šè€…ã‚‚å”¸ã‚‹ã€Œã‚€ãšã‹ã—ã„ã€ã¾ã§ã€3ã¤ã®é›£æ˜“åº¦ã§è‡ªåˆ†ã«åˆã£ãŸãƒ¬ãƒ™ãƒ«ã‚’é¸ã¹ã‚‹ï¼\n\nâ—†å¿ƒåœ°ã‚ˆã„æ“ä½œæ„Ÿã¨æ¼”å‡ºã«ãƒãƒã‚‹ï¼ï¼Ÿ\næ•°å­—ãŒæƒã†ã¨åºƒãŒã‚‹ã‚¦ã‚§ãƒ¼ãƒ–ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã€ã‚¯ãƒªã‚¢æ™‚ã®ç´™å¹é›ªãªã©ã€ãƒ—ãƒ¬ã‚¤ã‚’ç››ã‚Šä¸Šã’ã‚‹æ¼”å‡ºãŒã„ã£ã±ã„ï¼\næ´—ç·´ã•ã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³ã§è¦‹ã‚„ã™ãã€ç›´æ„Ÿçš„ãªæ“ä½œã§ã‚µã‚¯ã‚µã‚¯éŠã¹ã‚‹ã‹ã‚‰ã€ã¤ã„ã¤ã„å¤¢ä¸­ã«ãªã£ã¡ã‚ƒã†ã‹ã‚‚â€¦ï¼ï¼Ÿ\n\nâ—†ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚’ç›®æŒ‡ã—ã¦é™ç•Œã«æŒ‘ã‚ï¼\nãƒŸã‚¹ã¯3å›ã¾ã§ï¼ç·Šå¼µæ„Ÿã®ã‚ã‚‹ãƒ—ãƒ¬ã‚¤ã§é›†ä¸­åŠ›ã‚¢ãƒƒãƒ—ï¼\nã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ ã¯è¨˜éŒ²ã•ã‚Œã‚‹ã‹ã‚‰ã€éå»ã®è‡ªåˆ†ã‚’è¶…ãˆã¦ã€Œãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã€æ›´æ–°ã‚’ç›®æŒ‡ãã†ï¼\n\nâ—†ã„ã¤ã§ã‚‚ã©ã“ã§ã‚‚æ‰‹è»½ã«ãƒ—ãƒ¬ã‚¤ï¼\næ¯æ—¥ã®éš™é–“æ™‚é–“ã«ã€æ¥µä¸Šã®ãƒ‘ã‚ºãƒ«ä½“é¨“ã‚’å‘³ã‚ã„å°½ããã†ï¼',
                        previews: [
                            'nanpure_1.png',
                            'nanpure_2.png'
                        ]
                    },
                    
                },

                // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã“ã“ã«éŸ³æ¥½ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ â–¼â–¼â–¼
                // éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ã¯ã”è‡ªèº«ã§ã‚µãƒ¼ãƒãƒ¼ç­‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãã®URLã‚’è²¼ã£ã¦ãã ã•ã„
                // å‹•ä½œç¢ºèªç”¨ã«ãƒ•ãƒªãƒ¼ç´ æã®URLã‚’å…¥ã‚Œã¦ã„ã¾ã™
                music: {
                    // ID: { name: 'æ›²å', url: 'éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®URL', cost: å¿…è¦LP }
                    bgm_1: { name: 'Chill Beats', url: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3', cost: 60000 },
                    bgm_2: { name: 'You Far Away', url: 'MusMus-BGM-131.mp3', cost: 70000 },
                    bgm_3: { name: 'Bossa in Blue', url: 'MusMus-BGM-181.mp3', cost: 80000 },
                    bgm_4: { name: 'Our Dreams', url: 'MusMus-BGM-180.mp3', cost: 80000 },
                    bgm_5: { name: 'Shelves of Horizons', url: 'MusMus-BGM-179.mp3', cost: 90000 },
                    bgm_6: { name: 'Loving You Hurts Me', url: 'MusMus-BGM-187.mp3', cost: 100000 },
                    bgm_7: { name: 'After School Pop', url: 'MusMus-BGM-174.mp3', cost: 60000 },
                    
                    // ä¾‹: è‡ªåˆ†ã®æ›²ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
                    // mySong1: { name: 'My Study BGM', url: './music/mysong.mp3', cost: 300 },
                }
            };

            let state;
            let chartInstances = {};
            let isFeedbackMode = false;
            let isFeedbackExternalOpen = false;
            let breakSortable = null;
            let focusTimer = { interval: null, defaultTime: 0, timeLeft: 0, isRunning: false, isPaused: false };
            let stopwatch = { interval: null, startTime: 0, elapsedTime: 0, isRunning: false, isPaused: false };
            let miniTimerTemporarilyHidden = false;
            let quizTimer = { startTime: null };

            let bannerInterval = null;

            let previewAudio = new Audio(); // è©¦è´ç”¨
            let previewTimeout = null;      // 30ç§’åœæ­¢ç”¨ã‚¿ã‚¤ãƒãƒ¼
            
            const bgmAudio = new Audio();
            bgmAudio.loop = false; // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†ç”Ÿã®ãŸã‚ãƒ«ãƒ¼ãƒ—ã¯æ‰‹å‹•åˆ¶å¾¡
            let currentTrackIndex = 0;

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);
            
            let homeTaskListEl, newTaskInput, newTaskNumberEl;

            let quest = {
                plan: [], // { id, type: 'section' | 'break', text?, duration }
                active: false,
                currentIndex: -1,
                timerInterval: null,
                timeLeft: 0,
                breakWindow: null
            };

            // --- ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ã‚¯ãƒ©ã‚¹ï¼ˆå®Œå…¨ç‰ˆï¼šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç›£è¦–å¯¾å¿œï¼‰ ---
            class SwipeHandler {
                constructor(element, options = {}) {
                    this.container = element;
                    this.content = element.querySelector('.swipe-content');
                    this.actionsContainer = element.querySelector('.swipe-actions');
                    
                    this.onComplete = options.onComplete || null;
                    this.onDelete = options.onDelete || null;
                    
                    this.actionsWidth = this.actionsContainer ? this.actionsContainer.offsetWidth : 0;
                    
                    this.startX = 0;
                    this.startY = 0;
                    this.currentX = 0;
                    this.startOffset = 0;
                    
                    this.isDragging = false; 
                    this.isSwiping = false;  
                    this.currentTouchId = null;

                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒã‚¤ãƒ³ãƒ‰ï¼ˆremoveEventListenerç”¨ï¼‰
                    this.handleMove = this.handleMove.bind(this);
                    this.handleEnd = this.handleEnd.bind(this);

                    this.initEvents();
                }
            
                initEvents() {
                    // é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆã ã‘ã¯è¦ç´ è‡ªèº«ã«è¨­å®š
                    this.content.addEventListener('touchstart', (e) => this.handleStart(e), { passive: false });
                    this.content.addEventListener('mousedown', (e) => this.handleStart(e));

                    // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒãƒ–ãƒªãƒ³ã‚°åœæ­¢ç”¨ï¼‰
                    const btns = this.actionsContainer ? this.actionsContainer.querySelectorAll('.swipe-btn') : [];
                    btns.forEach(btn => {
                        // ã‚¿ãƒƒãƒé–‹å§‹æ™‚ã¯ãƒãƒ–ãƒªãƒ³ã‚°ã‚’æ­¢ã‚ã‚‹ã ã‘
                        btn.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: true });
                        
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (btn.classList.contains('btn-complete')) {
                                this.snapToClose();
                                if (this.onComplete) setTimeout(() => this.onComplete(), 300);
                            } else if (btn.classList.contains('btn-delete')) {
                                this.performDelete();
                            }
                        });
                    });
                }

                handleStart(e) {
                    // æ—¢ã«ãƒ‰ãƒ©ãƒƒã‚°ä¸­ãªã‚‰ç„¡è¦–
                    if (this.isDragging) return;

                    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãªã‚‰ç„¡è¦–
                    if (e.target.tagName === 'INPUT') return;

                    // æ—¢ã«é–‹ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§ä¸­èº«ã‚’è§¦ã£ãŸã‚‰é–‰ã˜ã‚‹
                    if (this.container.classList.contains('swiped-open') && e.target.closest('.swipe-content')) {
                        e.preventDefault(); // ã“ã“é‡è¦ï¼šé–‰ã˜ã‚‹å‹•ä½œã¨èªè­˜ã•ã›ã‚‹
                        this.snapToClose();
                        return;
                    }

                    let clientX, clientY;

                    if (e.type === 'touchstart') {
                        const touch = e.changedTouches[0];
                        this.currentTouchId = touch.identifier;
                        clientX = touch.clientX;
                        clientY = touch.clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }

                    this.isDragging = true;
                    this.isSwiping = false;
                    this.startX = clientX;
                    this.startY = clientY;

                    const style = window.getComputedStyle(this.content);
                    const matrix = new WebKitCSSMatrix(style.transform);
                    this.startOffset = matrix.m41; 

                    this.container.classList.add('is-dragging');

                    // â˜…é‡è¦â˜…: ç§»å‹•ã¨çµ‚äº†ã®ç›£è¦–ã‚’ã€Œwindowã€ã«å¯¾ã—ã¦è¡Œã†
                    // ã“ã‚Œã«ã‚ˆã‚Šã€æŒ‡ãŒè¦ç´ ã®å¤–ã«å‡ºã¦ã‚‚ã€ç”»é¢ç«¯ã«è¡Œã£ã¦ã‚‚è¿½è·¡ã§ãã‚‹
                    window.addEventListener('touchmove', this.handleMove, { passive: false });
                    window.addEventListener('touchend', this.handleEnd);
                    window.addEventListener('touchcancel', this.handleEnd); // ã‚·ã‚¹ãƒ†ãƒ ã®å‰²ã‚Šè¾¼ã¿å¯¾ç­–
                    
                    window.addEventListener('mousemove', this.handleMove);
                    window.addEventListener('mouseup', this.handleEnd);
                }
        
                handleMove(e) {
                    if (!this.isDragging) return;

                    let clientX, clientY;

                    if (e.type === 'touchmove') {
                        // è¿½è·¡ä¸­ã®æŒ‡ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
                        const touch = Array.from(e.changedTouches).find(t => t.identifier === this.currentTouchId);
                        if (!touch) return; 
                        clientX = touch.clientX;
                        clientY = touch.clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }
        
                    const diffX = clientX - this.startX;
                    const diffY = clientY - this.startY;
        
                    if (!this.isSwiping) {
                        // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®š
                        if (Math.abs(diffY) > Math.abs(diffX)) {
                            this.endDrag(); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­æ­¢
                            return;
                        }
                        // éŠã³ï¼ˆä¸æ„Ÿå¸¯ï¼‰
                        if (Math.abs(diffX) < 10) return; 
                        
                        this.isSwiping = true;
                        this.container.classList.add('is-swiping');
                    }

                    // ã‚¹ãƒ¯ã‚¤ãƒ—ç¢ºå®šå¾Œã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
                    if (e.cancelable) e.preventDefault();
        
                    let newX = this.startOffset + diffX;
        
                    // æŠµæŠ—ã¨åˆ¶é™
                    if (newX > 0) newX = newX * 0.2; // å³ã¸ã®å¼•ã£å¼µã‚ŠæŠµæŠ—
                    if (newX < -this.actionsWidth - 100) {
                        // å·¦ã¸ã®è¡ŒãéãæŠµæŠ—
                        const extra = newX - (-this.actionsWidth - 100);
                        newX = -this.actionsWidth - 100 + (extra * 0.2);
                    }
        
                    this.currentX = newX;
                    this.content.style.transform = `translateX(${newX}px)`;
                }
        
                handleEnd(e) {
                    if (!this.isDragging) return;

                    if (e.type === 'touchend' || e.type === 'touchcancel') {
                        const touch = Array.from(e.changedTouches).find(t => t.identifier === this.currentTouchId);
                        if (!touch) return; 
                    }

                    this.endDrag(); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è§£é™¤ç­‰ã®å…±é€šå‡¦ç†

                    // ä½ç½®åˆ¤å®š
                    if (this.currentX < -150) { // æ·±ãã‚¹ãƒ¯ã‚¤ãƒ—ã—ãŸã‚‰å‰Šé™¤
                        if (this.onDelete) {
                            this.content.style.transform = `translateX(-120vw)`; // ç”»é¢å¤–ã¸
                            this.performDelete();
                        } else {
                            this.snapToOpen();
                        }
                    } else if (this.currentX < -(this.actionsWidth / 2)) {
                        this.snapToOpen();
                    } else {
                        this.snapToClose();
                    }
                }

                // çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
                endDrag() {
                    this.isDragging = false;
                    this.isSwiping = false;
                    this.currentTouchId = null;
                    
                    this.container.classList.remove('is-dragging');
                    this.container.classList.remove('is-swiping');

                    // â˜…é‡è¦â˜…: windowã¸ã®ç›£è¦–ã‚’è§£é™¤ã™ã‚‹
                    window.removeEventListener('touchmove', this.handleMove);
                    window.removeEventListener('touchend', this.handleEnd);
                    window.removeEventListener('touchcancel', this.handleEnd);
                    
                    window.removeEventListener('mousemove', this.handleMove);
                    window.removeEventListener('mouseup', this.handleEnd);
                }
        
                snapToOpen() {
                    this.content.style.transform = `translateX(-${this.actionsWidth}px)`;
                    this.container.classList.add('swiped-open');
                }
        
                snapToClose() {
                    this.content.style.transform = `translateX(0px)`;
                    this.container.classList.remove('swiped-open');
                }
        
                performDelete() {
                    this.container.style.height = this.container.offsetHeight + 'px';
                    this.container.classList.add('swipe-deleting');
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…ã¡
                    requestAnimationFrame(() => {
                        this.container.style.height = '0px';
                        setTimeout(() => {
                            if (this.onDelete) this.onDelete();
                        }, 300);
                    });
                }
            }

            // ==========================================
            // â–¼â–¼â–¼ æ±ç”¨ã‚µãƒ–ãƒšãƒ¼ã‚¸ç®¡ç†ã‚¯ãƒ©ã‚¹ (ã“ã‚Œ1ã¤ã§å…¨ãƒšãƒ¼ã‚¸å¯¾å¿œ) â–¼â–¼â–¼
            // ==========================================
            class SubPage {
                constructor(elementId, options = {}) {
                    this.el = document.getElementById(elementId);
                    this.appContainer = document.getElementById('app-container');
                    this.onOpen = options.onOpen || null;   // é–‹ãã¨ãã«å®Ÿè¡Œã™ã‚‹é–¢æ•°
                    this.onClose = options.onClose || null; // é–‰ã˜ã‚‹ã¨ãã«å®Ÿè¡Œã™ã‚‹é–¢æ•°
                    
                    this.closeTimer = null;

                    // ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ç”¨å¤‰æ•°
                    this.touchStartX = 0;
                    this.touchStartY = 0;
                    this.touchCurrentX = 0;
                    this.isEdgeSwipe = false;
                    this.swipeTouchId = null;

                    // åˆæœŸåŒ–
                    this.initEvents();
                }

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                initEvents() {
                    if (!this.el) return;

                    // ã‚¿ãƒƒãƒé–‹å§‹
                    this.el.addEventListener('touchstart', (e) => {
                        if (this.isEdgeSwipe) return;
                        const touch = e.changedTouches[0];
                        this.touchStartX = touch.clientX;
                        this.touchStartY = touch.clientY;
                        
                        // â–¼â–¼â–¼ è¿½åŠ : ã‚¿ãƒƒãƒ—ã ã‘ã§çµ‚ã‚ã£ãŸå ´åˆã®èª¤åˆ¤å®šé˜²æ­¢ã®ãŸã‚ã€ç¾åœ¨åœ°ã‚‚åˆæœŸåŒ– â–¼â–¼â–¼
                        this.touchCurrentX = this.touchStartX; 
                        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

                        // ç”»é¢å·¦ç«¯(50pxä»¥å†…)ã‹ã‚‰ã®æ“ä½œã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—ãƒãƒƒã‚¯ã¨ã¿ãªã™
                        if (this.touchStartX < 50) {
                            this.isEdgeSwipe = true;
                            this.swipeTouchId = touch.identifier;
                            this.el.classList.add('is-swiping');
                            this.appContainer.style.transition = 'none';
                        }
                    }, { passive: true });

                    // ã‚¿ãƒƒãƒç§»å‹•
                    this.el.addEventListener('touchmove', (e) => {
                        if (!this.isEdgeSwipe) return;
                        
                        const touch = Array.from(e.changedTouches).find(t => t.identifier === this.swipeTouchId);
                        if (!touch) return;

                        this.touchCurrentX = touch.clientX;
                        const currentY = touch.clientY;

                        const diffX = this.touchCurrentX - this.touchStartX;
                        const diffY = currentY - this.touchStartY;

                        // â–¼â–¼â–¼ ç¸¦ç§»å‹•åˆ¤å®š (ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ãƒãƒƒã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«) â–¼â–¼â–¼
                        if (Math.abs(diffY) > Math.abs(diffX)) {
                            this.resetSwipeState();
                            return;
                        }

                        if (diffX > 0) {
                            if (e.cancelable) e.preventDefault();
                            
                            // ãƒšãƒ¼ã‚¸ã®ç§»å‹•
                            this.el.style.transform = `translateX(${diffX}px)`;
                            
                            // èƒŒæ™¯ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ã®ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ç§»å‹•
                            const screenWidth = window.innerWidth;
                            const progress = Math.min(diffX / screenWidth, 1);
                            const startX = -30;
                            const currentMainX = startX + (Math.abs(startX) * progress);
                            this.appContainer.style.transform = `translateX(${currentMainX}%)`;
                        }
                    }, { passive: false });

                    // ã‚¿ãƒƒãƒçµ‚äº†
                    this.el.addEventListener('touchend', (e) => {
                        if (!this.isEdgeSwipe) return;
                        const touch = Array.from(e.changedTouches).find(t => t.identifier === this.swipeTouchId);
                        if (!touch) return;

                        this.el.classList.remove('is-swiping');
                        this.appContainer.style.transition = '';

                        const diff = this.touchCurrentX - this.touchStartX;
                        const threshold = window.innerWidth / 3; // ç”»é¢ã®1/3ä»¥ä¸Šå‹•ã‹ã—ãŸã‚‰é–‰ã˜ã‚‹

                        if (diff > threshold) {
                            this.close(); // é–‰ã˜ã‚‹
                        } else {
                            this.resetPosition(); // å…ƒã«æˆ»ã™
                        }
                        
                        this.isEdgeSwipe = false;
                        this.swipeTouchId = null;
                    });
                }

                // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­æ–­æ™‚ã®ãƒªã‚»ãƒƒãƒˆ
                resetSwipeState() {
                    this.isEdgeSwipe = false;
                    this.el.classList.remove('is-swiping');
                    this.appContainer.style.transition = '';
                    this.resetPosition();
                }

                // ä½ç½®ã‚’å…ƒã«æˆ»ã™ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ï¼‰
                resetPosition() {
                    this.el.style.transform = '';
                    this.appContainer.style.transform = '';
                    this.appContainer.style.filter = '';
                }

                // ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                open() {
                    if (this.closeTimer) {
                        clearTimeout(this.closeTimer);
                        this.closeTimer = null;
                    }

                    // é–‹ãå‰ã®å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿ã®æç”»ãªã©ï¼‰
                    if (this.onOpen) this.onOpen();

                    // ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
                    this.resetPosition();
                    
                    // è¡¨ç¤ºï¼†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    this.el.style.display = 'flex';
                    void this.el.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶
                    this.el.classList.add('active');
                    
                    // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’å¥¥ã¸
                    this.appContainer.classList.add('background-pushed');
                }

                // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹
                close() {
                    this.el.classList.remove('active');
                    
                    // é–‰ã˜ã‚‹å‰ã®å‡¦ç†
                    if (this.onClose) this.onClose();

                    // ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’æˆ»ã™
                    this.appContainer.classList.remove('background-pushed');
                    this.resetPosition();

                    if (this.closeTimer) clearTimeout(this.closeTimer);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
                    this.closeTimer = setTimeout(() => {
                        if (!this.el.classList.contains('active')) {
                            this.el.style.display = 'none';
                        }
                        this.closeTimer = null;
                    }, 500);
                }
            }

            // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ DOMè¦ç´ 
            const questView = $('#quest-view');
            const questPlanListEl = $('#quest-plan-list');
            const breakSettingsListEl = $('#break-settings-list');
            const startQuestBtn = $('#start-quest-btn');
            const addBreaksBtn = $('#add-breaks-btn');
            const addSectionBtn = $('#add-section-btn');
            const addBreakBtn = $('#add-break-btn');
            
            const questActiveScreen = $('#quest-active-screen');
            const questSectionView = $('#quest-section-view');
            const questBreakView = $('#quest-break-view');
            const questSectionTitle = $('#quest-section-title');
            const questTimerEl = $('#quest-timer');
            const breakTimerEl = $('#break-timer');
            const questProgressEl = $('#quest-progress');
            const endQuestBtn = $('#end-quest-btn');

            const confirmationModal = $('#confirmation-modal');
            const modalConfirmBtn = $('#modal-confirm-btn');
            const modalCancelBtn = $('#modal-cancel-btn');

            const iframeOverlay = $('#iframe-overlay');
            const breakIframe = $('#break-iframe');
            const closeIframeBtn = $('#close-iframe-btn');
            const breakIconGrid = $('#break-icon-grid');
            
            const loadState = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const defaultState = {
                    user: {
                        isRegistered: false, // åˆå›ç™»éŒ²å®Œäº†ãƒ•ãƒ©ã‚°
                        name: 'ã‚²ã‚¹ãƒˆ',
                        icon: 'ğŸ™‚',
                        grade: '',
                        id: Math.random().toString(36).substring(2, 9), // ç°¡æ˜“ID
                        feedbackRewardClaimed: false
                    },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  profile: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lp: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unlockedThemes: ['default'],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeTheme: 'default',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unlockedBackgrounds: ['default'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeBackground: 'default',
                        unlockedGames: [], // è§£æ”¾æ¸ˆã¿ã‚²ãƒ¼ãƒ ID
                        unlockedMusic: [], // è§£æ”¾æ¸ˆã¿éŸ³æ¥½ID
                        routineTemplate: [
                            { id: 'tmpl_1', type: 'section', duration: 25 * 60 }, // 25åˆ†å­¦ç¿’
                            { id: 'tmpl_3', type: 'break', duration: 5 * 60 }     // 5åˆ†ä¼‘æ†©
                        ],
                        tasksLastUpdated: null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
                    tasks: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progress: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pinnedQuizzes: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countdowns: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focus: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalTime: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'timer',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isRunning: false, // å®Ÿè¡Œä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime: null,Â  // é–‹å§‹æ™‚åˆ»ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: 0Â  Â  Â  Â // ã‚¿ã‚¤ãƒãƒ¼ã®ç·æ™‚é–“
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  studyLog: {},Â 
                    sessionLog: [],
                    savedQuest: null, // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®ä¸­æ–­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings: { backgroundScopeGlobal: true , 
                                manualDarkMode: false,
                                themeMode: 'light',   // â˜…ã“ã‚Œã‚’è¿½åŠ  (light, dark, system)
                                bgmEnabled: false,      // BGMæ©Ÿèƒ½ã®ON/OFF
                                playlist: [],           // å†ç”Ÿãƒªã‚¹ãƒˆ(IDã®é…åˆ—)
                                bgmVolume: 0.5,          // éŸ³é‡ (ä»»æ„)
                                simpleBreakIcons: false // â˜…ã“ã‚Œâ€‹â€‹ã‚’è¿½åŠ ï¼šã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹è¨­å®š
                              },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastLogin: null,
                    breakIcons: [
                        { id: 'x', name: 'X', icon: 'twitter', url: 'https://x.com', openMode: 'external', visible: true, thumbnail: 'x.png' },
                        { id: 'instagram', name: 'Instagram', icon: 'instagram', url: 'https://www.instagram.com/', openMode: 'external', visible: true, thumbnail: 'Instagram.png' },
                        { id: 'youtube', name: 'YouTube', icon: 'youtube', url: 'https://www.youtube.com/', openMode: 'external', visible: true, thumbnail: 'youtube.png' },
                    ],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼ ---
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. èª­ã¿è¾¼ã¿å…ˆã®å¤‰æ•°ã‚’ `let` ã§å®£è¨€
Â  Â  Â  Â  Â  Â  Â  Â  let loaded = {};
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedData = localStorage.getItem('quizAppUltimateV8');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒ‡ãƒ¼ã‚¿ãŒ null ã‚„ç©ºæ–‡å­—ã§ãªã„å ´åˆã®ã¿ã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ï¼ˆè§£æï¼‰ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (savedData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loaded = JSON.parse(savedData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 4. ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒç ´æï¼‰ã—ãŸå ´åˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 5. ç ´æã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€`loaded` ã¯ç©ºã®ã¾ã¾ã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('quizAppUltimateV8');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 6. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€èª­ã¿è¾¼ã‚“ã å€¤ã§ä¸Šæ›¸ãï¼ˆãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚å®‰å…¨ã«ãƒãƒ¼ã‚¸ï¼‰
Â  Â  Â  Â  Â  Â  Â  Â  // (ã“ã“ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜)
Â  Â  Â  Â  Â  Â  Â  Â  state = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...defaultState,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...loaded,
                    user: { ...defaultState.user, ...(loaded.user || {}) }, // â˜…è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  profile: { ...defaultState.profile, ...(loaded.profile || {}) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focus: { ...defaultState.focus, ...(loaded.focus || {}) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings: { ...defaultState.settings, ...(loaded.settings || {}) },
                    breakIcons: loaded.breakIcons || defaultState.breakIcons
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹å‡¦ç† (å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾æµç”¨)
Â  Â  Â  Â  Â  Â  Â  Â  if(state.user.isRegistered && state.lastLogin !== new Date().toDateString()){
                    addLP(500, 'ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹', true);
                    state.lastLogin = new Date().toDateString();
                    saveState();
                }

                // 4. ä»Šæ—¥ã®äºˆå®šãƒªã‚»ãƒƒãƒˆå‡¦ç†
Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date().toDateString();
Â  Â  Â  Â  Â  Â  Â  Â  if (state.profile.tasksLastUpdated !== today) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸãŸã‚ã€ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.tasks = []; // ã‚¿ã‚¹ã‚¯ã‚’ç©ºã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.profile.tasksLastUpdated = today; // æ›´æ–°æ—¥ã‚’ä»Šæ—¥ã«è¨­å®š
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
            
            const saveState = () => localStorage.setItem('quizAppUltimateV8', JSON.stringify(state));

            // â˜…æ–°è¦è¿½åŠ : ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦é©ç”¨ã™ã‚‹é–¢æ•°
            const applyThemeColor = () => {
                const themeId = state.profile.activeTheme;
                const theme = initialData.themes[themeId] || initialData.themes['default'];
                
                // ç¾åœ¨htmlã‚¿ã‚°ã« 'dark' ã‚¯ãƒ©ã‚¹ãŒã¤ã„ã¦ã„ã‚‹ã‹ç¢ºèª
                const isDark = document.documentElement.classList.contains('dark');
                
                // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ dark ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ãã†ã§ãªã‘ã‚Œã° color ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
                const targetColor = (isDark && theme.dark) ? theme.dark : theme.color;
            
                // å¤‰æ•°ã‚’æ›´æ–° (hoverç”¨å¤‰æ•°ã«ã‚‚åŒã˜è‰²ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ãƒ›ãƒãƒ¼å¤‰åŒ–ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–)
                document.documentElement.style.setProperty('--primary-color', targetColor);
                document.documentElement.style.setProperty('--primary-color-hover', targetColor);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®è‰²ã‚‚åŒæœŸ (ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ãƒ†ãƒ¼ãƒè‰²ã€ãƒ€ãƒ¼ã‚¯æ™‚ã¯èƒŒæ™¯è‰²)
                const metaThemeColor = document.getElementById('meta-theme-color'); // ã‚‚ã—metaã‚¿ã‚°ãŒã‚ã‚Œã°
                if (metaThemeColor && !isDark) {
                    // metaThemeColor.setAttribute('content', targetColor); // å¿…è¦ã§ã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤
                }
            };
            
           // ä¿®æ­£ç®‡æ‰€ï¼šupdateAppearance é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ä¸Šæ›¸ãã—ã¦ãã ã•ã„
            const updateAppearance = () => {
                const appContainer = $('#app-container');
                if (!state.user.isRegistered) {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.setAttribute('data-theme', 'light');
                    appContainer.style.backgroundImage = 'none'; // å£ç´™ã‚‚ãªã—
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã‚‚ç™½ã«
                    const metaThemeColor = document.getElementById('meta-theme-color');
                    if (metaThemeColor) metaThemeColor.setAttribute('content', '#ffffff');
                    return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚ãˆã‚‹
                }
                const activeBgId = state.profile.activeBackground;
                const activeBg = initialData.backgrounds[activeBgId] || initialData.backgrounds['default'];
                const isGlobal = state.settings.backgroundScopeGlobal;
                const hasImage = activeBg && activeBg.url;
            
                // --- 1. ãƒ†ãƒ¼ãƒï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ï¼‰æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ ---
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šå€¤ï¼ˆæœªè¨­å®šãªã‚‰systemï¼‰
                let targetMode = state.settings.themeMode || 'system';
            
                // â˜…é‡è¦: å£ç´™ãŒå…¨ä½“é©ç”¨(isGlobal)ã§ã€ã‹ã¤ç”»åƒãŒã‚ã‚‹(hasImage)å ´åˆ
                // å£ç´™ã®toneè¨­å®šã‚’å¼·åˆ¶çš„ã«é©ç”¨ã™ã‚‹
                if (isGlobal && hasImage) {
                    targetMode = activeBg.tone; // 'light' or 'dark' or 'system'
                }
            
                // æœ€çµ‚çš„ã«ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã¨ç…§ã‚‰ã—åˆã‚ã›ã¦ 'light' ã‹ 'dark' ã‚’æ±ºã‚ã‚‹
                let effectiveTone = targetMode;
                if (effectiveTone === 'system') {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        effectiveTone = 'dark';
                    } else {
                        effectiveTone = 'light';
                    }
                }
            
                // --- 2. HTMLè¦ç´ ã¸ã®é©ç”¨ ---
                if (effectiveTone === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            
                // --- 3. èƒŒæ™¯ç”»åƒã®é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯ ---
                if (isGlobal && hasImage) {
                    appContainer.style.backgroundImage = `url(${activeBg.url})`;
                } else {
                    appContainer.style.backgroundImage = 'none';
                }
            
                // --- 4. ãƒãƒƒãƒï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼‰ã®è‰²åŒæœŸ ---
                const metaThemeColor = document.getElementById('meta-theme-color');
                if (metaThemeColor) {
                    const headerColor = (effectiveTone === 'dark') ? '#1A1A1D' : '#ffffff';
                    metaThemeColor.setAttribute('content', headerColor);
                }
                applyThemeColor();
            };
            
            const updateLpDisplay = () => {
                const homeLp = $('#home-lp-value');
                if (homeLp) {
                    homeLp.textContent = state.profile.lp.toLocaleString(); // 3æ¡åŒºåˆ‡ã‚Šã§è¦‹ã‚„ã™ã
                }
            
                // æ–°ã—ã„ã€Œãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã€ã®LPè¡¨ç¤ºã‚’æ›´æ–°
                const statusLp = $('#status-lp-display');
                if (statusLp) {
                    statusLp.textContent = state.profile.lp;
                }
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã®ç¾åœ¨å¹´æœˆ
            let currentCalendarDate = new Date();
            let selectedReportDate = new Date(); // é¸æŠä¸­ã®æ—¥ä»˜

            // â–¼â–¼â–¼ è¿½åŠ : æ±ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡é–¢æ•° â–¼â–¼â–¼
            const openModalWithAnim = (modalId, contentId) => {
                const modal = $(`#${modalId}`);
                const content = $(`#${contentId}`);
                
                modal.classList.remove('hidden');
                // æç”»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãšã‚‰ã—ã¦CSS transitionã‚’ç™ºç«ã•ã›ã‚‹
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-0');
                    content.classList.add('animate-pop-elastic'); // å¼¾ã‚€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                });
            };

            const closeModalWithAnim = (modalId, contentId) => {
                const modal = $(`#${modalId}`);
                const content = $(`#${contentId}`);
                
                modal.classList.add('opacity-0');
                content.classList.remove('animate-pop-elastic');
                content.classList.add('scale-0'); // ç¸®å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†(300ms)å¾Œã«éè¡¨ç¤º
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            };

            // --- æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•° ---
// --- æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« (ã‚­ãƒ£ãƒ³ã‚»ãƒ«éè¡¨ç¤ºå¯¾å¿œç‰ˆ) ---
const openGeneralConfirm = (title, message, iconName, confirmText, colorClass, onConfirm, cancelText = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', onCancel = null) => {
    const modal = document.getElementById('general-confirm-modal');
    const content = document.getElementById('general-confirm-content');
    
    // å†…å®¹ã‚»ãƒƒãƒˆ
    document.getElementById('general-confirm-title').textContent = title;
    document.getElementById('general-confirm-msg').innerHTML = message.replace(/\n/g, '<br>');
    document.getElementById('general-confirm-icon').setAttribute('data-lucide', iconName || 'alert-circle');
    
    // å®Ÿè¡Œãƒœã‚¿ãƒ³è¨­å®š
    const okBtn = document.getElementById('general-confirm-ok-btn');
    okBtn.textContent = confirmText || 'å®Ÿè¡Œã™ã‚‹';
    okBtn.className = `w-full py-3.5 rounded-full text-white font-bold shadow-lg transition-transform active:scale-95 ${colorClass || 'primary-bg'}`;
    
    // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š (Cloneã—ã¦ãƒªã‚»ãƒƒãƒˆ)
    const newOkBtn = okBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
    
    newOkBtn.addEventListener('click', () => {
        closeModalWithAnim('general-confirm-modal', 'general-confirm-content');
        if (onConfirm) onConfirm();
    });

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³è¨­å®š
    const cancelBtn = document.getElementById('general-confirm-cancel-btn');
    
    // â˜…ä¿®æ­£: cancelText ãŒ null ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’éš ã™
    if (cancelText === null) {
        cancelBtn.style.display = 'none';
    } else {
        cancelBtn.style.display = ''; // è¡¨ç¤º
        cancelBtn.textContent = cancelText;
        
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        newCancelBtn.addEventListener('click', () => {
            closeModalWithAnim('general-confirm-modal', 'general-confirm-content');
            if (onCancel) onCancel();
        });
    }

    // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–° & è¡¨ç¤º
    lucide.createIcons({ root: content });
    openModalWithAnim('general-confirm-modal', 'general-confirm-content');
};

// --- è³¼å…¥ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•° (ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç‰ˆ) ---
const openPurchaseConfirm = (item, type, onConfirm) => {
    const modal = $('#purchase-confirm-modal');
    const content = $('#purchase-confirm-content');
    
    // ã‚«ãƒ†ã‚´ãƒªåã®æ—¥æœ¬èªãƒãƒƒãƒ”ãƒ³ã‚°
    const typeMap = {
        theme: 'ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼',
        background: 'å£ç´™',
        game: 'ã‚²ãƒ¼ãƒ ',
        music: 'BGM'
    };

    // ã‚¢ã‚¤ãƒ†ãƒ æƒ…å ±ã‚»ãƒƒãƒˆ
    $('#purchase-item-name').textContent = item.name;
    $('#purchase-item-type').textContent = typeMap[type] || type.toUpperCase();
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã®ç”Ÿæˆ
    const previewContainer = $('#purchase-item-preview');
    previewContainer.innerHTML = '';
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ (ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—ã”ã¨ã«æœ€é©åŒ–)
    if (type === 'theme') {
        previewContainer.innerHTML = `
            <div class="w-16 h-16 rounded-full border-4 border-white dark:border-gray-700 shadow-lg" 
                 style="background-color: ${item.color}">
            </div>`;
    } else if (type === 'background') {
        const bgStyle = item.url ? `background-image: url(${item.url})` : 'background-color: #6b7280';
        previewContainer.innerHTML = `
            <div class="w-16 h-24 rounded-xl bg-cover bg-center border-2 border-white dark:border-gray-700 shadow-lg" 
                 style="${bgStyle}">
            </div>`;
    } else if (type === 'game') {
        // ã‚²ãƒ¼ãƒ ã®å ´åˆ: ã‚µãƒ ãƒã‚¤ãƒ«ãŒã‚ã‚Œã°ç”»åƒã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°ã‚¢ã‚¤ã‚³ãƒ³
        if (item.thumbnail) {
            previewContainer.innerHTML = `
                <div class="w-20 h-20 rounded-2xl border-2 border-white dark:border-gray-700 shadow-lg overflow-hidden bg-gray-100">
                    <img src="${item.thumbnail}" alt="game" class="w-full h-full object-cover">
                </div>`;
        } else {
            const iconName = item.icon || 'gamepad-2';
            previewContainer.innerHTML = `
                <div class="w-20 h-20 rounded-2xl bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-500 shadow-lg">
                    <i data-lucide="${iconName}" class="w-10 h-10"></i>
                </div>`;
        }
    } else {
        // éŸ³æ¥½ãªã©
        const iconName = item.icon || 'music';
        previewContainer.innerHTML = `
            <div class="w-20 h-20 rounded-2xl bg-pink-100 dark:bg-pink-900/50 flex items-center justify-center text-pink-500 shadow-lg">
                <i data-lucide="${iconName}" class="w-10 h-10"></i>
            </div>`;
    }

    // LPè¨ˆç®—è¡¨ç¤º
    const currentLP = state.profile.lp;
    const cost = item.cost;
    const afterLP = currentLP - cost;

    $('#purchase-current-lp').textContent = currentLP.toLocaleString();
    $('#purchase-cost-lp').textContent = `- ${cost.toLocaleString()}`;
    const afterEl = $('#purchase-after-lp');
    afterEl.textContent = afterLP.toLocaleString();
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹è¨­å®š (è‰²ãŒè¶³ã‚Šã‚‹ã‹ã©ã†ã‹)
    const okBtn = $('#purchase-confirm-ok-btn');
    // æ±ç”¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«åˆã‚ã›ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ±ä¸€
    okBtn.className = "w-full py-3.5 rounded-full font-bold shadow-lg transition-transform active:scale-95 flex items-center justify-center";

    if (afterLP >= 0) {
        afterEl.className = "font-black text-xl primary-text";
        okBtn.disabled = false;
        okBtn.classList.add('primary-bg', 'text-white');
        okBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
    } else {
        afterEl.className = "font-black text-xl text-red-500";
        okBtn.disabled = true;
        okBtn.classList.remove('primary-bg', 'text-white');
        okBtn.classList.add('bg-gray-400', 'text-white', 'cursor-not-allowed');
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š (cloneNodeã§å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤)
    const newOkBtn = okBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
    
    newOkBtn.addEventListener('click', () => {
        closeModalWithAnim('purchase-confirm-modal', 'purchase-confirm-content');
        if (onConfirm) onConfirm();
    });

    const cancelBtn = $('#purchase-confirm-cancel-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    
    newCancelBtn.addEventListener('click', () => {
        closeModalWithAnim('purchase-confirm-modal', 'purchase-confirm-content');
    });

    lucide.createIcons({ root: content });
    openModalWithAnim('purchase-confirm-modal', 'purchase-confirm-content');
};
// â–¼â–¼â–¼ è¿½åŠ : ç”»é¢ã®å‘ãã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•° â–¼â–¼â–¼
const controlScreenOrientation = async (mode) => {
    // APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯iOSã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
    if (!screen.orientation || !screen.orientation.lock) return;

    try {
        if (mode === 'quest') {
            // ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹æ™‚: ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«ã—ã¦æ¨ªç”»é¢ã‚’è¨±å¯/å›ºå®š
            // Androidã§ã¯ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«ã—ãªã„ã¨lockãŒåŠ¹ã‹ãªã„ã“ã¨ãŒå¤šã„ã§ã™
            await document.documentElement.requestFullscreen().catch(() => {}); // ã‚¨ãƒ©ãƒ¼ç„¡è¦–
            
            // 'landscape' ã§æ¨ªå‘ãã«å›ºå®šã—ã¾ã™
            await screen.orientation.lock('landscape').catch(() => {
                // ãƒ­ãƒƒã‚¯å¤±æ•—æ™‚ã¯ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆè‡ªç„¶ãªå›è»¢ã«ä»»ã›ã‚‹ï¼‰
                screen.orientation.unlock();
            });
        } else {
            // é€šå¸¸æ™‚: ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤ã—ã¦ç¸¦ç”»é¢ã«å›ºå®š
            if (document.fullscreenElement) {
                await document.exitFullscreen().catch(() => {});
            }
            
            // 'portrait' ã§ç¸¦å‘ãã«å›ºå®šã—ã¾ã™
            await screen.orientation.lock('portrait').catch(() => {});
        }
    } catch (e) {
        console.warn('ç”»é¢å›è»¢ã®åˆ¶å¾¡ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
    }
};
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
            const renderEngine = {
                pages: {
                    'home-page': () => {
                        // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆ: é«˜é€Ÿã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ (åˆ¤å®šç·©å’Œç‰ˆ) â–¼â–¼â–¼
                        const bannerContainer = document.getElementById('home-banner-carousel');
                        
                        if (bannerContainer && !bannerContainer.dataset.initialized) {
                            bannerContainer.dataset.initialized = 'true';

                            const originalBanners = initialData.banners || [];
                            if (originalBanners.length === 0) return;

                            const count = originalBanners.length;

                            // 1. ç”»åƒç”Ÿæˆ (5ã‚»ãƒƒãƒˆä½œæˆ)
                            // â–¼â–¼â–¼ ä¿®æ­£: data-linkå±æ€§ã‚’è¿½åŠ ã—ã€ã‚«ãƒ¼ã‚½ãƒ«ã‚’æŒ‡ãƒãƒ¼ã‚¯ã«ã™ã‚‹ â–¼â–¼â–¼
                            const createItemsHTML = (items) => items.map(b => `
                                <div class="banner-item cursor-pointer" data-link="${b.link || ''}">
                                    <img src="${b.url}" alt="banner" onerror="this.src='https://placehold.co/600x400/4f46e5/ffffff?text=Banner+${b.id}'">
                                </div>
                            `).join('');
                            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

                            bannerContainer.innerHTML = 
                                createItemsHTML(originalBanners) + 
                                createItemsHTML(originalBanners) + 
                                createItemsHTML(originalBanners) + 
                                createItemsHTML(originalBanners) + 
                                createItemsHTML(originalBanners);

                            const centerSetIndex = 2; // çœŸã‚“ä¸­ã®ã‚»ãƒƒãƒˆ (Set 2)

                            // 2. åº§æ¨™è¨ˆç®—ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
                            const getOneSetWidth = () => {
                                const item = bannerContainer.querySelector('.banner-item');
                                if (!item) return 0;
                                const gap = 16; 
                                return (item.offsetWidth + gap) * count;
                            };

                            // 3. åˆæœŸä½ç½®åˆã‚ã› (çœŸã‚“ä¸­ã®ã‚»ãƒƒãƒˆã¸)
                            const jumpToCenter = () => {
                                const setWidth = getOneSetWidth();
                                if (setWidth > 0) {
                                    bannerContainer.scrollTo({
                                        left: setWidth * centerSetIndex,
                                        behavior: 'instant'
                                    });
                                }
                            };
                            
                            // æç”»å¾…ã¡
                            setTimeout(jumpToCenter, 50);
                            setTimeout(jumpToCenter, 300);

                            // 4. ã€é‡è¦ã€‘ãƒ«ãƒ¼ãƒ—ç›£è¦– (åˆ¤å®šã‚’ç·©ãã™ã‚‹)
                            const onScroll = () => {
                                const setWidth = getOneSetWidth();
                                if (setWidth === 0) return;

                                const currentScroll = bannerContainer.scrollLeft;
                                
                                // åˆ¤å®šãƒ©ã‚¤ãƒ³:
                                // å·¦å´: Set 1 ã‚ˆã‚Šå·¦ã«è¡Œã£ãŸã‚‰ (Set 0 ã«å…¥ã‚Šãã†ã«ãªã£ãŸã‚‰)
                                // å³å´: Set 3 ã‚ˆã‚Šå³ã«è¡Œã£ãŸã‚‰ (Set 4 ã«å…¥ã‚Šãã†ã«ãªã£ãŸã‚‰)
                                // ã“ã‚Œã«ã‚ˆã‚Š Set 1, 2, 3 ã®é–“ (ç”»åƒæ•°Ã—3 ã®åºƒå¤§ãªã‚¨ãƒªã‚¢) ã¯è‡ªç”±ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹
                                
                                const leftThreshold = setWidth * 0.5; // å·¦ã®é™ç•Œä»˜è¿‘
                                const rightThreshold = setWidth * 3.5; // å³ã®é™ç•Œä»˜è¿‘

                                // å³ã«è¡ŒãéããŸå ´åˆ -> 2ã‚»ãƒƒãƒˆåˆ†æˆ»ã™ (Set 4 -> Set 2)
                                if (currentScroll >= rightThreshold) {
                                    bannerContainer.scrollLeft = currentScroll - (setWidth * 2);
                                }
                                // å·¦ã«è¡ŒãéããŸå ´åˆ -> 2ã‚»ãƒƒãƒˆåˆ†é€²ã‚ã‚‹ (Set 0 -> Set 2)
                                else if (currentScroll <= leftThreshold) {
                                    bannerContainer.scrollLeft = currentScroll + (setWidth * 2);
                                }
                            };

                            bannerContainer.addEventListener('scroll', onScroll, { passive: true });

                            // 5. è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                            let isTouching = false;
                            
                            const autoScroll = () => {
                                if (isTouching) return;

                                const item = bannerContainer.querySelector('.banner-item');
                                if (!item) return;
                                const oneSlideWidth = item.offsetWidth + 16;

                                const currentScroll = bannerContainer.scrollLeft;
                                const nextScroll = Math.ceil(currentScroll / oneSlideWidth) * oneSlideWidth + oneSlideWidth;
                                
                                bannerContainer.scrollTo({
                                    left: nextScroll,
                                    behavior: 'smooth'
                                });
                            };

                            if (bannerInterval) clearInterval(bannerInterval);
                            bannerInterval = setInterval(autoScroll, 4000);

                            // 6. ã‚¿ãƒƒãƒåˆ¶å¾¡
                            bannerContainer.addEventListener('touchstart', () => {
                                isTouching = true;
                                clearInterval(bannerInterval);
                            }, { passive: true });

                            bannerContainer.addEventListener('touchend', () => {
                                isTouching = false;
                                if (bannerInterval) clearInterval(bannerInterval);
                                bannerInterval = setInterval(autoScroll, 4000);
                            }, { passive: true });
                            // â–¼â–¼â–¼ ä¿®æ­£: ãƒãƒŠãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã®é·ç§»å‡¦ç† (éšå±¤ç§»å‹•ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œç‰ˆ) â–¼â–¼â–¼
                            bannerContainer.addEventListener('click', (e) => {
                                const item = e.target.closest('.banner-item');
                                if (!item) return;

                                const linkData = item.dataset.link;
                                if (!linkData) return;

                                const parts = linkData.split(':');
                                const type = parts[0];

                                if (type === 'page') {
                                    // â–  ã‚¿ãƒ–ç§»å‹• (ä¾‹: page:settings-page)
                                    const pageId = parts[1];
                                    const targetTab = document.querySelector(`.tab-btn[data-page="${pageId}"]`);
                                    if (targetTab) targetTab.click();
                                } 
                                else if (type === 'item') {
                                    // â–  ã‚¹ãƒˆã‚¢çµŒç”±ã§ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°ã‚’é–‹ã (ä¾‹: item:game:just100)
                                    const category = parts[1]; // game, theme, background, music
                                    const itemId = parts[2];
                                    
                                    // 1. ã‚¹ãƒˆã‚¢ç”»é¢ã‚’é–‹ã
                                    if (typeof statusPage !== 'undefined') {
                                        statusPage.open();
                                        
                                        // 2. è©²å½“ã®ã‚¿ãƒ–(ã‚²ãƒ¼ãƒ ç­‰)ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                                        // (DOMãŒæç”»ã•ã‚ŒãŸç›´å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹)
                                        const targetTab = document.querySelector(`.status-tab-btn[data-target="${category}"]`);
                                        if (targetTab) {
                                            targetTab.click();
                                        }

                                        // 3. è©³ç´°ç”»é¢ã‚’é–‹ã
                                        if (typeof openItemDetailScreen === 'function') {
                                            openItemDetailScreen(itemId, category);
                                        }
                                    }
                                }
                                else if (type === 'action') {
                                    // â–  ç‰¹å®šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ (ä¾‹: action:feedback)
                                    const actionType = parts[1];
                                    
                                    if (actionType === 'feedback') {
                                        // è¨­å®šã‚¿ãƒ–ã«ç§»å‹•
                                        const settingsTab = document.querySelector(`.tab-btn[data-page="settings-page"]`);
                                        if (settingsTab) settingsTab.click();

                                        // æ„è¦‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãå‡¦ç†
                                        isFeedbackExternalOpen = true; // å¾©å¸°æ™‚ã®ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                                        window.open('https://forms.gle/5JRuBNTfV65rhvkf7', '_blank');
                                    }
                                }
                            });
                            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
                        }
                        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
                        
                        // --- â–¼â–¼â–¼ ãƒ›ãƒ¼ãƒ ç”»é¢ãƒªã‚¹ãƒˆæç”»ã®ä¿®æ­£ â–¼â–¼â–¼ ---
                        const countdownContainer = $('#countdown-list');
                        
                        if (state.countdowns.length === 0) {
                            // ç©ºã®çŠ¶æ…‹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£
                            countdownContainer.innerHTML = `
                                <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern p-6 text-center">
                                    <p class="text-sm text-gray-400">ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                                    <p class="text-xs text-gray-300 mt-1">å³ä¸Šã®ã€Œ+ã€ã§è¿½åŠ </p>
                                </div>
                            `;
                        } else {
                            // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€: ãƒªã‚¹ãƒˆå…¨ä½“ã‚’å›²ã‚€divã‚’ä½œæˆã—ã€ãã®ä¸­ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¥ã‚Œã‚‹ â–¼â–¼â–¼
                            const listHTML = state.countdowns.map(cd => {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const targetStart = new Date(cd.date);
                                targetStart.setHours(0, 0, 0, 0);
                                const diffTime = targetStart - todayStart;
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                
                                // æ®‹ã‚Šæ—¥æ•°ã®è¡¨ç¤ºãƒ‡ã‚¶ã‚¤ãƒ³
                                let dayText = '';
                                if (diffDays > 0) {
                                    dayText = `<span class="text-xl font-black primary-text">${diffDays}</span><span class="text-[10px] text-gray-400 font-bold ml-0.5">æ—¥</span>`;
                                } else if (diffDays === 0) {
                                    dayText = `<span class="text-sm font-bold text-red-500">ä»Šæ—¥</span>`;
                                } else {
                                    dayText = `<span class="text-xs font-bold text-gray-400">çµ‚äº†</span>`;
                                }
                        
                                // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆæ ç·šãªã—ã€ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚ã‚Šï¼‰
                                return `
                                    <div class="countdown-card flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition active:bg-gray-100 dark:active:bg-gray-700" data-id="${cd.id}">
                                        <div class="flex items-center min-w-0 mr-4">
                                            <div class="flex-shrink-0 w-10 h-10 rounded-full primary-bg flex items-center justify-center mr-3 text-white shadow-md">
                                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                            </div>
                                            <div class="truncate">
                                                <h3 class="font-bold text-sm text-gray-800 dark:text-gray-200 truncate">${cd.name}</h3>
                                                <p class="text-[10px] text-gray-400 dark:text-gray-500 font-medium">${cd.date.replace(/-/g, '/')}</p>
                                            </div>
                                        </div>
                                        <div class="flex-shrink-0 text-right bg-gray-50 dark:bg-gray-700/50 px-3 py-1 rounded-lg">
                                            ${dayText}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        
                            // å¤–æ ã®ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Œã‚‹
                            countdownContainer.innerHTML = `
                                <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden divide-y divide-gray-100 dark:divide-gray-700">
                                    ${listHTML}
                                </div>
                            `;
                            lucide.createIcons({ root: countdownContainer });
                        
                            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆå†è¨­å®šï¼ˆå¤‰æ›´ãªã—ï¼‰
                            countdownContainer.querySelectorAll('.countdown-card').forEach(card => {
                                card.addEventListener('click', () => {
                                    openCountdownScreen(card.dataset.id);
                                });
                            });
                        }
                        // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---
                        
                        renderHomeTasks();
                    },
                    'study-page': () => {
    // --- 1. ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã®åˆ¶å¾¡ ---
    const pinnedContainer = $('#pinned-quizzes');
    const pinnedSectionContainer = pinnedContainer.parentElement; // è¦ªã®divã‚’å–å¾—
    
    // è¦ªã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š (æ—¢å­˜ã®HTMLæ§‹é€ ã«ä¾å­˜ã›ãšã€ã“ã“ã§ã‚¯ãƒ©ã‚¹ã‚’å†è¨­å®š)
    // è¦‹å‡ºã—ãŒå«ã¾ã‚Œã¦ã„ã‚‹è¦ªè¦ç´ ã§ã¯ãªãã€ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã™ã‚‹
    pinnedContainer.className = 'bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden divide-y divide-gray-100 dark:divide-gray-700';

    if (state.pinnedQuizzes.length > 0) {
        pinnedSectionContainer.style.display = 'block';
        
        const allPinned = state.pinnedQuizzes.map(id => initialData.quizzes.find(q => q.id === id)).filter(Boolean);
        const displayItems = allPinned.slice(0, 3);
        
        pinnedContainer.innerHTML = displayItems.map(q => createQuizCard(q, true)).join('');

        // ã€Œã™ã¹ã¦è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
        const existingBtn = document.getElementById('see-all-pinned-btn');
        if (existingBtn) existingBtn.remove();

        if (state.pinnedQuizzes.length >= 3) {
            // ãƒªã‚¹ãƒˆã®æœ€å¾Œã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹å½¢ã«å¤‰æ›´
            const seeAllContainer = document.createElement('div');
            seeAllContainer.className = 'p-3 text-center bg-gray-50 dark:bg-gray-700/30 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition';
            seeAllContainer.id = 'see-all-pinned-btn';
            seeAllContainer.innerHTML = `<span class="text-xs font-bold primary-text">ã™ã¹ã¦è¦‹ã‚‹ (${state.pinnedQuizzes.length})</span>`;
            
            seeAllContainer.onclick = () => {
                if (typeof pinnedListPage !== 'undefined') {
                    pinnedListPage.open();
                }
            };
            pinnedContainer.appendChild(seeAllContainer);
        }
    } else {
        pinnedSectionContainer.style.display = 'none';
    }

    // --- 2. ãƒ•ã‚£ãƒ«ã‚¿ã¨å…¨ã‚¯ã‚¤ã‚ºãƒªã‚¹ãƒˆ ---
    const allContainer = $('#all-quizzes');
    // ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
    allContainer.className = 'bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden divide-y divide-gray-100 dark:divide-gray-700';

    const subjects = [...new Set(initialData.quizzes.map(q => q.subject))];
    let activeFilter = $('#filter-container .active')?.dataset.filter;
    if (!activeFilter || activeFilter === 'all' || !subjects.includes(activeFilter)) {
        activeFilter = subjects[0];
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´
    $('#filter-container').innerHTML = subjects.map(s => 
        `<button class="filter-btn ${s === activeFilter ? 'active primary-bg text-white shadow-md' : 'bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 shadow-sm border border-gray-100 dark:border-gray-600'} px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-transform active:scale-95" data-filter="${s}">
            ${s}
        </button>`
    ).join('');

    const quizzes = initialData.quizzes.filter(q => q.subject === activeFilter);
    
    if (quizzes.length === 0) {
        allContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                <i data-lucide="book-x" class="w-10 h-10 mb-2 opacity-50"></i>
                <p class="text-sm">ã‚¯ã‚¤ã‚ºãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>`;
    } else {
        allContainer.innerHTML = quizzes.map(q => createQuizCard(q, state.pinnedQuizzes.includes(q.id))).join('');
    }
    
    lucide.createIcons();
},
                    // å¤‰æ›´å¾Œ
                  'focus-page': () => {
                      updateFocusModeUI();
                      updateBackgrounds();
                        const activeBg = initialData.backgrounds[state.profile.activeBackground] || initialData.backgrounds['default'];
                        const hasImage = activeBg && activeBg.url;
                        const isGlobal = state.settings.backgroundScopeGlobal;
                        
                        $$('.focus-view-bg').forEach(el => {
                            // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ•ã§ã€ã‹ã¤ç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿ã€é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã®è¦ç´ ã«ç›´æ¥èƒŒæ™¯ã‚’è¨­å®š
                            if (!isGlobal && hasImage) {
                                el.style.backgroundImage = `url(${activeBg.url})`;
                            } else {
                                // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ³ã®å ´åˆã¯ã€#app-containerã®èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«è‡ªèº«ã®èƒŒæ™¯ã‚’æ¶ˆã™
                                el.style.backgroundImage = 'none';
                            }
                        });
                    },
                    'my-chart-page': () => {
    // --- 1. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®— ---
    if (!state.sessionLog) state.sessionLog = [];
    
    const now = new Date();
    const y = now.getFullYear();
    const mt = String(now.getMonth() + 1).padStart(2, '0');
    const dt = String(now.getDate()).padStart(2, '0');
    const todayStr = `${y}-${mt}-${dt}`;
    
    const dayOfWeek = now.getDay();
    const diffToMon = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); 
    const monday = new Date(now.setDate(diffToMon));
    monday.setHours(0,0,0,0);

    let todaySec = 0;
    let weekSec = 0;
    let totalSec = 0;

    state.sessionLog.forEach(log => {
        totalSec += log.duration;
        if (log.date === todayStr) {
            todaySec += log.duration;
        }
        const logDate = new Date(log.date);
        if (logDate >= monday) {
            weekSec += log.duration;
        }
    });

    // --- HTMLæ§‹é€ ã®å†æ§‹ç¯‰ ---
    // ã‚‚ã—æ—¢å­˜ã®HTMLæ§‹é€ ãŒå¤ã„(grid-cols-3ã®ã¾ã¾)å ´åˆã€JSã§ä¸­èº«ã‚’æ›¸ãæ›ãˆã‚‹
    const pageEl = $('#my-chart-page');
    // æ—¢å­˜ã®ä¸­èº«ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æ§‹ç¯‰ï¼ˆæ§‹é€ å¤‰æ›´ã®ãŸã‚ï¼‰
    pageEl.innerHTML = `
        <div class="space-y-6 pb-20">
            <div>
                <h2 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">å­¦ç¿’æ™‚é–“</h2>
                <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern flex divide-x divide-gray-100 dark:divide-gray-700 overflow-hidden">
                    <div class="flex-1 p-4 text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 mb-1">ä»Šæ—¥</p>
                        <p class="text-xl font-black primary-text leading-none">${Math.floor(todaySec / 3600)}<span class="text-[10px] text-gray-400 ml-0.5 font-bold">h</span></p>
                    </div>
                    <div class="flex-1 p-4 text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 mb-1">ä»Šé€±</p>
                        <p class="text-xl font-black primary-text leading-none">${Math.floor(weekSec / 3600)}<span class="text-[10px] text-gray-400 ml-0.5 font-bold">h</span></p>
                    </div>
                    <div class="flex-1 p-4 text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                        <p class="text-xs font-bold text-gray-400 dark:text-gray-500 mb-1">åˆè¨ˆ</p>
                        <p class="text-xl font-black primary-text leading-none">${Math.floor(totalSec / 3600)}<span class="text-[10px] text-gray-400 ml-0.5 font-bold">h</span></p>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">é€±é–“æ¨ç§»</h2>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-super shadow-modern">
                    <canvas id="study-time-chart" height="200"></canvas>
                </div>
            </div>

            <div>
                <h2 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">å­¦ç¿’ãƒ­ã‚°</h2>
                <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                    <div class="p-4 pb-2">
                        <div class="flex justify-between items-center mb-4">
                            <button id="cal-prev-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition"><i data-lucide="chevron-left" class="w-5 h-5 text-gray-500"></i></button>
                            <h3 id="cal-month-title" class="font-bold text-lg text-gray-800 dark:text-white"></h3>
                            <button id="cal-next-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition"><i data-lucide="chevron-right" class="w-5 h-5 text-gray-500"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-bold text-gray-400 mb-2">
                            <span>æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span>åœŸ</span>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm pb-4 border-b border-gray-100 dark:border-gray-700">
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-800/50">
                        <div id="detail-date-title" class="text-xs font-bold text-gray-500 dark:text-gray-400 px-5 py-3 sticky top-0 bg-gray-50/95 dark:bg-gray-800/95 backdrop-blur-sm border-b border-gray-100 dark:border-gray-700 flex items-center">
                            <i data-lucide="clock" class="w-3 h-3 mr-1"></i> ä»Šæ—¥ã®è©³ç´°
                        </div>
                        <div id="study-session-list" class="divide-y divide-gray-100 dark:divide-gray-700">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // --- 4. ã‚°ãƒ©ãƒ•æç”» ---
    const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
    const rgb = hexToRgb(activeTheme.color);
    const chartBarColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.6)`;
    const chartBorderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)`;

    const labels = [];
    const chartData = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const da = String(d.getDate()).padStart(2, '0');
        const dayKey = `${y}-${m}-${da}`;
    
        labels.push(`${d.getMonth()+1}/${d.getDate()}`);
        
        const dayTotal = state.sessionLog
            .filter(l => l.date === dayKey)
            .reduce((acc, cur) => acc + cur.duration, 0);
            
        chartData.push(dayTotal / 60); 
    }
    
    renderChart('study-time-chart', 'bar', { 
        labels, 
        datasets: [{ 
            label: 'å­¦ç¿’æ™‚é–“', 
            data: chartData, 
            backgroundColor: chartBarColor,
            borderRadius: 4, // è§’ä¸¸ãƒãƒ¼
            borderSkipped: false,
        }] 
    }, { 
        responsive: true,
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.05)', borderDash: [4, 4] }, // ã‚°ãƒªãƒƒãƒ‰ç·šã‚’è–„ã
                ticks: {
                    font: { size: 10 },
                    color: '#9ca3af',
                    callback: function(value) {
                        if (value === 0) return '0';
                        if (value >= 60 && value % 60 === 0) return (value / 60) + 'h';
                        return value;
                    }
                }
            },
            x: {
                grid: { display: false },
                ticks: { font: { size: 10 }, color: '#9ca3af' }
            }
        },
        plugins: {
            legend: { display: false }, // å‡¡ä¾‹éè¡¨ç¤º
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: 10,
                cornerRadius: 8,
                callbacks: {
                    label: function(context) {
                        const val = context.raw;
                        const h = Math.floor(val / 60);
                        const m = Math.round(val % 60);
                        return h > 0 ? ` ${h}æ™‚é–“ ${m}åˆ†` : ` ${m}åˆ†`;
                    }
                }
            }
        }
    });

    // --- 5. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ ---
    renderCalendar();
    renderDailyDetails(selectedReportDate);
    
    $('#cal-prev-btn').onclick = () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        const grid = $('#calendar-grid');
        grid.classList.remove('calendar-slide-next', 'calendar-slide-prev');
        void grid.offsetWidth; 
        grid.classList.add('calendar-slide-prev');
        renderCalendar();
    };
    $('#cal-next-btn').onclick = () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        const grid = $('#calendar-grid');
        grid.classList.remove('calendar-slide-next', 'calendar-slide-prev');
        void grid.offsetWidth; 
        grid.classList.add('calendar-slide-next');
        renderCalendar();
    };

    lucide.createIcons();
},
                    
                    // renderEngineã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã® 'settings-page' ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆã¦ãã ã•ã„
                    'settings-page': () => {
                        const settingsPage = $('#settings-page');
                        settingsPage.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
                    
                        // --- 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ ---
                        const profileCard = document.createElement('div');
                        // rounded-super, shadow-modern ã‚’é©ç”¨
                        profileCard.className = 'bg-white dark:bg-gray-800 p-5 rounded-super shadow-modern mb-6 flex items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition active:scale-[0.98]';
                        profileCard.innerHTML = `
                            <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-3xl mr-4 border-2 shadow-sm" style="border-color: var(--primary-color);">
                                ${state.user.icon}
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg text-gray-800 dark:text-white mb-1">${state.user.name}</h3>
                                <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider">${state.user.grade || 'å­¦å¹´æœªè¨­å®š'}</p>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-full text-gray-400">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </div>
                        `;
                        profileCard.addEventListener('click', () => { profilePage.open(); });
                        settingsPage.appendChild(profileCard);
                    
                        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« ---
                        const createSectionTitle = (text) => {
                            const h3 = document.createElement('h3');
                            h3.className = 'text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-3 ml-4 mt-8';
                            h3.textContent = text;
                            return h3;
                        };
                    
                        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ (Inset Style) ---
                        const createListContainer = () => {
                            const div = document.createElement('div');
                            // rounded-super, shadow-modern, divide-y ã§çµ±ä¸€
                            div.className = 'bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden divide-y divide-gray-100 dark:divide-gray-700';
                            return div;
                        };
                    
                        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  ---
                        const createListItem = (icon, title, colorClass, onClick) => {
                            const item = document.createElement('div');
                            item.className = 'flex items-center p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition active:bg-gray-100 dark:active:bg-gray-700';
                            item.innerHTML = `
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-4 shadow-sm text-white" style="background-color: var(--primary-color);">
                                    <i data-lucide="${icon}" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="flex-grow font-bold text-sm text-gray-700 dark:text-gray-200">${title}</span>
                                <i data-lucide="chevron-right" class="text-gray-300 dark:text-gray-600 w-5 h-5"></i>
                            `;
                            item.addEventListener('click', onClick);
                            return item;
                        };
                    
                        // --- 2. ã€Œã‚¢ãƒ—ãƒªè¨­å®šã€ã‚°ãƒ«ãƒ¼ãƒ— ---
                        settingsPage.appendChild(createSectionTitle('ã‚¢ãƒ—ãƒªè¨­å®š'));
                        const generalList = createListContainer();
                    
                        // é€šçŸ¥è¨­å®š
                        if (!('Notification' in window) || Notification.permission !== 'granted') {
                            generalList.appendChild(createListItem('bell', 'é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹', 'bg-yellow-500', async () => {
                                if (!('Notification' in window)) { showToast('éå¯¾å¿œã§ã™'); return; }
                                
                                // ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã®å…±é€šå‡¦ç†
                                const showDeniedPopup = () => {
                                    openGeneralConfirm(
                                        'é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ',
                                        'ç«¯æœ«ã®è¨­å®šç”»é¢ã§å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚',
                                        'bell-off',
                                        'OK',
                                        'primary-bg',
                                        () => {}, // é–‰ã˜ã‚‹ã ã‘
                                        null // â˜…ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãªã—
                                    );
                                };

                                if (Notification.permission === 'denied') {
                                    showDeniedPopup();
                                    return;
                                }
                                
                                // è¨±å¯ã‚’æ±‚ã‚ã‚‹
                                const permission = await Notification.requestPermission();
                                if (permission === 'granted') { 
                                    showToast('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼'); 
                                    renderEngine.pages['settings-page'](); 
                                } else {
                                    showDeniedPopup();
                                }
                            }));
                        }
                    
                        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š
                        generalList.appendChild(createListItem('palette', 'ãƒ†ãƒ¼ãƒè¨­å®š', 'bg-blue-500', () => themeSettingsPage.open()));
                        
                        // å£ç´™è¨­å®š
                        generalList.appendChild(createListItem('image', 'å£ç´™è¨­å®š', 'bg-purple-500', () => backgroundSettingsPage.open()));
                    
                        settingsPage.appendChild(generalList);
                    
                        // --- 3. ã€Œã‚¯ã‚¨ã‚¹ãƒˆè¨­å®šã€ã‚°ãƒ«ãƒ¼ãƒ— ---
                        settingsPage.appendChild(createSectionTitle('ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®š'));
                        const questList = createListContainer();
                        
                        questList.appendChild(createListItem('repeat', 'ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¨­å®š', 'bg-teal-500', () => routineSettingsPage.open()));
                        questList.appendChild(createListItem('coffee', 'ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®š', 'bg-orange-500', () => breakSettingsPage.open()));
                        questList.appendChild(createListItem('music', 'BGMè¨­å®š', 'bg-pink-500', () => bgmSettingsPage.open()));
                    
                        settingsPage.appendChild(questList);
                    
                        // --- 4. ã€Œã‚µãƒãƒ¼ãƒˆã€ã‚°ãƒ«ãƒ¼ãƒ— ---
                        settingsPage.appendChild(createSectionTitle('ã‚µãƒãƒ¼ãƒˆ'));
                        const otherList = createListContainer();
                        
                        otherList.appendChild(createListItem('mail', 'æ„è¦‹ã‚’é€ã‚‹ï¼ˆã‚¢ã‚¤ãƒ‡ã‚¢ãƒ»ãƒã‚°ï¼‰', 'bg-gray-500', () => {
                            isFeedbackExternalOpen = true; 
                            window.open('https://forms.gle/5JRuBNTfV65rhvkf7', '_blank');
                        }));
                        
                        settingsPage.appendChild(otherList);
                    
                        // --- ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ ---
                        lucide.createIcons();
                        
                        // ä½™ç™½
                        const spacer = document.createElement('div');
                        spacer.className = 'h-20';
                        settingsPage.appendChild(spacer);
                    },
                    },
                renderAll: () => {
                    for(const pageId in renderEngine.pages){
                        if($(`#${pageId}`).classList.contains('active')){
                            renderEngine.pages[pageId]();
                        }
                    }
                    updateLpDisplay();
                    const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
                    document.documentElement.style.setProperty('--primary-color', activeTheme.color);
                    document.documentElement.style.setProperty('--primary-color-hover', activeTheme.hover);
                }
            };

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–¢æ•°
            const renderCalendar = () => {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                
                $('#cal-month-title').textContent = `${year}å¹´ ${month + 1}æœˆ`;
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay(); // 0:Sun
                
                const grid = $('#calendar-grid');
                grid.innerHTML = '';
                
                // ç©ºç™½ã‚»ãƒ«
                for(let i=0; i<startDayOfWeek; i++) {
                    grid.innerHTML += `<div></div>`;
                }
                
                // æ—¥ä»˜ã‚»ãƒ«
                for(let d=1; d<=daysInMonth; d++) {
                    // â˜…ä¿®æ­£: toISOStringã‚’ä½¿ã‚ãšã€æ‰‹å‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜æ–‡å­—åˆ—(YYYY-MM-DD)ã‚’ä½œã‚‹
                    const cellMonth = String(month + 1).padStart(2, '0');
                    const cellDay = String(d).padStart(2, '0');
                    const dateStr = `${year}-${cellMonth}-${cellDay}`;
                    
                    // ãƒ­ã‚°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const hasLog = state.sessionLog.some(l => l.date === dateStr);
                    
                    // â˜…ä¿®æ­£: é¸æŠä¸­ã®æ—¥ä»˜æ¯”è¼ƒã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§è¡Œã†
                    const selY = selectedReportDate.getFullYear();
                    const selM = String(selectedReportDate.getMonth() + 1).padStart(2, '0');
                    const selD = String(selectedReportDate.getDate()).padStart(2, '0');
                    const selectedDateStr = `${selY}-${selM}-${selD}`;
                    const isSelected = selectedDateStr === dateStr;
    
                    // â˜…ä¿®æ­£: ä»Šæ—¥ã®æ—¥ä»˜æ¯”è¼ƒã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§è¡Œã†
                    const now = new Date();
                    const nowY = now.getFullYear();
                    const nowM = String(now.getMonth() + 1).padStart(2, '0');
                    const nowD = String(now.getDate()).padStart(2, '0');
                    const todayStr = `${nowY}-${nowM}-${nowD}`;
                    const isToday = todayStr === dateStr;
    
                    let cellClass = "h-8 w-8 mx-auto flex flex-col items-center justify-center rounded-full cursor-pointer transition text-sm relative ";
                    let styleStr = ""; // â˜…è¿½åŠ : å‹•çš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
                    
                    if (isSelected) {
                        cellClass += "primary-bg text-white font-bold shadow-md date-pop-anim"; // â˜… date-pop-anim ã‚’è¿½åŠ 
                    } else if (isToday) {
                        cellClass += "border-2 font-bold";
                        styleStr = "border-color: var(--primary-color); color: var(--primary-color);";
                    } else {
                        cellClass += "hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300";
                    }
    
                    // ãƒãƒ¼ã‚«ãƒ¼ï¼ˆãƒ­ã‚°ãŒã‚ã‚‹æ—¥ï¼‰
                    const marker = hasLog && !isSelected ? `<span class="absolute bottom-1 w-1 h-1 rounded-full" style="background-color: var(--primary-color);"></span>` : '';
    
                    const cell = document.createElement('div');
                    cell.className = "text-center";
                    cell.innerHTML = `<div class="${cellClass}" style="${styleStr}">${d}${marker}</div>`;
                    
                    cell.addEventListener('click', () => {
                        selectedReportDate = new Date(year, month, d);
                        renderCalendar(); // é¸æŠçŠ¶æ…‹æ›´æ–°ã®ãŸã‚å†æç”»
                        renderDailyDetails(selectedReportDate);
                    });
                    
                    grid.appendChild(cell);
                }
            };
    
            // æŒ‡å®šã—ãŸæ—¥ã®è©³ç´°ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
// â–¼â–¼â–¼ ä¿®æ­£: è©³ç´°ãƒ­ã‚°ã‚’Inset Listå½¢å¼ã§æç”» â–¼â–¼â–¼
const renderDailyDetails = (targetDate) => {
    const y = targetDate.getFullYear();
    const m = String(targetDate.getMonth() + 1).padStart(2, '0');
    const d = String(targetDate.getDate()).padStart(2, '0');
    const dateStr = `${y}-${m}-${d}`;

    const displayDate = `${targetDate.getMonth()+1}æœˆ${targetDate.getDate()}æ—¥`;
    
    const titleEl = $('#detail-date-title');
    if(titleEl) titleEl.innerHTML = `<i data-lucide="calendar" class="w-3 h-3 mr-1.5"></i>${displayDate} ã®è©³ç´°`;
    
    const sessions = state.sessionLog.filter(l => l.date === dateStr);
    const listContainer = $('#study-session-list');
    if(!listContainer) return; // ã‚¨ãƒ©ãƒ¼ã‚¬ãƒ¼ãƒ‰

    if (sessions.length === 0) {
        listContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                <i data-lucide="coffee" class="w-8 h-8 mb-2 opacity-50"></i>
                <p class="text-xs font-bold">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>`;
    } else {
        // çµ‚äº†æ™‚åˆ»ã®é™é †ã§è¡¨ç¤º
        listContainer.innerHTML = sessions.slice().reverse().map(s => {
            const min = Math.floor(s.duration / 60);
            const sec = s.duration % 60;
            const durationText = min > 0 ? `${min}<span class="text-[10px] ml-0.5">åˆ†</span>` : `${sec}<span class="text-[10px] ml-0.5">ç§’</span>`;
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚ˆã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã®å‡ºã—åˆ†ã‘ (ç°¡æ˜“çš„)
            let iconName = 'book-open';
            let bgClass = 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400';
            
            if (s.title.includes('ã‚¿ã‚¤ãƒãƒ¼')) {
                iconName = 'timer';
            } else if (s.title.includes('ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ')) {
                iconName = 'watch';
                bgClass = 'bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400';
            } else if (s.title.includes('ã‚¯ã‚¤ã‚º')) {
                iconName = 'help-circle';
                bgClass = 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400';
            } else if (s.title.includes('ä¼‘æ†©') || s.title.includes('ãƒ–ãƒ¬ã‚¤ã‚¯')) {
                iconName = 'coffee';
                bgClass = 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400';
            }

            return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full ${bgClass} flex items-center justify-center mr-3 shadow-sm">
                        <i data-lucide="${iconName}" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-grow min-w-0 mr-2">
                        <h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 truncate">${s.title}</h4>
                        <p class="text-[10px] text-gray-400 dark:text-gray-500">${s.endTime || '--:--'} çµ‚äº†</p>
                    </div>
                    <div class="flex-shrink-0 text-right">
                        <p class="text-base font-bold primary-text leading-none">${durationText}</p>
                    </div>
                </div>
            `;
        }).join('');
    }
    lucide.createIcons({ root: listContainer.parentElement }); // è¦ªè¦ç´ ã‚’æŒ‡å®šã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
};
            
           // â–¼â–¼â–¼ ä¿®æ­£: ã‚¯ã‚¤ã‚ºã‚¢ã‚¤ãƒ†ãƒ ã‚’ã€Œãƒªã‚¹ãƒˆè¡Œã€ãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰æ›´ â–¼â–¼â–¼
            const createQuizCard = (quiz, isPinned) => {
                if(!quiz) return '';
                const progress = state.progress[quiz.id];
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã®å½¢å®šç¾©
                const levelIcons = { 1: 'book-open-check', 2: 'thumbs-up', 3: 'award'};
                // è‰²å®šç¾© (å°‘ã—æ¿ƒã„ã‚ã§è¦–èªæ€§ç¢ºä¿)
                const levelColors = { 
                    1: 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400', 
                    2: 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400', 
                    3: 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-400'
                };
            
                // é€²æ—ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³
                const iconClass = progress ? levelColors[progress.level] : 'bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500';
                const iconName = progress ? levelIcons[progress.level] : 'book';
            
                return `
                     <div class="quiz-card flex items-center p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition active:bg-gray-100 dark:active:bg-gray-700" data-id="${quiz.id}">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full ${iconClass} flex items-center justify-center mr-4 shadow-sm">
                            <i data-lucide="${iconName}" class="w-5 h-5"></i>
                        </div>
                        
                        <div class="flex-grow min-w-0 mr-2">
                            <h3 class="font-bold text-sm text-gray-800 dark:text-gray-200 truncate leading-tight mb-0.5">${quiz.title}</h3>
                            <p class="text-xs font-medium text-gray-400 dark:text-gray-500 truncate flex items-center">
                                <span class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded text-[10px] mr-1">${quiz.subject}</span>
                                ${quiz.genre}
                            </p>
                        </div>
            
                        <button class="pin-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600 transition flex-shrink-0 ${isPinned ? 'primary-text' : 'text-gray-400'}" data-id="${quiz.id}">
                            <i data-lucide="pin" class="w-5 h-5 ${isPinned ? 'fill-current' : ''}"></i>
                        </button>
                    </div>
                `;
            };
            
            const renderChart = (canvasId, type, data, options) => {
                const ctx = $(`#${canvasId}`).getContext('2d');
                if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            };

            // --- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ (ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ç‰ˆãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¿®æ­£æ¸ˆã¿) ---
const showToast = (message, type = 'normal') => {
    const toast = document.getElementById('toast');
    
    // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
    if (toast.hideTimer) clearTimeout(toast.hideTimer);

    // ã‚¢ã‚¤ã‚³ãƒ³ã®å½¢ã ã‘ã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å¤‰ãˆã‚‹ï¼ˆè‰²ã¯å…¨ã¦ç™½ã«ã™ã‚‹ãŸã‚ï¼‰
    let iconName = 'info';
    
    if (type === 'success') {
        iconName = 'check-circle';
    } else if (type === 'error') {
        iconName = 'alert-triangle';
    } else if (type === 'quest') {
        iconName = 'map';
    }

    // HTMLæ§‹ç¯‰
    // â˜…å¤‰æ›´ç‚¹:
    // 1. ã‚¢ã‚¤ã‚³ãƒ³ã®èƒŒæ™¯ã‚’ bg-white/20 (åŠé€æ˜ã®ç™½) ã«å¤‰æ›´
    // 2. ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²ã‚’ text-white ã«å¤‰æ›´
    // 3. ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã‚’ text-white ã«å¤‰æ›´
    // 4. whitespace-nowrap ã¯ç¶­æŒï¼ˆã‚¬ã‚¿ã¤ãé˜²æ­¢ï¼‰
    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="p-2 rounded-full bg-white/20 flex-shrink-0">
                <i data-lucide="${iconName}" class="w-5 h-5 text-white"></i>
            </div>
            <span class="font-bold text-sm text-white drop-shadow-md pr-2 whitespace-nowrap">${message}</span>
        </div>
    `;
    
    // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
    lucide.createIcons({ root: toast });

    // --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç† ---
    
    // 1. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸€æ™‚ç„¡åŠ¹åŒ– & åˆæœŸä½ç½®ã‚»ãƒƒãƒˆ
    toast.style.transition = 'none';
    
    // â˜…å¤‰æ›´ç‚¹:
    // èƒŒæ™¯è‰²ã‚¯ãƒ©ã‚¹ã‚’ bg-white... ã‹ã‚‰ 'primary-bg' (ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼) ã«å¤‰æ›´
    // ãƒœãƒ¼ãƒ€ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ï¼ˆãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ä¸€è‰²ã«ã™ã‚‹ãŸã‚ï¼‰
    toast.className = `fixed left-1/2 -translate-x-1/2 z-[3000] 
                       primary-bg shadow-2xl rounded-full px-2 py-2 
                       transform translate-y-[-150%] opacity-0 scale-x-50`;

    // 2. ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶ (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆã®é©ç”¨)
    void toast.offsetWidth;

    // 3. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ– (iOSé¢¨ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°)
    toast.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

    // 4. è¡¨ç¤ºçŠ¶æ…‹ã¸ (translate-y-4 = top: 1remç›¸å½“ã®ä½ç½®)
    requestAnimationFrame(() => {
        toast.classList.remove('translate-y-[-150%]', 'opacity-0', 'scale-x-50');
        toast.classList.add('translate-y-4', 'opacity-100', 'scale-x-100');
    });

    // 5. è‡ªå‹•éè¡¨ç¤º
    toast.hideTimer = setTimeout(() => {
        toast.classList.remove('translate-y-4', 'opacity-100', 'scale-x-100');
        toast.classList.add('translate-y-[-150%]', 'opacity-0', 'scale-x-50');
    }, 3000);
};
            const addLP = (amount, reason, show = true) => {
                state.profile.lp += amount;
                updateLpDisplay();
                saveState();

                // ä¿®æ­£ç‚¹: amount ãŒ 1ä»¥ä¸Š ã‹ã¤ show ãŒ true ã®æ™‚ã ã‘ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å‡ºã™
                if(show && amount > 0) {
                    showLpPopup(amount, reason);
                }
            };

            // â–¼â–¼â–¼ è¿½åŠ ãƒ»ä¿®æ­£: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ (åˆè¨ˆè¡¨ç¤ºå‰Šé™¤å¯¾å¿œ) â–¼â–¼â–¼
            const lpPopupModal = document.getElementById('lp-popup-modal');
            const lpPopupContent = document.getElementById('lp-popup-content');
            const lpPopupAmount = document.getElementById('lp-popup-amount');
            const lpPopupReason = document.getElementById('lp-popup-reason');
            // const lpPopupTotal ... â†å‰Šé™¤ã—ã¾ã—ãŸ
            const lpPopupCloseBtn = document.getElementById('lp-popup-close-btn');
            
            let popupAutoCloseTimer = null;

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹é–¢æ•°
            const closeLpPopup = () => {
                if (popupAutoCloseTimer) {
                    clearTimeout(popupAutoCloseTimer);
                    popupAutoCloseTimer = null;
                }

                lpPopupModal.style.opacity = '0';
                lpPopupContent.classList.remove('animate-pop-elastic');
                lpPopupContent.classList.add('scale-0');

                setTimeout(() => {
                    lpPopupModal.classList.add('hidden');
                }, 300);
            };

            // --- LPç²å¾—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° ---
const showLpPopup = (amount, reason) => {
    // UIã‚’LPç²å¾—ãƒ¢ãƒ¼ãƒ‰ã«ãƒªã‚»ãƒƒãƒˆ
    $('#popup-title').textContent = 'GET!';
    
    // ã‚¢ã‚¤ãƒ†ãƒ é–¢é€£ã‚’éš ã™
    $('#popup-item-icon').classList.add('hidden');
    $('#popup-item-name').classList.add('hidden');

    // ã‚³ã‚¤ãƒ³é–¢é€£ã‚’è¡¨ç¤º
    $('#popup-coin-img').classList.remove('hidden');
    $('#popup-lp-container').classList.remove('hidden');

    $('#lp-popup-reason').textContent = reason;
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    const modal = $('#lp-popup-modal');
    const content = $('#lp-popup-content');

    modal.classList.remove('hidden');
    requestAnimationFrame(() => {
        modal.style.opacity = '1';
        content.classList.remove('scale-0');
        content.classList.add('animate-pop-elastic');
    });

    animateValue($('#lp-popup-amount'), 0, amount, 1000);
    
    lucide.createIcons();

    if (popupAutoCloseTimer) {
        clearTimeout(popupAutoCloseTimer);
        popupAutoCloseTimer = null;
    }
};

            // --- ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç‰ˆ) ---
const showItemPopup = (item, type) => {
    // UIã‚’ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    $('#popup-title').textContent = 'UNLOCK!';
    
    // ã‚³ã‚¤ãƒ³é–¢é€£ã‚’éš ã™
    $('#popup-coin-img').classList.add('hidden');
    $('#popup-lp-container').classList.add('hidden');
    
    // ã‚¢ã‚¤ãƒ†ãƒ é–¢é€£ã‚’è¡¨ç¤º
    const iconContainer = $('#popup-item-icon');
    const nameLabel = $('#popup-item-name');
    
    iconContainer.classList.remove('hidden');
    nameLabel.classList.remove('hidden');

    // ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
    const categoryName = (type === 'theme' ? 'ãƒ†ãƒ¼ãƒ' : type === 'background' ? 'å£ç´™' : type === 'game' ? 'ã‚²ãƒ¼ãƒ ' : 'BGM');
    $('#lp-popup-reason').textContent = `${categoryName}ã‚’äº¤æ›ã—ã¾ã—ãŸ`;
    nameLabel.textContent = item.name;

    // ã‚¢ã‚¤ã‚³ãƒ³/ç”»åƒã®ç”Ÿæˆ (ã‚ãã‚ãæ„Ÿã‚’å‡ºã™ãŸã‚å°‘ã—å¤§ãã‚ã«)
    iconContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢
    
    // ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
    iconContainer.className = "relative z-10 w-32 h-32 flex items-center justify-center animate-coin-float mx-auto";

    if (type === 'theme') {
        iconContainer.innerHTML = `
            <div class="w-24 h-24 rounded-full shadow-2xl border-4 border-white dark:border-gray-700 ring-4 ring-yellow-400/50" 
                 style="background-color: ${item.color}">
            </div>`;
            
    } else if (type === 'background') {
        const style = item.url ? `background-image: url(${item.url})` : 'background-color: #6b7280;';
        // å£ç´™ã¯ç¸¦é•·ã«è¦‹ã›ã‚‹
        iconContainer.className = "relative z-10 w-24 h-40 flex items-center justify-center animate-coin-float mx-auto";
        iconContainer.innerHTML = `
            <div class="w-full h-full rounded-2xl shadow-2xl border-2 border-white dark:border-gray-700 bg-cover bg-center ring-4 ring-yellow-400/50" 
                 style="${style}">
            </div>`;
            
    } else if (type === 'game') {
        if (item.thumbnail) {
            iconContainer.innerHTML = `
                <div class="w-28 h-28 rounded-3xl shadow-2xl border-2 border-white dark:border-gray-700 overflow-hidden ring-4 ring-yellow-400/50">
                    <img src="${item.thumbnail}" class="w-full h-full object-cover">
                </div>`;
        } else {
            const iconName = item.icon || 'gamepad-2';
            iconContainer.innerHTML = `
                <div class="w-28 h-28 bg-white dark:bg-gray-700 rounded-3xl shadow-2xl flex items-center justify-center ring-4 ring-yellow-400/50">
                    <i data-lucide="${iconName}" class="w-14 h-14 text-indigo-500"></i>
                </div>`;
        }
        
    } else {
        // éŸ³æ¥½ãªã©
        const iconName = item.icon || 'music';
        iconContainer.innerHTML = `
            <div class="w-28 h-28 bg-white dark:bg-gray-700 rounded-3xl shadow-2xl flex items-center justify-center ring-4 ring-yellow-400/50">
                <i data-lucide="${iconName}" class="w-14 h-14 text-pink-500"></i>
            </div>`;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º (LPç²å¾—æ™‚ã¨åŒã˜å¼¾ã‚€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨)
    const modal = $('#lp-popup-modal');
    const content = $('#lp-popup-content');
    
    modal.classList.remove('hidden');
    
    requestAnimationFrame(() => {
        modal.style.opacity = '1';
        content.classList.remove('scale-0');
        content.classList.add('animate-pop-elastic');
    });
    
    lucide.createIcons(); // ã‚¢ã‚¤ã‚³ãƒ³å†ç”Ÿæˆ

    // è‡ªå‹•ã§é–‰ã˜ãªã„ã‚ˆã†ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (popupAutoCloseTimer) {
        clearTimeout(popupAutoCloseTimer);
        popupAutoCloseTimer = null;
    }
};

            // æ•°å­—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¤‰æ›´ãªã—ï¼‰
            const animateValue = (obj, start, end, duration) => {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.innerHTML = Math.floor(progress * (end - start) + start);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            };

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
            lpPopupCloseBtn.addEventListener('click', () => {
                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                lpPopupModal.style.opacity = '0';
                lpPopupContent.classList.remove('animate-pop-elastic');
                lpPopupContent.classList.add('scale-0'); // æ¬¡å›ã®ãŸã‚ã«ç¸®ã‚ã¦ãŠã

                setTimeout(() => {
                    lpPopupModal.classList.add('hidden');
                }, 300); // transitionã®æ™‚é–“ã¨åˆã‚ã›ã‚‹
            });
            
            const formatTime = (s) => {
                const totalSeconds = Math.floor(s);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                if (hours > 0) return `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            };

            // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘BGMåˆ¶å¾¡é–¢æ•°ç¾¤ â–¼â–¼â–¼
            const playBGM = () => {
                if (!state.settings.bgmEnabled || state.settings.playlist.length === 0) return;
                
                if (bgmAudio.paused) {
                    const trackId = state.settings.playlist[currentTrackIndex];
                    const track = initialData.music[trackId];
                    if (track) {
                        if (!bgmAudio.src || !bgmAudio.src.includes(track.url)) {
                            bgmAudio.src = track.url;
                        }
                        
                        // â˜…è¿½åŠ : ãƒ­ãƒƒã‚¯ç”»é¢ç­‰ã®è¡¨ç¤ºã‚’æ›´æ–°
                        updateMediaSession(track.name);

                        bgmAudio.play().catch(e => console.log('å†ç”Ÿã‚¨ãƒ©ãƒ¼(ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã‹ã‚‚):', e));
                    }
                }
            };

            // â–¼â–¼â–¼ ä¿®æ­£: iOSå¯¾å¿œç‰ˆ (ã‚·ãƒ¼ã‚¯ç„¡åŠ¹åŒ–ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ä¸€æ‹¬è¨­å®š) â–¼â–¼â–¼
            const updateMediaSession = (title) => {
                if ('mediaSession' in navigator) {
                    // ç›¸å¯¾ãƒ‘ã‚¹ã‚’çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›ã™ã‚‹
                    const artworkUrl = new URL('SQ_logo.png', window.location.href).href;

                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: title,
                        artist: 'StudyQuest',
                        album: 'BGM Collection',
                        artwork: [
                            { src: artworkUrl, sizes: '96x96', type: 'image/png' },
                            { src: artworkUrl, sizes: '128x128', type: 'image/png' },
                            { src: artworkUrl, sizes: '192x192', type: 'image/png' },
                            { src: artworkUrl, sizes: '256x256', type: 'image/png' },
                            { src: artworkUrl, sizes: '384x384', type: 'image/png' },
                            { src: artworkUrl, sizes: '512x512', type: 'image/png' },
                            { src: artworkUrl, sizes: '1024x1024', type: 'image/png' },
                            { src: artworkUrl, sizes: '2048x2048', type: 'image/png' },
                        ]
                    });

                    // å†ç”Ÿãƒ»ä¸€æ™‚åœæ­¢ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                    navigator.mediaSession.setActionHandler('play', () => {
                        if (previewAudio.src && !previewAudio.paused) return; // å†ç”Ÿä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
                        if (previewAudio.src && previewAudio.paused && previewAudio.currentTime > 0) {
                            previewAudio.play(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†é–‹
                        } else {
                            // ã‚¯ã‚¨ã‚¹ãƒˆä¸­BGMå†é–‹
                            bgmAudio.play();
                        }
                    });
                    navigator.mediaSession.setActionHandler('pause', () => {
                        if (!previewAudio.paused) previewAudio.pause();
                        if (!bgmAudio.paused) bgmAudio.pause();
                    });

                    // â˜…è¿½åŠ : ã‚·ãƒ¼ã‚¯ã‚„ã‚¹ã‚­ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆä¸­ã¨åŒã˜æŒ™å‹•ã«ã™ã‚‹ãŸã‚ï¼‰
                    navigator.mediaSession.setActionHandler('seekto', null);
                    navigator.mediaSession.setActionHandler('previoustrack', null);
                    navigator.mediaSession.setActionHandler('nexttrack', null);
                }
            };

            const pauseBGM = () => {
                bgmAudio.pause();
            };

            const stopBGM = () => {
                bgmAudio.pause();
                bgmAudio.currentTime = 0;
                
                // ãƒã‚¤ãƒ†ã‚£ãƒ–ã®å†ç”Ÿç”»é¢ã‹ã‚‰æ¶ˆã™ãŸã‚ã®å‡¦ç†
                bgmAudio.src = ""; 
                bgmAudio.load(); // ã“ã‚Œã‚’å‘¼ã¶ã“ã¨ã§ãƒ–ãƒ©ã‚¦ã‚¶ã«ç©ºã®çŠ¶æ…‹ã‚’èªè­˜ã•ã›ã‚‹
            };

            // æ›²ãŒçµ‚ã‚ã£ãŸã‚‰æ¬¡ã®æ›²ã¸
            bgmAudio.addEventListener('ended', () => {
                currentTrackIndex++;
                if (currentTrackIndex >= state.settings.playlist.length) {
                    currentTrackIndex = 0; // æœ€åˆã«æˆ»ã‚‹
                }
                const nextTrackId = state.settings.playlist[currentTrackIndex];
                const nextTrack = initialData.music[nextTrackId];
                if (nextTrack) {
                    bgmAudio.src = nextTrack.url;
                    bgmAudio.play();
                }
            });

            // ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒãƒ¼ã«æ™‚é–“ã‚’åŠ ç®—ã™ã‚‹é–¢æ•°
            const addTimerTime = (seconds) => {
                if (focusTimer.isRunning) return; // å®Ÿè¡Œä¸­ã¯æ™‚é–“ã‚’å¤‰æ›´ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
                focusTimer.timeLeft += seconds;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
            };
            
            // ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
            const resetTimerDisplay = () => {
                if (focusTimer.isRunning) return;
                focusTimer.timeLeft = 0;
                $('#focus-timer-display').textContent = formatTime(0);
            };
            
            const formatStopwatchTime = (s) => {
                const totalSeconds = s;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                // const ms = ... ã®è¡Œã‚’å‰Šé™¤
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`; // è¿”ã‚Šå€¤ã‹ã‚‰msã‚’å‰Šé™¤
            };

            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            const logStudyTime = (type, seconds) => {
                // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                const today = `${y}-${m}-${d}`;
            
                if (!state.studyLog[today]) state.studyLog[today] = { focus: 0, quiz: 0 };
                state.studyLog[today][type] += seconds;
            };
            // è©³ç´°ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
            const recordSession = (title, durationSeconds) => {
            const now = new Date();
            
            // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜æ–‡å­—åˆ—ã‚’ä½œæˆ
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const dateStr = `${y}-${m}-${d}`;
        
            // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (HH:MM)
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const endTimeStr = `${hours}:${minutes}`;
        
            const newSession = {
                id: Date.now(),
                date: dateStr,
                title: title,
                duration: durationSeconds,
                endTime: endTimeStr
            };
        
            // stateã«è¿½åŠ 
            if (!state.sessionLog) state.sessionLog = [];
            state.sessionLog.push(newSession);
            
            // æ—¢å­˜ã®é›†è¨ˆç”¨ãƒ­ã‚°ã‚‚æ›´æ–°ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
            logStudyTime('focus', durationSeconds); 
            saveState();
        };
            
            // â–¼â–¼â–¼ renderHomeTasks é–¢æ•°å…¨ä½“ã‚’æ›¸ãæ›ãˆ â–¼â–¼â–¼
            // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆ: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ç¶­æŒã™ã‚‹ renderHomeTasks â–¼â–¼â–¼
            const renderHomeTasks = () => {
                if (!homeTaskListEl) return;

                // â˜…1. ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
                const mainContainer = document.querySelector('main');
                const savedScrollTop = mainContainer ? mainContainer.scrollTop : 0;
            
                // 1. ç©ºã®çŠ¶æ…‹ (Empty State)
                if (!state.tasks || state.tasks.length === 0) {
                    homeTaskListEl.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10 text-gray-400 dark:text-gray-500">
                            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-full mb-3">
                                <i data-lucide="clipboard-list" class="w-8 h-8 opacity-50"></i>
                            </div>
                            <p class="text-sm font-bold">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                            <p class="text-xs mt-1 opacity-70">ä¸‹ã®å…¥åŠ›æ¬„ã‹ã‚‰è¿½åŠ ã§ãã¾ã™(Enterã§æ±ºå®š)</p>
                        </div>
                    `;
                } else {
                    homeTaskListEl.innerHTML = ''; // ã‚¯ãƒªã‚¢
                    
                    state.tasks.forEach((task, index) => {
                        const isCompleted = task.completed || false;
                        
                        // å®Œäº†æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
                        const bgStyle = isCompleted ? 'bg-gray-50 dark:bg-gray-900' : 'bg-white dark:bg-gray-800';
                        const numBgStyle = isCompleted ? 'background-color: #9ca3af;' : 'background-color: var(--primary-color);';
                        const textColor = isCompleted ? 'text-gray-400 dark:text-gray-500 line-through' : 'text-gray-800 dark:text-gray-200';
                        const subTextColor = isCompleted ? 'text-gray-300 dark:text-gray-600 line-through' : 'text-gray-400 dark:text-gray-400';
            
                        const taskEl = document.createElement('div');
                        taskEl.setAttribute('data-id', task.id);
                        
                        // é«˜ã•å›ºå®š
                        taskEl.className = `task-item swipe-container relative overflow-hidden group h-[72px] w-full`;
            
                        // ãƒ†ã‚­ã‚¹ãƒˆè§£æ
                        const match = task.text.match(/^(.+?)[\sã€€]+(.+)$/);
                        let displayHTML = '';
            
                        if (match) {
                            displayHTML = `
                                <div class="flex flex-col justify-center h-full pointer-events-none">
                                    <span class="text-sm font-bold leading-tight ${textColor} mb-0.5 truncate">${match[1]}</span>
                                    <span class="text-[10px] font-bold leading-tight ${subTextColor} truncate">${match[2]}</span>
                                </div>
                            `;
                        } else {
                            displayHTML = `
                                <div class="flex items-center h-full pointer-events-none">
                                    <span class="text-sm font-bold leading-tight ${textColor} truncate">${task.text}</span>
                                </div>
                            `;
                        }
            
                        // HTMLæ§‹ç¯‰
                        taskEl.innerHTML = `
                            <div class="swipe-actions">
                                <button class="btn-complete swipe-btn bg-gray-300 dark:bg-gray-600 w-[70px]">
                                    <i data-lucide="${isCompleted ? 'rotate-ccw' : 'check'}" class="w-6 h-6"></i>
                                </button>
                                <button class="btn-delete swipe-btn bg-red-500 w-[70px]">
                                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                                </button>
                            </div>
            
                            <div class="swipe-content flex items-center px-4 h-full relative z-10 w-full transition-colors ${bgStyle}">
                                
                                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 shadow-sm transition-colors"
                                     style="${numBgStyle}">
                                    <span class="font-bold text-sm text-white">${index + 1}</span>
                                </div>
                                
                                <div class="flex-grow min-w-0 relative h-full">
                                    <div class="task-view-layer absolute inset-0 cursor-text select-none"
                                         onclick="if(!${isCompleted}) { this.classList.add('opacity-0', 'pointer-events-none'); this.nextElementSibling.classList.remove('opacity-0', 'pointer-events-none'); this.nextElementSibling.focus(); }">
                                        ${displayHTML}
                                    </div>
            
                                    <input type="text" value="${task.text}" 
                                        class="task-edit-input absolute inset-0 w-full h-full bg-transparent border-none outline-none font-bold text-sm text-gray-800 dark:text-gray-200 opacity-0 pointer-events-none transition-opacity"
                                        onblur="this.classList.add('opacity-0', 'pointer-events-none'); this.previousElementSibling.classList.remove('opacity-0', 'pointer-events-none');"
                                        onkeypress="if(event.key === 'Enter') this.blur();"
                                        ${isCompleted ? 'disabled' : ''}>
                                </div>
                                
                                <button type="button" class="task-handle cursor-grab active:cursor-grabbing text-gray-300 hover:text-gray-500 p-2 -mr-2 flex-shrink-0 touch-none h-10 w-10 flex items-center justify-center">
                                    <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `;
                        
                        homeTaskListEl.appendChild(taskEl);
                        
                        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š: ã‚¹ãƒ¯ã‚¤ãƒ—
                        new SwipeHandler(taskEl, {
                            onComplete: () => {
                                const taskToUpdate = state.tasks.find(t => t.id === task.id);
                                if (taskToUpdate) {
                                    taskToUpdate.completed = !taskToUpdate.completed;
                                    saveState();
                                    renderHomeTasks();
                                }
                            },
                            onDelete: () => {
                                state.tasks = state.tasks.filter(t => t.id !== task.id);
                                saveState();
                                setTimeout(renderHomeTasks, 300);
                                showToast('ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                            }
                        });
            
                        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š: ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†
                        const input = taskEl.querySelector('.task-edit-input');
                        input.addEventListener('change', (e) => {
                            const taskToUpdate = state.tasks.find(t => t.id === task.id);
                            if (taskToUpdate) {
                                taskToUpdate.text = e.target.value;
                                saveState();
                                renderHomeTasks();
                            }
                        });
                    });
                }
                
                // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
                lucide.createIcons({
                    root: homeTaskListEl,
                    attrs: { class: "w-5 h-5" }
                });

                // â˜…2. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ (æç”»å®Œäº†å¾Œã«å®Ÿè¡Œ)
                if (mainContainer) {
                    requestAnimationFrame(() => {
                        mainContainer.scrollTop = savedScrollTop;
                    });
                }
            };
            document.body.addEventListener('click', e => {
                const quizCard = e.target.closest('.quiz-card');
                if (quizCard && !e.target.closest('.pin-btn')) {
                    const quiz = initialData.quizzes.find(q => q.id === quizCard.dataset.id);
                    
                    if (quiz && quiz.url) {
                        // 1. è¨ˆæ¸¬ç”¨ã®çŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆ
                        currentQuizId = quiz.id;
                        quizTimer.startTime = Date.now();
                        isQuizExternalOpen = true; // â˜…ã“ã“é‡è¦: ã€Œå¤–éƒ¨ã«è¡Œã£ã¦ã„ã‚‹ã€ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
    
                        // 2. å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã (ã‚µãƒ–ãƒšãƒ¼ã‚¸é·ç§»ã¯ã—ãªã„)
                        window.open(quiz.url, '_blank');
                    }
                }
                // â–¼â–¼â–¼ ä¿®æ­£: ãƒ”ãƒ³ç•™ã‚è§£é™¤æ™‚ã«ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚‚å³åº§ã«æ›´æ–°ã™ã‚‹ â–¼â–¼â–¼
                const pinBtn = e.target.closest('.pin-btn');
                if(pinBtn) {
                    const quizId = pinBtn.dataset.id;
                    state.pinnedQuizzes.includes(quizId) ? state.pinnedQuizzes = state.pinnedQuizzes.filter(id => id !== quizId) : state.pinnedQuizzes.push(quizId);
                    saveState(); 
                    
                    // æ•™æãƒšãƒ¼ã‚¸ï¼ˆè¦ªå…ƒï¼‰ã‚’æ›´æ–°
                    renderEngine.pages['study-page'](); 
                    
                    // â˜…è¿½åŠ : ãƒ”ãƒ³ç•™ã‚ä¸€è¦§ãƒšãƒ¼ã‚¸ãŒé–‹ã„ã¦ã„ã‚‹ãªã‚‰ã€ãã“ã‚‚å³åº§ã«å†æç”»
                    if (document.getElementById('pinned-list-screen').classList.contains('active')) {
                        renderPinnedListPageContent();
                    }
                    
                    lucide.createIcons();
                }
                // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
                
                const filterBtn = e.target.closest('.filter-btn');
                if(filterBtn) {
                     $$('#filter-container .filter-btn').forEach(b => {
                         b.classList.remove('active', 'primary-bg', 'text-white');
                         b.classList.add('bg-gray-200', 'dark:bg-gray-600');
                     });
                     filterBtn.classList.add('active', 'primary-bg', 'text-white');
                     filterBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                     renderEngine.pages['study-page']();
                     lucide.createIcons();
                }

                const closeModalBtn = e.target.closest('.close-modal-btn');
                if (closeModalBtn) {
                    const modal = $(`#${closeModalBtn.dataset.modal}`);
                    modal.style.display = 'none';
                    if (closeModalBtn.dataset.modal === 'quiz-modal') {
                        $('#assessment-modal').dataset.quizId = modal.dataset.currentQuiz;
                        $('#assessment-modal').style.display = 'flex';
                        if(quizTimer.startTime) {
                            const elapsed = Math.round((Date.now() - quizTimer.startTime) / 1000);
                            const title = $('#quiz-modal-title').textContent || 'ã‚¯ã‚¤ã‚º';
                            recordSession(title, elapsed);
                            quizTimer.startTime = null;
                            saveState();
                        }
                    }
                }
                
                const assessmentBtn = e.target.closest('.assessment-btn');
                if(assessmentBtn) {
                    const level = parseInt(assessmentBtn.dataset.level);
                    const quizId = $('#assessment-modal').dataset.quizId;
                    
                    // 1. é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    state.progress[quizId] = { level, date: new Date().toISOString() };
                    
                    // ã‚¯ã‚¤ã‚ºã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ±ºã‚ã‚‹
                    const quizObj = initialData.quizzes.find(q => q.id === quizId);
                    const title = quizObj ? quizObj.title : 'ã‚¯ã‚¤ã‚º';

                    // å­¦ç¿’ãƒ­ã‚°ï¼ˆãƒªã‚¹ãƒˆï¼‰ã«è¿½åŠ 
                    if (currentQuizElapsed > 0) {
                        recordSession(title, currentQuizElapsed);
                        // ã‚°ãƒ©ãƒ•ç”¨é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ  ('quiz' ã‚¿ã‚¤ãƒ—ã¨ã—ã¦è¨˜éŒ²)
                        logStudyTime('quiz', currentQuizElapsed);
                        
                        // ç·åˆè¨ˆæ™‚é–“ã‚‚æ›´æ–°ï¼ˆã‚‚ã—state.focus.totalTimeã§ç®¡ç†ã—ã¦ã„ã‚‹ãªã‚‰ï¼‰
                        state.focus.totalTime += currentQuizElapsed;
                    }
                    
                    // ã‚¯ã‚¨ã‚¹ãƒˆã¨åŒæ§˜ã«ã€Œ1åˆ† = 1LPã€ã§è¨ˆç®—
                    const earnedLP = Math.floor(currentQuizElapsed / 60);
                    
                    if (earnedLP > 0) {
                        addLP(earnedLP, 'ã‚¯ã‚¤ã‚º');
                    }
                    
                    currentQuizElapsed = 0; // ä½¿ã„çµ‚ã‚ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
                    saveState();
                    
                    // 2. â˜…é‡è¦â˜… ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶çš„ã«å†æç”»ã™ã‚‹
                    // renderEngine.renderAll() ã¯ 'active' ã‚¯ãƒ©ã‚¹ãŒã¤ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã ã‘ã‚’æç”»ã™ã‚‹ãŸã‚ã€ã“ã‚Œã§OKã§ã™
                    renderEngine.renderAll();
                    
                    // 3. ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆLucideï¼‰ã‚’å†ç”Ÿæˆã™ã‚‹
                    // HTMLãŒæ›¸ãæ›ã‚ã£ãŸç›´å¾Œã¯ã‚¢ã‚¤ã‚³ãƒ³ãŒ <i> ã‚¿ã‚°ã®ã¾ã¾ãªã®ã§ã€ã“ã‚Œã‚’ <svg> ã«å¤‰æ›ã—ã¾ã™
                    lucide.createIcons();

                    // 4. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    closeModalWithAnim('assessment-modal', 'assessment-content');
                }

                const themeBtn = e.target.closest('.theme-btn');
                if(themeBtn){
                    const themeId = themeBtn.dataset.theme;
                    if(state.profile.unlockedThemes.includes(themeId)) {
                        state.profile.activeTheme = themeId;
                        saveState();
                        renderEngine.renderAll();
                    } else {
                        const theme = initialData.themes[themeId];
                        const confirmBtn = $('#theme-purchase-confirm');
                        
                        $('#theme-purchase-title').textContent = `ã€Œ${theme.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        $('#theme-purchase-cost').textContent = `å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ: ${theme.cost} LP`;
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        $('#theme-preview').style.backgroundColor = theme.color;
                
                        // ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (state.profile.lp >= theme.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = themeId;
                        confirmBtn.dataset.itemType = 'theme';
                        $('#theme-purchase-modal').style.display = 'flex';
                    }
                }

                const backgroundBtn = e.target.closest('.background-btn');
                if(backgroundBtn){
                    const bgId = backgroundBtn.dataset.bg;
                    if(state.profile.unlockedBackgrounds.includes(bgId)) {
                        state.profile.activeBackground = bgId;
                        saveState();
                        updateAppearance();
                        renderEngine.pages['settings-page']();
                        lucide.createIcons();
                    } else {
                        const bg = initialData.backgrounds[bgId];
                        const confirmBtn = $('#background-purchase-confirm');
                
                        $('#background-purchase-title').textContent = `ã€Œ${bg.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        $('#background-purchase-cost').textContent = `å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ: ${bg.cost} LP`;
                
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        const previewEl = $('#background-preview');
                        if (bg.url) {
                            previewEl.style.backgroundImage = `url(${bg.url})`;
                            previewEl.classList.remove('hidden');
                        } else {
                            previewEl.classList.add('hidden'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãªã©ç”»åƒãŒãªã„å ´åˆã¯éè¡¨ç¤º
                        }
                        
                        // ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (state.profile.lp >= bg.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = bgId;
                        confirmBtn.dataset.itemType = 'background';
                        $('#background-purchase-modal').style.display = 'flex';
                    }
                }

                const editCountdownBtn = e.target.closest('.edit-countdown-btn');
                if(editCountdownBtn){
                    const id = editCountdownBtn.dataset.id;
                    openCountdownModal(id);
                }

                // â–¼â–¼â–¼ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¤ãƒãƒ¼/SWï¼‰ã®ãƒªã‚¹ãƒŠãƒ¼ä¿®æ­£ â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  Â  const focusModeBtn = e.target.closest('.focus-mode-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if(focusModeBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mode = focusModeBtn.dataset.mode;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.focus.mode = mode; // 'timer' ã‹ 'stopwatch' ãŒå…¥ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateFocusModeUI(); // UIã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

Â  Â  Â  Â  Â  Â  Â  Â  // 1. ã‚¯ã‚¨ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ– (SubPageã‚¯ãƒ©ã‚¹å®šç¾©ã®å¾Œã«è¿½åŠ )
                const questPage = new SubPage('quest-view', {
                    onOpen: () => {
                        // é–‹ã„ãŸã¨ãã«å®Ÿè¡Œã™ã‚‹å‡¦ç†
                        renderQuestPlan();
                        lucide.createIcons();
                    }
                });
                
                // 2. ã€Œã‚¯ã‚¨ã‚¹ãƒˆã€ãƒœã‚¿ãƒ³ï¼ˆFocusãƒšãƒ¼ã‚¸å†…ï¼‰ã®å‡¦ç†ã‚’å¤‰æ›´
                // ï¼ˆæ—¢å­˜ã® showQuestBtn é–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã¾ãŸã¯ä»¥ä¸‹ã«æ›¸ãæ›ãˆï¼‰
                const showQuestBtn = document.getElementById('show-quest-btn'); // å¤‰æ•°å®šç¾©ã‚’ç¢ºèª
                if (showQuestBtn) {
                    showQuestBtn.addEventListener('click', () => {
                        // focus-main-view ã‚’éš ã™å¿…è¦ã¯ãªããªã‚Šã¾ã—ãŸï¼ˆSubPageãŒä¸Šã«é‡ãªã‚‹ãŸã‚ï¼‰
                        questPage.open(); 
                    });
                }
                
                // 3. ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’å¤‰æ›´
                // ï¼ˆæ—¢å­˜ã® questBackBtn é–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã¾ãŸã¯ä»¥ä¸‹ã«æ›¸ãæ›ãˆï¼‰
                const questBackBtn = document.getElementById('quest-back-btn');
                if (questBackBtn) {
                    questBackBtn.addEventListener('click', () => {
                        questPage.close();
                        // æˆ»ã‚‹ã¨ãã«Focusç”»é¢ã®UIæ›´æ–°ãŒå¿…è¦ãªã‚‰ã“ã“ã§è¡Œã†
                        updateFocusModeUI(); 
                    });
                }

                // æ™‚é–“åŠ ç®—ãƒœã‚¿ãƒ³ã®å‡¦ç†
                const timeAddBtn = e.target.closest('.time-add-btn');
                if(timeAddBtn) {
                    const time = parseInt(timeAddBtn.dataset.time);
                    addTimerTime(time);
                }
                
                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
                const timerResetBtn = e.target.closest('#timer-reset-btn');
                if(timerResetBtn) {
                    resetTimerDisplay();
                }
                // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒœã‚¿ãƒ³ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆä¸­ï¼‰
                const breakSettingsBtn = e.target.closest('#break-settings-btn');
                    if (breakSettingsBtn) {
                        // æ­£ã—ã„ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
                        breakSettingsPage.open(); 
                    }
                    
                    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆã“ã‚Œã¯SubPageã‚¯ãƒ©ã‚¹ã§è‡ªå‹•ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®ifæ–‡ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨å‰Šé™¤ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ãŒã€å¿µã®ãŸã‚è¨˜è¿°ã™ã‚‹å ´åˆã‚‚ close() ã‚’ä½¿ã„ã¾ã™ï¼‰
                    const breakSettingsCloseBtn = e.target.closest('#break-settings-close-btn');
                    if (breakSettingsCloseBtn) {
                        breakSettingsPage.close();
                    }
            });
            
            // --- Focus Page Logic ---
            const updateMiniTimer = () => {
                if (miniTimerTemporarilyHidden) {
                    $('#mini-timer-container').classList.remove('visible');
                    return;
                }
                const container = $('#mini-timer-container');
                const bar = $('#mini-timer-bar');
                if ((focusTimer.isRunning || stopwatch.isRunning) && !$('#focus-page').classList.contains('active')) {
                    container.classList.add('visible');
                    if(focusTimer.isRunning){
                        const progress = (focusTimer.defaultTime - focusTimer.timeLeft) / focusTimer.defaultTime * 100;
                        $('#mini-timer-text').textContent = formatTime(focusTimer.timeLeft);
                        $('#mini-timer-progress-bar').style.width = `${progress}%`;
                    } else { // stopwatch
                         $('#mini-timer-text').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                         $('#mini-timer-progress-bar').style.width = `100%`;
                    }
                } else {
                    // â–¼ è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’æ“ä½œã™ã‚‹
                    if (container) {
                        container.classList.remove('visible');
                    }
                }
            };
            
            const timerTick = () => {
                focusTimer.timeLeft--;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
                updateMiniTimer();
                if (focusTimer.timeLeft <= 0) {
                    clearInterval(focusTimer.interval);
                    // showToast ã¨ new Notification ã¯ Service Worker ãŒæ‹…å½“ã™ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
                    // showToast('é›†ä¸­ãƒ¢ãƒ¼ãƒ‰å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
                    // if (Notification.permission === 'granted') { ... }
            
                    const elapsed = focusTimer.defaultTime;
                    logStudyTime('focus', elapsed);
                    addLP(Math.floor(elapsed/60), 'ã‚¿ã‚¤ãƒãƒ¼');
                    state.focus.totalTime += elapsed;
                    saveState();
                    resetTimerUI();
            
                }
            };
            
            const stopwatchTick = () => {
                stopwatch.elapsedTime = (Date.now() - stopwatch.startTime) / 1000;
                if (stopwatch.elapsedTime >= 43200) {
                    stopwatch.elapsedTime = 43200; // æ™‚é–“ã‚’å›ºå®š
                    $('#stopwatch-display').textContent = formatStopwatchTime(43200);
                    updateMiniTimer();
                    endStopwatch(); // å¼·åˆ¶çµ‚äº†
                    showToast('12æ™‚é–“ã‚’çµŒéã—ãŸãŸã‚çµ‚äº†ã—ã¾ã—ãŸ');
                    return; // ã“ã“ã§å‡¦ç†ã‚’æŠœã‘ã‚‹
                }
                $('#stopwatch-display').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                updateMiniTimer();
            };

            const pauseFocusTimer = () => {
                if (!focusTimer.isRunning || focusTimer.isPaused) return;
                focusTimer.isPaused = true;
                clearInterval(focusTimer.interval);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>å†é–‹`;
                lucide.createIcons();
            };

            const resumeFocusTimer = () => {
                if (!focusTimer.isRunning || !focusTimer.isPaused) return;
                focusTimer.isPaused = false;
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢`;
                lucide.createIcons();
            };

            const pauseStopwatch = () => {
                if (!stopwatch.isRunning || stopwatch.isPaused) return;
                stopwatch.isPaused = true;
                clearInterval(stopwatch.interval);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>å†é–‹`;
                lucide.createIcons();
            };

            const resumeStopwatch = () => {
                if (!stopwatch.isRunning || !stopwatch.isPaused) return;
                stopwatch.isPaused = false;
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢`;
                lucide.createIcons();
            };

            // â–¼â–¼â–¼ ä¿®æ­£: è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ â–¼â–¼â–¼
            const updateFocusModeUI = () => {
                const mode = state.focus.mode;
                const glider = $('#focus-mode-glider');
                const timerBtn = $('.focus-mode-btn[data-mode="timer"]');
                const stopwatchBtn = $('.focus-mode-btn[data-mode="stopwatch"]');
                
                const timerView = $('#timer-view');
                const stopwatchView = $('#stopwatch-view');

                // 1. ã‚°ãƒ©ã‚¤ãƒ€ãƒ¼ã®ç§»å‹•
                if (mode === 'timer') {
                    glider.style.transform = 'translateX(0%)';
                    timerBtn.classList.add('active');
                    stopwatchBtn.classList.remove('active');
                } else {
                    glider.style.transform = 'translateX(100%)';
                    timerBtn.classList.remove('active');
                    stopwatchBtn.classList.add('active');
                }

                // 2. ãƒ“ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
                // ç¾åœ¨éè¡¨ç¤ºã®æ–¹ã‚’è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™ºç«ã•ã›ã‚‹
                if (mode === 'timer') {
                    if (timerView.style.display !== 'flex') {
                        stopwatchView.style.display = 'none';
                        timerView.style.display = 'flex';
                        
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†ç”Ÿ
                        timerView.classList.remove('view-fade-enter');
                        void timerView.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼(å†æç”»)ã‚’å¼·åˆ¶
                        timerView.classList.add('view-fade-enter');
                    }
                } else if (mode === 'stopwatch') {
                    if (stopwatchView.style.display !== 'flex') {
                        timerView.style.display = 'none';
                        stopwatchView.style.display = 'flex';
                        
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†ç”Ÿ
                        stopwatchView.classList.remove('view-fade-enter');
                        void stopwatchView.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼(å†æç”»)ã‚’å¼·åˆ¶
                        stopwatchView.classList.add('view-fade-enter');
                    }
                }
            };

            // â–¼â–¼â–¼ æ–°è¦è¿½åŠ : èƒŒæ™¯ç”»åƒã‚’ focus-view-bg ã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆå«ã‚€ï¼‰ã«é©ç”¨ã™ã‚‹é–¢æ•° â–¼â–¼â–¼
            const updateBackgrounds = () => {
                const activeBgId = state.profile.activeBackground;
                const activeBg = initialData.backgrounds[activeBgId] || initialData.backgrounds['default'];
                const isGlobal = state.settings.backgroundScopeGlobal;
                const hasImage = activeBg && activeBg.url;
            
                // .focus-view-bg ã‚¯ãƒ©ã‚¹ã‚’æŒã¤ã™ã¹ã¦ã®è¦ç´ ï¼ˆã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã€ã‚¯ã‚¨ã‚¹ãƒˆç”»é¢ãªã©ï¼‰ã‚’å–å¾—
                $$('.focus-view-bg').forEach(el => {
                    // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ•ã§ã€ã‹ã¤ç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿ã€å€‹åˆ¥ã«èƒŒæ™¯ã‚’è¨­å®š
                    // â€»ã‚¯ã‚¨ã‚¹ãƒˆç”»é¢ã¯å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãªã®ã§ã€GlobalãŒONã§ã‚‚OFFã§ã‚‚èƒŒæ™¯ç”»åƒã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯æ¡ä»¶ã‚’èª¿æ•´
                    // ã“ã“ã§ã¯ã€Œã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã¨åŒã˜æŒ™å‹•ï¼ˆGlobal OFFãªã‚‰å€‹åˆ¥ã«è¡¨ç¤ºï¼‰ã€ã«åŠ ãˆã€
                    // ã€Œã‚¯ã‚¨ã‚¹ãƒˆç”»é¢(#quest-active-screen)ãªã‚‰å¸¸ã«è¡¨ç¤ºã€ã¨ã„ã†ãƒ­ã‚¸ãƒƒã‚¯ã«ã—ã¾ã™ã€‚
                    
                    const isQuestScreen = el.id === 'quest-active-screen';
            
                    if ((!isGlobal && hasImage) || (isQuestScreen && hasImage)) {
                        el.style.backgroundImage = `url(${activeBg.url})`;
                    } else {
                        // å…¨ä½“é©ç”¨ãŒONã®å ´åˆã¯è¦ª(body)ã®èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã®ã§é€æ˜ã«ã™ã‚‹ã€ã¾ãŸã¯ç”»åƒãªã—
                        el.style.backgroundImage = 'none';
                    }
                });
            };

            const resetTimerUI = () => {
                clearInterval(focusTimer.interval);
                focusTimer.isRunning = false; focusTimer.isPaused = false;
                focusTimer.timeLeft = focusTimer.defaultTime; // defaultTimeã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ
                $('#focus-timer-display').textContent = formatTime(focusTimer.defaultTime);
                $('#focus-start-btn').classList.remove('hidden');
                $('#focus-controls').classList.add('hidden');
                $('#timer-settings-container').classList.remove('hidden');
                updateMiniTimer();
            };

            const resetStopwatchUI = () => {
                clearInterval(stopwatch.interval);
                stopwatch.isRunning = false; stopwatch.isPaused = false;
                stopwatch.elapsedTime = 0;
                $('#stopwatch-display').textContent = formatStopwatchTime(0);
                $('#stopwatch-start-btn').classList.remove('hidden');
                $('#stopwatch-controls').classList.add('hidden');
                updateMiniTimer();
            };

            const endFocusTimer = () => {
                if (!focusTimer.isRunning) return;
                const elapsed = focusTimer.defaultTime - focusTimer.timeLeft;
                if (elapsed > 0) { recordSession('ã‚¿ã‚¤ãƒãƒ¼', elapsed); addLP(Math.floor(elapsed / 60), 'ã‚¿ã‚¤ãƒãƒ¼'); state.focus.totalTime += elapsed; saveState(); }
                resetTimerUI();
            
                // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ã‚’é€šçŸ¥
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ command: 'focusTimer_stop' });
                }
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // â–²â–²â–²ã€è¿½åŠ ã€‘ã“ã“ã¾ã§â–²â–²â–²
            };

            const endStopwatch = () => {
                if (!stopwatch.isRunning) return;
                const elapsed = Math.round(stopwatch.elapsedTime);
                if (elapsed > 0) { recordSession('ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ', elapsed); addLP(Math.floor(elapsed / 60), 'ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ'); state.focus.totalTime += elapsed; saveState(); }
                resetStopwatchUI();
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // â–²â–²â–²ã€è¿½åŠ ã€‘ã“ã“ã¾ã§â–²â–²â–²
            };
            
            const setTimer = (seconds) => {
                focusTimer.defaultTime = seconds; // defaultTimeã‚‚æ›´æ–°
                focusTimer.timeLeft = seconds;
                $('#focus-timer-display').textContent = formatTime(seconds);
            };

           $('#focus-start-btn').addEventListener('click', () => {
                if (focusTimer.timeLeft <= 0) {
                    showToast('æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }
                focusTimer.defaultTime = focusTimer.timeLeft;
                focusTimer.isRunning = true;
                focusTimer.isPaused = false;
                state.focus.isRunning = true;
                state.focus.startTime = Date.now(); // ç¾åœ¨æ™‚åˆ»ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
                state.focus.duration = focusTimer.timeLeft;
                saveState();
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-start-btn').classList.add('hidden');
                $('#focus-controls').classList.remove('hidden');
                $('#timer-settings-container').classList.add('hidden');
                updateMiniTimer();
            
                // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã‚’é€šçŸ¥
                if (navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'focusTimer_start', // â˜… 'startTimer' ã‹ã‚‰å¤‰æ›´
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeLeft: focusTimer.timeLeft,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'âŒ›ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†', // â˜… é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚' // â˜… é€šçŸ¥æœ¬æ–‡ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
            });
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–¼â–¼â–¼ */

            // ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®šãƒ“ãƒ¥ãƒ¼ã®ãƒœã‚¿ãƒ³
            addSectionBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'section',
                    text: '', // â˜…ã“ã“ã‚’ç©ºæ–‡å­—ã«ã™ã‚‹ï¼ˆã“ã‚Œã§å…¥åŠ›æ¬„ãŒç©ºã«ãªã‚‹ï¼‰
                    duration: 25 * 60
                });
                renderQuestPlan();
            });

            addBreakBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'break',
                    duration: 5 * 60
                });
                renderQuestPlan();
            });

            startQuestBtn.addEventListener('click', startQuest);

            // ã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œç”»é¢ã®çµ‚äº†ãƒœã‚¿ãƒ³ï¼ˆãƒãƒ„ãƒœã‚¿ãƒ³ï¼‰
            endQuestBtn.addEventListener('click', () => {
                // æ–°ã—ã„ã€Œæ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã€ã‚’ä½¿ã„ã¾ã™
                openGeneralConfirm(
                    'ã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ', // ã‚¿ã‚¤ãƒˆãƒ«
                    'é€”ä¸­ã§çµ‚äº†ã™ã‚‹ã¨ã€ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€Œä¸­æ–­ã€ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚', // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    'alert-triangle', // ã‚¢ã‚¤ã‚³ãƒ³
                    'çµ‚äº†ã™ã‚‹', // ãƒœã‚¿ãƒ³ã®æ–‡å­—
                    'bg-red-500 hover:bg-red-600', // ãƒœã‚¿ãƒ³ã®è‰²
                    () => endQuest(false) // å®Ÿè¡Œæ™‚ã®å‡¦ç†
                );
            });

           // ä¼‘æ†©ä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ã‚¢ã‚¤ã‚³ãƒ³ãƒ›ãƒ¼ãƒ ç”»é¢)
Â  Â  Â  Â  Â  Â  if(breakIconGrid) {
Â  Â  Â  Â  Â  Â  Â  Â  breakIconGrid.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = e.target.closest('.break-content-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btn && btn.dataset.url) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ã“ã“ã‹ã‚‰å¤‰æ›´â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btn.dataset.openMode === 'external') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¤–éƒ¨ã‚¿ãƒ–ã§é–‹ã (å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºä¸å¯)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(btn.dataset.url, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¾“æ¥é€šã‚Šã‚¢ãƒ—ãƒªå†… (iframe) ã§é–‹ã (å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºå¯èƒ½)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openIframe(btn.dataset.url);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ã“ã“ã¾ã§å¤‰æ›´â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
            closeIframeBtn.addEventListener('click', closeIframe);

            /* â–²â–²â–² è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–²â–²â–² */
            
            $('#focus-pause-btn').addEventListener('click', () => { if (focusTimer.isPaused) resumeFocusTimer(); else pauseFocusTimer(); });
            $('#focus-end-btn').addEventListener('click', endFocusTimer);

            $('#stopwatch-start-btn').addEventListener('click', () => {
                stopwatch.isRunning = true; stopwatch.isPaused = false;
                // ä¿®æ­£ï¼šä¿å­˜ã•ã‚ŒãŸæ™‚é–“ã§ã¯ãªãã€å¸¸ã«ç¾åœ¨ã®æ™‚åˆ»ã‹ã‚‰é–‹å§‹
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
            
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = true;
                // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®å ´åˆã€é–‹å§‹æ™‚åˆ»ã®ã¿ä¿å­˜
                state.focus.startTime = stopwatch.startTime; 
                saveState();
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
                updateMiniTimer();
            });
            $('#stopwatch-pause-btn').addEventListener('click', () => { if (stopwatch.isPaused) resumeStopwatch(); else pauseStopwatch(); });
            $('#stopwatch-end-btn').addEventListener('click', endStopwatch);
            
            // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆv4: CSSåˆ¶å¾¡ã«ã‚ˆã‚‹å®Œå…¨ãªè‰²ç®¡ç† â–¼â–¼â–¼
            let isAnimating = false;

            $$('.tab-btn').forEach(btn => btn.addEventListener('click', e => {
                const targetBtn = e.currentTarget;
                const nextPageId = targetBtn.dataset.page;
                const activePage = document.querySelector('.page.active');
                
                if ((activePage && activePage.id === nextPageId) || isAnimating) return;

                const nextPage = $(`#${nextPageId}`);
                if (!nextPage) return;

                $('main').scrollTop = 0;

                // --- 1. ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–° ---
                // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‹ã‚‰ active-tab ã‚’å‰Šé™¤
                $$('.tab-btn').forEach(b => {
                    b.classList.remove('active-tab');
                    
                    // é›†ä¸­ãƒœã‚¿ãƒ³(center-fab)ã®ãƒªã‚»ãƒƒãƒˆï¼ˆå¤‰å½¢ã®ã¿ï¼‰
                    if (b.classList.contains('center-fab')) {
                        b.style.transform = '';
                    }
                });

                // æŠ¼ã•ã‚ŒãŸã‚¿ãƒ–ã« active-tab ã‚’ä»˜ä¸
                // (CSSã§è‰²ãŒè‡ªå‹•çš„ã«å¤‰ã‚ã‚Šã¾ã™ã€‚çœŸã‚“ä¸­ãƒœã‚¿ãƒ³ã¯CSSã§ç„¡è¦–ã•ã‚Œã‚‹ã®ã§å®‰å…¨ã§ã™)
                targetBtn.classList.add('active-tab');

                // --- 2. é›†ä¸­ãƒœã‚¿ãƒ³ç‹¬è‡ªã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ---
                if (targetBtn.classList.contains('center-fab')) {
                    targetBtn.animate([
                        { transform: 'translateX(-50%) scale(0.9)' },
                        { transform: 'translateX(-50%) scale(1.1)' },
                        { transform: 'translateX(-50%) scale(1)' }
                    ], { duration: 300, easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)' });
                }

                $('#header-title').textContent = targetBtn.dataset.title;

                // --- 3. ãƒšãƒ¼ã‚¸é·ç§»å‡¦ç† (å¤‰æ›´ãªã—) ---
                isAnimating = true;

                if (activePage) {
                    activePage.classList.add('page-exit');
                    activePage.classList.remove('active');
                    activePage.addEventListener('animationend', () => {
                        activePage.classList.remove('page-exit');
                    }, { once: true });
                }

                nextPage.classList.add('page-enter');

                requestAnimationFrame(() => {
                    setTimeout(() => {
                        if (renderEngine.pages[nextPageId]) { 
                            renderEngine.pages[nextPageId](); 
                        }
                        if (nextPageId === 'focus-page') {
                            miniTimerTemporarilyHidden = false;
                        }
                        updateMiniTimer();
                        lucide.createIcons();
                    }, 10);
                });

                nextPage.addEventListener('animationend', () => {
                    nextPage.classList.remove('page-enter');
                    nextPage.classList.add('active');
                    isAnimating = false;
                }, { once: true });
            }));
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆ: è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹ â–¼â–¼â–¼
            const miniTimerBar = $('#mini-timer-bar');
            if (miniTimerBar) {
                miniTimerBar.addEventListener('click', (e) => {
                    if (e.target.closest('#close-mini-timer-btn')) return;
                    const focusTab = document.querySelector('.tab-btn[data-page="focus-page"]');
                    if (focusTab) focusTab.click();
                });
            }
            
            const closeMiniTimerBtn = $('#close-mini-timer-btn');
            if (closeMiniTimerBtn) {
                closeMiniTimerBtn.addEventListener('click', () => {
                    miniTimerTemporarilyHidden = true;
                    const container = $('#mini-timer-container');
                    if (container) container.classList.remove('visible');
                });
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            // --- Countdown Logic ---
            // 1. ã‚µãƒ–ãƒšãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
            const countdownPage = new SubPage('countdown-screen');
            let editingCountdownId = null; // ç·¨é›†ä¸­ã®IDã‚’ä¿æŒ

            // æˆ»ã‚‹ãƒœã‚¿ãƒ³
            $('#close-countdown-btn').addEventListener('click', () => countdownPage.close());

            // 2. ç”»é¢ã‚’é–‹ãé–¢æ•° (æ–°è¦ãƒ»ç·¨é›†å…±é€š)
            function openCountdownScreen(id = null) {
                editingCountdownId = id;
                const titleEl = $('#countdown-screen-title');
                const nameInput = $('#countdown-name');
                const dateInput = $('#countdown-date');
                const memoInput = $('#countdown-memo'); // â˜…è¿½åŠ 
                const deleteBtn = $('#countdown-delete-btn');

                if (id) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                    titleEl.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†';
                    deleteBtn.classList.remove('hidden');
                    
                    const item = state.countdowns.find(c => c.id === id);
                    if (item) {
                        nameInput.value = item.name;
                        dateInput.value = item.date;
                        memoInput.value = item.memo || ''; // â˜…ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿ (ãªã‘ã‚Œã°ç©ºæ–‡å­—)
                    }
                } else {
                    // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                    titleEl.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ ';
                    deleteBtn.classList.add('hidden');
                    
                    nameInput.value = '';
                    memoInput.value = ''; // â˜…ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªã‚¢
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜: 2é€±é–“å¾Œ
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() + 14);
                    // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã®YYYY-MM-DDã‚’å–å¾—
                    const y = defaultDate.getFullYear();
                    const m = String(defaultDate.getMonth() + 1).padStart(2, '0');
                    const d = String(defaultDate.getDate()).padStart(2, '0');
                    dateInput.value = `${y}-${m}-${d}`;
                }

                countdownPage.open();
            }

            // 3. ä¿å­˜å‡¦ç†
            function saveCountdown() {
                const name = $('#countdown-name').value.trim();
                const date = $('#countdown-date').value;
                const memo = $('#countdown-memo').value; // â˜…ãƒ¡ãƒ¢ã‚’å–å¾—

                if (!name || !date) {
                    showToast('ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const newData = {
                    name,
                    date,
                    memo // â˜…ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
                };

                if (editingCountdownId) {
                    // æ›´æ–°
                    const index = state.countdowns.findIndex(c => c.id === editingCountdownId);
                    if (index !== -1) {
                        state.countdowns[index] = { ...state.countdowns[index], ...newData };
                    }
                } else {
                    // æ–°è¦ä½œæˆ
                    newData.id = `cd_${Date.now()}`;
                    state.countdowns.push(newData);
                }

                // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
                state.countdowns.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                saveState();
                renderEngine.pages['home-page'](); // ãƒ›ãƒ¼ãƒ ç”»é¢æ›´æ–°
                countdownPage.close();
                showToast('ä¿å­˜ã—ã¾ã—ãŸ');
            }

            // 4. å‰Šé™¤å‡¦ç†
            function deleteCountdown() {
                openGeneralConfirm(
                    'ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤',
                    'ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nå‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚',
                    'trash-2',
                    'å‰Šé™¤ã™ã‚‹',
                    'bg-red-500 hover:bg-red-600', // èµ¤è‰²ãƒœã‚¿ãƒ³
                    () => {
                        // å®Ÿè¡Œå‡¦ç†
                        if (editingCountdownId) {
                            state.countdowns = state.countdowns.filter(c => c.id !== editingCountdownId);
                            saveState();
                            renderEngine.pages['home-page']();
                            countdownPage.close();
                            showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
                        }
                    }
                );
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            $('#add-countdown-btn').addEventListener('click', () => openCountdownScreen()); // æ–°è¦è¿½åŠ 
            $('#countdown-save-btn').addEventListener('click', saveCountdown);
            $('#countdown-delete-btn').addEventListener('click', deleteCountdown);

            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®é–¢æ•°ç¾¤ â–¼â–¼â–¼ */

            // â–¼â–¼â–¼ renderQuestPlan é–¢æ•°å…¨ä½“ã‚’æ›¸ãæ›ãˆ â–¼â–¼â–¼
            function renderQuestPlan() {
                if (!questPlanListEl) return;
                const scrollContainer = document.querySelector('#quest-view .flex-grow');
                const savedScrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
                questPlanListEl.innerHTML = '';
                
                // 1. ç©ºã®çŠ¶æ…‹
                if (quest.plan.length === 0) {
                    questPlanListEl.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10 text-gray-400 dark:text-gray-500">
                            <i data-lucide="map" class="w-12 h-12 mb-3 opacity-20"></i>
                            <p class="text-sm font-bold">ã‚¯ã‚¨ã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                            <p class="text-xs mt-1 opacity-70">ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                        </div>
                    `;
                }
            
                let sectionCounter = 1;
            
                quest.plan.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.setAttribute('data-id', item.id);
                    
                    // â˜…é«˜ã•å›ºå®š: h-[72px] ã‚’æŒ‡å®š
                    itemEl.className = 'swipe-container relative overflow-hidden group h-[72px] w-full';
            
                    let iconHTML = '';
                    let contentAreaHTML = '';
            
                    if (item.type === 'section') {
                        // === ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå­¦ç¿’ï¼‰ ===
                        
                        // 1. ç•ªå·ãƒ‡ã‚¶ã‚¤ãƒ³ (ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼èƒŒæ™¯ + ç™½æ–‡å­—)
                        iconHTML = `
                            <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center border border-transparent shadow-sm transition-colors" style="background-color: var(--primary-color);">
                                <span class="text-sm font-bold text-white">${sectionCounter}</span>
                            </div>
                        `;
            
                        // 2. ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºç”¨HTMLç”Ÿæˆ (ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«å¯¾å¿œ)
                        const text = item.text || 'æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³';
                        const match = text.match(/^(.+?)[\sã€€]+(.+)$/);
                        let displayHTML = '';
            
                        if (match) {
                            // [ãƒ¡ã‚¤ãƒ³ + ã‚µãƒ–]
                            displayHTML = `
                                <div class="flex flex-col justify-center h-full pointer-events-none">
                                    <span class="text-sm font-bold text-gray-800 dark:text-gray-200 leading-tight mb-0.5 truncate">${match[1]}</span>
                                    <span class="text-[10px] font-bold text-gray-400 dark:text-gray-400 leading-tight truncate">${match[2]}</span>
                                </div>
                            `;
                        } else {
                            // [1è¡Œ]
                            const textColor = item.text ? 'text-gray-800 dark:text-gray-200' : 'text-gray-400 dark:text-gray-500';
                            displayHTML = `
                                <div class="flex items-center h-full pointer-events-none">
                                    <span class="text-sm font-bold ${textColor} leading-tight truncate">${text}</span>
                                </div>
                            `;
                        }
            
                        // 3. é‡ã­åˆã‚ã›æ§‹é€  (è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼ + ç·¨é›†ãƒ¬ã‚¤ãƒ¤ãƒ¼)
                        contentAreaHTML = `
                            <div class="flex-grow min-w-0 relative h-full mr-2">
                                <div class="absolute inset-0 cursor-text select-none"
                                     onclick="this.classList.add('opacity-0', 'pointer-events-none'); this.nextElementSibling.classList.remove('opacity-0', 'pointer-events-none'); this.nextElementSibling.focus();">
                                    ${displayHTML}
                                </div>
                                <input type="text" value="${item.text}" data-original-id="${item.originalTaskId || ''}" 
                                    class="quest-item-input absolute inset-0 w-full h-full bg-transparent border-none outline-none font-bold text-sm text-gray-800 dark:text-gray-200 opacity-0 pointer-events-none transition-opacity" 
                                    onblur="this.classList.add('opacity-0', 'pointer-events-none'); this.previousElementSibling.classList.remove('opacity-0', 'pointer-events-none');"
                                    onkeypress="if(event.key === 'Enter') this.blur();"
                                    placeholder="æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³">
                            </div>
                        `;
                        sectionCounter++;
            
                    } else {
                        // === ä¼‘æ†© ===
                        iconHTML = `
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center shadow-sm">
                                <i data-lucide="coffee" class="w-4 h-4 text-green-600 dark:text-green-400"></i>
                            </div>
                        `;
                        // ä¼‘æ†©ã¯ç·¨é›†ä¸å¯ã§å›ºå®šè¡¨ç¤º
                        contentAreaHTML = `
                            <div class="flex-grow min-w-0 h-full flex items-center mr-2">
                                <span class="font-bold text-gray-500 dark:text-gray-400 text-sm">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </span>
                            </div>
                        `;
                    }
            
                    // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ å…¨ä½“ã®HTMLçµ„ã¿ç«‹ã¦
                    itemEl.innerHTML = `
                        <div class="swipe-actions">
                            <button class="btn-delete swipe-btn bg-red-500 w-[70px]">
                                <i data-lucide="trash-2" class="w-6 h-6"></i>
                                <span>å‰Šé™¤</span>
                            </button>
                        </div>
            
                        <div class="swipe-content flex items-center px-4 h-full relative z-10 w-full bg-white dark:bg-gray-800 transition-colors">
                            <div class="mr-3 flex-shrink-0">
                                ${iconHTML}
                            </div>
                            
                            ${contentAreaHTML}
            
                            <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg px-2 py-1 flex-shrink-0 mr-1 h-8">
                                <input type="number" value="${item.duration / 60}" 
                                    class="quest-item-duration w-8 bg-transparent text-center font-bold text-sm text-gray-700 dark:text-gray-200 focus:outline-none p-0 appearance-none">
                                <span class="text-[10px] text-gray-400 font-bold ml-0.5">åˆ†</span>
                            </div>
            
                            <button class="quest-handle cursor-grab active:cursor-grabbing text-gray-300 hover:text-gray-500 p-2 -mr-2 flex-shrink-0 touch-none h-10 w-10 flex items-center justify-center">
                                <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                            </button>
                        </div>
                    `;
            
                    questPlanListEl.appendChild(itemEl);
            
                    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
                    
                    // 1. å‰Šé™¤ã‚¹ãƒ¯ã‚¤ãƒ—
                    new SwipeHandler(itemEl, {
                        onDelete: () => {
                            quest.plan = quest.plan.filter(p => p.id !== item.id);
                            setTimeout(renderQuestPlan, 300);
                        }
                    });
            
                    // 2. ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ (ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿)
                    const input = itemEl.querySelector('.quest-item-input');
                    if (input) {
                        input.addEventListener('change', (e) => {
                            item.text = e.target.value;
                            item.originalTaskId = e.target.dataset.originalId || null;
                            renderQuestPlan(); // å†æç”»ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
                        });
                    }
            
                    // 3. æ™‚é–“å¤‰æ›´
                    const durationInput = itemEl.querySelector('.quest-item-duration');
                    durationInput.addEventListener('change', (e) => {
                        let val = parseInt(e.target.value);
                        
                        // â–¼â–¼â–¼ ä¿®æ­£: ä¸Šé™ãƒ»ä¸‹é™ãƒã‚§ãƒƒã‚¯ â–¼â–¼â–¼
                        if (isNaN(val) || val < 1) val = 1;
                        if (val > 720) val = 720; // 720åˆ†(12æ™‚é–“)ã§ã‚«ãƒ³ã‚¹ãƒˆ
                        
                        e.target.value = val; // å…¥åŠ›æ¬„ã®æ•°å­—ã‚‚æ›¸ãæ›ãˆã‚‹
                        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
                    
                        const defaultVal = (item.type === 'section') ? 25 : 5;
                        item.duration = val * 60;
                    });
                });
            
                lucide.createIcons({ root: questPlanListEl });
                if (scrollContainer) {
                    // requestAnimationFrameã‚’ä½¿ã£ã¦æç”»å®Œäº†ã‚’å¾…ã¤ã¨ã‚ˆã‚Šç¢ºå®Ÿã§ã™
                    requestAnimationFrame(() => {
                        scrollContainer.scrollTop = savedScrollTop;
                    });
                }
            }
            // â–²â–²â–² å¤‰æ›´ã“ã“ã¾ã§ â–²â–²â–²
            
        // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•° (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è€æ€§å¼·åŒ–ç‰ˆ)
Â  Â  Â  Â  function startQuestTimer(duration, onTick, onEnd) {
Â  Â  Â  Â  Â  Â  // 1. æ—¢å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
Â  Â  Â  Â  Â  Â  if (quest.timerInterval) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(quest.timerInterval);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã€Œçµ¶å¯¾çš„ãªçµ‚äº†æ™‚åˆ»ã€ã‚’è¨ˆç®—
Â  Â  Â  Â  Â  Â  const endTime = Date.now() + duration * 1000;

            // 2.5. å‘¼ã³å‡ºã—ç›´å¾Œã«ã€ã¾ãšUIã‚’ç¾åœ¨ã®æ™‚é–“ã§æ›´æ–°ã™ã‚‹
Â  Â  Â  Â  Â  Â  const initialTimeLeft = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
Â  Â  Â  Â  Â  Â  onTick(initialTimeLeft);
Â  Â  Â  Â  Â  Â  quest.timeLeft = initialTimeLeft;

Â  Â  Â  Â  Â  Â  // 3. 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’é–‹å§‹
Â  Â  Â  Â  Â  Â  quest.timerInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  // 4. çµ‚äº†æ™‚åˆ»ã¨ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ã€æœ¬å½“ã®æ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®— (0ç§’æœªæº€ã«ã¯ã—ãªã„)
Â  Â  Â  Â  Â  Â  Â  Â  const timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));

Â  Â  Â  Â  Â  Â  Â  Â  // 5. ãƒ­ã‚°è¨˜éŒ²ç”¨ã«ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®æ®‹ã‚Šæ™‚é–“ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  quest.timeLeft = timeLeft; 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 6. UIã‚’æ›´æ–° (onTick)
Â  Â  Â  Â  Â  Â  Â  Â  onTick(timeLeft);

Â  Â  Â  Â  Â  Â  Â  Â  // 7. çµ‚äº†æ™‚åˆ»ã‚’éãã¦ã„ãŸã‚‰ã€ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ onEnd ã‚’å‘¼ã¶
Â  Â  Â  Â  Â  Â  Â  Â  if (now >= endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(quest.timerInterval);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quest.timerInterval = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onEnd(); // çµ‚äº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1000); // 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ (å³å¯†ã«ã¯100msç­‰ã®æ–¹ãŒç²¾åº¦ã¯è‰¯ã„ãŒã€1000msã§ã‚‚ååˆ†)
Â  Â  Â  Â  };

        function cancelQuestAlarm() {
Â  Â  Â  Â  Â  Â  if (navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  // 'stopTimer' ã‚³ãƒãƒ³ãƒ‰ã‚’ (é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã¨) å…±æœ‰ã—ã¦ä½¿ç”¨
Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'questTimer_stop' 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        function sendQuestAlarm(durationInSeconds, title, body) {
Â  Â  Â  Â  Â  Â  if (Notification.permission === "granted" && navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  // 'startTimer' ã‚³ãƒãƒ³ãƒ‰ã‚’ (é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã¨) å…±æœ‰ã—ã¦ä½¿ç”¨
Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.controller.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  command: 'questTimer_start', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeLeft: durationInSeconds,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: title, // é€šçŸ¥ã®ã‚¿ã‚¤ãƒˆãƒ«
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: body Â // é€šçŸ¥ã®æœ¬æ–‡
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // â–¼â–¼â–¼ æ–°è¦ãƒ»ä¿®æ­£: ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç¢ºèªç”»é¢ä»˜ãï¼‰ â–¼â–¼â–¼

            const questTransitionView = $('#quest-transition-view');
            const transitionTitle = $('#transition-title');
            const transitionMessage = $('#transition-message');
            const transitionNextText = $('#transition-next-text');
            const transitionNextDuration = $('#transition-next-duration');
            const transitionStartBtn = $('#transition-start-btn');
            const transitionIcon = $('#transition-icon');

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€æº–å‚™
            function runNextQuestStep() {
                quest.currentIndex++;
                
                // å…¨ã‚¹ãƒ†ãƒƒãƒ—çµ‚äº†æ™‚ã®å‡¦ç†
                if (quest.currentIndex >= quest.plan.length) {
                    endQuest(true);
                    return;
                }

                const nextStep = quest.plan[quest.currentIndex];

                // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’ä¿å­˜ (ç¾åœ¨åœ°ã¨é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²)
                state.savedQuest = {
                    plan: quest.plan,
                    currentIndex: quest.currentIndex,
                    startTime: Date.now(), // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®é–‹å§‹æ™‚åˆ»ï¼ˆä»®ï¼‰
                    active: true
                };
                saveState();

                // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å³é–‹å§‹ã—ã€ãã‚Œä»¥é™ã¯ç¢ºèªç”»é¢ã‚’å‡ºã™
                if (quest.currentIndex === 0) {
                    executeQuestStep(nextStep);
                } else {
                    showTransitionScreen(nextStep);
                }
            }

            // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼ˆå¾…æ©Ÿï¼‰ç”»é¢ã‚’è¡¨ç¤º
            function showTransitionScreen(step) {
                // å‰ã®ç”»é¢ã‚’éš ã™
                questSectionView.style.display = 'none';
                questBreakView.style.display = 'none';

                // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ã‚’è¡¨ç¤º
                questTransitionView.style.display = 'flex';
                
                // å†…å®¹ã®ã‚»ãƒƒãƒˆ
                if (step.type === 'section') {
                    transitionTitle.textContent = "å­¦ç¿’ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ";
                    transitionMessage.textContent = "æº–å‚™ãŒã§ããŸã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
                    transitionIcon.setAttribute('data-lucide', 'book-open');
                    transitionNextText.textContent = step.text;
                    transitionNextDuration.textContent = `${step.duration / 60} åˆ†`;
                    transitionStartBtn.className = "primary-bg primary-bg-hover text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center";
                } else {
                    transitionTitle.textContent = "ä¼‘æ†©ã‚¿ã‚¤ãƒ ";
                    transitionMessage.textContent = "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼å°‘ã—é ­ã‚’ä¼‘ã‚ã¾ã—ã‚‡ã†ã€‚";
                    transitionIcon.setAttribute('data-lucide', 'coffee');
                    transitionNextText.textContent = "ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ ";
                    transitionNextDuration.textContent = `${step.duration / 60} åˆ†`;
                    transitionStartBtn.className = "bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center";
                }

                lucide.createIcons();

                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸€åº¦ã ã‘ç™ºç«ã™ã‚‹ã‚ˆã†ã«è¨­å®šï¼‰
                transitionStartBtn.onclick = () => {
                    questTransitionView.style.display = 'none';
                    executeQuestStep(step);
                };
            }

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
            // æ–‡å­—ã‚µã‚¤ã‚ºã‚’ç¸®å°ã—ã€ã‚¹ãƒšãƒ¼ã‚¹åˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯ã‚’èª¿æ•´
            const updateQuestTitleDisplay = (text) => {
                if (!text) return;
            
                // å…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã®ã„ãšã‚Œã‹ã§åˆ†å‰²
                // ^(.+?) : è¡Œé ­ã‹ã‚‰æœ€çŸ­ãƒãƒƒãƒï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
                // [\sã€€]+ : ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Š
                // (.+)$  : æ®‹ã‚Šã™ã¹ã¦ï¼ˆã‚µãƒ–ï¼‰
                const match = text.match(/^(.+?)[\sã€€]+(.+)$/);
                
                const container = document.getElementById('quest-section-title');
                
                if (match) {
                    const main = match[1];
                    const sub = match[2];
                    
                    container.innerHTML = `
                        <div class="flex flex-col items-center animate-fadeIn w-full px-2">
                            <span class="text-2xl md:text-3xl font-bold mb-1 leading-tight text-center break-words w-full">${main}</span>
                            <span class="text-sm md:text-base text-gray-400 font-medium opacity-90 text-center break-words w-full">${sub}</span>
                        </div>
                    `;
                } else {
                    // ã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„å ´åˆã‚‚æ–‡å­—ã‚µã‚¤ã‚ºã‚’ç¸®å°ã—ã¦è¡¨ç¤º
                    container.innerHTML = `
                        <div class="flex flex-col items-center animate-fadeIn w-full px-2">
                            <span class="text-2xl md:text-3xl font-bold mb-1 leading-tight text-center break-words w-full">${text}</span>
                        </div>
                    `;
                }
            };

            // å®Ÿéš›ã®ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤ºã—ã¦é–‹å§‹
            function executeQuestStep(currentStep) {
                cancelQuestAlarm();

                // â˜…è¿½åŠ : å®Ÿéš›ã«ã‚¿ã‚¤ãƒãƒ¼ãŒå‹•ãã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ­£ç¢ºãªé–‹å§‹æ™‚åˆ»ã‚’ä¿å­˜
                if(state.savedQuest) {
                    state.savedQuest.startTime = Date.now();
                    // currentStepãŒä¼‘æ†©ã‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹åŒºåˆ¥ã—ã¦ä¿å­˜ã—ã¦ã‚‚è‰¯ã„ãŒã€
                    // å¾©å…ƒæ™‚ã«è¨ˆç®—ã™ã‚‹ã®ã§æœ€ä½é™ Date.now() ãŒã‚ã‚Œã°OK
                    saveState();
                }

                // ã‚¢ãƒ—ãƒª2ã®ãƒˆãƒ¼ã‚¹ãƒˆé–¢æ•°ã¨Notification APIã‚’ä½¿ç”¨
                const showQuestNotification = (title, body) => {
                    showToast(body);
                    if (Notification.permission === "granted" && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            command: 'showQuestNotification',
                            title: title,
                            body: body
                        });
                    }
                };

                if (currentStep.type === 'section') {
                    playBGM();
                    questSectionView.style.display = 'flex';
                    questBreakView.style.display = 'none';
                    
                    updateQuestTitleDisplay(currentStep.text);
                    // é€²æ—è¡¨ç¤º
                    const totalSections = quest.plan.filter(p => p.type === 'section').length;
                    const currentSectionNumber = quest.plan.slice(0, quest.currentIndex + 1).filter(p => p.type === 'section').length;
                    questProgressEl.textContent = `${currentSectionNumber} / ${totalSections}`;

                    // â˜…ã“ã“ã§SWã«ã€Œäºˆç´„ã€ã‚’å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã€æ™‚é–“ã«ãªã‚Œã°è‡ªå‹•ã§é€šçŸ¥ãŒæ¥ã¾ã™
                    sendQuestAlarm(
                        currentStep.duration,
                        'ğŸ”¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†',
                        'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼'
                    );
                    
                    startQuestTimer(
                        currentStep.duration,
                        (timeLeft) => { questTimerEl.textContent = formatTime(timeLeft); },
                        () => {
                            // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ 1 â–¼â–¼â–¼ ---
                            // ã“ã“ã§ showQuestNotification ã‚’å‘¼ã¶ã¨ã€Œä»Šã™ãé€šçŸ¥ã€ãŒé€ã‚‰ã‚Œã¦é‡è¤‡ã—ã¾ã™ã€‚
                            // ä»£ã‚ã‚Šã« showToast ã ã‘å‘¼ã‚“ã§ã€ç”»é¢å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘è¡¨ç¤ºã—ã¾ã™ã€‚
                            const elapsed = currentStep.duration;
                            if (elapsed > 0) {
                                recordSession(currentStep.text, elapsed);
                                const earned = Math.floor(elapsed / 60);
                                // ç¬¬3å¼•æ•°ã‚’ false ã«ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’æŠ‘åˆ¶
                                addLP(earned, 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³', false); 
                                // ç´¯ç©å¤‰æ•°ã«åŠ ç®—
                                quest.accumulatedLp = (quest.accumulatedLp || 0) + earned;
                                state.focus.totalTime += elapsed;
                                
                                if (currentStep.originalTaskId) {
                                    const taskId = parseInt(currentStep.originalTaskId);
                                    const taskIndex = state.tasks.findIndex(t => t.id === taskId);
                                    if (taskIndex !== -1) {
                                        state.tasks[taskIndex].completed = true;
                                    }
                                }
                                saveState();
                            }
                            // â˜…é€šçŸ¥ã¯SWã®äºˆç´„ã«ä»»ã›ã€ã“ã“ã§ã¯ãƒˆãƒ¼ã‚¹ãƒˆã®ã¿è¡¨ç¤º
                            showToast('ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼'); 
                            // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

                            runNextQuestStep(); // æ¬¡ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ï¼‰ã¸
                        }
                    );
                } else { // break
                    pauseBGM();
                    questSectionView.style.display = 'none';
                    questBreakView.style.display = 'flex';
                    renderBreakIcons();

                    // â˜…ã“ã“ã§SWã«ã€Œäºˆç´„ã€ã‚’å…¥ã‚Œã¦ã„ã¾ã™
                    sendQuestAlarm(
                        currentStep.duration,
                        'â˜•ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ çµ‚äº†',
                        'ä¼‘æ†©æ™‚é–“ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚'
                    );
                    
                    startQuestTimer(
                        currentStep.duration,
                        (timeLeft) => {
                            breakTimerEl.textContent = formatTime(timeLeft);
                            // æ®‹ã‚Š30ç§’ã®é€šçŸ¥ã¯ã€Œäºˆç´„ã€ã—ã¦ã„ãªã„ã®ã§ã€ã“ã“ã‹ã‚‰é€ã£ã¦ã‚‚OKï¼ˆé‡è¤‡ã—ãªã„ï¼‰
                            if (timeLeft === 30) {
                                showQuestNotification('â±ã¾ã‚‚ãªãä¼‘æ†©çµ‚äº†', '30ç§’å¾Œã«çµ‚äº†ã—ã¾ã™ã€‚');
                            }
                        },
                        () => {
                            // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ 2 â–¼â–¼â–¼ ---
                            // ã“ã“ã‚‚åŒæ§˜ã«ä¿®æ­£
                            // showQuestNotification('ä¼‘æ†©çµ‚äº†', 'ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚'); 
                            showToast('ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚');
                            // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

                            closeIframe();
                            runNextQuestStep(); // æ¬¡ï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ç”»é¢ï¼‰ã¸
                        }
                    );
                }
                lucide.createIcons();
            }
            // â–²â–²â–² ã‚¯ã‚¨ã‚¹ãƒˆé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£å®Œäº† â–²â–²â–²

        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹é–¢æ•°ï¼ˆç·¨é›†ç”»é¢ç¶­æŒç‰ˆï¼‰
        function startQuest() {
            if (quest.plan.length === 0) {
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆã®äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            // â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹æ™‚ã«æ¨ªç”»é¢å›ºå®šï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ã«ã™ã‚‹ â–¼â–¼â–¼
            controlScreenOrientation('quest');
            document.body.classList.add('is-quest-mode');

            quest.plan.forEach(item => {
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã€ã‹ã¤ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„ï¼ˆã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿ï¼‰å ´åˆ
                if (item.type === 'section' && (!item.text || item.text.trim() === '')) {
                    item.text = 'æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³';
                }
            });
            renderQuestPlan();

            // 1. èƒŒæ™¯ã‚„å¤‰æ•°ã®æº–å‚™
            quest.active = true;
            quest.currentIndex = -1;
            quest.accumulatedLp = 0; // â˜…ã“ã‚Œã‚’è¡Œã‚’è¿½åŠ ï¼ˆç²å¾—LPã®ç´¯ç©ç”¨ï¼‰
            updateBackgrounds();

            // 2. ã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œç”»é¢ã‚’è¡¨ç¤ºï¼ˆã¾ã é€æ˜ãƒ»ç¸®å°çŠ¶æ…‹ï¼‰
            // æœ€å‰é¢(z-200)ã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ä¸‹ã®ç·¨é›†ç”»é¢ã¯è¦‹ãˆãªããªã‚Šã¾ã™ãŒã€å­˜åœ¨ã—ç¶šã‘ã¾ã™
            questActiveScreen.style.display = 'flex';
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦é©ç”¨ï¼ˆãµã‚ã£ã¨å‡ºã‚‹æ¼”å‡ºï¼‰
            questActiveScreen.classList.remove('animate-screen-enter');
            void questActiveScreen.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶
            questActiveScreen.classList.add('animate-screen-enter');

            // 3. ã‚¢ãƒ—ãƒª2ã®ãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã‚’éš ã™
            // (ç·¨é›†ç”»é¢ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éš ã—ã¾ã™ãŒã€å¿µã®ãŸã‚ã“ã“ã§ã‚‚éš ã—ã¦ãŠãã¾ã™)
            $('header').style.display = 'none';
            $('nav').style.display = 'none';
            $('#mini-timer-container').classList.remove('visible');
            document.body.style.overflow = 'hidden';

            // 4. æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹
            runNextQuestStep();
        };

        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ‚äº†ã™ã‚‹é–¢æ•°
        function endQuest(completed = false) {
            state.savedQuest = null;
            saveState();
            stopBGM();
            clearInterval(quest.timerInterval);
            quest.timerInterval = null; // å¿˜ã‚Œãšã«ã‚¯ãƒªã‚¢

Â  Â  Â  Â  Â  Â  // --- â˜…è¿½åŠ â˜… ã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†æ™‚ã«SWã®ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ ---
Â  Â  Â  Â  Â  Â  cancelQuestAlarm();
            if (!completed && quest.currentIndex >= 0 && quest.currentIndex < quest.plan.length) {
                const currentStep = quest.plan[quest.currentIndex];
                // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒ 'section' (å­¦ç¿’ä¸­) ã®å ´åˆã®ã¿è¨˜éŒ²
                if (currentStep.type === 'section') {
                    const elapsed = currentStep.duration - quest.timeLeft; // çµŒéæ™‚é–“
                    if (elapsed > 0) {
                        recordSession(`${currentStep.text} (ä¸­æ–­)`, elapsed);
                        addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¸­æ–­ï¼‰');
                        state.focus.totalTime += elapsed;
                        saveState();
                        showToast(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® ${formatTime(elapsed)} ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`);
                    }
                }
            }
            
            quest.active = false;
            questActiveScreen.style.display = 'none';

            // ã‚¢ãƒ—ãƒª2ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ–ãƒãƒ¼ã‚’å†è¡¨ç¤º
            $('header').style.display = 'flex';
            $('nav').style.display = '';

            document.body.style.overflow = 'auto';
            closeIframe();
            // â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†æ™‚ã«ç¸¦ç”»é¢ã«æˆ»ã™ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤ï¼‰ â–¼â–¼â–¼
            controlScreenOrientation('default');
            document.body.classList.remove('is-quest-mode');
            if (completed) {
                // ç´¯ç©LPãŒã‚ã‚Œã°ã¾ã¨ã‚ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
                if ((quest.accumulatedLp || 0) > 0) {
                    showLpPopup(quest.accumulatedLp, 'ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†');
                }
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
            }
        };

        // ä¼‘æ†©ç”¨iframeã‚’é–‹ãé–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼šãƒ•ãƒªãƒ¼ã‚ºå¯¾ç­–ãƒ»æ¨©é™å¼·åŒ–ï¼‰
            function openIframe(url) {
                const container = $('#game-container');
                const overlay = $('#iframe-overlay');
                const loader = $('#iframe-loader');
                
                overlay.style.display = 'flex';
                loader.style.display = 'flex';

                // iframeã‚’ä½œæˆ
                const iframe = document.createElement('iframe');
                iframe.id = 'break-iframe';
                iframe.className = 'w-full h-full absolute inset-0 opacity-0 transition-opacity duration-300';
                
                // â–¼â–¼â–¼ ä¿®æ­£ç‚¹1: sandboxã®æ¨©é™ã‚’å¼·åŒ– (allow-same-originãªã©ã‚’è¿½åŠ ) â–¼â–¼â–¼
                // allow-same-origin: ã‚²ãƒ¼ãƒ ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã‚»ãƒ¼ãƒ–ãªã©ã‚’ã™ã‚‹å ´åˆã«å¿…é ˆ
                // allow-presentation / allow-orientation-lock: ç”»é¢åˆ¶å¾¡ç³»
                iframe.sandbox = 'allow-scripts allow-forms allow-popups allow-same-origin allow-modals allow-presentation allow-orientation-lock';
                
                // â–¼â–¼â–¼ ä¿®æ­£ç‚¹2: ã‚²ãƒ¼ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ã®è¨±å¯å±æ€§ã‚’è¿½åŠ  â–¼â–¼â–¼
                // ã“ã‚Œã«ã‚ˆã‚ŠGPUã®ä½¿ç”¨ãªã©ãŒã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
                iframe.allow = "autoplay; fullscreen; gyroscope; accelerometer; clipboard-write";
                
                iframe.style.border = '0';
                iframe.src = url;

                // èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
                iframe.onload = () => {
                    loader.style.display = 'none';
                    iframe.classList.remove('opacity-0');
                    iframe.classList.add('opacity-100');
                };

                container.appendChild(iframe);
                lucide.createIcons();
            };
        
            function closeIframe() {
                const container = $('#game-container');
                const iframe = document.getElementById('break-iframe');
                const overlay = $('#iframe-overlay');
                
                // iframeãŒå­˜åœ¨ã™ã‚Œã°å‰Šé™¤
                if (iframe) {
                    iframe.remove();
                }
                
                overlay.style.display = 'none';
            };
            
        // â˜…ä¿®æ­£å¾Œâ˜… ä¼‘æ†©ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        // â†“â†“â†“ æ—¢å­˜ã® renderBreakIcons ã‚’ã“ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â†“â†“â†“
function renderBreakIcons() {
    if (!breakIconGrid) return;

    const isSimple = state.settings.simpleBreakIcons; // è¨­å®šã‚’ç¢ºèª
    const items = state.breakIcons.filter(icon => icon.visible);

    breakIconGrid.innerHTML = items.map(icon => {
        let visualHTML = '';

        if (isSimple) {
            // â˜…ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰: ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼èƒŒæ™¯ + ç™½ã‚¢ã‚¤ã‚³ãƒ³
            // .break-app-icon ã‚¯ãƒ©ã‚¹ (CSSã§72pxã‚µã‚¤ã‚ºæŒ‡å®šæ¸ˆã¿) ã‚’åˆ©ç”¨ã—ã¤ã¤ã€èƒŒæ™¯è‰²ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§ä¸Šæ›¸ã
            visualHTML = `
                <div class="break-app-icon shadow-lg" style="background-color: var(--primary-color);">
                    <i data-lucide="${icon.icon}" class="w-8 h-8 text-white"></i>
                </div>
            `;
        } else {
            // â˜…é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ç”»åƒ
            if (icon.thumbnail) {
                // èƒŒæ™¯è‰²ã‚¯ãƒ©ã‚¹ã‚’ bg-transparent ã«ã—ã¦ãƒœãƒƒã‚¯ã‚¹ã‚’æ¶ˆã™
                visualHTML = `<img src="${icon.thumbnail}" alt="${icon.name}" class="break-app-icon bg-transparent object-cover">`;
            } else {
                // ç”»åƒãŒãªã„å ´åˆ
                visualHTML = `
                    <div class="break-app-icon bg-gray-700">
                        <i data-lucide="${icon.icon}" class="w-8 h-8 text-white"></i>
                    </div>
                `;
            }
        }

        return `
            <button class="break-content-btn" data-url="${icon.url}" data-open-mode="${icon.openMode || 'external'}" data-id="${icon.id}">
                ${visualHTML}
                <span>${icon.name}</span>
            </button>
        `;
    }).join('');
    
    lucide.createIcons();
}
// â†‘â†‘â†‘ ä¿®æ­£ã“ã“ã¾ã§ â†‘â†‘â†‘

        // â˜…æ–°è¦è¿½åŠ â˜… è§£ç¦æ¸ˆã¿ã‚²ãƒ¼ãƒ ã‚’breakIconsã«åŒæœŸã•ã›ã‚‹é–¢æ•°
        // â†“â†“â†“ æ—¢å­˜ã® syncGamesToBreakIcons ã‚’ã“ã®ã‚³ãƒ¼ãƒ‰ã«ä¸¸ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â†“â†“â†“
function syncGamesToBreakIcons() {
    // 1. ã‚²ãƒ¼ãƒ ã®åŒæœŸ
    state.profile.unlockedGames.forEach(gameId => {
        const game = initialData.games[gameId];
        if (!game) return;

        // æœ€æ–°ã®ã‚µãƒ ãƒã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
        const newThumbnail = game.thumbnail || (game.previews && game.previews.length > 0 ? game.previews[0] : null);
        
        // æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‹ç¢ºèª
        const existingIcon = state.breakIcons.find(icon => icon.id === gameId);
        
        if (existingIcon) {
            // â˜…é‡è¦: æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚‹å ´åˆã§ã‚‚ã€æœ€æ–°ã®ç”»åƒæƒ…å ±ã‚’ä¸Šæ›¸ãã™ã‚‹
            existingIcon.thumbnail = newThumbnail;
            // ã¤ã„ã§ã«åå‰ãªã©ã‚‚æœ€æ–°ã«åŒæœŸã—ã¦ãŠãã¨å®‰å…¨ã§ã™
            existingIcon.name = game.name;
            existingIcon.icon = game.icon;
            existingIcon.url = game.url;
        } else {
            // ãƒªã‚¹ãƒˆã«ãªã„å ´åˆã¯æ–°è¦è¿½åŠ 
            state.breakIcons.push({
                id: gameId,
                name: game.name,
                icon: game.icon,
                url: game.url,
                openMode: 'iframe',
                type: 'game',
                visible: true,
                thumbnail: newThumbnail
            });
        }
    });

    // 2. SNSã‚¢ã‚¤ã‚³ãƒ³ï¼ˆX, Instagram, YouTubeï¼‰ã®ç”»åƒæƒ…å ±ã‚‚å¼·åˆ¶æ›´æ–°
    // ã“ã‚Œã«ã‚ˆã‚Šã€localStorageã«å¤ã„ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã¦ã‚‚ç”»åƒãŒåæ˜ ã•ã‚Œã¾ã™
    const staticIcons = [
        { id: 'x', thumbnail: 'x.png' },
        { id: 'instagram', thumbnail: 'Instagram.png' },
        { id: 'youtube', thumbnail: 'youtube.png' }
    ];

    staticIcons.forEach(staticItem => {
        const target = state.breakIcons.find(i => i.id === staticItem.id);
        if (target) {
            // å¼·åˆ¶çš„ã«ç”»åƒãƒ‘ã‚¹ã‚’è¨­å®š
            target.thumbnail = staticItem.thumbnail;
        }
    });

    saveState(); // å¤‰æ›´ã‚’ä¿å­˜
}
// â†‘â†‘â†‘ ä¿®æ­£ã“ã“ã¾ã§ â†‘â†‘â†‘

        // --- 6. ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®šã‚µãƒ–ãƒšãƒ¼ã‚¸ (æ–°è¦è¿½åŠ ) ---
        // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆ: ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ è¨­å®šãƒšãƒ¼ã‚¸ (ãƒˆã‚°ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œç‰ˆ) â–¼â–¼â–¼

// ä¸¦ã³æ›¿ãˆç®¡ç†ç”¨ã®å¤‰æ•°ã‚’ã“ã“ï¼ˆé–¢æ•°ã®å¤–ï¼‰ã§å®šç¾©
let breakSortableActive = null;
let breakSortableInactive = null;

const breakSettingsPage = new SubPage('break-settings-screen', {
    onOpen: () => {
        const pageRoot = document.querySelector('#break-settings-screen .overflow-y-auto');
        if (!pageRoot) return;

        // æ—¢å­˜ã®Sortableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¢ºå®Ÿã«ç ´æ£„
        if (breakSortableActive) {
            breakSortableActive.destroy();
            breakSortableActive = null;
        }
        if (breakSortableInactive) {
            breakSortableInactive.destroy();
            breakSortableInactive = null;
        }

        const isSimple = state.settings.simpleBreakIcons;

        // HTMLç”Ÿæˆ
        pageRoot.innerHTML = `
            <div class="space-y-8 pb-10">
                <div>
                    <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                    <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                        <div class="flex items-center justify-between p-4 h-16">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mr-4 shadow-sm text-white" style="background-color: var(--primary-color);">
                                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                                </div>
                                <div class="flex flex-col justify-center">
                                    <span class="text-sm font-bold text-gray-800 dark:text-white">ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹</span>
                                    <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500">ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã§è¡¨ç¤º</span>
                                </div>
                            </div>
                            <div class="relative">
                                <input type="checkbox" id="break-style-toggle" class="peer sr-only">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--primary-color)]"></div>
                                <label for="break-style-toggle" class="absolute inset-0 cursor-pointer w-full h-full"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">è¡¨ç¤ºä¸­ (ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•)</h3>
                    <div id="break-active-list" class="grid grid-cols-4 gap-4 p-2 min-h-[120px] transition-colors"></div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">è¿½åŠ å¯èƒ½</h3>
                    <div id="break-inactive-list" class="grid grid-cols-4 gap-4 p-2 min-h-[120px]"></div>
                </div>
            </div>
        `;

        // 1. ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒåˆ¶å¾¡ (â˜…ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸ)
        const toggle = document.getElementById('break-style-toggle');
        if (toggle) {
            toggle.checked = isSimple;
            toggle.addEventListener('change', (e) => {
                state.settings.simpleBreakIcons = e.target.checked;
                saveState();
                
                // â˜…é‡è¦: ã‚¹ã‚¤ãƒƒãƒã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³(transition)ã‚’è¦‹ã›ã‚‹ãŸã‚ã€
                // 0.3ç§’å¾…ã£ã¦ã‹ã‚‰ç”»é¢ã‚’å†æç”»ã—ã¾ã™ã€‚
                setTimeout(() => {
                    breakSettingsPage.onOpen(); 
                }, 300);
            });
        }

        const activeContainer = document.getElementById('break-active-list');
        const inactiveContainer = document.getElementById('break-inactive-list');

        const activeIcons = state.breakIcons.filter(i => i.visible);
        const inactiveIcons = state.breakIcons.filter(i => !i.visible);

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼: ã‚¢ã‚¤ã‚³ãƒ³HTMLç”Ÿæˆ ---
        const createIconHTML = (icon, type) => {
            let visualHTML = '';
            const badgeColor = type === 'active' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
            const badgeIcon = type === 'active' ? 'x' : 'plus';
            const actionClass = type === 'active' ? 'remove-break-btn' : 'add-break-btn';

            if (isSimple) {
                // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰
                visualHTML = `
                    <div class="w-[72px] h-[72px] rounded-2xl shadow-md flex items-center justify-center transition-transform active:scale-95" style="background-color: var(--primary-color);">
                        <i data-lucide="${icon.icon}" class="w-8 h-8 text-white"></i>
                    </div>
                `;
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆç”»åƒï¼‰
                if (icon.thumbnail) {
                    visualHTML = `
                        <div class="w-[72px] h-[72px] rounded-2xl shadow-md overflow-hidden bg-transparent transition-transform active:scale-95 relative flex items-center justify-center">
                            <img src="${icon.thumbnail}" alt="${icon.name}" class="w-full h-full object-cover">
                        </div>
                    `;
                } else {
                    visualHTML = `
                        <div class="w-[72px] h-[72px] rounded-2xl shadow-md flex items-center justify-center bg-gray-700 transition-transform active:scale-95">
                            <i data-lucide="${icon.icon}" class="w-8 h-8 text-white"></i>
                        </div>
                    `;
                }
            }

            return `
                <div class="break-settings-item relative group cursor-grab active:cursor-grabbing touch-none select-none" data-id="${icon.id}">
                    <div class="relative mb-1 flex-shrink-0">
                        ${visualHTML}
                        <button class="${actionClass} action-badge ${badgeColor} text-white transition-colors">
                            <i data-lucide="${badgeIcon}" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <span>${icon.name}</span>
                </div>
            `;
        };

        // --- 2. ãƒªã‚¹ãƒˆæç”» ---
        activeContainer.innerHTML = activeIcons.map(icon => createIconHTML(icon, 'active')).join('');
        inactiveContainer.innerHTML = inactiveIcons.map(icon => createIconHTML(icon, 'inactive')).join('');

        lucide.createIcons({ root: document.getElementById('break-settings-screen') });

        // --- 3. çŠ¶æ…‹ä¿å­˜ãƒ»æ›´æ–°å‡¦ç† ---
        const updateStateFromDOM = () => {
            const activeIds = Array.from(activeContainer.querySelectorAll('.break-settings-item')).map(el => el.dataset.id);
            const inactiveIds = Array.from(inactiveContainer.querySelectorAll('.break-settings-item')).map(el => el.dataset.id);

            const newActive = activeIds.map(id => {
                const item = state.breakIcons.find(i => i.id === id);
                if(item) item.visible = true; 
                return item;
            }).filter(Boolean);

            const newInactive = inactiveIds.map(id => {
                const item = state.breakIcons.find(i => i.id === id);
                if(item) item.visible = false;
                return item;
            }).filter(Boolean);

            state.breakIcons = [...newActive, ...newInactive];
            saveState();
        };

        // --- 4. ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ ---
        const setupBtnEvents = (container, isRemoving) => {
            const btnClass = isRemoving ? '.remove-break-btn' : '.add-break-btn';
            container.querySelectorAll(btnClass).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const itemEl = e.target.closest('.break-settings-item');
                    const id = itemEl.dataset.id;
                    
                    itemEl.classList.add('animate-scale-out');
                    
                    setTimeout(() => {
                        const icon = state.breakIcons.find(i => i.id === id);
                        if (icon) {
                            icon.visible = !isRemoving;
                            saveState();
                            breakSettingsPage.onOpen();
                        }
                    }, 300);
                });
            });
        };

        setupBtnEvents(activeContainer, true);
        setupBtnEvents(inactiveContainer, false);

        // --- 5. SortableJS è¨­å®š ---
        const sortableOptions = {
            group: 'breakIconsGroup',
            animation: 250,
            delay: 100,
            delayOnTouchOnly: true,
            touchStartThreshold: 5,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: (evt) => {
                updateStateFromDOM();
                setTimeout(() => breakSettingsPage.onOpen(), 50);
            }
        };

        breakSortableActive = Sortable.create(activeContainer, sortableOptions);
        breakSortableInactive = Sortable.create(inactiveContainer, sortableOptions);
    }
});
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ç´ä»˜ã‘
            $('#close-break-settings-btn').addEventListener('click', () => breakSettingsPage.close());

        /* â–²â–²â–² è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®é–¢æ•°ç¾¤ â–²â–²â–² */
        
            
            const restoreFocusState = () => {
            // ä¿å­˜ã•ã‚ŒãŸå®Ÿè¡Œä¸­ã®ã‚¿ã‚¤ãƒãƒ¼/SWãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (!state.focus.isRunning || !state.focus.startTime) {
                setTimer(1800);
                return;
            }
        
            const elapsed = Math.floor((Date.now() - state.focus.startTime) / 1000); // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
        
            // å¾©å…ƒã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦UIã‚’æ›´æ–°
            updateFocusModeUI();
        
            if (state.focus.mode === 'timer') {
                const timeLeft = state.focus.duration - elapsed;
        
                if (timeLeft <= 0) {
                    // å¾©å…ƒæ™‚ã«ã¯ã‚¿ã‚¤ãƒãƒ¼ãŒæ—¢ã«çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆ
                    showToast('ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã„ã‚‹é–“ã«ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¾ã—ãŸ');
                    new Notification('StudyQuest', { body: 'é›†ä¸­ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¦ã„ã¾ã—ãŸã€‚' }); // é€šçŸ¥ã‚‚å‡ºã™
                    recordSession('ã‚¿ã‚¤ãƒãƒ¼', state.focus.duration);
                    addLP(Math.floor(state.focus.duration / 60), 'ã‚¿ã‚¤ãƒãƒ¼');
                    resetTimerUI();
                    // çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                    state.focus.isRunning = false;
                    state.focus.startTime = null;
                    saveState();
                    setTimer(1800); // æ¬¡ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
                } else {
                    // ã‚¿ã‚¤ãƒãƒ¼ã‚’å¾©å…ƒ
                    focusTimer.timeLeft = timeLeft;
                    focusTimer.defaultTime = state.focus.duration;
                    focusTimer.isRunning = true;
        
                    $('#focus-timer-display').textContent = formatTime(timeLeft);
                    $('#focus-start-btn').classList.add('hidden');
                    $('#focus-controls').classList.remove('hidden');
                    $('#timer-settings-container').classList.add('hidden');
        
                    focusTimer.interval = setInterval(timerTick, 1000);
                    updateMiniTimer();
                }
            } else { // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®å ´åˆ
                stopwatch.elapsedTime = elapsed;
                stopwatch.startTime = state.focus.startTime;
                stopwatch.isRunning = true;
        
                $('#stopwatch-display').textContent = formatStopwatchTime(elapsed);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
        
                stopwatch.interval = setInterval(stopwatchTick, 100);
                updateMiniTimer();
            }
        };

            // ==========================================
            // â–¼â–¼â–¼ åˆæœŸè¨­å®šã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ (ãƒ‡ã‚¶ã‚¤ãƒ³çµ±ä¸€ãƒ»ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ) â–¼â–¼â–¼
            // ==========================================

            const wizardData = {
                step: 0,
                maxStep: 4, 
                tempProfile: { name: '', icon: '', grade: '' },
                direction: 'next'
            };

            const gradeCategories = {
                'elementary': { label: 'å°å­¦ç”Ÿ', color: 'text-orange-500 bg-orange-50 dark:bg-orange-900/20', grades: ['å°å­¦1å¹´ç”Ÿ', 'å°å­¦2å¹´ç”Ÿ', 'å°å­¦3å¹´ç”Ÿ', 'å°å­¦4å¹´ç”Ÿ', 'å°å­¦5å¹´ç”Ÿ', 'å°å­¦6å¹´ç”Ÿ'] },
                'middle': { label: 'ä¸­å­¦ç”Ÿ', color: 'text-green-500 bg-green-50 dark:bg-green-900/20', grades: ['ä¸­å­¦1å¹´ç”Ÿ', 'ä¸­å­¦2å¹´ç”Ÿ', 'ä¸­å­¦3å¹´ç”Ÿ'] },
                'high': { label: 'é«˜æ ¡ç”Ÿ', color: 'text-blue-500 bg-blue-50 dark:bg-blue-900/20', grades: ['é«˜æ ¡1å¹´ç”Ÿ', 'é«˜æ ¡2å¹´ç”Ÿ', 'é«˜æ ¡3å¹´ç”Ÿ'] },
                'other': { label: 'ãã®ä»–', color: 'text-purple-500 bg-purple-50 dark:bg-purple-900/20', grades: ['å¤§å­¦ãƒ»å°‚é–€å­¦ç”Ÿ', 'ç¤¾ä¼šäººãƒ»ãã®ä»–'] }
            };

            const startRegistrationWizard = () => {
                const wizard = $('#registration-wizard');
                $('#welcome-screen').classList.add('hidden');
                
                wizard.classList.remove('hidden');
                requestAnimationFrame(() => {
                    wizard.classList.remove('opacity-0', 'scale-95');
                    wizard.classList.add('opacity-100', 'scale-100');
                });

                wizardData.step = 0;
                wizardData.direction = 'next';
                const currentIcon = $('#reg-icon') ? $('#reg-icon').value : 'ğŸ“';
                wizardData.tempProfile.icon = currentIcon;
                renderWizardStep();
            };

            const closeWizard = () => {
                const wizard = $('#registration-wizard');
                wizard.classList.remove('opacity-100', 'scale-100');
                wizard.classList.add('opacity-0', 'scale-95');
                
                setTimeout(() => {
                    wizard.classList.add('hidden');
                    const welcome = $('#welcome-screen');
                    welcome.classList.remove('hidden');
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
                    const slides = welcome.querySelectorAll('.welcome-slide-item');
                    slides.forEach(el => {
                        el.style.animation = 'none';
                        el.style.opacity = '0';
                        el.offsetHeight; 
                        el.style.animation = ''; 
                    });
                    
                    const fadeIns = welcome.querySelectorAll('.animate-fadeIn');
                    fadeIns.forEach(el => {
                        el.classList.remove('animate-fadeIn');
                        el.offsetHeight;
                        el.classList.add('animate-fadeIn');
                    });

                }, 300);
            };

            const handleNextStep = () => {
                if (wizardData.step < 3) {
                    performTransition('next', () => {
                        wizardData.step++;
                        renderWizardStep();
                    });
                } else {
                    handleNotificationRequest();
                }
            };

            const handlePrevStep = () => {
                if (wizardData.step > 0) {
                    performTransition('prev', () => {
                        wizardData.step--;
                        renderWizardStep();
                    });
                }
            };

            const performTransition = (direction, callback) => {
                const content = $('#wizard-content');
                wizardData.direction = direction;
                const exitClass = direction === 'next' ? 'wizard-anim-next-exit' : 'wizard-anim-prev-exit';
                content.classList.add(exitClass);
                setTimeout(() => {
                    content.classList.remove(exitClass);
                    callback();
                }, 300);
            };

            const renderWizardStep = () => {
                const content = $('#wizard-content');
                const nextBtn = $('#wizard-next-btn');
                const prevBtn = $('#wizard-prev-btn');
                const indicator = $('#wizard-steps');

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹é©ç”¨
                const enterClass = wizardData.direction === 'next' ? 'wizard-anim-next-enter' : 'wizard-anim-prev-enter';
                content.classList.remove('wizard-anim-next-enter', 'wizard-anim-prev-enter');
                void content.offsetWidth;
                content.classList.add(enterClass);

                // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
                if (indicator.children.length !== 4) {
                    indicator.innerHTML = Array(4).fill(0).map((_, i) => `<div class="step-dot"></div>`).join('');
                }
                Array.from(indicator.children).forEach((dot, i) => {
                    if (i === wizardData.step) dot.classList.add('active');
                    else dot.classList.remove('active');
                });

                // ãƒœã‚¿ãƒ³åˆ¶å¾¡
                // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£ (shadow-moderné©ç”¨)
                prevBtn.className = "w-14 h-14 flex-shrink-0 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 rounded-full shadow-modern flex items-center justify-center transition-transform active:scale-95 border-none";
                prevBtn.classList.remove('hidden');
                
                if (wizardData.step === 0) {
                    prevBtn.disabled = true;
                    prevBtn.style.opacity = '0.3';
                    prevBtn.style.cursor = 'default';
                } else {
                    prevBtn.disabled = false;
                    prevBtn.style.opacity = '1';
                    prevBtn.style.cursor = 'pointer';
                }

                nextBtn.innerHTML = 'æ¬¡ã¸';
                nextBtn.onclick = handleNextStep;
                nextBtn.disabled = false;

                content.innerHTML = '';

                // --- Step 0: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š ---
                if (wizardData.step === 0) {
                    content.innerHTML = `
                        <div class="flex-grow flex flex-col items-center justify-center w-full">
                            <h2 class="text-2xl font-bold mb-2 text-center text-gray-800 dark:text-white">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®š</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-10 text-center">ã¾ãšã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºã‚ã¾ã—ã‚‡ã†ï¼</p>
                            
                            <div class="relative group cursor-pointer mb-8 transition-transform active:scale-95" id="wiz-icon-picker">
                                <div class="w-32 h-32 rounded-full border-4 shadow-modern bg-gray-50 dark:bg-gray-800 flex items-center justify-center text-6xl select-none" style="border-color: var(--primary-color);">
                                    ${wizardData.tempProfile.icon || 'ğŸ“'}
                                </div>
                                <div class="absolute bottom-0 right-0 text-white p-3 rounded-full shadow-lg border-4 border-white dark:border-gray-900" style="background-color: var(--primary-color);">
                                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                </div>
                            </div>

                            <div class="w-full max-w-xs">
                                <label class="block text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider text-center">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
                                <input type="text" id="wiz-name-input" class="w-full p-4 rounded-super shadow-modern border-none outline-none text-lg font-bold text-center text-gray-800 dark:text-white dark:bg-gray-800 placeholder-gray-300 focus:ring-2 primary-ring" placeholder="ä¾‹: ã‚¹ã‚¿ãƒ‡ã‚£å‹‡è€…" value="${wizardData.tempProfile.name}">
                            </div>
                        </div>
                    `;

                    const iconEl = content.querySelector('#wiz-icon-picker .text-6xl');
                    content.querySelector('#wiz-icon-picker').onclick = () => {
                        const emojis = ['ğŸ“','âœï¸','ğŸ”¥','ğŸ±','ğŸ¶','ğŸš€','â­','ğŸ','âš½','ğŸµ','ğŸ¨','ğŸ’»'];
                        wizardData.tempProfile.icon = emojis[Math.floor(Math.random() * emojis.length)];
                        iconEl.textContent = wizardData.tempProfile.icon;
                    };
                    
                    const nameInput = content.querySelector('#wiz-name-input');
                    nameInput.oninput = (e) => {
                        wizardData.tempProfile.name = e.target.value;
                        nextBtn.disabled = !e.target.value.trim();
                    };
                    nextBtn.disabled = !wizardData.tempProfile.name;
                }

                // --- Step 1: å­¦å¹´è¨­å®š ---
                else if (wizardData.step === 1) {
                    content.innerHTML = `
                        <div class="w-full">
                            <h2 class="text-2xl font-bold mb-2 text-center text-gray-800 dark:text-white">å­¦å¹´ã‚’é¸æŠ</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-8 text-center">å­¦ç¿’å†…å®¹ã®å‚è€ƒã«ã—ã¾ã™</p>
                            <div id="grade-accordion-area" class="w-full space-y-3"></div>
                        </div>
                    `;
                    
                    const area = content.querySelector('#grade-accordion-area');
                    nextBtn.disabled = !wizardData.tempProfile.grade;

                    Object.entries(gradeCategories).forEach(([key, data]) => {
                        // ãƒ‡ã‚¶ã‚¤ãƒ³çµ±ä¸€: rounded-super, shadow-modern
                        const container = document.createElement('div');
                        container.className = "bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden transition-all duration-300 border border-transparent";
                        const isContainsSelected = data.grades.includes(wizardData.tempProfile.grade);
                        
                        if (isContainsSelected) container.classList.add('primary-border', 'border-2');

                        const headerBtn = document.createElement('button');
                        headerBtn.className = "w-full p-5 flex items-center justify-between font-bold text-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors";
                        headerBtn.innerHTML = `
                            <div class="flex items-center">
                                <span class="w-2 h-2 rounded-full mr-3" style="background-color: var(--primary-color);"></span>
                                <span>${data.label}</span>
                            </div>
                            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform duration-300 accordion-icon"></i>
                        `;

                        const listDiv = document.createElement('div');
                        listDiv.className = "grade-list overflow-hidden transition-all duration-300 ease-in-out bg-gray-50 dark:bg-gray-900/30";
                        listDiv.style.maxHeight = isContainsSelected ? "500px" : "0px";

                        const grid = document.createElement('div');
                        grid.className = "p-3 grid grid-cols-2 gap-2";

                        data.grades.forEach(g => {
                            const btn = document.createElement('button');
                            const isSelected = wizardData.tempProfile.grade === g;
                            const selectedClass = isSelected 
                                ? 'primary-bg text-white shadow-md transform scale-[1.02]' 
                                : 'bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-600';

                            btn.className = `p-3 rounded-xl text-sm font-bold transition-all text-center grade-btn ${selectedClass}`;
                            btn.textContent = g;
                            
                            btn.onclick = (e) => {
                                // ã‚¯ãƒ©ã‚¹ä»˜ã‘æ›¿ãˆã®ã¿ï¼ˆç”»é¢å†æç”»ã—ãªã„ï¼‰
                                area.querySelectorAll('.grade-btn').forEach(b => {
                                    b.className = 'p-3 rounded-xl text-sm font-bold transition-all text-center grade-btn bg-white dark:bg-gray-700 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-600';
                                });
                                e.currentTarget.className = 'p-3 rounded-xl text-sm font-bold transition-all text-center grade-btn primary-bg text-white shadow-md transform scale-[1.02]';
                                
                                wizardData.tempProfile.grade = g;
                                nextBtn.disabled = false;
                            };
                            grid.appendChild(btn);
                        });

                        listDiv.appendChild(grid);
                        container.appendChild(headerBtn);
                        container.appendChild(listDiv);
                        area.appendChild(container);

                        headerBtn.onclick = () => {
                            const isOpen = listDiv.style.maxHeight !== "0px";
                            if (!isOpen) {
                                area.querySelectorAll('.grade-list').forEach(el => el.style.maxHeight = "0px");
                                area.querySelectorAll('.accordion-icon').forEach(el => el.style.transform = "rotate(0deg)");
                                area.querySelectorAll('.border-2').forEach(el => el.classList.remove('primary-border', 'border-2'));
                                
                                listDiv.style.maxHeight = "500px";
                                headerBtn.querySelector('.accordion-icon').style.transform = "rotate(180deg)";
                                container.classList.add('primary-border', 'border-2');
                            } else {
                                listDiv.style.maxHeight = "0px";
                                headerBtn.querySelector('.accordion-icon').style.transform = "rotate(0deg)";
                                container.classList.remove('primary-border', 'border-2');
                            }
                        };
                        
                        if (isContainsSelected) {
                            headerBtn.querySelector('.accordion-icon').style.transform = "rotate(180deg)";
                        }
                    });
                }

                // --- Step 2: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¨­å®š (èª¬æ˜ã‚¨ãƒªã‚¢ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–) ---
                else if (wizardData.step === 2) {
                    content.innerHTML = `
                        <div class="w-full h-full flex flex-col">
                            <div class="flex-shrink-0 text-center mb-2">
                                <h2 class="text-2xl font-bold mb-1 text-gray-800 dark:text-white">å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«</h2>
                                <p class="text-xs text-gray-500 dark:text-gray-400 font-bold mb-3">
                                    ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆãƒ»ã‚¹ãƒ¯ã‚¤ãƒ—ã§å‰Šé™¤
                                </p>
                            </div>
                
                            <div class="flex-shrink-0 bg-white dark:bg-gray-800 p-4 rounded-super border-2 mb-3 shadow-sm" style="border-color: var(--primary-color);">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center shadow-sm text-white mt-1" style="background-color: var(--primary-color);">
                                        <i data-lucide="map" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <h4 class="text-xs font-bold primary-text mb-1">ã‚¯ã‚¨ã‚¹ãƒˆã«ã¤ã„ã¦</h4>
                                        <p class="text-[10px] text-gray-600 dark:text-gray-300 leading-tight mb-2">
                                            ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãªã©ã‚’ã€Œå­¦ç¿’ã€ã¨ã€Œä¼‘æ†©ã€ã®ã‚»ãƒƒãƒˆã§è¡Œã†ã“ã¨ã§ã€ãƒ¡ãƒªãƒãƒªã‚’ã¤ã‘ã¦é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
                                        </p>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1.5">
                                                <i data-lucide="book-open" class="w-3 h-3 primary-text mr-1.5 flex-shrink-0"></i>
                                                <span class="text-[10px] font-bold truncate primary-text">BGMã‚’ã‹ã‘ã¦å­¦ç¿’</span>
                                            </div>
                                            <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1.5">
                                                <i data-lucide="coffee" class="w-3 h-3 text-green-500 mr-1.5 flex-shrink-0"></i>
                                                <span class="text-[10px] text-green-600 dark:text-green-400 font-bold truncate">SNSãƒ»ã‚²ãƒ¼ãƒ ã§ä¼‘æ†©</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-grow overflow-hidden flex flex-col bg-white dark:bg-gray-800 rounded-super shadow-modern p-1 border border-gray-100 dark:border-gray-700 mb-2">
                                <div id="wiz-routine-list" class="flex-grow overflow-y-auto p-1 space-y-2"></div>
                                
                                <div class="flex items-center justify-between p-2 gap-2 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-b-[20px]">
                                    <button id="wiz-add-section" class="flex-1 py-3 rounded-xl hover:bg-white dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold text-sm transition-all flex items-center justify-center active:scale-95 shadow-sm border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                        <i data-lucide="plus" class="w-4 h-4 mr-1"></i> ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                                    </button>
                                    <button id="wiz-add-break" class="flex-1 py-3 rounded-xl hover:bg-white dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold text-sm transition-all flex items-center justify-center active:scale-95 shadow-sm border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                        <i data-lucide="coffee" class="w-4 h-4 mr-1"></i> ãƒ–ãƒ¬ã‚¤ã‚¯
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    const listEl = content.querySelector('#wiz-routine-list');
                    const renderList = () => {
                        listEl.innerHTML = state.profile.routineTemplate.map((item, idx) => `
                            <div class="wiz-routine-item swipe-container relative overflow-hidden group w-full bg-gray-50 dark:bg-gray-700/30 rounded-xl transition-colors border border-gray-100 dark:border-gray-700/50" data-index="${idx}">
                                <div class="swipe-actions">
                                    <button class="btn-delete swipe-btn bg-red-500 w-[70px] rounded-r-xl">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="swipe-content flex items-center p-3 h-full relative z-10 w-full bg-white dark:bg-gray-800 rounded-xl">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 flex-shrink-0 ${item.type==='section'?'bg-indigo-100 dark:bg-indigo-900/30':'bg-green-100 dark:bg-green-900/30'}">
                                        <i data-lucide="${item.type==='section'?'book-open':'coffee'}" class="w-5 h-5 ${item.type==='section'?'text-indigo-500':'text-green-500'}"></i>
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <p class="font-bold text-sm text-gray-800 dark:text-gray-200">${item.type==='section'?'ã‚»ã‚¯ã‚·ãƒ§ãƒ³':'ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ '}</p>
                                    </div>
                                    <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg px-2 py-1 flex-shrink-0 mr-2">
                                        <input type="number" value="${Math.floor(item.duration/60)}" class="wiz-duration-input w-8 bg-transparent text-center font-bold text-sm text-gray-700 dark:text-gray-200 focus:outline-none p-0 appearance-none">
                                        <span class="text-[10px] text-gray-400 font-bold ml-0.5">åˆ†</span>
                                    </div>
                                    <div class="wiz-handle cursor-grab active:cursor-grabbing text-gray-300 p-2 -mr-2 touch-none">
                                        <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        lucide.createIcons({ root: listEl });

                        listEl.querySelectorAll('.wiz-routine-item').forEach(itemEl => {
                            const idx = parseInt(itemEl.dataset.index);
                            itemEl.querySelector('.wiz-duration-input').addEventListener('change', (e) => {
                                let val = parseInt(e.target.value);
                                if(val < 1) val = 1;
                                state.profile.routineTemplate[idx].duration = val * 60;
                            });
                            new SwipeHandler(itemEl, {
                                onDelete: () => {
                                    state.profile.routineTemplate.splice(idx, 1);
                                    renderList();
                                }
                            });
                        });
                    };
                    renderList();

                    if (window.Sortable) {
                        Sortable.create(listEl, {
                            handle: '.wiz-handle',
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            delay: 150, 
                            delayOnTouchOnly: true,
                            touchStartThreshold: 5,
                            filter: '.swiped-open, .is-swiping, .swipe-deleting',
                            onEnd: (evt) => {
                                const item = state.profile.routineTemplate.splice(evt.oldIndex, 1)[0];
                                state.profile.routineTemplate.splice(evt.newIndex, 0, item);
                                wizardData.isRoutineEdited = true;
                            }
                        });
                    }

                    content.querySelector('#wiz-add-section').onclick = () => {
                        state.profile.routineTemplate.push({ id: Date.now(), type: 'section', duration: 25 * 60 });
                        renderList();
                        setTimeout(() => listEl.scrollTop = listEl.scrollHeight, 100);
                    };
                    content.querySelector('#wiz-add-break').onclick = () => {
                        state.profile.routineTemplate.push({ id: Date.now(), type: 'break', duration: 5 * 60 });
                        renderList();
                        setTimeout(() => listEl.scrollTop = listEl.scrollHeight, 100);
                    };
                }

                // --- Step 3: é€šçŸ¥è¨±å¯ ---
                else if (wizardData.step === 3) {
                    nextBtn.innerHTML = 'é€šçŸ¥ã‚’è¨±å¯ã—ã¦å§‹ã‚ã‚‹';
                    
                    content.innerHTML = `
                        <div class="flex-grow flex flex-col items-center justify-center w-full h-full">
                            <div class="relative w-full h-full mb-8">
                                <img src="tutorial_4.png" class="w-full h-full object-contain drop-shadow-2xl" alt="Notification" onerror="this.style.display='none'">
                            </div>
                            <p class="text-xs font-bold text-gray-400 dark:text-gray-500 text-center bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded-full mb-6">
                                â€»ã“ã‚Œã‚‰ã®è¨­å®šã¯ã„ã¤ã§ã‚‚å¤‰æ›´å¯èƒ½ã§ã™
                            </p>
                        </div>
                    `;
                }

                lucide.createIcons();
            };

            // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆ: ã‚ˆã†ã“ãç”»é¢ã®é€šçŸ¥è¨±å¯ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
            const handleNotificationRequest = async () => {
                if (!('Notification' in window)) {
                    completeWizard();
                    return;
                }

                // æ—¢ã«è¨±å¯ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (Notification.permission === 'granted') {
                    completeWizard();
                    return;
                }

                // ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆã¾ãŸã¯ã“ã‚Œã‹ã‚‰æ‹’å¦ã—ãŸå ´åˆï¼‰ã®å…±é€šå‡¦ç†
                const showDeniedPopup = () => {
                    openGeneralConfirm(
                        'é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ',
                        'ç«¯æœ«ã®è¨­å®šç”»é¢ã§å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚',
                        'bell-off',
                        'OK',
                        'primary-bg',
                        () => completeWizard(), // OKã‚’æŠ¼ã—ãŸã‚‰å®Œäº†ã—ã¦é€²ã‚€
                        null // â˜…ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ãªã—
                    );
                };

                // ä»¥å‰ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (Notification.permission === 'denied') {
                    showDeniedPopup();
                    return;
                }

                // ã¾ã æœªé¸æŠã®å ´åˆ -> ãƒã‚¤ãƒ†ã‚£ãƒ–ã®è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        completeWizard();
                    } else {
                        // ä»Šå›ã€Œè¨±å¯ã—ãªã„ã€ã‚’é¸ã‚“ã å ´åˆ
                        showDeniedPopup();
                    }
                } catch (e) {
                    console.error(e);
                    completeWizard();
                }
            };

            const completeWizard = () => {
                state.user.name = wizardData.tempProfile.name;
                state.user.icon = wizardData.tempProfile.icon;
                state.user.grade = wizardData.tempProfile.grade;
                state.user.isRegistered = true;
                
                addLP(1000, 'ã¯ã˜ã‚ã¾ã—ã¦ï¼', false);
                state.lastLogin = new Date().toDateString();
                
                saveState();
                updateAppearance();

                const wizard = $('#registration-wizard');
                wizard.classList.add('opacity-0', 'scale-95');
                
                setTimeout(() => {
                    wizard.classList.add('hidden');
                    $('#app-container').classList.remove('hidden');
                    renderEngine.renderAll();
                    showToast(`ã‚ˆã†ã“ãã€${state.user.name}ã•ã‚“ï¼`);
                    showLpPopup(1000, 'åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹');
                }, 300);
            };

            $('#wizard-close-btn').addEventListener('click', closeWizard);
            $('#wizard-prev-btn').addEventListener('click', handlePrevStep);
            
            $('#btn-start-new').addEventListener('click', startRegistrationWizard);
            // â–¼â–¼â–¼ è¿½åŠ : å¼•ãç¶™ããƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š â–¼â–¼â–¼
            const transferStartBtn = document.getElementById('btn-transfer-start');
            if (transferStartBtn) {
                transferStartBtn.addEventListener('click', () => {
                    openMigrationModal(true);
                });
            }

            // ==========================================
            // â–²â–²â–² æ–°ã—ã„åˆæœŸè¨­å®šã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰çµ‚äº† â–²â–²â–²
            // ==========================================
            
            // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã‚¯ã‚¨ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã®å®šç¾©ï¼ˆã“ã‚ŒãŒæŠœã‘ã¦ã„ã¾ã—ãŸï¼‰ â–¼â–¼â–¼
            const questPage = new SubPage('quest-view', {
                onOpen: () => {
                    renderQuestPlan();
                    lucide.createIcons();
                }
            });

            // ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆFocusãƒšãƒ¼ã‚¸å†…ï¼‰
            const showQuestBtn = document.getElementById('show-quest-btn');
            if (showQuestBtn) {
                showQuestBtn.addEventListener('click', (e) => {
                    // bodyã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¨é‡è¤‡ã—ãªã„ã‚ˆã†ã«ä¼æ’­ã‚’æ­¢ã‚ã‚‹
                    e.stopPropagation(); 
                    questPage.open();
                });
            }

            // ã‚¯ã‚¨ã‚¹ãƒˆæˆ»ã‚‹ãƒœã‚¿ãƒ³
            const questBackBtn = document.getElementById('quest-back-btn');
            if (questBackBtn) {
                questBackBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    questPage.close();
                    updateFocusModeUI(); 
                });
            }
            // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

            // ==========================================
            // â–¼â–¼â–¼ å„ãƒšãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ– (ã“ã“ã ã‘ã§ç®¡ç†ã§ãã¾ã™) â–¼â–¼â–¼
            // ==========================================

            // 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢
            const profilePage = new SubPage('profile-screen', {
                onOpen: () => {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ç‰¹æœ‰ã®æç”»å‡¦ç†
                    $('#edit-profile-icon').value = state.user.icon;
                    $('#edit-profile-name').value = state.user.name;
                    
                    const gradeSelect = $('#edit-profile-grade');
                    
                    // â–¼â–¼â–¼ ä¿®æ­£: é¸æŠè‚¢ãŒå­˜åœ¨ã—ãªã„å ´åˆã€JSã§ç›´æ¥ç”Ÿæˆã™ã‚‹ â–¼â–¼â–¼
                    if (gradeSelect.children.length <= 1) { 
                        const allGrades = [
                            'å°å­¦1å¹´ç”Ÿ', 'å°å­¦2å¹´ç”Ÿ', 'å°å­¦3å¹´ç”Ÿ', 'å°å­¦4å¹´ç”Ÿ', 'å°å­¦5å¹´ç”Ÿ', 'å°å­¦6å¹´ç”Ÿ',
                            'ä¸­å­¦1å¹´ç”Ÿ', 'ä¸­å­¦2å¹´ç”Ÿ', 'ä¸­å­¦3å¹´ç”Ÿ',
                            'é«˜æ ¡1å¹´ç”Ÿ', 'é«˜æ ¡2å¹´ç”Ÿ', 'é«˜æ ¡3å¹´ç”Ÿ',
                            'å¤§å­¦ãƒ»å°‚é–€å­¦ç”Ÿ', 'ç¤¾ä¼šäººãƒ»ãã®ä»–'
                        ];
                        
                        let optionsHTML = '<option value="" disabled>é¸æŠã—ã¦ãã ã•ã„</option>';
                        allGrades.forEach(g => {
                            optionsHTML += `<option value="${g}">${g}</option>`;
                        });
                        gradeSelect.innerHTML = optionsHTML;
                    }
                    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

                    gradeSelect.value = state.user.grade;
                }
            });
            $('#close-profile-btn').addEventListener('click', () => profilePage.close());

            // ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´ãƒœã‚¿ãƒ³ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
            const editIconBtn = document.getElementById('edit-icon-random-btn');
            if (editIconBtn) {
                editIconBtn.addEventListener('click', () => {
                    const emojis = ['ğŸ“','âœï¸','ğŸ”¥','ğŸ±','ğŸ¶','ğŸš€','â­','ğŸ','âš½','ğŸµ','ğŸ¨','ğŸ’»'];
                    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
                    document.getElementById('edit-profile-icon').value = randomEmoji;
                });
            }

            // ä¿å­˜ãƒœã‚¿ãƒ³
            const saveProfileBtn = document.getElementById('save-profile-btn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', () => {
                    const nameInput = document.getElementById('edit-profile-name');
                    const gradeInput = document.getElementById('edit-profile-grade');
                    const iconInput = document.getElementById('edit-profile-icon');

                    const newName = nameInput.value.trim();
                    const newGrade = gradeInput.value;

                    if (!newName || !newGrade) {
                        showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨å­¦å¹´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return;
                    }

                    // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    state.user.name = newName;
                    state.user.grade = newGrade;
                    state.user.icon = iconInput.value;
                    if (state.user.name === 'é–‹ç™ºç”¨ã€€SQpjfij5678' && state.user.grade === 'å¤§å­¦ãƒ»å°‚é–€å­¦ç”Ÿ') {
                        addLP(1000000, 'é–‹ç™ºè€…æ”¯çµ¦', true);
                    }
                    saveState();

                    // è¨­å®šç”»é¢ï¼ˆè¦ªç”»é¢ï¼‰ã®è¡¨ç¤ºã‚’æ›´æ–°
                    // â€»renderEngineãŒå®šç¾©æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’å‰æ
                    if (typeof renderEngine !== 'undefined' && renderEngine.pages['settings-page']) {
                        renderEngine.pages['settings-page']();
                    }

                    showToast('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                    profilePage.close();
                });
            }

            // 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢
            const statusPage = new SubPage('status-screen', {
                onOpen: () => {
                    renderStatusPageContent(); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã®æç”»
                }
            });

            const openMigrationBtn = $('#open-migration-menu-btn');
            // â–¼â–¼â–¼ ä¿®æ­£: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã‚’é–‹ã„ãŸã¾ã¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é‡ã­ã‚‹ â–¼â–¼â–¼
            if (openMigrationBtn) {
                openMigrationBtn.addEventListener('click', () => {
                    // profilePage.close(); // å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                    openMigrationModal();   // å³åº§ã«é–‹ã
                });
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
            $$('.status-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.currentTarget.dataset.target; // theme, background, game, music ã®ã„ãšã‚Œã‹

                    // 1. å…¨ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«ã™ã‚‹ï¼ˆè‰²ã¯ã‚°ãƒ¬ãƒ¼ã«æˆ»ã™ï¼‰
                    $$('.status-tab-btn').forEach(b => {
                        b.classList.remove('active', 'primary-bg', 'text-white');
                        b.classList.add('bg-gray-200', 'dark:bg-gray-600'); 
                    });

                    // 2. ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«ã™ã‚‹ï¼ˆè‰²ã¯ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼‰
                    e.currentTarget.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                    e.currentTarget.classList.add('active', 'primary-bg', 'text-white');

                    // 3. å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’éš ã™
                    $$('.status-content-section').forEach(section => {
                        section.classList.add('hidden');
                    });

                    // 4. é¸æŠã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹
                    const targetSection = $(`#status-content-${target}`);
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }
                    
                    // ã‚¢ã‚¤ã‚³ãƒ³ã®å†ç”Ÿæˆï¼ˆå¿µã®ãŸã‚ï¼‰
                    lucide.createIcons();
                });
            });
            
            const homeLpBanner = $('#home-lp-banner');
            if (homeLpBanner) {
                homeLpBanner.addEventListener('click', () => statusPage.open());
            }

            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ã‚’é–‰ã˜ã‚‹
            $('#close-status-btn').addEventListener('click', () => statusPage.close());

            // ==========================================
            // â–¼â–¼â–¼ PeerJS ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ (UIå®Œå…¨çµ±åˆç‰ˆ) â–¼â–¼â–¼
            // ==========================================
            
            let peer = null;
            let conn = null;

            // ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            function showMigrationView(viewId) {
                $$('.migration-view').forEach(el => el.classList.add('hidden'));
                $(`#${viewId}`).classList.remove('hidden');
                lucide.createIcons();
            }

            // å…¨ç”»é¢è¡¨ç¤ºã‚’é–‹ã
            function openMigrationModal(fromWelcomeScreen = false) {
                const screen = $('#migration-screen');
                const closeBtn = $('#close-migration-btn');

                // 1. ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
                // â˜…ä¿®æ­£: ã©ã¡ã‚‰ã®å ´åˆã§ã‚‚ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤ºã™ã‚‹
                closeBtn.style.visibility = 'visible';
                
                // â˜…è¿½åŠ : ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆé€šå¸¸ã¯è¡¨ç¤ºï¼‰
                $$('.migration-back-step').forEach(btn => btn.style.display = '');

                // 2. è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                screen.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                screen.classList.add('opacity-100', 'pointer-events-auto', 'scale-100');
                
                // 3. åˆæœŸçŠ¶æ…‹ã¸ãƒªã‚»ãƒƒãƒˆ
                showMigrationView('migration-step-1');
                $('#migration-sender-error').classList.add('hidden');
                $('#migration-target-id').value = "";

                $('#migration-my-id').textContent = "...";
                
                if(peer) { peer.destroy(); peer = null; }
            }

            // å…¨ç”»é¢è¡¨ç¤ºã‚’é–‰ã˜ã‚‹
            function closeMigrationModal() {
                const screen = $('#migration-screen');
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§éš ã™
                screen.classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                screen.classList.add('opacity-0', 'pointer-events-none', 'scale-95');

                // æ¥ç¶šç ´æ£„
                if(peer) { peer.destroy(); peer = null; }
                if(conn) { conn.close(); conn = null; }
            }

            $('#close-migration-btn').addEventListener('click', closeMigrationModal);

            // ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒ†ãƒƒãƒ—å†…ï¼‰
            $$('.migration-back-step').forEach(btn => {
                btn.addEventListener('click', () => {
                    if(peer) { peer.destroy(); peer = null; }
                    showMigrationView('migration-step-1');
                });
            });

            // --- ãƒ¢ãƒ¼ãƒ‰é¸æŠ ---
            $('#migration-mode-send').addEventListener('click', () => {
                showMigrationView('migration-sender-view');
                initPeerSender();
            });

            $('#migration-mode-receive').addEventListener('click', () => {
                showMigrationView('migration-receiver-view');
                initPeerReceiver();
            });

            // --- PeerJS ãƒ­ã‚¸ãƒƒã‚¯ ---

            function initPeerSender() {
                peer = new Peer(); 
                peer.on('error', (err) => {
                    console.error(err);
                    showSenderError("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err.type);
                });
            }

            function showSenderError(msg) {
                const errBox = $('#migration-sender-error');
                const errText = $('#migration-sender-error-text');
                errText.textContent = msg;
                errBox.classList.remove('hidden');
            }
            
            // æ¥ç¶šãƒœã‚¿ãƒ³ (é€ä¿¡å´)
            $('#migration-connect-btn').addEventListener('click', () => {
                const targetId = $('#migration-target-id').value.trim().toUpperCase();
                if(!targetId) {
                    showSenderError("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    return;
                }
                
                const btn = $('#migration-connect-btn');
                btn.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mr-2"></div>æ¥ç¶šä¸­...`;
                btn.disabled = true;
                $('#migration-sender-error').classList.add('hidden'); // ã‚¨ãƒ©ãƒ¼æ¶ˆå»
                
                conn = peer.connect(targetId);
                
                conn.on('open', () => {
                    // æ¥ç¶šæˆåŠŸ -> ç¢ºèªç”»é¢ã¸é·ç§»
                    showMigrationView('migration-confirm-view');
                    btn.innerHTML = `<span>æ¥ç¶šã™ã‚‹</span>`;
                    btn.disabled = false;
                });
                
                conn.on('error', (err) => {
                     btn.innerHTML = `<span>æ¥ç¶šã™ã‚‹</span>`;
                     btn.disabled = false;
                     showSenderError("æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ");
                });

                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–
                setTimeout(() => {
                    if(!conn.open) {
                        btn.innerHTML = `<span>æ¥ç¶šã™ã‚‹</span>`;
                        btn.disabled = false;
                        showSenderError("å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    }
                }, 5000);
            });

            // ç¢ºèªç”»é¢ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
            $('#migration-confirm-no-btn').addEventListener('click', () => {
                if(conn) conn.close();
                showMigrationView('migration-sender-view');
            });

            // ç¢ºèªç”»é¢ï¼šå®Ÿè¡Œï¼ˆé€ä¿¡ï¼‰
            $('#migration-confirm-yes-btn').addEventListener('click', () => {
                // å‡¦ç†ä¸­ç”»é¢ã¸
                showMigrationView('migration-complete-view');
                $('#migration-complete-title').textContent = "é€ä¿¡ä¸­...";
                $('#migration-complete-msg').textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã—ã¦ã„ã¾ã™";

                const dataToSend = JSON.stringify(state);
                conn.send(dataToSend);
                
                // é€ä¿¡å®Œäº†æ¼”å‡º
                setTimeout(() => {
                    $('#migration-spinner').classList.add('hidden');
                    $('#migration-success-icon').classList.remove('hidden');
                    $('#migration-complete-title').textContent = "é€ä¿¡å®Œäº†";
                    $('#migration-complete-msg').textContent = "ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ã—ã¾ã™...";
                    
                    setTimeout(() => {
                        localStorage.removeItem('quizAppUltimateV8');
                        location.reload();
                    }, 2000);
                }, 1000);
            });

            function initPeerReceiver() {
                const myPeerId = Math.random().toString(36).substring(2, 6).toUpperCase(); 
                
                peer = new Peer(myPeerId);
                
                peer.on('open', (id) => {
                    $('#migration-my-id').textContent = id;
                    $('#migration-status-receive').textContent = "æ¥ç¶šå¾…æ©Ÿä¸­...";
                    $('#migration-receiver-indicator').className = "w-2 h-2 bg-yellow-500 rounded-full animate-ping";
                    $('#migration-receiver-status-box').className = "flex items-center space-x-2 text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20 px-4 py-2 rounded-full transition-colors";
                });
                
                peer.on('connection', (c) => {
                    $('#migration-status-receive').textContent = "ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­...";
                    $('#migration-receiver-indicator').className = "w-2 h-2 bg-green-500 rounded-full animate-bounce";
                    $('#migration-receiver-status-box').className = "flex items-center space-x-2 text-green-500 bg-green-50 dark:bg-green-900/20 px-4 py-2 rounded-full transition-colors";
                    
                    c.on('data', (data) => {
                        try {
                            const receivedState = JSON.parse(data);
                            if(receivedState.profile && receivedState.user) {
                                // å—ä¿¡å®Œäº†ç”»é¢ã¸
                                showMigrationView('migration-complete-view');
                                $('#migration-spinner').classList.add('hidden');
                                $('#migration-success-icon').classList.remove('hidden');
                                $('#migration-complete-title').textContent = "å¼•ç¶™ãå®Œäº†ï¼";
                                $('#migration-complete-msg').textContent = "ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¾ã™...";

                                localStorage.setItem('quizAppUltimateV8', data);
                                setTimeout(() => location.reload(), 2000);
                            }
                        } catch(e) {
                            console.error(e);
                            alert('ãƒ‡ãƒ¼ã‚¿ç ´æã‚¨ãƒ©ãƒ¼'); // ã“ã“ã ã‘ã¯è‡´å‘½çš„ãªã®ã§alertã§OKï¼ˆã‚ã‚‹ã„ã¯ã‚¨ãƒ©ãƒ¼ç”»é¢ã‚’ä½œã‚‹ï¼‰
                            showMigrationView('migration-step-1');
                        }
                    });
                });
                
                peer.on('error', (err) => {
                     if(err.type === 'unavailable-id') {
                         initPeerReceiver(); 
                     } else {
                         $('#migration-status-receive').textContent = "ã‚¨ãƒ©ãƒ¼: " + err.type;
                         $('#migration-receiver-indicator').className = "w-2 h-2 bg-red-500 rounded-full";
                     }
                });
            }

            // ==========================================
            // â–¼â–¼â–¼ è¿½åŠ : èµ·å‹•æ™‚ã®ç™»éŒ²ãƒã‚§ãƒƒã‚¯é–¢æ•° â–¼â–¼â–¼
            // ==========================================
            const checkUserRegistration = () => {
                const appContainer = document.getElementById('app-container');
                const welcomeScreen = document.getElementById('welcome-screen');
                const wizardScreen = document.getElementById('registration-wizard');

                if (state.user.isRegistered) {
                    // ç™»éŒ²æ¸ˆã¿ã®å ´åˆ: ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’è¡¨ç¤º
                    appContainer.classList.remove('hidden');
                    if(welcomeScreen) welcomeScreen.classList.add('hidden');
                    if(wizardScreen) wizardScreen.classList.add('hidden');
                    
                    // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’æ¶ˆã™å‡¦ç†ï¼ˆæ—¢å­˜ã®å‡¦ç†ãŒã‚ã‚‹å ´åˆã¯ãã¡ã‚‰ã«ä»»ã›ã‚‹ï¼‰
                    const splash = document.getElementById('splash-screen');
                    if (splash) {
                        setTimeout(() => {
                            splash.style.opacity = '0';
                            setTimeout(() => splash.style.display = 'none', 500);
                        }, 1000);
                    }
                } else {
                    // æœªç™»éŒ²ã®å ´åˆ: ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’éš ã—ã€ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‚’è¡¨ç¤º
                    appContainer.classList.add('hidden');
                    if(welcomeScreen) welcomeScreen.classList.remove('hidden');
                    
                    // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’æ¶ˆã™
                    const splash = document.getElementById('splash-screen');
                    if (splash) {
                        setTimeout(() => {
                            splash.style.opacity = '0';
                            setTimeout(() => splash.style.display = 'none', 500);
                        }, 500);
                    }
                }
            };

            // ==========================================
            // â–²â–²â–² æ–°è¦è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯çµ‚äº† â–²â–²â–²
            // ==========================================

            // â˜…æ–°è¦è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®å¾©å…ƒãƒã‚§ãƒƒã‚¯é–¢æ•°
            // --- ã‚¯ã‚¨ã‚¹ãƒˆå¾©å…ƒãƒã‚§ãƒƒã‚¯ (æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ç‰ˆ) ---
const checkQuestResume = () => {
    if (state.savedQuest && state.savedQuest.active) {
        openGeneralConfirm(
            'ã‚¯ã‚¨ã‚¹ãƒˆã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ',
            'ä¸­æ–­ã•ã‚ŒãŸã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\nå‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã—ã¾ã™ã‹ï¼Ÿ',
            'rotate-ccw', // å†é–‹ã‚¢ã‚¤ã‚³ãƒ³
            'å†é–‹ã™ã‚‹',   // è‚¯å®šãƒœã‚¿ãƒ³
            'primary-bg', // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼
            () => { 
                // OKæ™‚ã®å‡¦ç†
                resumeQuestProcess();
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆã‚’å†é–‹ã—ã¾ã—ãŸ', 'quest');
            },
            'ç ´æ£„ã—ã¦çµ‚äº†', // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆ
            () => { 
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«(ç ´æ£„)æ™‚ã®å‡¦ç†
                const saved = state.savedQuest;
                const currentStep = saved.plan[saved.currentIndex];
                
                // çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã¦ãƒ­ã‚°ã«æ®‹ã™ï¼ˆä»»æ„ï¼‰
                const now = Date.now();
                const elapsedSeconds = Math.floor((now - saved.startTime) / 1000);
                const actualDuration = Math.min(elapsedSeconds, currentStep.duration);

                if (currentStep.type === 'section' && actualDuration > 0) {
                    const statusText = (elapsedSeconds >= currentStep.duration) ? '(ä¸åœ¨ä¸­å®Œäº†)' : '(ä¸­æ–­)';
                    recordSession(currentStep.text + statusText, actualDuration);
                    if (actualDuration > 60) {
                        addLP(Math.floor(actualDuration / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†');
                    }
                }
                
                state.savedQuest = null;
                saveState();
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆã‚’ç ´æ£„ã—ã¾ã—ãŸ', 'info');
            }
        );
    }
};

            // â˜…æ–°è¦è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆå¾©å…ƒå®Ÿè¡Œãƒ—ãƒ­ã‚»ã‚¹
            const resumeQuestProcess = () => {
                const saved = state.savedQuest;
                document.body.classList.add('is-quest-mode');
                quest.plan = saved.plan;
                quest.currentIndex = saved.currentIndex;
                quest.active = true;
                updateBackgrounds();

                // UIåˆ‡ã‚Šæ›¿ãˆ
                $('header').style.display = 'none';
                $('nav').style.display = 'none';
                $('#mini-timer-container').classList.remove('visible');
                $('#quest-active-screen').style.display = 'flex';
                document.body.style.overflow = 'hidden';

                const currentStep = quest.plan[quest.currentIndex];
                
                // çµŒéæ™‚é–“ã‚’è¨ˆç®—
                const now = Date.now();
                const elapsedSinceStart = Math.floor((now - saved.startTime) / 1000);
                const remaining = currentStep.duration - elapsedSinceStart;

                if (remaining <= 0) {
                    // è£ã§çµ‚ã‚ã£ã¦ã„ãŸå ´åˆ
                    showToast('é–‰ã˜ã¦ã„ã‚‹é–“ã«ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚');
                    // ãƒ­ã‚°è¨˜éŒ²ãªã©ã¯çœç•¥ã—ã¦ã€å¼·åˆ¶çš„ã«æ¬¡ã¸é€²ã‚ã‚‹ã‹ã€å®Œäº†æ‰±ã„ã«ã™ã‚‹
                    // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œå®Œäº†ã€ã¨ã—ã¦æ¬¡ã¸
                    if (currentStep.type === 'section') {
                        // ãƒ­ã‚°ã ã‘è¨˜éŒ²ã—ã¦ãŠã
                        recordSession(currentStep.text + '(ä¸­æ–­)', currentStep.duration);
                        state.focus.totalTime += currentStep.duration;
                        addLP(Math.floor(currentStep.duration / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³');
                        saveState();
                    }
                    // æ¬¡ã¸
                    runNextQuestStep();
                } else {
                    // ã¾ã ç¶šã„ã¦ã„ã‚‹å ´åˆ -> ãã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€”ä¸­ã‹ã‚‰å†é–‹
                    // executeQuestStepã‚’å‘¼ã¶ã¨ã‚¿ã‚¤ãƒãƒ¼ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã®ã§ã€
                    // æ‰‹å‹•ã§UIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ startQuestTimer ã‚’å‘¼ã¶
                    setupResumedStep(currentStep, remaining);
                }
            };

            // â˜…æ–°è¦è¿½åŠ : é€”ä¸­ã‹ã‚‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            const setupResumedStep = (step, timeLeft) => {
                cancelQuestAlarm(); // å¿µã®ãŸã‚

                if (step.type === 'section') {
                    playBGM();
                    questSectionView.style.display = 'flex';
                    questBreakView.style.display = 'none';
                    updateQuestTitleDisplay(step.text);
                    const totalSections = quest.plan.filter(p => p.type === 'section').length;
                    const currentSectionNumber = quest.plan.slice(0, quest.currentIndex + 1).filter(p => p.type === 'section').length;
                    questProgressEl.textContent = `${currentSectionNumber} / ${totalSections}`;
                    
                    // ã‚¿ã‚¤ãƒãƒ¼å†é–‹
                    startQuestTimer(
                        timeLeft, // æ®‹ã‚Šæ™‚é–“ã§é–‹å§‹
                        (t) => { questTimerEl.textContent = formatTime(t); },
                        () => {
                            // çµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆexecuteQuestStepã®ä¸­èº«ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ï¼‰
                            // ç°¡ç•¥åŒ–ã®ãŸã‚å…±é€šéƒ¨åˆ†ã‚’é–¢æ•°åŒ–ã™ã‚‹ã‹ã€ã“ã“ã«ã‚³ãƒ”ãƒ¼
                            const elapsed = step.duration; // æº€äº†æ‰±ã„
                            recordSession(step.text, elapsed);
                            addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³');
                            state.focus.totalTime += elapsed;
                            if (step.originalTaskId) {
                                const tIndex = state.tasks.findIndex(t => t.id === parseInt(step.originalTaskId));
                                if (tIndex !== -1) state.tasks[tIndex].completed = true;
                            }
                            saveState();
                            showToast('ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
                            runNextQuestStep();
                        }
                    );
                } else {
                    // ä¼‘æ†©ã®å ´åˆ
                    pauseBGM();
                    questSectionView.style.display = 'none';
                    questBreakView.style.display = 'flex';
                    renderBreakIcons();
                    
                    startQuestTimer(
                        timeLeft,
                        (t) => { breakTimerEl.textContent = formatTime(t); },
                        () => {
                            showToast('ä¼‘æ†©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚');
                            closeIframe();
                            runNextQuestStep();
                        }
                    );
                }
                lucide.createIcons();
            };

            // â–¼â–¼â–¼ è¿½åŠ : å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®å¾©å¸°æ¤œçŸ¥ç”¨ â–¼â–¼â–¼
            let isQuizExternalOpen = false; // ã‚¯ã‚¤ã‚ºã§å¤–éƒ¨ã«è¡Œã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
            let currentQuizElapsed = 0;

            // ã‚¢ãƒ—ãƒªã«æˆ»ã£ã¦ããŸï¼ˆã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸï¼‰æ™‚ã®å‡¦ç†
            document.addEventListener('visibilitychange', () => {
                // ã‚¢ãƒ—ãƒªãŒè¡¨ç¤ºçŠ¶æ…‹ã«ãªã£ãŸæ™‚
                if (document.visibilityState === 'visible') {
                    
                    // --- æ—¢å­˜ã®ã‚¯ã‚¤ã‚ºå¾©å¸°å‡¦ç† ---
                    if (isQuizExternalOpen && currentQuizId) {
                        // 1. æ™‚é–“ã‚’è¨ˆç®—
                        if (quizTimer.startTime) {
                            const now = Date.now();
                            const elapsed = Math.round((now - quizTimer.startTime) / 1000);
                            
                            // â˜…é‡è¦: ã“ã“ã§LPè¨ˆç®—ç”¨ã®å¤‰æ•°ã«æ™‚é–“ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
                            currentQuizElapsed = elapsed;

                            // 2. è©•ä¾¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                            $('#assessment-modal').dataset.quizId = currentQuizId;
                            openModalWithAnim('assessment-modal', 'assessment-content');

                            // 3. ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
                            quizTimer.startTime = null;
                        }
                        // ãƒ•ãƒ©ã‚°ã‚’ä¸‹ã‚ã™
                        isQuizExternalOpen = false;
                        // IDã¯è©•ä¾¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ä¿æŒã™ã‚‹ã‹ã€ã“ã“ã§æ¶ˆã—ã¦è©•ä¾¡æ™‚ã«å‚ç…§ã™ã‚‹ã‹ã§ã™ãŒã€
                        // è©•ä¾¡ãƒ¢ãƒ¼ãƒ€ãƒ«å´ã§ dataset.quizId ã‚’ä½¿ã†ã®ã§ã“ã“ã¯ä¿æŒã§ã‚‚OKã§ã™ãŒã€äºŒé‡èµ·å‹•é˜²æ­¢ã®ãŸã‚nullã«ã™ã‚‹ãªã‚‰è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯æ³¨æ„
                        // ä»Šå›ã¯ assessment-modal ã® dataset ã«å…¥ã‚ŒãŸã®ã§ currentQuizId ã¯ null ã«ã—ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™
                        // currentQuizId = null; 
                    }

                    // --- â–¼â–¼â–¼ è¿½åŠ : æ„è¦‹ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®å¾©å¸°å‡¦ç† â–¼â–¼â–¼ ---
                    if (isFeedbackExternalOpen) {
                        isFeedbackExternalOpen = false; // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

                        // ã¾ã å ±é…¬ã‚’å—ã‘å–ã£ã¦ã„ãªã„å ´åˆã®ã¿ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                        if (!state.user.feedbackRewardClaimed) {
                            const modal = $('#feedback-reward-modal');
                            const content = $('#feedback-reward-content');
                            const input = $('#feedback-code-input');
                            
                            input.value = ''; // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                            $('#feedback-code-error').classList.add('hidden'); // ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º

                            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã)
                            modal.classList.remove('hidden');
                            requestAnimationFrame(() => {
                                modal.classList.remove('opacity-0');
                                content.classList.remove('scale-95');
                                content.classList.add('scale-100');
                            });
                        }
                    }
                    // --- â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² ---
                }
            });

            // â–¼â–¼â–¼ è¿½åŠ : æ„è¦‹é€ä¿¡ãŠç¤¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
            const feedbackModal = $('#feedback-reward-modal');
            const feedbackContent = $('#feedback-reward-content');
            const feedbackInput = $('#feedback-code-input');
            const feedbackError = $('#feedback-code-error');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
            const closeFeedbackModal = () => {
                feedbackModal.classList.add('opacity-0');
                feedbackContent.classList.remove('scale-100');
                feedbackContent.classList.add('scale-95');
                setTimeout(() => {
                    feedbackModal.classList.add('hidden');
                }, 300);
            };

            // ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³
            const feedbackCancelBtn = $('#feedback-code-cancel');
            if(feedbackCancelBtn) {
                feedbackCancelBtn.addEventListener('click', closeFeedbackModal);
            }

            // ã€Œå—ã‘å–ã‚‹ã€ãƒœã‚¿ãƒ³
            const feedbackSubmitBtn = $('#feedback-code-submit');
            if(feedbackSubmitBtn) {
                feedbackSubmitBtn.addEventListener('click', () => {
                    const code = feedbackInput.value.trim().toUpperCase(); // å¤§æ–‡å­—ã«å¤‰æ›ã—ã¦å–å¾—

                    if (code === 'SQ39') {
                        // æ­£è§£ã®å ´åˆ
                        addLP(500, 'æ„è¦‹é€ä¿¡ã®ãŠç¤¼'); // 500LPä»˜ä¸
                        state.user.feedbackRewardClaimed = true; // å—ã‘å–ã‚Šæ¸ˆã¿ã«ã™ã‚‹
                        saveState();
                        
                        showToast('500LPã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼');
                        closeFeedbackModal();
                    } else {
                        // ä¸æ­£è§£ã®å ´åˆ
                        feedbackError.classList.remove('hidden');
                        feedbackInput.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æºã‚‰ã™
                        feedbackContent.animate([
                            { transform: 'translateX(0)' },
                            { transform: 'translateX(-5px)' },
                            { transform: 'translateX(5px)' },
                            { transform: 'translateX(0)' }
                        ], { duration: 200 });
                    }
                });
            }

            // å…¥åŠ›ã—ç›´ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã‚’æ¶ˆã™
            if(feedbackInput) {
                feedbackInput.addEventListener('input', () => {
                    feedbackError.classList.add('hidden');
                    feedbackInput.classList.remove('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                });
            }
            // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

            const init = () => {
                if (window.Chart) {
                    Chart.defaults.font.family = "'LINE Seed JP', 'Inter', 'Noto Sans JP', sans-serif";
                }
Â  Â  Â  Â  Â  Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('sw.js')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(registration => console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.log('Service Workerç™»éŒ²å¤±æ•—:', error));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â // â˜…è¿½åŠ : ç”»é¢ã®ä»–ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰é–‹ã„ã¦ã„ã‚‹ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹å‡¦ç†
                document.addEventListener('touchstart', (e) => {
                    // ã‚¿ãƒƒãƒ—ã•ã‚ŒãŸè¦ç´ ãŒã€Œé–‹ã„ã¦ã„ã‚‹ã‚¹ãƒ¯ã‚¤ãƒ—ã‚³ãƒ³ãƒ†ãƒŠã€ã®å†…éƒ¨ã§ãªã‘ã‚Œã°é–‰ã˜ã‚‹
                    const openContainers = document.querySelectorAll('.swipe-container.swiped-open');
                    
                    openContainers.forEach(container => {
                        // ã‚³ãƒ³ãƒ†ãƒŠè‡ªèº«ã‚„ãã®å­è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒœã‚¿ãƒ³æ“ä½œãªã©ã®ãŸã‚ï¼‰
                        if (container.contains(e.target)) return;

                        // ãã‚Œä»¥å¤–ï¼ˆå¤–å´ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ãŸå ´åˆã¯é–‰ã˜ã‚‹
                        const content = container.querySelector('.swipe-content');
                        if (content) {
                            content.style.transform = 'translateX(0px)';
                            container.classList.remove('swiped-open');
                        }
                    });
                }, { passive: true });

                // ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–ã™ã‚‹
                if (window.matchMedia) {
                    const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    colorSchemeQuery.addEventListener('change', (e) => {
                        // OSã®ãƒ†ãƒ¼ãƒãŒå¤‰ã‚ã£ãŸã‚‰ã€ã‚¢ãƒ—ãƒªã®è¦‹ãŸç›®ã‚’å†è¨ˆç®—ã™ã‚‹
                        // updateAppearanceå†…ã§ã€Œãƒ‡ãƒã‚¤ã‚¹ã«åˆã‚ã›ã‚‹ã€è¨­å®šã‹ã©ã†ã‹ãŒåˆ¤å®šã•ã‚Œã‚‹ãŸã‚ã€
                        // ã“ã“ã§ã¯ç„¡æ¡ä»¶ã«å‘¼ã³å‡ºã™ã ã‘ã§OKã§ã™ã€‚
                        updateAppearance();
                    });
                }
                
Â  Â  Â  Â  Â  Â  Â  Â  loadState();

                syncGamesToBreakIcons();

                // 1. æ–°ã—ã„DOMè¦ç´ ã‚’å¤‰æ•°ã«å‰²ã‚Šå½“ã¦
                homeTaskListEl = $('#home-task-list');
                newTaskInput = $('#new-task-input');
                newTaskNumberEl = $('#new-task-number');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒšãƒ¼ã‚¸æç”»ã®å‰ã«ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹ã‚’å¾©å…ƒãƒ»è¨­å®šã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  restoreFocusState();
                checkQuestResume();  // â˜…è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆã®å¾©å…ƒãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // å…¨ã¦ã®ãƒšãƒ¼ã‚¸ã‚’æç”»
Â  Â  Â  Â  Â  Â  Â  Â  renderEngine.renderAll();
                
                // 2. Sortable.js ã®åˆæœŸåŒ– (ä»Šæ—¥ã®äºˆå®š)
                if (homeTaskListEl) {
                    Sortable.create(homeTaskListEl, {
                        handle: '.task-handle', 
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        delay: 200, // â˜…é‡è¦: 200msé•·æŠ¼ã—ã—ãªã„ã¨ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ãªã„
                        delayOnTouchOnly: true, // ã‚¿ãƒƒãƒæ“ä½œã®æ™‚ã ã‘é…å»¶ã•ã›ã‚‹ï¼ˆãƒã‚¦ã‚¹ã¯å³æ™‚ï¼‰
                        touchStartThreshold: 5, // 5pxä»¥ä¸Šå‹•ã„ãŸã‚‰ã‚¿ãƒƒãƒ—ã§ã¯ãªããƒ‰ãƒ©ãƒƒã‚°åˆ¤å®šï¼ˆèª¤å‹•ä½œé˜²æ­¢ï¼‰
                        filter: '.swiped-open, .is-swiping, .swipe-deleting', // â˜…è¿½åŠ : ã“ã‚Œã‚‰ãŒä»˜ã„ã¦ã„ã‚‹è¦ç´ ã¯ä¸¦ã³æ›¿ãˆä¸å¯
                        onEnd: (evt) => { /* ä¸­èº«ã¯å¤‰æ›´ãªã— */
                            const item = state.tasks.splice(evt.oldIndex, 1)[0];
                            state.tasks.splice(evt.newIndex, 0, item);
                            saveState();
                            renderHomeTasks(); 
                        }
                    });

                    // 3. ã‚¿ã‚¹ã‚¯å‰Šé™¤ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»)
                    homeTaskListEl.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.delete-task-btn');
                        if (deleteBtn) {
                            const taskItem = deleteBtn.closest('.task-item');
                            const taskId = parseInt(taskItem.dataset.id);
                            state.tasks = state.tasks.filter(t => t.id !== taskId);
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                // 4. æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ  (Enterã‚­ãƒ¼)
                if (newTaskInput) {
                    newTaskInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && e.target.value.trim() !== '') {
                            state.tasks.push({ id: Date.now(), text: e.target.value.trim() });
                            e.target.value = '';
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }
                // â–¼â–¼â–¼ è¿½åŠ ç®‡æ‰€: ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ãƒƒãƒ—æ™‚ã®å‡¦ç† â–¼â–¼â–¼
                const addTaskBtn = document.getElementById('add-task-btn');
                if (addTaskBtn && newTaskInput) {
                    // é‡è¤‡ç™»éŒ²ã‚’é˜²ããŸã‚ã€ä¸€åº¦cloneNodeã§ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã‹ã€onclickã‚’ä½¿ç”¨
                    addTaskBtn.onclick = () => {
                        if (newTaskInput.value.trim() !== '') {
                            state.tasks.push({ id: Date.now(), text: newTaskInput.value.trim() });
                            newTaskInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                            saveState();
                            renderHomeTasks();
                        } else {
                            newTaskInput.focus(); // ç©ºãªã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
                        }
                    };
                }

                 // Sortable.js ã®åˆæœŸåŒ– (ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³)
                    if (questPlanListEl) { // questPlanListEl ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©æ¸ˆã¿
                        Sortable.create(questPlanListEl, {
                            handle: '.quest-handle', // ã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒ³ãƒ‰ãƒ«
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            delay: 200, // â˜…è¿½åŠ 
                            delayOnTouchOnly: true, // â˜…è¿½åŠ 
                            touchStartThreshold: 5, // â˜…è¿½åŠ 
                            filter: '.swiped-open, .is-swiping, .swipe-deleting', // â˜…è¿½åŠ 
                            onEnd: (evt) => {
                                // quest.plan é…åˆ—ã‚’ä¸¦ã³æ›¿ãˆ
                                // (quest.plan ã¯ state ã«ä¿å­˜ã•ã‚Œãªã„ä¸€æ™‚çš„ãªã‚‚ã®)
                                const item = quest.plan.splice(evt.oldIndex, 1)[0];
                                quest.plan.splice(evt.newIndex, 0, item);
                                renderQuestPlan(); // ç•ªå·ã‚’æŒ¯ã‚Šç›´ã™ãŸã‚ã«å†æç”»
                            }
                        });
                    }
                
                // 5. ã€Œä»Šæ—¥ã®äºˆå®šã€èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
                const loadTasksBtn = document.getElementById('load-tasks-btn');
                if (loadTasksBtn) {
                    loadTasksBtn.addEventListener('click', () => {
                        const activeTasks = state.tasks.filter(t => !t.completed);
            
                        if (activeTasks.length === 0) {
                            showToast('ã€Œä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã€ã«æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                            return;
                        }

                        // â–¼â–¼â–¼ ä¿®æ­£: èª­ã¿è¾¼ã¿å‡¦ç†ã‚’é–¢æ•°åŒ– â–¼â–¼â–¼
                        const executeLoadTasks = () => {
                            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå­¦ç¿’ã®ã¿ï¼‰ã¨ã—ã¦æ‰±ã†
                            const template = (state.profile.routineTemplate && state.profile.routineTemplate.length > 0) 
                                ? state.profile.routineTemplate 
                                : [{ type: 'section', duration: 25 * 60 }];
                
                            quest.plan = []; // ã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                            let taskIndex = 0;
                            let templateIndex = 0;
                
                            // ã‚¿ã‚¹ã‚¯ãŒãªããªã‚‹ã¾ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦é…ç½®
                            while (taskIndex < activeTasks.length) {
                                const templateItem = template[templateIndex % template.length];
                                
                                if (templateItem.type === 'section') {
                                    // å­¦ç¿’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã€ã‚¿ã‚¹ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹
                                    const task = activeTasks[taskIndex];
                                    quest.plan.push({
                                        id: Date.now() + Math.random(),
                                        type: 'section',
                                        text: task.text,
                                        duration: templateItem.duration,
                                        originalTaskId: task.id
                                    });
                                    taskIndex++;
                                } else {
                                    // ä¼‘æ†©ã®å ´åˆã€ãã®ã¾ã¾è¿½åŠ 
                                    quest.plan.push({
                                        id: Date.now() + Math.random(),
                                        type: 'break',
                                        text: 'ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ ',
                                        duration: templateItem.duration
                                    });
                                }
                                
                                templateIndex++;
                            }
                
                            showToast(`${activeTasks.length} ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã«é©ç”¨ã—ã¾ã—ãŸã€‚`);
                            renderQuestPlan();
                        };
                        // â–²â–²â–² é–¢æ•°åŒ–ã“ã“ã¾ã§ â–²â–²â–²

                        // â–¼â–¼â–¼ ä¿®æ­£: æ¡ä»¶åˆ†å²ã‚’è¿½åŠ  â–¼â–¼â–¼
                        if (quest.plan.length > 0) {
                            // ã™ã§ã«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹å ´åˆã¯ç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
                            openGeneralConfirm(
                                'ã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ',
                                'ç¾åœ¨ã®ã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã¯ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã€\nä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã§ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚',
                                'alert-triangle',
                                'ä¸Šæ›¸ãã™ã‚‹',
                                'bg-red-500 hover:bg-red-600',
                                () => {
                                    executeLoadTasks(); // OKãªã‚‰å®Ÿè¡Œ
                                }
                            );
                        } else {
                            // ç©ºã®å ´åˆã¯ç¢ºèªãªã—ã§å³å®Ÿè¡Œ
                            executeLoadTasks();
                        }
                        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
                    });
                }
Â  Â  Â  Â  Â  Â  Â  Â  updateAppearance();

                checkUserRegistration();
                
                // â–¼â–¼â–¼ å¤‰æ›´ï¼ˆinitã®æœ€å¾Œã«lucideã‚’1å›å®Ÿè¡Œï¼‰ â–¼â–¼â–¼
                lucide.createIcons();
                    setTimeout(() => {
                        // ã‚‚ã—æœªç™»éŒ²ãªã‚‰ã€ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ãŒæ¶ˆãˆã‚‹ç›´å‰ã«ã€Œã‚ˆã†ã“ãç”»é¢ã€ã‚’è£ã§è¡¨ç¤ºçŠ¶æ…‹ã«ã™ã‚‹
                        if (!state.user.isRegistered) {
                            $('#welcome-screen').classList.remove('hidden');
                        }
                    
                        const splash = document.getElementById('splash-screen');
                        if (splash) {
                            // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
                            splash.classList.add('opacity-0');
                            
                            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
                            setTimeout(() => {
                                splash.style.display = 'none';
                            }, 500);
                        }
                    }, 1500); // 1.5ç§’å¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆé–‹å§‹
Â  Â  Â  Â  Â  Â  };

            // â–¼â–¼â–¼ ä¿®æ­£: ç¬¬4å¼•æ•°ã« onSuccess (æˆåŠŸæ™‚ã®å‡¦ç†) ã‚’è¿½åŠ  â–¼â–¼â–¼
            const purchaseItem = (id, type, cost, onSuccess) => {
                if (state.profile.lp < cost) {
                    showToast('LPãŒè¶³ã‚Šã¾ã›ã‚“');
                    return;
                }
                state.profile.lp -= cost;
                
                let itemData = null;

                if (type === 'theme') {
                    state.profile.unlockedThemes.push(id);
                    itemData = initialData.themes[id];
                } 
                else if (type === 'background') {
                    state.profile.unlockedBackgrounds.push(id);
                    itemData = initialData.backgrounds[id];
                } 
                else if (type === 'game') {
                    state.profile.unlockedGames.push(id);
                    itemData = initialData.games[id];
                } 
                else if (type === 'music') {
                    state.profile.unlockedMusic.push(id);
                    itemData = initialData.music[id];
                }
                
                saveState();
                updateLpDisplay();
                
                if(type === 'game') syncGamesToBreakIcons();

                renderStatusPageContent();
                
                if (itemData) {
                    showItemPopup(itemData, type);
                }

                // â–¼â–¼â–¼ è¿½åŠ : è³¼å…¥æˆåŠŸæ™‚ã«ã€æ¸¡ã•ã‚ŒãŸé–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ â–¼â–¼â–¼
                if (onSuccess) {
                    onSuccess();
                }
            };

                const applyItem = (id, type) => {
                    if (type === 'theme') {
                        state.profile.activeTheme = id;
                        // â–¼ ä¿®æ­£: applyThemeColor() ã‚’å‘¼ã¶ã“ã¨ã§ã€ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ¤å®šã‚’å«ã‚ã¦é©ç”¨ã™ã‚‹
                        applyThemeColor();
                    } else if (type === 'background') {
                        state.profile.activeBackground = id;
                        updateAppearance();  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç­‰ã®æ›´æ–°
                        updateBackgrounds(); // èƒŒæ™¯ç”»åƒã®æ›´æ–°
                    }
                    saveState();
                    renderStatusPageContent(); // å†æç”»ã—ã¦ã€Œé©ç”¨ä¸­ã€è¡¨ç¤ºã«ã™ã‚‹
                    showToast('é©ç”¨ã—ã¾ã—ãŸ');
                };
            
// â–¼â–¼â–¼ ã€åå‰ä¸­å¤®æƒãˆä¿®æ­£ç‰ˆã€‘ã‚¹ãƒˆã‚¢ç”»é¢æç”»ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼

// ä¸¦ã³é †ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
let currentStoreSort = 'default';

const renderStatusPageContent = () => {
    // 1. LPè¡¨ç¤ºæ›´æ–°
    const lpDisplay = $('#status-lp-display');
    if (lpDisplay) lpDisplay.textContent = state.profile.lp;

    // 2. ã‚½ãƒ¼ãƒˆUIã®è¨­ç½® (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸã®å…ˆé ­ã«è¿½åŠ )
    const scrollContainer = document.querySelector('#status-screen .overflow-y-auto');
    let sortContainer = document.getElementById('status-sort-container');

    if (scrollContainer && !sortContainer) {
        sortContainer = document.createElement('div');
        sortContainer.id = 'status-sort-container';
        
        sortContainer.className = "w-full flex justify-end items-center mb-2"; 
        
        sortContainer.innerHTML = `
            <div class="relative group">
                <select id="store-sort-select" class="appearance-none cursor-pointer bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs font-bold py-2 pl-4 pr-9 rounded-full border border-gray-200 dark:border-gray-600 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-all focus:outline-none focus:ring-2 primary-ring">
                    <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                    <option value="lp">LPï¼ˆæ˜‡é †ï¼‰</option>
                    <option value="name">åå‰</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2.5 text-gray-400 group-hover:primary-text transition-colors">
                    <i data-lucide="arrow-up-down" class="w-3.5 h-3.5"></i>
                </div>
            </div>
        `;
        // å…ˆé ­ã«æŒ¿å…¥
        scrollContainer.prepend(sortContainer);
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        const select = sortContainer.querySelector('#store-sort-select');
        select.value = currentStoreSort;
        select.addEventListener('change', (e) => {
            currentStoreSort = e.target.value;
            renderStatusPageContent(); // å†æç”»
        });
    }

    // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚¢ã‚¤ãƒ†ãƒ ã®HTMLç”Ÿæˆ ---
    const createItemHTML = (id, item, type, isUnlocked, isActive) => {
        let iconHTML = '';
        let statusBadge = '';
        let activeClass = isActive ? 'ring-4 ring-blue-500 ring-offset-2 dark:ring-offset-gray-900' : '';
        
        const checkMarkBadge = `<div class="absolute top-2 right-2 bg-white/90 dark:bg-gray-800/90 rounded-full p-1.5 shadow-md z-10"><i data-lucide="check" class="w-4 h-4 primary-text"></i></div>`;

        // åŸºæœ¬ã¯æ­£æ–¹å½¢
        let containerClass = 'w-full aspect-square rounded-3xl';
        
        if (type === 'theme') {
            containerClass = 'w-20 h-20 rounded-full';
            iconHTML = `<div class="w-full h-full rounded-full shadow-inner" style="background-color: ${item.color}"></div>`;
            if (isUnlocked) statusBadge = checkMarkBadge;

        } else if (type === 'background') {
            containerClass = 'w-full aspect-[9/16] rounded-3xl';
            const style = item.url ? `background-image: url(${item.url})` : 'background-color: #6b7280;';
            iconHTML = `<div class="w-full h-full bg-cover bg-center" style="${style}"></div>`;
            if (isUnlocked) statusBadge = checkMarkBadge;

        } else if (type === 'game') {
            if (item.thumbnail) {
                iconHTML = `<div class="w-full h-full bg-cover bg-center" style="background-image: url('${item.thumbnail}')"></div>`;
            } else if (item.previews && item.previews.length > 0) {
                const previewUrl = item.previews[0];
                iconHTML = `<div class="w-full h-full bg-cover bg-center" style="background-image: url('${previewUrl}')"></div>`;
            } else {
                iconHTML = `<i data-lucide="${item.icon || 'gamepad-2'}" class="w-10 h-10 text-indigo-500"></i>`;
            }
            if (isUnlocked) statusBadge = checkMarkBadge;

        } else {
            // éŸ³æ¥½ãªã©
            const iconName = item.icon || 'music';
            const colorClass = 'text-pink-500';
            iconHTML = `<i data-lucide="${iconName}" class="w-10 h-10 ${colorClass}"></i>`;
            if (isUnlocked) statusBadge = checkMarkBadge;
        }

        const shadowClass = isActive ? 'shadow-none' : 'shadow-md dark:shadow-gray-900/50';
        const lockOverlay = !isUnlocked ? `<div class="absolute inset-0 bg-black/40 flex flex-col items-center justify-center ${type === 'theme' ? 'rounded-full' : 'rounded-2xl'} text-white backdrop-blur-[1px]"><i data-lucide="lock" class="w-5 h-5 mb-1"></i><span class="text-xs font-bold tracking-wider">${item.cost}</span></div>` : '';

        return `
            <div class="text-center cursor-pointer item-btn group relative p-1" data-id="${id}" data-type="${type}">
                <div class="${containerClass} mx-auto relative ${activeClass} ${shadowClass} bg-gray-100 dark:bg-gray-700 flex items-center justify-center overflow-hidden transition-transform active:scale-95 duration-200">
                    ${iconHTML}
                    ${lockOverlay}
                    ${statusBadge}
                </div>
                <p class="text-xs mt-3 font-bold truncate px-1 text-gray-700 dark:text-gray-300 text-center">${item.name}</p>
            </div>
        `;
    };

    // --- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ãƒˆé–¢æ•° ---
    const getSortedItems = (dataObj) => {
        // [id, itemData] ã®é…åˆ—ã«å¤‰æ›
        const items = Object.entries(dataObj);

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ãƒ†ãƒ ï¼ˆã‚³ã‚¹ãƒˆ0ï¼‰ã¨ãã‚Œä»¥å¤–ã«åˆ†é›¢
        const defaults = items.filter(([, item]) => item.cost === 0);
        const others = items.filter(([, item]) => item.cost > 0);

        // othersã‚’ã‚½ãƒ¼ãƒˆ
        others.sort((a, b) => {
            const itemA = a[1];
            const itemB = b[1];

            if (currentStoreSort === 'lp') {
                // LPæ˜‡é †
                return itemA.cost - itemB.cost;
            } else if (currentStoreSort === 'name') {
                // åå‰é †ï¼ˆç°¡æ˜“æ¯”è¼ƒï¼‰
                return itemA.name.localeCompare(itemB.name, 'ja');
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç™»éŒ²é †ï¼‰
                return 0;
            }
        });

        // çµåˆã—ã¦è¿”ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå„ªå…ˆï¼‰
        return [...defaults, ...others];
    };

    // --- å„ãƒªã‚¹ãƒˆã®æç”»ï¼ˆã‚½ãƒ¼ãƒˆé©ç”¨ï¼‰---
    
    // ãƒ†ãƒ¼ãƒ
    const sortedThemes = getSortedItems(initialData.themes);
    $('#status-theme-list').innerHTML = sortedThemes.map(([id, theme]) => {
        return createItemHTML(id, theme, 'theme', state.profile.unlockedThemes.includes(id), state.profile.activeTheme === id);
    }).join('');

    // å£ç´™
    const sortedBackgrounds = getSortedItems(initialData.backgrounds);
    $('#status-background-list').innerHTML = sortedBackgrounds.map(([id, bg]) => {
        return createItemHTML(id, bg, 'background', state.profile.unlockedBackgrounds.includes(id), state.profile.activeBackground === id);
    }).join('');

    // ã‚²ãƒ¼ãƒ 
    const sortedGames = getSortedItems(initialData.games);
    $('#status-game-list').innerHTML = sortedGames.map(([id, game]) => {
        return createItemHTML(id, game, 'game', state.profile.unlockedGames.includes(id), false);
    }).join('');

    // éŸ³æ¥½
    const sortedMusic = getSortedItems(initialData.music);
    $('#status-music-list').innerHTML = sortedMusic.map(([id, music]) => {
        return createItemHTML(id, music, 'music', state.profile.unlockedMusic.includes(id), false);
    }).join('');

    lucide.createIcons();
    // ã‚‚ã—ã‚½ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠå†…ã«ã‚‚ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚‹ãªã‚‰ãã“ã‚‚
    if(sortContainer) lucide.createIcons({ root: sortContainer });

    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆå†æç”»ã”ã¨ã«å†è¨­å®šï¼‰
    $$('.item-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const { id, type } = btn.dataset;
            openItemDetailScreen(id, type);
        });
    });
};
            
            // â–¼â–¼â–¼ ä¿®æ­£: ãƒ”ãƒ³ç•™ã‚ä¸€è¦§ã‚’æç”»ã™ã‚‹é–¢æ•°ã‚’ç‹¬ç«‹å®šç¾© â–¼â–¼â–¼
            const renderPinnedListPageContent = () => {
                const container = $('#pinned-list-full-content');
                if(!container) return;
                container.className = 'bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden divide-y divide-gray-100 dark:divide-gray-700';
                
                // å…¨ã¦ã®ãƒ”ãƒ³ç•™ã‚ã‚¯ã‚¤ã‚ºã‚’å–å¾—
                const allPinned = state.pinnedQuizzes.map(id => initialData.quizzes.find(q => q.id === id)).filter(Boolean);
                
                if (allPinned.length === 0) {
                    container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-10 text-gray-400 dark:text-gray-500">
                <i data-lucide="pin-off" class="w-10 h-10 mb-2 opacity-50"></i>
                <p class="text-sm font-bold">ãƒ”ãƒ³ç•™ã‚ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        `;
                } else {
                    container.innerHTML = allPinned.map(q => createQuizCard(q, true)).join('');
                }
                
                // ã‚³ãƒ³ãƒ†ãƒŠå†…ã ã‘ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–ï¼‰
                lucide.createIcons({ root: container });
            };

            // ã‚µãƒ–ãƒšãƒ¼ã‚¸ã®å®šç¾©
            const pinnedListPage = new SubPage('pinned-list-screen', {
                onOpen: () => {
                    renderPinnedListPageContent();
                }
            });
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³
            $('#close-pinned-list-btn').addEventListener('click', () => pinnedListPage.close());
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            // ==========================================
            // â–¼â–¼â–¼ ã‚¢ã‚¤ãƒ†ãƒ è©³ç´°ç”»é¢ã®åˆ¶å¾¡ (SubPageã‚¯ãƒ©ã‚¹é©ç”¨ç‰ˆ) â–¼â–¼â–¼
            // ==========================================

            // 1. ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ– (å¿…ãšé–¢æ•°ã®å‰ã«æ›¸ã)
            const itemDetailPage = new SubPage('item-detail-screen', {
                onClose: () => {
                    stopMusicPreview(); // é–‰ã˜ã‚‹ã¨ãã«éŸ³æ¥½ã‚’æ­¢ã‚ã‚‹
                }
            });

            // â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¤ã‚ºç”»é¢ã®åˆ¶å¾¡ â–¼â–¼â–¼
            let currentQuizId = null;

            // â–¼â–¼â–¼ ä¿®æ­£: ã‚¯ã‚¤ã‚ºç”»é¢ã‚‚iframeã‚’å‹•çš„ç”Ÿæˆãƒ»å‰Šé™¤ã™ã‚‹ â–¼â–¼â–¼
            const quizPage = new SubPage('quiz-screen', {
                onClose: () => {
                    // 1. iframeã‚’å‰Šé™¤
                    const container = $('#quiz-container');
                    const iframe = document.getElementById('quiz-screen-iframe');
                    if (iframe) {
                        iframe.remove();
                    }
                    
                    // ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
                    $('#quiz-loader').style.display = 'none';

                    // 2. è©•ä¾¡ãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰ã®å‡¦ç† (æ—¢å­˜ã‚³ãƒ¼ãƒ‰ç¶­æŒ)
                    if (currentQuizId) {
                         $('#assessment-modal').dataset.quizId = currentQuizId;
                         openModalWithAnim('assessment-modal', 'assessment-content');
                         
                         if(quizTimer.startTime) {
                            const elapsed = Math.round((Date.now() - quizTimer.startTime) / 1000);
                            const title = $('#quiz-screen-title').textContent || 'ã‚¯ã‚¤ã‚º';
                            recordSession(title, elapsed);
                            quizTimer.startTime = null;
                            saveState();
                        }
                        currentQuizId = null;
                    }
                }
            });
            
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            $('#close-quiz-btn').addEventListener('click', () => quizPage.close());

            // 2. è©³ç´°ç”»é¢ã‚’é–‹ãé–¢æ•°
            // â†“â†“â†“ openItemDetailScreen ã‚’ã“ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â†“â†“â†“
const openItemDetailScreen = (id, type) => {
    const screen = $('#item-detail-screen');
    let itemData;
    let categoryName = '';

    if (type === 'theme') {
        itemData = initialData.themes[id];
        categoryName = 'ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼';
    } else if (type === 'background') {
        itemData = initialData.backgrounds[id];
        categoryName = 'å£ç´™';
    } else if (type === 'game') {
        itemData = initialData.games[id];
        categoryName = 'ã‚²ãƒ¼ãƒ ';
    } else if (type === 'music') {
        itemData = initialData.music[id];
        categoryName = 'BGM';
    }

    $('#detail-title').textContent = itemData.name;
    $('#detail-subtitle').textContent = categoryName;
    
    const iconContainer = $('#detail-icon-container');
    iconContainer.innerHTML = '';
    
    if (type === 'theme') {
        iconContainer.style.backgroundColor = itemData.color;
        iconContainer.className = "w-32 h-32 rounded-full shadow-lg border-4 border-white dark:border-gray-700 mx-auto";
    } else if (type === 'background') {
        iconContainer.className = "w-32 h-56 rounded-3xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden mx-auto";
        const bgStyle = itemData.url ? `background-image: url(${itemData.url}); background-size: cover; background-position: center;` : 'background-color: #6b7280;';
        iconContainer.innerHTML = `<div class="w-full h-full" style="${bgStyle}"></div>`;
    } else {
        // ã‚²ãƒ¼ãƒ  ã¾ãŸã¯ éŸ³æ¥½
        iconContainer.style.backgroundColor = ''; 
        iconContainer.className = "w-32 h-32 rounded-3xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden flex items-center justify-center bg-gray-100 dark:bg-gray-800 relative mx-auto";
        
        // â˜…ä¿®æ­£: ã‚²ãƒ¼ãƒ ã‹ã¤ã‚µãƒ ãƒã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤º
        if (type === 'game' && itemData.thumbnail) {
            iconContainer.innerHTML = `<img src="${itemData.thumbnail}" alt="${itemData.name}" class="w-full h-full object-cover">`;
        } else {
            // å¾“æ¥é€šã‚Šã®ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
            const iconName = itemData.icon || (type === 'music' ? 'music' : 'gamepad-2');
            const iconColor = type === 'game' ? 'text-indigo-500' : 'text-pink-500';
            let innerContent = `<i data-lucide="${iconName}" class="w-16 h-16 ${iconColor}"></i>`;

            if (type === 'music') {
                innerContent += `
                    <button id="detail-music-play-btn" class="absolute inset-0 flex items-center justify-center bg-black/5 hover:bg-black/20 transition-colors z-10 group">
                        <div class="bg-white/90 dark:bg-gray-800/90 p-3 rounded-full shadow-lg transform transition-transform group-hover:scale-110">
                            <i id="detail-play-icon" data-lucide="play" class="w-6 h-6 text-pink-500 fill-current ml-0.5"></i>
                        </div>
                    </button>
                `;
            }
            iconContainer.innerHTML = innerContent;

            if (type === 'music') {
                setTimeout(() => {
                    const playBtn = $('#detail-music-play-btn');
                    const playIcon = $('#detail-play-icon');
                    if (playBtn) {
                        playBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (!previewAudio.paused && previewAudio.src === itemData.url) {
                                stopMusicPreview();
                            } else {
                                stopMusicPreview();
                                previewAudio.src = itemData.url;
                                previewAudio.volume = 0.5;
                                
                                // â˜…ä¿®æ­£: æ­£ã—ã„ã‚¢ã‚¤ãƒ†ãƒ åã‚’ã‚»ãƒƒãƒˆ
                                updateMediaSession(itemData.name);
                                
                                previewAudio.play();
                                playIcon.setAttribute('data-lucide', 'square');
                                playIcon.classList.remove('ml-0.5');
                                lucide.createIcons();
                                previewTimeout = setTimeout(stopMusicPreview, 30000);
                            }
                        };
                    }
                }, 0);
            }
        }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆã‚²ãƒ¼ãƒ ç”¨ï¼‰
    const previewSection = $('#detail-preview-section');
    if (type === 'game' && itemData.previews && itemData.previews.length > 0) {
        previewSection.classList.remove('hidden');
        renderGamePreviews(itemData); // â€»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚µã‚¤ã‚ºã¯ renderGamePreviews å†…ã§åˆ¶å¾¡
    } else {
        previewSection.classList.add('hidden');
    }

                const descEl = $('#detail-description');
                    let descriptionText = "";

                    if (type === 'theme') {
                        descriptionText = "ã‚¢ãƒ—ãƒªå…¨ä½“ã«é©ç”¨ã§ãã‚‹ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã§ã™ã€‚\næ°—åˆ†ã«åˆã‚ã›ã¦è‰²ã‚’å¤‰ãˆã¦ã€ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸Šã’ã¾ã—ã‚‡ã†ï¼\n\nã€Œè¨­å®š > ãƒ†ãƒ¼ãƒè¨­å®šã€ã‹ã‚‰éšæ™‚å¤‰æ›´ã§ãã¾ã™ã€‚";
                    } else if (type === 'background') {
                        descriptionText = "ã‚¯ã‚¨ã‚¹ãƒˆã‚„ã‚¿ã‚¤ãƒãƒ¼ãƒ»ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®èƒŒæ™¯ã§ã™ã€‚\nã‚¢ãƒ—ãƒªå…¨ä½“ã«èƒŒæ™¯ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚\nãŠæ°—ã«å…¥ã‚Šã®å£ç´™ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãªãŒã‚‰å­¦ç¿’ã—ã¾ã—ã‚‡ã†ã€‚\n\nã€Œè¨­å®š > å£ç´™è¨­å®šã€ã‹ã‚‰éšæ™‚å¤‰æ›´ã§ãã¾ã™ã€‚";
                    } else if (type === 'music') {
                        descriptionText = "ã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«å†ç”Ÿã§ãã‚‹BGMã§ã™ã€‚\nã€Œè¨­å®š > BGMè¨­å®šã€ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹ã¨ã€ã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«è‡ªå‹•ã§å†ç”Ÿã•ã‚Œã¾ã™ã€‚";
                    } else if (type === 'game') {
                        // ãƒ‡ãƒ¼ã‚¿å®šç¾©ã«è¿½åŠ ã—ãŸ description ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡ã‚’è¡¨ç¤º
                        descriptionText = itemData.description || "ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ ã«éŠã¹ã‚‹ã‚²ãƒ¼ãƒ ã§ã™ã€‚\nçŸ­æ™‚é–“ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¦ã€æ¬¡ã®å­¦ç¿’ã‚’é›†ä¸­ã—ã¾ã—ã‚‡ã†ã€‚";
                    } else {
                        // ãã®ä»–ï¼ˆäºˆå‚™ï¼‰
                        descriptionText = "ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å­¦ç¿’ä½“é¨“ãŒã‚ˆã‚Šè±Šã‹ã«ãªã‚Šã¾ã™ã€‚LPã‚’è²¯ã‚ã¦äº¤æ›ã—ã¾ã—ã‚‡ã†ã€‚";
                    }

                    // æ”¹è¡Œã‚³ãƒ¼ãƒ‰(\n)ã‚’<br>ã‚¿ã‚°ã«å¤‰æ›ã—ã¦è¡¨ç¤º
                    descEl.innerHTML = descriptionText.replace(/\n/g, '<br>');

                // --- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ â–¼â–¼â–¼ ---
                
                // ãƒœã‚¿ãƒ³æç”»ãƒ­ã‚¸ãƒƒã‚¯ã‚’é–¢æ•°åŒ–
                // â†“â†“â†“ æ—¢å­˜ã® renderActionButton ã‚’ã“ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â†“â†“â†“
const renderActionButton = () => {
    const actionBtn = $('#detail-action-btn');
    const statusText = $('#detail-status-text');
    
    // æœ€æ–°ã®çŠ¶æ…‹ã‚’stateã‹ã‚‰å†å–å¾—
    let isUnlocked = false;
    let isActive = false;

    if (type === 'theme') {
        isUnlocked = state.profile.unlockedThemes.includes(id);
        isActive = state.profile.activeTheme === id;
    } else if (type === 'background') {
        isUnlocked = state.profile.unlockedBackgrounds.includes(id);
        isActive = state.profile.activeBackground === id;
    } else if (type === 'game') {
        isUnlocked = state.profile.unlockedGames.includes(id);
    } else if (type === 'music') {
        isUnlocked = state.profile.unlockedMusic.includes(id);
    }

    const newBtn = actionBtn.cloneNode(true);
    actionBtn.parentNode.replaceChild(newBtn, actionBtn);

    newBtn.className = "font-bold py-3 px-8 rounded-full shadow-lg transition-transform active:scale-95 flex items-center min-w-[140px] justify-center text-lg";

    if (!isUnlocked) {
        // æœªè³¼å…¥çŠ¶æ…‹
        statusText.classList.add('hidden'); // æœªè³¼å…¥æ™‚ã¯éš ã™
        
        newBtn.innerHTML = `<span class="mr-1">${itemData.cost}</span> <span class="text-sm">LP ã§äº¤æ›</span>`;
        
        if (state.profile.lp >= itemData.cost) {
            newBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            newBtn.classList.add('primary-bg', 'text-white');
            newBtn.onclick = () => {
                openPurchaseConfirm(itemData, type, () => {
                    purchaseItem(id, type, itemData.cost, () => {
                        renderActionButton();
                    });
                });
            };
        } else {
            newBtn.classList.remove('primary-bg', 'text-white');
            newBtn.classList.add('bg-gray-400', 'text-gray-100', 'cursor-not-allowed');
            newBtn.onclick = () => showToast('LPãŒè¶³ã‚Šã¾ã›ã‚“');
        }
    } else {
        // è³¼å…¥æ¸ˆã¿çŠ¶æ…‹
        
        // â˜…ä¿®æ­£: äº¤æ›æ¸ˆã¿ã®æ–‡å­—ã®ã¨ã“ã‚ã«å¿…è¦LPã‚’è¡¨ç¤ºã™ã‚‹
        statusText.textContent = `${itemData.cost} LP (äº¤æ›æ¸ˆ)`;
        statusText.classList.remove('hidden');

        if (type === 'theme' || type === 'background') {
            if (isActive) {
                newBtn.innerHTML = `<span>é©ç”¨ä¸­</span>`;
                newBtn.className = "bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-bold py-3 px-8 rounded-full shadow-none cursor-default min-w-[140px]";
                newBtn.onclick = null;
            } else {
                newBtn.innerHTML = `<span>é©ç”¨ã™ã‚‹</span>`;
                newBtn.className = "primary-bg text-white font-bold py-3 px-8 rounded-full shadow-lg active:scale-95 cursor-pointer min-w-[140px]";
                newBtn.onclick = () => {
                    applyItem(id, type);
                    renderActionButton();
                };
            }
        } else {
            newBtn.innerHTML = `<span>è§£æ”¾æ¸ˆã¿</span>`;
            newBtn.className = "bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 font-bold py-3 px-8 rounded-full shadow-none cursor-default min-w-[140px]";
            newBtn.onclick = null;
        }
    }
};
// â†‘â†‘â†‘ ä¿®æ­£ã“ã“ã¾ã§ â†‘â†‘â†‘
                // åˆå›æç”»å®Ÿè¡Œ
                renderActionButton();

                // --- â–²â–²â–² ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³å¤‰æ›´ã“ã“ã¾ã§ â–²â–²â–² ---

                lucide.createIcons();
                itemDetailPage.open();
            };

            // ãƒ†ãƒ¼ãƒè¨­å®šã‚µãƒ–ãƒšãƒ¼ã‚¸ï¼ˆä¿®æ­£ç‰ˆ: å†æç”»ãƒã‚°ä¿®æ­£ & è‰²åŒæœŸï¼‰
const themeSettingsPage = new SubPage('theme-settings-screen', {
    onOpen: () => {
        // ã‚³ãƒ³ãƒ†ãƒŠã‚’IDã§ç¢ºå®Ÿã«å–å¾—
        const contentArea = document.getElementById('theme-settings-content');
        if (!contentArea) return;

        // ä¸€åº¦ä¸­èº«ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ï¼ˆã“ã‚Œã§å†æç”»æ™‚ã®é‡è¤‡ã‚„ãƒã‚°ã‚’é˜²ãï¼‰
        contentArea.innerHTML = "";

        // --- 1. å¤–è¦³ãƒ¢ãƒ¼ãƒ‰è¨­å®šãƒœãƒƒã‚¯ã‚¹ ---
        const modeSection = document.createElement('div');
        modeSection.className = "mb-8";
        modeSection.innerHTML = `
            <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">å¤–è¦³ãƒ¢ãƒ¼ãƒ‰</h3>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-super shadow-modern overflow-hidden">
                <div class="relative w-full h-12 flex items-center">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-4 shadow-sm" style="background-color: var(--primary-color);">
                        <i data-lucide="moon" class="w-4 h-4 text-white"></i>
                    </div>
                    <div class="flex-grow min-w-0 mr-4">
                        <p class="text-sm font-bold text-gray-800 dark:text-white">ãƒ¢ãƒ¼ãƒ‰è¨­å®š</p>
                    </div>
                    <div class="relative">
                        <span id="theme-mode-label" class="text-sm font-bold primary-text pr-6">è‡ªå‹•</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                        <select id="theme-mode-select" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <option value="light">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</option>
                            <option value="dark">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</option>
                            <option value="system">è‡ªå‹• (ãƒ‡ãƒã‚¤ã‚¹)</option>
                        </select>
                    </div>
                </div>
                <div id="theme-locked-msg" class="hidden mt-3 px-4 py-2 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 text-xs font-bold flex items-center rounded-lg">
                    <i data-lucide="lock" class="w-3 h-3 mr-1.5"></i> å£ç´™è¨­å®šã«ã‚ˆã‚Šå›ºå®šä¸­
                </div>
            </div>
        `;
        contentArea.appendChild(modeSection);

        // --- 2. ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®šãƒœãƒƒã‚¯ã‚¹ ---
        const colorSection = document.createElement('div');
        
        const buttonsHTML = state.profile.unlockedThemes.map(id => {
            const theme = initialData.themes[id];
            const isActive = state.profile.activeTheme === id;
            // â–¼ é¸æŠæ ã®è‰²ã‚’ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«åŒæœŸ (styleå±æ€§ã§box-shadowã‚’åˆ¶å¾¡)
            const activeStyle = isActive 
                ? `box-shadow: 0 0 0 3px var(--primary-color), 0 0 0 5px white; transform: scale(1.1);` 
                : `border: 4px solid transparent;`;
            
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒªãƒ³ã‚°ã®éš™é–“è‰²èª¿æ•´ç”¨ï¼ˆç°¡æ˜“çš„ã«ç™½å›ºå®šã«ã—ã¦ã„ã¾ã™ãŒã€å¿…è¦ãªã‚‰ãƒ€ãƒ¼ã‚¯å¯¾å¿œã‚‚å¯ï¼‰
            
            return `
                <div class="flex flex-col items-center pt-2">
                    <button class="theme-btn w-12 h-12 rounded-full relative transition-all active:scale-95 shadow-sm" 
                            style="background-color: ${theme.color}; ${activeStyle}" 
                            data-theme="${id}">
                        ${isActive ? '<div class="absolute inset-0 flex items-center justify-center"><i data-lucide="check" class="text-white w-6 h-6 drop-shadow-md"></i></div>' : ''}
                    </button>
                    <span class="text-[10px] font-bold mt-3 text-gray-500 dark:text-gray-400 ${isActive ? 'primary-text' : ''}">${theme.name}</span>
                </div>`;
        }).join('');

        colorSection.innerHTML = `
            <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</h3>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-super shadow-modern grid grid-cols-4 gap-y-6 gap-x-4">
                ${buttonsHTML}
            </div>
        `;
        contentArea.appendChild(colorSection);

        // --- 3. ãƒ­ã‚¸ãƒƒã‚¯è¨­å®š ---
        const select = document.getElementById('theme-mode-select');
        const label = document.getElementById('theme-mode-label');
        const lockedMsg = document.getElementById('theme-locked-msg');
        const currentMode = state.settings.themeMode || 'system';

        const updateLabel = (val) => {
            const textMap = { 'light': 'ãƒ©ã‚¤ãƒˆ', 'dark': 'ãƒ€ãƒ¼ã‚¯', 'system': 'è‡ªå‹•' };
            label.textContent = textMap[val] || 'è‡ªå‹•';
        };

        if (select) {
            select.value = currentMode;
            updateLabel(currentMode);

            const activeBg = initialData.backgrounds[state.profile.activeBackground];
            const isGlobal = state.settings.backgroundScopeGlobal;
            
            if (isGlobal && activeBg && activeBg.url) {
                select.disabled = true;
                lockedMsg.classList.remove('hidden');
                if (activeBg.tone && activeBg.tone !== 'system') {
                    select.value = activeBg.tone;
                    updateLabel(activeBg.tone);
                }
            } else {
                select.disabled = false;
                lockedMsg.classList.add('hidden');
            }

            select.onchange = (e) => {
                state.settings.themeMode = e.target.value;
                saveState();
                updateLabel(e.target.value);
                updateAppearance();
            };
        }

        // ã‚«ãƒ©ãƒ¼å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
        contentArea.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                state.profile.activeTheme = btn.dataset.theme;
                saveState();
                applyThemeColor();
                themeSettingsPage.onOpen(); // å†å¸°çš„ã«å‘¼ã‚“ã§å†æç”»
            });
        });

        lucide.createIcons();
    }
});
            $('#close-theme-settings-btn').addEventListener('click', () => themeSettingsPage.close());

            // å£ç´™è¨­å®šã‚µãƒ–ãƒšãƒ¼ã‚¸ï¼ˆä¿®æ­£ç‰ˆ: ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ãƒˆã‚°ãƒ«è‰²åŒæœŸï¼‰
const backgroundSettingsPage = new SubPage('background-settings-screen', {
    onOpen: () => {
        // HTMLæ§‹é€ ã‚’JSã§ç”Ÿæˆ
        const pageRoot = document.querySelector('#background-settings-screen .overflow-y-auto');
        if(!pageRoot) return;

        pageRoot.innerHTML = `
            <div class="space-y-8 pb-10">
                <div>
                    <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">å£ç´™ã‚’é¸æŠ</h3>
                    <div id="background-selector-container" class="bg-white dark:bg-gray-800 p-6 rounded-super shadow-modern grid grid-cols-2 gap-4"></div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                    <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                        
                        <div class="relative flex items-center justify-between p-4 h-16">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mr-4 shadow-sm" style="background-color: var(--primary-color);">
                                    <i data-lucide="smartphone" class="w-4 h-4 text-white"></i>
                                </div>
                                <div class="flex flex-col justify-center">
                                    <span class="text-sm font-bold text-gray-800 dark:text-white">å…¨ä½“ã«é©ç”¨</span>
                                    <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500">ãƒ›ãƒ¼ãƒ ç”»é¢ç­‰ã«ã‚‚åæ˜ </span>
                                </div>
                            </div>
                            
                            <div class="relative">
                                <input type="checkbox" id="background-scope-toggle-sub" class="peer sr-only">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--primary-color)]"></div>
                                <label for="background-scope-toggle-sub" class="absolute inset-0 cursor-pointer w-full h-full"></label>
                            </div>
                        </div>

                    </div>
                    <p class="text-xs text-gray-400 mt-2 ml-2">â€»ã‚ªãƒ³ã«ã™ã‚‹ã¨è¦–èªæ€§ãŒä¸‹ãŒã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
                </div>
            </div>
        `;

        const container = document.getElementById('background-selector-container');
        
        // --- 1. å£ç´™ä¸€è¦§ã®æç”» ---
        const renderBackgrounds = () => {
            container.innerHTML = state.profile.unlockedBackgrounds.map(id => {
                const bg = initialData.backgrounds[id];
                const isActive = state.profile.activeBackground === id;
                // é¸æŠä¸­ã®æ ç·šã‚’ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«
                const activeStyle = isActive 
                    ? `box-shadow: 0 0 0 3px var(--primary-color);` 
                    : '';
                
                return `
                    <div class="flex flex-col items-center">
                        <button class="background-btn w-full aspect-[9/16] rounded-2xl border border-gray-200 dark:border-gray-700 relative bg-gray-200 dark:bg-gray-700 bg-cover bg-center transition-all active:scale-95 shadow-sm" 
                                style="background-image: ${bg.url ? `url(${bg.url})` : 'none'}; ${activeStyle}" 
                                data-bg="${id}">
                            ${!bg.url ? '<i data-lucide="image-off" class="w-8 h-8 text-gray-400 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>' : ''}
                            ${isActive ? `<div class="absolute inset-0 flex items-center justify-center bg-black/20 rounded-2xl"><div class="rounded-full p-1 shadow-sm" style="background-color: var(--primary-color);"><i data-lucide="check" class="text-white w-4 h-4"></i></div></div>` : ''}
                        </button>
                        <p class="text-xs mt-2 font-bold text-gray-600 dark:text-gray-300 truncate w-full text-center">${bg.name}</p>
                    </div>`;
            }).join('');
            lucide.createIcons();

            container.querySelectorAll('.background-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const bgId = btn.dataset.bg;
                    state.profile.activeBackground = bgId;
                    saveState();
                    updateAppearance();   // å…¨ä½“ãƒ†ãƒ¼ãƒæ›´æ–°
                    updateBackgrounds();  // èƒŒæ™¯ç”»åƒæ›´æ–°
                    renderBackgrounds();  // ãƒªã‚¹ãƒˆå†æç”»
                });
            });
        };

        renderBackgrounds();

        // --- 2. ã‚¹ã‚¤ãƒƒãƒã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
        const toggle = document.getElementById('background-scope-toggle-sub');
        if (toggle) {
            toggle.checked = state.settings.backgroundScopeGlobal;
            toggle.addEventListener('change', (e) => {
                state.settings.backgroundScopeGlobal = e.target.checked;
                saveState();
                updateAppearance();
                updateBackgrounds();
                // ãƒˆã‚°ãƒ«ã®è‰²ãŒCSSå¤‰æ•°ã§å³æ™‚åæ˜ ã•ã‚Œãªã„å ´åˆã®ãŸã‚ã€è¦ªã‚’å†æç”»ã—ã¦ã‚‚è‰¯ã„ãŒã€CSSå¤‰æ•°ãªã‚‰è‡ªå‹•ã§å¤‰ã‚ã‚‹ã¯ãš
            });
        }
        
        lucide.createIcons();
    }
});
            $('#close-bg-settings-btn').addEventListener('click', () => backgroundSettingsPage.close());

            // â–¼â–¼â–¼ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¨­å®šç”»é¢ã®åˆ¶å¾¡ â–¼â–¼â–¼

            let routineSortable = null;
            // â–¼â–¼â–¼ ä¿®æ­£ç‰ˆ: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³è¨­å®šãƒšãƒ¼ã‚¸ (é‡è¤‡è§£æ¶ˆãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¿®æ­£ãƒ»ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ) â–¼â–¼â–¼
const routineSettingsPage = new SubPage('routine-settings-screen', {
    onOpen: () => {
        // ã‚³ãƒ³ãƒ†ãƒŠã‚’å–å¾—
        const contentArea = document.getElementById('routine-settings-content');
        if (!contentArea) return;

        // æ—¢å­˜ã®Sortableã‚’ç ´æ£„
        if (routineSortable) {
            routineSortable.destroy();
            routineSortable = null;
        }

        // HTMLã‚’JSã§ä¸€æ‹¬ç”Ÿæˆï¼ˆã“ã‚Œã§é‡è¤‡ã‚’é˜²ãï¼‰
        contentArea.innerHTML = `
            <div class="space-y-4 pb-10">
                <p class="text-xs text-gray-500 dark:text-gray-400 px-2">
                    ã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚<br>
                    ã‚¹ãƒ¯ã‚¤ãƒ—ã§å‰Šé™¤ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆãŒã§ãã¾ã™ã€‚
                </p>

                <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                    <div id="routine-list-container" class="divide-y divide-gray-100 dark:divide-gray-700"></div>

                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800/50 gap-2 border-t border-gray-100 dark:border-gray-700">
                        <button id="btn-add-section" class="flex-1 py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold text-sm transition-colors flex items-center justify-center active:scale-95">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i> ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                        </button>
                        <div class="w-px h-6 bg-gray-300 dark:bg-gray-600"></div>
                        <button id="btn-add-break" class="flex-1 py-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold text-sm transition-colors flex items-center justify-center active:scale-95">
                            <i data-lucide="coffee" class="w-4 h-4 mr-1"></i> ãƒ–ãƒ¬ã‚¤ã‚¯
                        </button>
                    </div>
                </div>
            </div>
        `;

        const listContainer = document.getElementById('routine-list-container');

        // --- ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ æç”»é–¢æ•° ---
        const renderItems = () => {
            if (state.profile.routineTemplate.length === 0) {
                listContainer.innerHTML = `
                    <div class="py-10 text-center text-gray-400 dark:text-gray-500">
                        <i data-lucide="list-x" class="w-10 h-10 mx-auto mb-2 opacity-30"></i>
                        <p class="text-xs font-bold">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãŒç©ºã§ã™</p>
                    </div>`;
                lucide.createIcons({ root: listContainer });
                return;
            }

            listContainer.innerHTML = state.profile.routineTemplate.map((item, index) => {
                let iconHTML = '';
                let titleHTML = '';
                
                if (item.type === 'section') {
                    iconHTML = `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600 dark:text-indigo-400 shadow-sm"><i data-lucide="book-open" class="w-4 h-4"></i></div>`;
                    titleHTML = `<span class="text-sm font-bold text-gray-800 dark:text-gray-200">ã‚»ã‚¯ã‚·ãƒ§ãƒ³</span>`;
                } else {
                    iconHTML = `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center text-green-600 dark:text-green-400 shadow-sm"><i data-lucide="coffee" class="w-4 h-4"></i></div>`;
                    titleHTML = `<span class="text-sm font-bold text-gray-800 dark:text-gray-200">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </span>`;
                }

                const durationMin = Math.floor(item.duration / 60);

                // â˜…ä¿®æ­£ç‚¹: activeæ™‚ã®èƒŒæ™¯è‰²ã‹ã‚‰ã€Œ/50ã€ã‚’å‰Šé™¤ã—ã¦ä¸é€æ˜ã«ã™ã‚‹
                return `
                    <div class="routine-item swipe-container relative overflow-hidden group h-[72px] w-full bg-white dark:bg-gray-800 transition-colors" data-index="${index}">
                        <div class="swipe-actions">
                            <button class="btn-delete swipe-btn bg-red-500 w-[70px]">
                                <i data-lucide="trash-2" class="w-6 h-6"></i>
                                <span>å‰Šé™¤</span>
                            </button>
                        </div>

                        <div class="swipe-content flex items-center px-4 h-full relative z-10 w-full bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 active:bg-gray-100 dark:active:bg-gray-700 transition-colors">
                            <div class="mr-3 flex-shrink-0">${iconHTML}</div>
                            
                            <div class="flex-grow min-w-0 flex flex-col justify-center mr-2">
                                ${titleHTML}
                            </div>

                            <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg px-2 py-1 flex-shrink-0 mr-1 h-8">
                                <input type="number" value="${durationMin}" 
                                    class="routine-duration-input w-8 bg-transparent text-center font-bold text-sm text-gray-700 dark:text-gray-200 focus:outline-none p-0 appearance-none">
                                <span class="text-[10px] text-gray-400 font-bold ml-0.5">åˆ†</span>
                            </div>

                            <button class="routine-handle cursor-grab active:cursor-grabbing text-gray-300 hover:text-gray-500 p-2 -mr-2 flex-shrink-0 touch-none h-10 w-10 flex items-center justify-center">
                                <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            listContainer.querySelectorAll('.routine-item').forEach(itemEl => {
                const index = parseInt(itemEl.dataset.index);
                const item = state.profile.routineTemplate[index];

                // æ™‚é–“å¤‰æ›´
                const input = itemEl.querySelector('.routine-duration-input');
                input.addEventListener('change', (e) => {
                    let val = parseInt(e.target.value);
                    
                    // â–¼â–¼â–¼ ä¿®æ­£: ä¸Šé™ãƒ»ä¸‹é™ãƒã‚§ãƒƒã‚¯ â–¼â–¼â–¼
                    if (val < 1) val = 1;
                    if (val > 720) val = 720; // 720åˆ†ã§ã‚«ãƒ³ã‚¹ãƒˆ
                    
                    e.target.value = val; // å…¥åŠ›æ¬„ã‚’æ›¸ãæ›ãˆ
                    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
                
                    item.duration = val * 60;
                    saveState();
                });

                // ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤
                new SwipeHandler(itemEl, {
                    onDelete: () => {
                        state.profile.routineTemplate.splice(index, 1);
                        saveState();
                        // â˜… ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«å†æç”»
                        setTimeout(renderItems, 300); 
                    }
                });
            });

            lucide.createIcons({ root: listContainer });
        };

        // åˆå›æç”»
        renderItems();

        // SortableåˆæœŸåŒ– (ãƒªã‚¹ãƒˆãŒç©ºã§ãªã„å ´åˆã®ã¿)
        // â˜…ä¿®æ­£: delayè¨­å®šãªã©ã‚’ã‚¯ã‚¨ã‚¹ãƒˆãƒªã‚¹ãƒˆã¨çµ±ä¸€
        if (state.profile.routineTemplate.length > 0) {
            routineSortable = Sortable.create(listContainer, {
                handle: '.routine-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                delay: 200, 
                delayOnTouchOnly: true, 
                touchStartThreshold: 5,
                filter: '.swiped-open, .is-swiping, .swipe-deleting',
                onEnd: (evt) => {
                    const item = state.profile.routineTemplate.splice(evt.oldIndex, 1)[0];
                    state.profile.routineTemplate.splice(evt.newIndex, 0, item);
                    saveState();
                    renderItems(); // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŒ¯ã‚Šç›´ã—ã®ãŸã‚å†æç”»
                }
            });
        }

        // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        document.getElementById('btn-add-section').addEventListener('click', () => {
            state.profile.routineTemplate.push({ id: Date.now(), type: 'section', duration: 25 * 60 });
            saveState();
            // ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦Sortableã‚’å†è¨­å®š
            routineSettingsPage.onOpen();
        });

        document.getElementById('btn-add-break').addEventListener('click', () => {
            state.profile.routineTemplate.push({ id: Date.now(), type: 'break', duration: 5 * 60 });
            saveState();
            routineSettingsPage.onOpen();
        });

        lucide.createIcons();
    }
});

// æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆã“ã‚Œã¯å¤‰æ›´ãªã—ï¼‰
document.getElementById('close-routine-settings-btn').addEventListener('click', () => routineSettingsPage.close());
// â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
            // --- 5. BGMè¨­å®šã‚µãƒ–ãƒšãƒ¼ã‚¸ ---
            let bgmSortablePlaylist = null;
            let bgmSortableLibrary = null;
            let currentPreviewId = null; // å†ç”Ÿä¸­ã®ãƒˆãƒ©ãƒƒã‚¯IDã‚’ç®¡ç†

            const bgmSettingsPage = new SubPage('bgm-settings-screen', {
                onOpen: () => {
                    const pageRoot = document.querySelector('#bgm-settings-screen .overflow-y-auto');
                    if (!pageRoot) return;

                    // æ—¢å­˜ã®Sortableã‚’ç ´æ£„
                    if (bgmSortablePlaylist) { bgmSortablePlaylist.destroy(); bgmSortablePlaylist = null; }
                    if (bgmSortableLibrary) { bgmSortableLibrary.destroy(); bgmSortableLibrary = null; }

                    // HTMLç”Ÿæˆ
                    pageRoot.innerHTML = `
                        <div class="space-y-8 pb-20">
                            <div>
                                <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">è¨­å®š</h3>
                                <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                                    <div class="flex items-center justify-between p-4 h-16">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-4 shadow-sm text-white" style="background-color: var(--primary-color);">
                                                <i data-lucide="music" class="w-4 h-4 text-white"></i>
                                            </div>
                                            <div class="flex flex-col justify-center">
                                                <span class="text-sm font-bold text-gray-800 dark:text-white">BGMæ©Ÿèƒ½</span>
                                                <span class="text-[10px] font-bold text-gray-400 dark:text-gray-500">ã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ—å†ç”Ÿ</span>
                                            </div>
                                        </div>
                                        <div class="relative">
                                            <input type="checkbox" id="bgm-toggle-sub" class="peer sr-only">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--primary-color)]"></div>
                                            <label for="bgm-toggle-sub" class="absolute inset-0 cursor-pointer w-full h-full"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h3>
                                <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                                    <div id="bgm-playlist-container" class="divide-y divide-gray-100 dark:divide-gray-700 min-h-[60px]"></div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2 ml-2">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h3>
                                <div class="bg-white dark:bg-gray-800 rounded-super shadow-modern overflow-hidden">
                                    <div id="bgm-library-container" class="divide-y divide-gray-100 dark:divide-gray-700 min-h-[60px]"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    // ãƒˆã‚°ãƒ«è¨­å®š
                    const toggle = document.getElementById('bgm-toggle-sub');
                    if (toggle) {
                        toggle.checked = state.settings.bgmEnabled;
                        toggle.addEventListener('change', (e) => {
                            state.settings.bgmEnabled = e.target.checked;
                            saveState();
                        });
                    }

                    const playlistContainer = document.getElementById('bgm-playlist-container');
                    const libraryContainer = document.getElementById('bgm-library-container');

                    // --- ãƒªã‚¹ãƒˆæç”»é–¢æ•° ---
                    const renderLists = () => {
                        const playlistIds = state.settings.playlist;
                        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€Œãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ãªã„è§£æ”¾æ¸ˆã¿æ›²ã€
                        const libraryIds = state.profile.unlockedMusic.filter(id => !playlistIds.includes(id));

                        const isPlaying = !previewAudio.paused;

                        const createItemHTML = (id, index, listType) => {
                            const track = initialData.music[id];
                            if (!track) return '';

                            // å†ç”Ÿä¸­åˆ¤å®š: IDã§æ¯”è¼ƒ
                            const isTrackPlaying = isPlaying && currentPreviewId === id;
                            
                            // ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
                            let playIcon = 'play';
                            let iconClass = 'ml-0.5'; 
                            
                            if (isTrackPlaying) {
                                playIcon = 'square';
                                iconClass = ''; 
                            }

                            // å·¦å´ã®è¦ç´  (ç•ªå· or ãƒ—ãƒ©ã‚¹)
                            let leftIconHTML;
                            if (listType === 'playlist') {
                                leftIconHTML = `
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3 flex-shrink-0 text-white shadow-sm pointer-events-none" style="background-color: var(--primary-color);">
                                        <span class="text-xs font-bold">${index + 1}</span>
                                    </div>`;
                            } else {
                                // ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³: ã‚°ãƒ¬ãƒ¼ç³»ã®ãƒ›ãƒãƒ¼è‰²ã«å¤‰æ›´
                                leftIconHTML = `
                                    <button class="add-bgm-btn w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mr-3 flex-shrink-0 text-gray-400 hover:bg-gray-200 hover:text-gray-600 dark:hover:bg-gray-600 dark:hover:text-gray-300 transition-colors" data-id="${id}">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>`;
                            }

                            // å³å´ã®ãƒãƒ³ãƒ‰ãƒ« (å…±é€šåŒ–)
                            const handleHTML = `
                                <div class="bgm-handle p-2 text-gray-300 hover:text-gray-500 cursor-grab active:cursor-grabbing touch-none flex-shrink-0 ml-1">
                                    <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                </div>`;

                            // ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ã¿æœ‰åŠ¹ï¼‰
                            let swipeActionsHTML = '';
                            let containerClass = 'bgm-sortable-item group relative w-full bg-white dark:bg-gray-800 transition-colors';
                            
                            if (listType === 'playlist') {
                                containerClass += ' swipe-container overflow-hidden h-[72px]';
                                swipeActionsHTML = `
                                    <div class="swipe-actions">
                                        <button class="remove-bgm-btn swipe-btn bg-red-500 w-[70px]">
                                            <i data-lucide="trash-2" class="w-6 h-6"></i>
                                            <span>å‰Šé™¤</span>
                                        </button>
                                    </div>
                                `;
                            } else {
                                containerClass += ' h-[72px]'; // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚é«˜ã•ã‚’æƒãˆã‚‹
                            }

                            // èƒŒæ™¯è‰²è¨­å®š: ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã«é€æ˜åº¦ã‚’ä½¿ã‚ãšä¸é€æ˜è‰²ã‚’æŒ‡å®šã—ã¦é€ã‘é˜²æ­¢
                            const contentBgClass = "bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 active:bg-gray-100 dark:active:bg-gray-700";

                            return `
                                <div class="${containerClass}" data-id="${id}">
                                    ${swipeActionsHTML}
                                    <div class="swipe-content flex items-center p-3 h-full relative z-10 w-full transition-colors ${contentBgClass}">
                                        ${leftIconHTML}

                                        <div class="flex-grow min-w-0 mr-2 flex flex-col justify-center">
                                            <p class="font-bold text-sm text-gray-800 dark:text-gray-200 truncate">${track.name}</p>
                                        </div>

                                        <button class="preview-bgm-btn w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition flex items-center justify-center flex-shrink-0" 
                                                data-id="${id}" data-url="${track.url}" data-name="${track.name}">
                                            <i data-lucide="${playIcon}" class="w-5 h-5 primary-text ${iconClass} ${isTrackPlaying ? 'fill-current' : 'fill-current'}"></i>
                                        </button>

                                        ${handleHTML}
                                    </div>
                                </div>
                            `;
                        };

                        // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæç”»
                        if (playlistIds.length === 0) {
                            playlistContainer.innerHTML = `<div class="py-8 text-center text-xs text-gray-400 font-bold pointer-events-none">ã“ã“ã¸ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¿½åŠ </div>`;
                        } else {
                            playlistContainer.innerHTML = playlistIds.map((id, i) => createItemHTML(id, i, 'playlist')).join('');
                        }

                        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæç”»
                        if (libraryIds.length === 0) {
                            libraryContainer.innerHTML = `<div class="py-8 text-center text-xs text-gray-400 font-bold pointer-events-none">ã™ã¹ã¦è¿½åŠ æ¸ˆã¿ã§ã™</div>`;
                        } else {
                            libraryContainer.innerHTML = libraryIds.map((id, i) => createItemHTML(id, i, 'library')).join('');
                        }

                        // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ
                        lucide.createIcons({ root: document.getElementById('bgm-settings-screen') });

                        // --- ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---

                        // 1. è©¦è´ãƒœã‚¿ãƒ³
                        document.querySelectorAll('.preview-bgm-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const id = btn.dataset.id;
                                const url = btn.dataset.url;
                                const name = btn.dataset.name;
                                toggleMusicPreview(url, btn, name, id);
                            });
                        });

                        // 2. è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªå´ãƒ»ã‚¯ãƒªãƒƒã‚¯ç”¨ï¼‰
                        document.querySelectorAll('.add-bgm-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const id = btn.dataset.id;
                                state.settings.playlist.push(id);
                                saveState();
                                renderLists(); 
                            });
                        });

                        // 3. ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤ï¼ˆãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå´ï¼‰
                        if (playlistIds.length > 0) {
                            playlistContainer.querySelectorAll('.bgm-sortable-item').forEach(itemEl => {
                                new SwipeHandler(itemEl, {
                                    onDelete: () => {
                                        const id = itemEl.dataset.id;
                                        const idx = state.settings.playlist.indexOf(id);
                                        if (idx > -1) {
                                            state.settings.playlist.splice(idx, 1);
                                            saveState();
                                            // å‰Šé™¤ã—ãŸæ›²ãŒå†ç”Ÿä¸­ãªã‚‰æ­¢ã‚ã‚‹
                                            if (currentPreviewId === id) stopMusicPreview();
                                            setTimeout(renderLists, 300);
                                        }
                                    }
                                });
                            });
                        }
                    };

                    // åˆå›æç”»
                    renderLists();

                    // --- Drag & Dropè¨­å®š (ãƒªã‚¹ãƒˆé–“ç§»å‹•å¯¾å¿œ) ---
                    const commonSortableOptions = {
                        group: 'bgm-lists', // å…±é€šã®ã‚°ãƒ«ãƒ¼ãƒ—å
                        handle: '.bgm-handle',
                        animation: 200,
                        delay: 100,
                        delayOnTouchOnly: true,
                        touchStartThreshold: 5,
                        ghostClass: 'sortable-ghost',
                        filter: '.swiped-open, .is-swiping, .swipe-deleting, .text-center', // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã‚„ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é™¤å¤–
                        
                        // ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                        onEnd: (evt) => {
                            // DOMä¸Šã®ä¸¦ã³é †ã‚’å…ƒã« state.settings.playlist ã‚’å†æ§‹ç¯‰
                            const newPlaylist = [];
                            playlistContainer.querySelectorAll('.bgm-sortable-item').forEach(el => {
                                newPlaylist.push(el.dataset.id);
                            });

                            state.settings.playlist = newPlaylist;
                            saveState();
                            
                            // DOMãŒSortableã«ã‚ˆã£ã¦ç§»å‹•æ¸ˆã¿ãªã®ã§ã€è¦‹ãŸç›®ã‚’æ•´ãˆã‚‹ãŸã‚ã«å°‘ã—é…ã‚Œã¦å†æç”»
                            setTimeout(() => renderLists(), 50);
                        }
                    };

                    bgmSortablePlaylist = Sortable.create(playlistContainer, commonSortableOptions);
                    bgmSortableLibrary = Sortable.create(libraryContainer, commonSortableOptions);
                },
                
                onClose: () => {
                    stopMusicPreview();
                }
            });

            // BGMè©¦è´ã®å†ç”Ÿãƒ»åœæ­¢åˆ¶å¾¡ï¼ˆä¿®æ­£ç‰ˆ: IDç®¡ç†ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ï¼‰
            const toggleMusicPreview = (url, btnElement, titleName = 'è©¦è´', trackId = null) => {
                // ç¾åœ¨å†ç”Ÿä¸­ã®IDã¨ä¸€è‡´ã—ã€ã‹ã¤å†ç”Ÿä¸­ã§ã‚ã‚Œã°åœæ­¢
                if (currentPreviewId === trackId && !previewAudio.paused) {
                    stopMusicPreview();
                    return;
                }

                // åœæ­¢ï¼†ãƒªã‚»ãƒƒãƒˆ
                stopMusicPreview();

                currentPreviewId = trackId; // IDã‚’ä¿å­˜
                previewAudio.src = url;
                previewAudio.volume = 0.5;
                
                updateMediaSession(titleName);
                
                previewAudio.play().then(() => {
                    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã€Œåœæ­¢(square)ã€ã«å¤‰æ›´
                    if (btnElement) {
                        // ç‚¹æ»…(playing-icon)ã¯å‰Šé™¤ã€‚fill-currentã§ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼å¡—ã‚Šã¤ã¶ã—
                        btnElement.innerHTML = '<i data-lucide="square" class="w-5 h-5 primary-text fill-current"></i>';
                        lucide.createIcons({ root: btnElement });
                    }
                    
                    // 30ç§’å¾Œã«è‡ªå‹•åœæ­¢
                    if (previewTimeout) clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(stopMusicPreview, 30000); 

                }).catch(e => {
                    console.error("è©¦è´ã‚¨ãƒ©ãƒ¼", e);
                    currentPreviewId = null;
                });
            };
            
            const stopMusicPreview = () => {
                previewAudio.pause();
                previewAudio.currentTime = 0;
                previewAudio.src = "";
                
                currentPreviewId = null; // IDãƒªã‚»ãƒƒãƒˆ

                if (previewTimeout) clearTimeout(previewTimeout);
                
                // å…¨ã¦ã®å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ã€Œå†ç”Ÿ(play)ã€ã«æˆ»ã™
                document.querySelectorAll('.preview-bgm-btn').forEach(btn => {
                     btn.innerHTML = '<i data-lucide="play" class="w-5 h-5 primary-text ml-0.5 fill-current"></i>';
                     // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤ï¼ˆå¿µã®ãŸã‚ï¼‰
                     btn.classList.remove('playing-icon');
                });
                
                lucide.createIcons();
            };

            $('#close-bgm-settings-btn').addEventListener('click', () => bgmSettingsPage.close());

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ç´ä»˜ã‘
            $('#close-item-detail-btn').addEventListener('click', () => itemDetailPage.close());

            // â€» å¤ã„ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¶å¾¡ã‚³ãƒ¼ãƒ‰ã‚„ closeItemDetailScreen é–¢æ•°ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
            // ==========================================

            // è³¼å…¥ãƒœã‚¿ãƒ³ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            const attachPurchaseEvents = () => {
                // ã‚²ãƒ¼ãƒ è³¼å…¥
                $$('.game-purchase-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        const item = initialData.games[id];
                        $('#game-purchase-title').textContent = item.name;
                        $('#game-purchase-cost').textContent = `å¿…è¦ãƒã‚¤ãƒ³ãƒˆ: ${item.cost} LP`;
                        renderGamePreviews(item);
                        
                        const confirmBtn = $('#game-purchase-confirm');
                        confirmBtn.dataset.itemId = id;
                        confirmBtn.dataset.itemType = 'game';
                        confirmBtn.disabled = state.profile.lp < item.cost;
                        
                        lucide.createIcons();
                        $('#game-purchase-modal').style.display = 'flex';
                    });
                });

                // éŸ³æ¥½è³¼å…¥
                $$('.music-purchase-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.id;
                        const item = initialData.music[id];
                        $('#music-purchase-title').textContent = item.name;
                        $('#music-purchase-cost').textContent = `å¿…è¦ãƒã‚¤ãƒ³ãƒˆ: ${item.cost} LP`;
                        
                        const previewBtn = $('#music-preview-btn');
                        const newPreviewBtn = previewBtn.cloneNode(true);
                        previewBtn.parentNode.replaceChild(newPreviewBtn, previewBtn);
                        
                        newPreviewBtn.addEventListener('click', () => {
                            // â˜…ä¿®æ­£: ç¬¬3å¼•æ•°ã«ã‚¢ã‚¤ãƒ†ãƒ åã‚’æ¸¡ã™
                            toggleMusicPreview(item.url, newPreviewBtn, item.name);
                        });
                        
                        const confirmBtn = $('#music-purchase-confirm');
                        confirmBtn.dataset.itemId = id;
                        confirmBtn.dataset.itemType = 'music';
                        confirmBtn.disabled = state.profile.lp < item.cost;
                        
                        $('#music-purchase-modal').style.display = 'flex';
                        lucide.createIcons();
                    });
                });
            };
            
        /* â–¼â–¼â–¼ è¿½åŠ æ©Ÿèƒ½ç”¨é–¢æ•° â–¼â–¼â–¼ */
        
        // â†“â†“â†“ æ—¢å­˜ã® renderGamePreviews ã‚’ã“ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â†“â†“â†“
const renderGamePreviews = (game) => {
    const container = $('#detail-carousel'); 
    if(!container) return;
    container.innerHTML = '';

    if (!game.previews || game.previews.length === 0) {
        container.innerHTML = `
            <div class="preview-item w-full aspect-video bg-gray-100 dark:bg-gray-800 rounded-xl flex flex-col items-center justify-center text-gray-400 border border-gray-200 dark:border-gray-700">
                <i data-lucide="image-off" class="w-12 h-12 mb-2"></i>
                <span>No Preview</span>
            </div>`;
        return;
    }

    game.previews.forEach((url) => { 
        const item = document.createElement('div');
        
        // â˜…ä¿®æ­£: indexã«ã‚ˆã‚‹åˆ†å²ã‚’å‰Šé™¤ã—ã€å…¨ã¦ aspect-[9/16] ã§çµ±ä¸€
        item.className = 'preview-item w-[70vw] md:w-[300px] aspect-[9/16] flex-shrink-0 bg-gray-100 dark:bg-gray-800 rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-700 snap-center shadow-sm';
        
        const isVideo = url.endsWith('.mp4') || url.endsWith('.webm');
        
        if (isVideo) {
            item.innerHTML = `<video src="${url}" controls playsinline muted class="w-full h-full object-cover pointer-events-auto"></video>`;
        } else {
            // object-coverã§ã¯ãªã object-contain ã«ã™ã‚‹ã¨å…¨ä½“ãŒè¦‹ãˆã¾ã™ãŒã€
            // ã€ŒåŒæ§˜ã®ã‚µã‚¤ã‚ºã€ã¨ã®ã”è¦æœ›ãªã®ã§ãƒ‡ã‚¶ã‚¤ãƒ³ã®ä¸€è²«æ€§ã‚’ä¿ã¤ãŸã‚ object-cover ã«ã—ã¦ã„ã¾ã™ã€‚
            // å…¨ä½“ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯ã“ã“ã‚’ object-contain ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
            item.innerHTML = `<img src="${url}" alt="preview" class="w-full h-full object-cover">`;
        }
        container.appendChild(item);
    });
    
    container.className = "flex overflow-x-auto gap-4 pb-4 px-6 snap-x snap-mandatory scroll-smooth no-scrollbar";
};
// â†‘â†‘â†‘ ä¿®æ­£ã“ã“ã¾ã§ â†‘â†‘â†‘
        
            // ==========================================
            // â–¼â–¼â–¼ PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¼·åˆ¶ãƒ­ã‚¸ãƒƒã‚¯ (æ”¹ä¿®ç‰ˆ) â–¼â–¼â–¼
            // ==========================================
            let deferredPrompt = null;

            // 1. Android/Chromeç”¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒƒãƒ
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // Androidã®å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¥ã¦ã‹ã‚‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ç­‰ã®åˆ¶å¾¡ã‚‚å¯èƒ½ã§ã™ãŒ
                // ä»Šå›ã¯ä¸€å¾‹ã€Œãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰è¡¨ç¤ºã€ã§åˆ¶å¾¡ã—ã¾ã™
            });

            // 2. èµ·å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
            const checkPwaStatus = () => {
                const startContainer = document.getElementById('pwa-start-buttons'); // é€šå¸¸ã®ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ç¾¤
                const installArea = document.getElementById('pwa-install-trigger-area'); // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³(1ã¤)
                const installBtn = document.getElementById('pwa-install-trigger-btn');
                const iosOverlay = document.getElementById('ios-install-overlay');

                // PWAãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã®åˆ¤å®š
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

                if (isStandalone) {
                    // â˜…ã‚¢ãƒ—ãƒªã¨ã—ã¦é–‹ã„ã¦ã„ã‚‹å ´åˆ -> é€šå¸¸é€šã‚Š
                    startContainer.classList.remove('hidden');
                    installArea.classList.add('hidden');
                } else {
                    // â˜…ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã—ã¦é–‹ã„ã¦ã„ã‚‹å ´åˆ -> ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã¿è¡¨ç¤º (ç”»é¢ã‚¹ãƒƒã‚­ãƒª)
                    startContainer.classList.add('hidden');
                    installArea.classList.remove('hidden');

                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
                    installBtn.onclick = async () => {
                        // iOSåˆ¤å®š
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

                        if (isIOS) {
                            // â–¼ iOSã®å ´åˆ: å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã—ã¦èª˜å°ã™ã‚‹
                            iosOverlay.classList.remove('hidden');
                            iosOverlay.style.display = 'flex'; // flexã§è¡¨ç¤º
                            // ã‚¢ã‚¤ã‚³ãƒ³å†ç”Ÿæˆ(ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å†…ã®ã‚¢ã‚¤ã‚³ãƒ³ç”¨)
                            if(window.lucide) lucide.createIcons({ root: iosOverlay });
                        } else {
                            // â–¼ Android/PCã®å ´åˆ: ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‡ºã™
                            if (deferredPrompt) {
                                deferredPrompt.prompt();
                                const { outcome } = await deferredPrompt.userChoice;
                                console.log(`User response: ${outcome}`);
                                deferredPrompt = null;
                            } else {
                                // ä¸‡ãŒä¸€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå‡ºã›ãªã„å ´åˆï¼ˆæ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãªã©ï¼‰
                                alert('ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                            }
                        }
                    };
                }
            };

            // 4. åˆæœŸå®Ÿè¡Œã¨ãƒªã‚µã‚¤ã‚ºç›£è¦–
            checkPwaStatus();
            window.matchMedia('(display-mode: standalone)').addEventListener('change', checkPwaStatus);
            // ==========================================
            // â–²â–²â–² æ”¹ä¿®ã“ã“ã¾ã§ â–²â–²â–²
            // ==========================================
            // â–¼â–¼â–¼ è¿½åŠ : èµ·å‹•æ™‚ã«ç¸¦ç”»é¢å›ºå®šã‚’è©¦ã¿ã‚‹ â–¼â–¼â–¼
            controlScreenOrientation('default');
            init();
        });
        // â–¼â–¼â–¼ è¿½åŠ : ç”»é¢å›è»¢ãƒ»ãƒªã‚µã‚¤ã‚ºæ™‚ã®ãƒãƒŠãƒ¼ä½ç½®ã‚ºãƒ¬ä¿®æ­£ â–¼â–¼â–¼
window.addEventListener('resize', () => {
    // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã‚‹ã®ã‚’å°‘ã—å¾…ã¤ï¼ˆã“ã‚ŒãŒé‡è¦ã§ã™ï¼‰
    setTimeout(() => {
        const carousel = document.getElementById('home-banner-carousel');
        if (!carousel) return;

        const item = carousel.querySelector('.banner-item');
        if (!item) return;

        // ãƒãƒŠãƒ¼1æšåˆ†ã®å¹… + éš™é–“(12px) ã‚’è¨ˆç®—
        // â€»CSSã§ gap: 12px ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ãŸã‚
        const gap = 12; 
        const oneSlideWidth = item.offsetWidth + gap;

        // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‹ã‚‰ã€ä¸€ç•ªè¿‘ã„ãƒãƒŠãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
        const scrollPos = carousel.scrollLeft;
        const nearestIndex = Math.round(scrollPos / oneSlideWidth);

        // ãã®ãƒãƒŠãƒ¼ã®ä½ç½®ã¸ç¬æ™‚ã«ç§»å‹•ã•ã›ã‚‹
        carousel.scrollTo({
            left: nearestIndex * oneSlideWidth,
            behavior: 'instant' // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§å³åº§ã«åˆã‚ã›ã‚‹
        });
    }, 300); // 0.3ç§’å¾…æ©Ÿï¼ˆiOSã®å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã«åˆã‚ã›ã‚‹ï¼‰
});
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    </script>
    <div id="ios-install-overlay" class="fixed inset-0 z-[9999] bg-black/90 text-white hidden animate-fadeIn" onclick="this.classList.add('hidden')">
        
        <div class="absolute inset-0 flex flex-col items-center justify-start pt-20 px-6 text-center pointer-events-none">

            <div class="space-y-4 text-left bg-white/10 p-6 rounded-2xl border border-white/10 backdrop-blur-sm w-full max-w-sm">
                <div class="flex items-center">
                    <span class="w-6 h-6 rounded-full bg-white text-black font-bold flex items-center justify-center text-xs mr-3 flex-shrink-0">1</span>
                    <p class="text-sm">ç”»é¢ä¸‹éƒ¨ã® <i data-lucide="share" class="inline w-4 h-4 mx-1"></i> ã€Œå…±æœ‰ã€ ã‚’ã‚¿ãƒƒãƒ—</p>
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 rounded-full bg-white text-black font-bold flex items-center justify-center text-xs mr-3 flex-shrink-0">2</span>
                    <p class="text-sm"><i data-lucide="plus-square" class="inline w-4 h-4 mx-1"></i>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ</p>
                </div>
                <div class="flex items-center">
                    <span class="w-6 h-6 rounded-full bg-white text-black font-bold flex items-center justify-center text-xs mr-3 flex-shrink-0">3</span>
                    <p class="text-sm">å³ä¸Šã®ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å®Œäº†</p>
                </div>
            </div>
        </div>

        <div class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center pointer-events-none z-10">
            <div class="mt-32">
                <img src="SQ_logo.png" alt="Icon" class="w-20 h-20 rounded-2xl shadow-2xl mx-auto mb-4 border border-white/20">
                <h3 class="text-2xl font-bold mb-2">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹</h3>
            </div>
                <p class="mt-12 text-gray-500 text-xs font-bold">â€»ç«¯æœ«ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ã€æ“ä½œæ–¹æ³•ãŒç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
        </div>

        <div class="absolute bottom-6 right-8 flex flex-col items-center animate-bounce pointer-events-none">
            <p class="text-sm font-bold mb-2">ã“ã“ã‚’ã‚¿ãƒƒãƒ—</p>
            <i data-lucide="arrow-down" class="w-8 h-8 text-white"></i>
        </div>
    </div>
    <div id="dev-lock-screen" class="fixed inset-0 z-[100000] bg-gray-900 flex flex-col items-center justify-center p-6 text-center hidden touch-none">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full border border-gray-200 dark:border-gray-700">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">æ­£å¸¸ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰<br>ã§ãã¾ã›ã‚“ã§ã—ãŸ</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 font-bold leading-relaxed">
                ã‚‚ã—ã“ã‚ŒãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã¯ã€<br>é–‹ç™ºè€…ã«ãŠçŸ¥ã‚‰ã›ãã ã•ã„<br>ãŠæ‰‹æ•°ã‚’ãŠã‹ã‘ã—ã¦ã€ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“
            </p>
            
            <input type="password" id="dev-pass-input" placeholder="DOWNLOAD_FAILED_503" class="w-full p-4 rounded-xl bg-gray-100 dark:bg-gray-700 border border-transparent focus:border-indigo-500 outline-none text-center font-bold text-gray-900 dark:text-white mb-4 transition-colors">
            <p id="dev-pass-error" class="text-xs text-red-500 font-bold mb-4 hidden">â€»é–‹ç™ºè€…ã«ãŠçŸ¥ã‚‰ã›ãã ã•ã„</p>

            <button id="dev-unlock-btn" class="w-full primary-bg text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95">
                ã‚¿ãƒƒãƒ—ã—ãªã„ã§ãã ã•ã„
            </button>
        </div>
    </div>
</body>
</html>
